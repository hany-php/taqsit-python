The following is a digest of the repository "NizamTaqsit".
This digest is designed to be easily parsed by Large Language Models.

--- SUMMARY ---
Repository: NizamTaqsit
Files Analyzed: 176
Total Text Size: 787.65 KB
Estimated Tokens (text only): ~203,138

--- DIRECTORY STRUCTURE ---
NizamTaqsit/
├── app/
│   ├── Controllers/
│   │   ├── Api/
│   │   │   └── ApiV2Controller.php
│   │   ├── AdvancedReportController.php
│   │   ├── ApiController.php
│   │   ├── ApiKeyController.php
│   │   ├── AuthController.php
│   │   ├── BackupController.php
│   │   ├── CategoryController.php
│   │   ├── CustomerController.php
│   │   ├── DashboardController.php
│   │   ├── ExportController.php
│   │   ├── InstallmentController.php
│   │   ├── InvoiceController.php
│   │   ├── NotificationController.php
│   │   ├── PaymentController.php
│   │   ├── ProductController.php
│   │   ├── ReportController.php
│   │   ├── SettingController.php
│   │   └── UserController.php
│   ├── Helpers/
│   │   └── functions.php
│   ├── Models/
│   │   ├── Category.php
│   │   ├── Customer.php
│   │   ├── Installment.php
│   │   ├── InstallmentPlan.php
│   │   ├── Invoice.php
│   │   ├── Model.php
│   │   ├── Payment.php
│   │   ├── Product.php
│   │   ├── Setting.php
│   │   └── User.php
│   └── Views/
│       ├── auth/
│       │   └── login.php
│       ├── categories/
│       │   ├── index.php
│       │   └── show.php
│       ├── customers/
│       │   ├── create.php
│       │   ├── edit.php
│       │   ├── index.php
│       │   └── show.php
│       ├── dashboard/
│       │   └── index.php
│       ├── errors/
│       │   ├── 404.php
│       │   └── 500.php
│       ├── installments/
│       │   ├── index.php
│       │   ├── overdue.php
│       │   └── today.php
│       ├── invoices/
│       │   ├── contract.php
│       │   ├── edit.php
│       │   ├── index.php
│       │   ├── print.php
│       │   └── show.php
│       ├── layouts/
│       │   ├── header.php
│       │   ├── master.php
│       │   └── sidebar.php
│       ├── notifications/
│       │   └── index.php
│       ├── partials/
│       │   ├── export_buttons.php
│       │   ├── pagination.php
│       │   └── table_selection.php
│       ├── payments/
│       │   ├── index.php
│       │   └── receipt.php
│       ├── pos/
│       │   ├── index.php
│       │   └── installment.php
│       ├── products/
│       │   ├── create.php
│       │   ├── edit.php
│       │   ├── index.php
│       │   └── show.php
│       ├── settings/
│       │   ├── api.php
│       │   ├── backup.php
│       │   ├── index.php
│       │   └── installment.php
│       └── users/
│           ├── create.php
│           ├── edit.php
│           └── index.php
├── config/
│   ├── app.php
│   ├── database.php
│   └── routes.php
├── core/
│   ├── ApiMiddleware.php
│   ├── Application.php
│   ├── BaseApiController.php
│   ├── Controller.php
│   ├── Database.php
│   ├── Pagination.php
│   ├── Permission.php
│   └── Router.php
├── database/
│   ├── add_color_column.php
│   ├── init.php
│   ├── migrate_api_keys.php
│   ├── migrate_menu_config.php
│   └── schema.sql
├── docker/
│   ├── default.conf
│   ├── nginx.conf
│   └── supervisord.conf
├── docs/
│   └── screenshots/
│       ├── customers.png [binary]
│       ├── dashboard.png [binary]
│       ├── pos.png [binary]
│       ├── products.png [binary]
│       ├── reports.png [binary]
│       └── settings.png [binary]
├── uploads/
│   └── products/
│       ├── product_0019a351492c879937b621507990992d.jpg [binary]
│       ├── product_030affcc8ef5cf2edc36473c5405a945.jpg [binary]
│       ├── product_03f63b99ab06a68bd7cce264ba554b7f.jpg [binary]
│       ├── product_042d007f65154fc706c7cde123e9da2c.jpg [binary]
│       ├── product_053b0774772fe04c5492a6623ca87334.jpg [binary]
│       ├── product_0ef41a6e15cb950531a7a572877c9eb8.jpg [binary]
│       ├── product_193eb5d14c271b615ceeb12c4e06f0fc.jpg [binary]
│       ├── product_1ccb90e7f12b65c15cccf6d04e59253c.jpg [binary]
│       ├── product_1e0bd056ef39cfe0e9400bf3a9ec5ee3.jpg [binary]
│       ├── product_1eb60dd7eab57d9f8c37290630589231.jpg [binary]
│       ├── product_1ff31c1a326a4c88c5586e6301ac20d6.jpg [binary]
│       ├── product_20053e7297161cdd5ea9508071cd51d1.jpg [binary]
│       ├── product_20cf527fdc861e4d2b4932bbdbc416c4.jpg [binary]
│       ├── product_22bbdfc6a47fb9b45712c6c6da80b64c.jpg [binary]
│       ├── product_249dbe7b8fc1d55ca1fe7a5c66a78295.jpg [binary]
│       ├── product_26fe312b44f29e22bdb93371529b005c.jpg [binary]
│       ├── product_277f1d586bd73ab155221bb561aaf8b9.jpg [binary]
│       ├── product_28eba8bd7ad642bcacc03bcb68f4960c.jpg [binary]
│       ├── product_2b06b219069afff6e05636d91042da55.jpg [binary]
│       ├── product_2c618c884482c2f5a4f23b107d7edbdc.jpg [binary]
│       ├── product_32fb01eb8da9c488ff5fe6b2573ca9aa.jpg [binary]
│       ├── product_33f920d2f6457e7a4b5875a814ff9a0e.jpg [binary]
│       ├── product_3f9da76d2c1fe37e47b60256f6279a10.jpg [binary]
│       ├── product_4c1e6723246f572fa2be31dc5aabbecc.jpg [binary]
│       ├── product_4ddcf32ffd0ea4db8d4588e920576e00.jpg [binary]
│       ├── product_502bd13b40fa29b0ecbb73b7096bba2b.jpg [binary]
│       ├── product_543d63ddbd713807f6eda4f0ed705c4e.jpg [binary]
│       ├── product_5470bc5dc6cde08b661d904bf0ab465e.jpg [binary]
│       ├── product_55320e58a932dbebcf4f1c56a794c542.jpg [binary]
│       ├── product_63b27e306c1a1922c8d15075bf92b7c2.jpg [binary]
│       ├── product_6b911089f66763c955d386888082327d.jpg [binary]
│       ├── product_712b8d0eff5f752e341bc8ed2eb55863.jpg [binary]
│       ├── product_752a4cfa775fdb477c52546b1161024e.jpg [binary]
│       ├── product_75a33559849112b375c3c0dafb212341.jpg [binary]
│       ├── product_796a9398287518e5391629b8526568e0.jpg [binary]
│       ├── product_79b3b0f764e13fa74e60ac9a140d6281.jpg [binary]
│       ├── product_7eb6bd1bd09f298f40a3a0d895586370.jpg [binary]
│       ├── product_80fbe0681fa345bb7a04383dfdb2be93.jpg [binary]
│       ├── product_83e1656790fa1a248fe9cf56894e68df.jpg [binary]
│       ├── product_865a85a7b6fc81cb2185984b3709904d.jpg [binary]
│       ├── product_87c711af950cf29d180c8baeec2be579.jpg [binary]
│       ├── product_8a7023801fc6fee807e76204b38130e7.jpg [binary]
│       ├── product_8eb5d500000f677050d987be6a0b5d88.jpg [binary]
│       ├── product_97804d9fe0b087d11c032724e27de5f6.jpg [binary]
│       ├── product_9819d0540eb1c819fa3178097a2453e9.jpg [binary]
│       ├── product_9a54a7c6237ad55dc39a43d39703150a.jpg [binary]
│       ├── product_9bd83b5ce232d79295155bf8999ab3f7.jpg [binary]
│       ├── product_9c8bb245095790dccae21a14972e233a.jpg [binary]
│       ├── product_9e3b564b4f041595f6045d110c57096b.jpg [binary]
│       ├── product_9eec2ee6b6faad0d52ca48ee896da989.jpg [binary]
│       ├── product_a327722e2d87cf7229f5b60ea2913dc2.jpg [binary]
│       ├── product_a73ff9a4e44cbc539b4756e9c8546ebf.jpg [binary]
│       ├── product_a7463ca4249243afc02f7e4b3516734f.jpg [binary]
│       ├── product_ab669dbd4045143a6b74b785f98944d4.jpg [binary]
│       ├── product_bd59ccb9e68526240bbef18fed9e5129.jpg [binary]
│       ├── product_c014cef3382a0afab2683c2811495e80.jpg [binary]
│       ├── product_c3e5d0343fb67b62bcd8cdc7c68ab917.jpg [binary]
│       ├── product_c7122ffd096293e7cb4fffe7fb48a7c6.jpg [binary]
│       ├── product_c82a9fe6934473f2a3c32731caaff23f.jpg [binary]
│       ├── product_cda5407e4e96fa2b55a334de33ac5ebf.jpg [binary]
│       ├── product_d6c7eeee46ccfc49bca77f0c1a6c814f.jpg [binary]
│       ├── product_d7ce3bdf8abec9309fd2ec568ea9e1b7.jpg [binary]
│       ├── product_d8346c4bbef455ff6c850b58c8fd8dbd.jpg [binary]
│       ├── product_db692a5514e732de81b592b6fabd8d35.jpg [binary]
│       ├── product_e6d4342a51f8be50abb41ee5ed2df90f.jpg [binary]
│       ├── product_e941a19e1cfa33246bddc68ba0fa840f.jpg [binary]
│       ├── product_e96bcad44e9b1d99d058d00479fa38c5.jpg [binary]
│       ├── product_e97d7a7d15bedb2b409ce620ec6df786.jpg [binary]
│       ├── product_efe9419a793af18e7f244c778af3d9f6.jpg [binary]
│       ├── product_f107011759ef0e603ed67b2f3cc2c796.jpg [binary]
│       ├── product_f58f2c184780b5a9b95135c39ac6592d.jpg [binary]
│       ├── product_f59b85c0d4095702e3aba10357e2e842.jpg [binary]
│       ├── product_fc0fe18db553453482e11640e8587f2d.jpg [binary]
│       ├── product_fd72d7a7e863a2acc100275235cccd0c.jpg [binary]
│       └── product_fde7f1873f0bf78a21b0ca9a329641d5.jpg [binary]
├── add_products_with_images.php
├── check_api_keys.php
├── docker-compose-copy.yml
├── fix_password.php
├── generate_bulk_products.php
├── generate_sample_data.php
└── README.md


--- FILE CONTENTS ---
============================================================
FILE: app/Controllers/Api/ApiV2Controller.php
============================================================
<?php
namespace App\Controllers\Api;

use Core\BaseApiController;

/**
 * ╔══════════════════════════════════════════════════════════════════╗
 * ║                    نظام تقسيط - API v2 Controller                 ║
 * ║              نقاط نهاية شاملة لجميع الموارد                       ║
 * ╚══════════════════════════════════════════════════════════════════╝
 */
class ApiV2Controller extends BaseApiController
{
    // ══════════════════════════════════════════════════════════════════
    // المنتجات
    // ══════════════════════════════════════════════════════════════════
    
    /**
     * قائمة المنتجات
     */
    public function products(): void
    {
        $pagination = $this->getPagination();
        $search = $_GET['q'] ?? '';
        $category = $_GET['category'] ?? '';
        
        $where = "WHERE p.is_active = 1";
        $params = [];
        
        if ($search) {
            $where .= " AND (p.name LIKE ? OR p.barcode LIKE ? OR p.brand LIKE ?)";
            $params[] = "%{$search}%";
            $params[] = "%{$search}%";
            $params[] = "%{$search}%";
        }
        
        if ($category) {
            $where .= " AND p.category_id = ?";
            $params[] = $category;
        }
        
        // العدد الإجمالي
        $total = (int) $this->db->fetchColumn(
            "SELECT COUNT(*) FROM products p {$where}",
            $params
        );
        
        // جلب البيانات
        $products = $this->db->fetchAll(
            "SELECT p.*, c.name as category_name 
             FROM products p 
             LEFT JOIN categories c ON p.category_id = c.id 
             {$where}
             ORDER BY p.id DESC
             LIMIT {$pagination['per_page']} OFFSET {$pagination['offset']}",
            $params
        );
        
        $this->paginated($products, $total, $pagination['page'], $pagination['per_page']);
    }
    
    /**
     * عرض منتج
     */
    public function product(int $id): void
    {
        $product = $this->db->fetch(
            "SELECT p.*, c.name as category_name 
             FROM products p 
             LEFT JOIN categories c ON p.category_id = c.id 
             WHERE p.id = ?",
            [$id]
        );
        
        if (!$product) {
            $this->notFound('المنتج غير موجود');
        }
        
        $this->success($product);
    }
    
    /**
     * إضافة منتج
     */
    public function createProduct(): void
    {
        $data = $this->getJsonInput();
        
        $errors = [];
        if (empty($data['name'])) {
            $errors['name'] = 'اسم المنتج مطلوب';
        }
        if (empty($data['cash_price']) || !is_numeric($data['cash_price'])) {
            $errors['cash_price'] = 'السعر النقدي مطلوب';
        }
        
        if (!empty($errors)) {
            $this->validationError($errors);
        }
        
        $productData = [
            'name' => $data['name'],
            'description' => $data['description'] ?? null,
            'category_id' => $data['category_id'] ?? null,
            'barcode' => $data['barcode'] ?? null,
            'sku' => $data['sku'] ?? null,
            'cash_price' => $data['cash_price'],
            'installment_price' => $data['installment_price'] ?? $data['cash_price'],
            'cost_price' => $data['cost_price'] ?? null,
            'quantity' => $data['quantity'] ?? 0,
            'min_quantity' => $data['min_quantity'] ?? 5,
            'brand' => $data['brand'] ?? null,
            'model' => $data['model'] ?? null,
            'warranty_months' => $data['warranty_months'] ?? 0,
            'is_active' => $data['is_active'] ?? 1,
        ];
        
        $id = $this->db->insert('products', $productData);
        $this->logApiActivity('create_product', 'products', $id);
        
        $product = $this->db->fetch("SELECT * FROM products WHERE id = ?", [$id]);
        $this->success($product, 'تم إضافة المنتج بنجاح', 201);
    }
    
    /**
     * تعديل منتج
     */
    public function updateProduct(int $id): void
    {
        $product = $this->db->fetch("SELECT * FROM products WHERE id = ?", [$id]);
        if (!$product) {
            $this->notFound('المنتج غير موجود');
        }
        
        $data = $this->getJsonInput();
        $updateData = [];
        
        $fields = ['name', 'description', 'category_id', 'barcode', 'sku', 'cash_price', 
                   'installment_price', 'cost_price', 'quantity', 'min_quantity', 
                   'brand', 'model', 'warranty_months', 'is_active'];
        
        foreach ($fields as $field) {
            if (isset($data[$field])) {
                $updateData[$field] = $data[$field];
            }
        }
        
        if (!empty($updateData)) {
            $updateData['updated_at'] = date('Y-m-d H:i:s');
            $this->db->update('products', $updateData, 'id = ?', [$id]);
            $this->logApiActivity('update_product', 'products', $id);
        }
        
        $product = $this->db->fetch("SELECT * FROM products WHERE id = ?", [$id]);
        $this->success($product, 'تم تحديث المنتج بنجاح');
    }
    
    /**
     * حذف منتج
     */
    public function deleteProduct(int $id): void
    {
        $product = $this->db->fetch("SELECT * FROM products WHERE id = ?", [$id]);
        if (!$product) {
            $this->notFound('المنتج غير موجود');
        }
        
        $this->db->delete('products', 'id = ?', [$id]);
        $this->logApiActivity('delete_product', 'products', $id);
        
        $this->success(null, 'تم حذف المنتج بنجاح');
    }
    
    // ══════════════════════════════════════════════════════════════════
    // التصنيفات
    // ══════════════════════════════════════════════════════════════════
    
    /**
     * قائمة التصنيفات
     */
    public function categories(): void
    {
        $categories = $this->db->fetchAll(
            "SELECT c.*, 
                    (SELECT COUNT(*) FROM products WHERE category_id = c.id) as products_count
             FROM categories c 
             ORDER BY c.sort_order, c.name"
        );
        
        $this->success($categories);
    }
    
    /**
     * عرض تصنيف
     */
    public function category(int $id): void
    {
        $category = $this->db->fetch(
            "SELECT c.*, 
                    (SELECT COUNT(*) FROM products WHERE category_id = c.id) as products_count
             FROM categories c WHERE c.id = ?",
            [$id]
        );
        
        if (!$category) {
            $this->notFound('التصنيف غير موجود');
        }
        
        // جلب المنتجات
        $category['products'] = $this->db->fetchAll(
            "SELECT * FROM products WHERE category_id = ? AND is_active = 1",
            [$id]
        );
        
        $this->success($category);
    }
    
    /**
     * إضافة تصنيف
     */
    public function createCategory(): void
    {
        $data = $this->getJsonInput();
        
        if (empty($data['name'])) {
            $this->validationError(['name' => 'اسم التصنيف مطلوب']);
        }
        
        $categoryData = [
            'name' => $data['name'],
            'description' => $data['description'] ?? null,
            'parent_id' => $data['parent_id'] ?? null,
            'icon' => $data['icon'] ?? null,
            'sort_order' => $data['sort_order'] ?? 0,
            'is_active' => $data['is_active'] ?? 1,
        ];
        
        $id = $this->db->insert('categories', $categoryData);
        $this->logApiActivity('create_category', 'categories', $id);
        
        $category = $this->db->fetch("SELECT * FROM categories WHERE id = ?", [$id]);
        $this->success($category, 'تم إضافة التصنيف بنجاح', 201);
    }
    
    /**
     * تعديل تصنيف
     */
    public function updateCategory(int $id): void
    {
        $category = $this->db->fetch("SELECT * FROM categories WHERE id = ?", [$id]);
        if (!$category) {
            $this->notFound('التصنيف غير موجود');
        }
        
        $data = $this->getJsonInput();
        $updateData = [];
        
        foreach (['name', 'description', 'parent_id', 'icon', 'sort_order', 'is_active'] as $field) {
            if (isset($data[$field])) {
                $updateData[$field] = $data[$field];
            }
        }
        
        if (!empty($updateData)) {
            $updateData['updated_at'] = date('Y-m-d H:i:s');
            $this->db->update('categories', $updateData, 'id = ?', [$id]);
            $this->logApiActivity('update_category', 'categories', $id);
        }
        
        $category = $this->db->fetch("SELECT * FROM categories WHERE id = ?", [$id]);
        $this->success($category, 'تم تحديث التصنيف بنجاح');
    }
    
    /**
     * حذف تصنيف
     */
    public function deleteCategory(int $id): void
    {
        $category = $this->db->fetch("SELECT * FROM categories WHERE id = ?", [$id]);
        if (!$category) {
            $this->notFound('التصنيف غير موجود');
        }
        
        // التحقق من عدم وجود منتجات
        $count = $this->db->fetchColumn("SELECT COUNT(*) FROM products WHERE category_id = ?", [$id]);
        if ($count > 0) {
            $this->error('لا يمكن حذف التصنيف لأنه يحتوي على منتجات', 400);
        }
        
        $this->db->delete('categories', 'id = ?', [$id]);
        $this->logApiActivity('delete_category', 'categories', $id);
        
        $this->success(null, 'تم حذف التصنيف بنجاح');
    }
    
    // ══════════════════════════════════════════════════════════════════
    // العملاء
    // ══════════════════════════════════════════════════════════════════
    
    /**
     * قائمة العملاء
     */
    public function customers(): void
    {
        $pagination = $this->getPagination();
        $search = $_GET['q'] ?? '';
        
        $where = "WHERE 1=1";
        $params = [];
        
        if ($search) {
            $where .= " AND (full_name LIKE ? OR phone LIKE ? OR national_id LIKE ?)";
            $params[] = "%{$search}%";
            $params[] = "%{$search}%";
            $params[] = "%{$search}%";
        }
        
        $total = (int) $this->db->fetchColumn(
            "SELECT COUNT(*) FROM customers {$where}",
            $params
        );
        
        $customers = $this->db->fetchAll(
            "SELECT c.*, 
                    COALESCE((SELECT SUM(remaining_amount) FROM invoices WHERE customer_id = c.id AND status = 'active'), 0) as balance
             FROM customers c 
             {$where}
             ORDER BY c.id DESC
             LIMIT {$pagination['per_page']} OFFSET {$pagination['offset']}",
            $params
        );
        
        $this->paginated($customers, $total, $pagination['page'], $pagination['per_page']);
    }
    
    /**
     * عرض عميل
     */
    public function customer(int $id): void
    {
        $customer = $this->db->fetch("SELECT * FROM customers WHERE id = ?", [$id]);
        
        if (!$customer) {
            $this->notFound('العميل غير موجود');
        }
        
        // إضافة الرصيد
        $customer['balance'] = (float) $this->db->fetchColumn(
            "SELECT COALESCE(SUM(remaining_amount), 0) FROM invoices WHERE customer_id = ? AND status = 'active'",
            [$id]
        );
        
        // إضافة عدد الفواتير النشطة
        $customer['active_invoices_count'] = (int) $this->db->fetchColumn(
            "SELECT COUNT(*) FROM invoices WHERE customer_id = ? AND status = 'active'",
            [$id]
        );
        
        $this->success($customer);
    }
    
    /**
     * إضافة عميل
     */
    public function createCustomer(): void
    {
        $data = $this->getJsonInput();
        
        $errors = [];
        if (empty($data['full_name'])) {
            $errors['full_name'] = 'اسم العميل مطلوب';
        }
        if (empty($data['phone'])) {
            $errors['phone'] = 'رقم الهاتف مطلوب';
        }
        
        if (!empty($errors)) {
            $this->validationError($errors);
        }
        
        // التحقق من عدم تكرار الهاتف
        $existing = $this->db->fetch("SELECT id FROM customers WHERE phone = ?", [$data['phone']]);
        if ($existing) {
            $this->validationError(['phone' => 'رقم الهاتف مسجل مسبقاً']);
        }
        
        $customerData = [
            'full_name' => $data['full_name'],
            'phone' => $data['phone'],
            'phone2' => $data['phone2'] ?? null,
            'national_id' => $data['national_id'] ?? null,
            'address' => $data['address'] ?? null,
            'city' => $data['city'] ?? null,
            'work_address' => $data['work_address'] ?? null,
            'work_phone' => $data['work_phone'] ?? null,
            'guarantor_name' => $data['guarantor_name'] ?? null,
            'guarantor_phone' => $data['guarantor_phone'] ?? null,
            'guarantor_national_id' => $data['guarantor_national_id'] ?? null,
            'credit_limit' => $data['credit_limit'] ?? 0,
            'notes' => $data['notes'] ?? null,
            'is_active' => $data['is_active'] ?? 1,
        ];
        
        $id = $this->db->insert('customers', $customerData);
        $this->logApiActivity('create_customer', 'customers', $id);
        
        $customer = $this->db->fetch("SELECT * FROM customers WHERE id = ?", [$id]);
        $this->success($customer, 'تم إضافة العميل بنجاح', 201);
    }
    
    /**
     * تعديل عميل
     */
    public function updateCustomer(int $id): void
    {
        $customer = $this->db->fetch("SELECT * FROM customers WHERE id = ?", [$id]);
        if (!$customer) {
            $this->notFound('العميل غير موجود');
        }
        
        $data = $this->getJsonInput();
        $updateData = [];
        
        $fields = ['full_name', 'phone', 'phone2', 'national_id', 'address', 'city',
                   'work_address', 'work_phone', 'guarantor_name', 'guarantor_phone',
                   'guarantor_national_id', 'credit_limit', 'notes', 'is_active'];
        
        foreach ($fields as $field) {
            if (isset($data[$field])) {
                $updateData[$field] = $data[$field];
            }
        }
        
        if (!empty($updateData)) {
            $updateData['updated_at'] = date('Y-m-d H:i:s');
            $this->db->update('customers', $updateData, 'id = ?', [$id]);
            $this->logApiActivity('update_customer', 'customers', $id);
        }
        
        $customer = $this->db->fetch("SELECT * FROM customers WHERE id = ?", [$id]);
        $this->success($customer, 'تم تحديث بيانات العميل بنجاح');
    }
    
    /**
     * حذف عميل
     */
    public function deleteCustomer(int $id): void
    {
        $customer = $this->db->fetch("SELECT * FROM customers WHERE id = ?", [$id]);
        if (!$customer) {
            $this->notFound('العميل غير موجود');
        }
        
        // التحقق من عدم وجود فواتير
        $count = $this->db->fetchColumn("SELECT COUNT(*) FROM invoices WHERE customer_id = ?", [$id]);
        if ($count > 0) {
            $this->error('لا يمكن حذف العميل لأنه مرتبط بفواتير', 400);
        }
        
        $this->db->delete('customers', 'id = ?', [$id]);
        $this->logApiActivity('delete_customer', 'customers', $id);
        
        $this->success(null, 'تم حذف العميل بنجاح');
    }
    
    // ══════════════════════════════════════════════════════════════════
    // المستخدمين
    // ══════════════════════════════════════════════════════════════════
    
    /**
     * قائمة المستخدمين
     */
    public function users(): void
    {
        $users = $this->db->fetchAll(
            "SELECT id, username, full_name, phone, email, role, is_active, last_login, created_at 
             FROM users ORDER BY id DESC"
        );
        
        $this->success($users);
    }
    
    /**
     * عرض مستخدم
     */
    public function user(int $id): void
    {
        $user = $this->db->fetch(
            "SELECT id, username, full_name, phone, email, role, is_active, last_login, created_at 
             FROM users WHERE id = ?",
            [$id]
        );
        
        if (!$user) {
            $this->notFound('المستخدم غير موجود');
        }
        
        $this->success($user);
    }
    
    /**
     * إضافة مستخدم
     */
    public function createUser(): void
    {
        $data = $this->getJsonInput();
        
        $errors = [];
        if (empty($data['username'])) {
            $errors['username'] = 'اسم المستخدم مطلوب';
        }
        if (empty($data['password'])) {
            $errors['password'] = 'كلمة المرور مطلوبة';
        }
        if (empty($data['full_name'])) {
            $errors['full_name'] = 'الاسم الكامل مطلوب';
        }
        
        if (!empty($errors)) {
            $this->validationError($errors);
        }
        
        // التحقق من عدم تكرار اسم المستخدم
        $existing = $this->db->fetch("SELECT id FROM users WHERE username = ?", [$data['username']]);
        if ($existing) {
            $this->validationError(['username' => 'اسم المستخدم موجود مسبقاً']);
        }
        
        $userData = [
            'username' => $data['username'],
            'password_hash' => password_hash($data['password'], PASSWORD_DEFAULT),
            'full_name' => $data['full_name'],
            'phone' => $data['phone'] ?? null,
            'email' => $data['email'] ?? null,
            'role' => $data['role'] ?? 'sales',
            'is_active' => $data['is_active'] ?? 1,
        ];
        
        $id = $this->db->insert('users', $userData);
        $this->logApiActivity('create_user', 'users', $id);
        
        $user = $this->db->fetch(
            "SELECT id, username, full_name, phone, email, role, is_active, created_at FROM users WHERE id = ?",
            [$id]
        );
        $this->success($user, 'تم إضافة المستخدم بنجاح', 201);
    }
    
    /**
     * تعديل مستخدم
     */
    public function updateUser(int $id): void
    {
        $user = $this->db->fetch("SELECT * FROM users WHERE id = ?", [$id]);
        if (!$user) {
            $this->notFound('المستخدم غير موجود');
        }
        
        $data = $this->getJsonInput();
        $updateData = [];
        
        foreach (['full_name', 'phone', 'email', 'role', 'is_active'] as $field) {
            if (isset($data[$field])) {
                $updateData[$field] = $data[$field];
            }
        }
        
        if (!empty($data['password'])) {
            $updateData['password_hash'] = password_hash($data['password'], PASSWORD_DEFAULT);
        }
        
        if (!empty($updateData)) {
            $updateData['updated_at'] = date('Y-m-d H:i:s');
            $this->db->update('users', $updateData, 'id = ?', [$id]);
            $this->logApiActivity('update_user', 'users', $id);
        }
        
        $user = $this->db->fetch(
            "SELECT id, username, full_name, phone, email, role, is_active, created_at FROM users WHERE id = ?",
            [$id]
        );
        $this->success($user, 'تم تحديث بيانات المستخدم بنجاح');
    }
    
    /**
     * حذف مستخدم
     */
    public function deleteUser(int $id): void
    {
        $user = $this->db->fetch("SELECT * FROM users WHERE id = ?", [$id]);
        if (!$user) {
            $this->notFound('المستخدم غير موجود');
        }
        
        // لا يمكن حذف المستخدم الوحيد
        $count = $this->db->fetchColumn("SELECT COUNT(*) FROM users WHERE is_active = 1");
        if ($count <= 1) {
            $this->error('لا يمكن حذف المستخدم الوحيد في النظام', 400);
        }
        
        $this->db->delete('users', 'id = ?', [$id]);
        $this->logApiActivity('delete_user', 'users', $id);
        
        $this->success(null, 'تم حذف المستخدم بنجاح');
    }
    
    // ══════════════════════════════════════════════════════════════════
    // الفواتير
    // ══════════════════════════════════════════════════════════════════
    
    /**
     * قائمة الفواتير
     */
    public function invoices(): void
    {
        $pagination = $this->getPagination();
        $type = $_GET['type'] ?? '';
        $status = $_GET['status'] ?? '';
        $customerId = $_GET['customer_id'] ?? '';
        
        $where = "WHERE 1=1";
        $params = [];
        
        if ($type) {
            $where .= " AND i.invoice_type = ?";
            $params[] = $type;
        }
        
        if ($status) {
            $where .= " AND i.status = ?";
            $params[] = $status;
        }
        
        if ($customerId) {
            $where .= " AND i.customer_id = ?";
            $params[] = $customerId;
        }
        
        $total = (int) $this->db->fetchColumn(
            "SELECT COUNT(*) FROM invoices i {$where}",
            $params
        );
        
        $invoices = $this->db->fetchAll(
            "SELECT i.*, c.full_name as customer_name, c.phone as customer_phone,
                    u.full_name as user_name
             FROM invoices i 
             LEFT JOIN customers c ON i.customer_id = c.id
             LEFT JOIN users u ON i.user_id = u.id
             {$where}
             ORDER BY i.id DESC
             LIMIT {$pagination['per_page']} OFFSET {$pagination['offset']}",
            $params
        );
        
        $this->paginated($invoices, $total, $pagination['page'], $pagination['per_page']);
    }
    
    /**
     * عرض فاتورة
     */
    public function invoice(int $id): void
    {
        $invoice = $this->db->fetch(
            "SELECT i.*, c.full_name as customer_name, c.phone as customer_phone,
                    u.full_name as user_name
             FROM invoices i 
             LEFT JOIN customers c ON i.customer_id = c.id
             LEFT JOIN users u ON i.user_id = u.id
             WHERE i.id = ?",
            [$id]
        );
        
        if (!$invoice) {
            $this->notFound('الفاتورة غير موجودة');
        }
        
        // جلب بنود الفاتورة
        $invoice['items'] = $this->db->fetchAll(
            "SELECT * FROM invoice_items WHERE invoice_id = ?",
            [$id]
        );
        
        // جلب الأقساط إذا كانت تقسيط
        if ($invoice['invoice_type'] === 'installment') {
            $invoice['installments'] = $this->db->fetchAll(
                "SELECT * FROM installments WHERE invoice_id = ? ORDER BY installment_number",
                [$id]
            );
        }
        
        // جلب المدفوعات
        $invoice['payments'] = $this->db->fetchAll(
            "SELECT * FROM payments WHERE invoice_id = ? ORDER BY payment_date DESC",
            [$id]
        );
        
        $this->success($invoice);
    }
    
    // ══════════════════════════════════════════════════════════════════
    // الأقساط
    // ══════════════════════════════════════════════════════════════════
    
    /**
     * قائمة الأقساط
     */
    public function installments(): void
    {
        $pagination = $this->getPagination();
        $status = $_GET['status'] ?? '';
        $customerId = $_GET['customer_id'] ?? '';
        
        $where = "WHERE 1=1";
        $params = [];
        
        if ($status) {
            $where .= " AND inst.status = ?";
            $params[] = $status;
        }
        
        if ($customerId) {
            $where .= " AND i.customer_id = ?";
            $params[] = $customerId;
        }
        
        $total = (int) $this->db->fetchColumn(
            "SELECT COUNT(*) FROM installments inst
             JOIN invoices i ON inst.invoice_id = i.id
             {$where}",
            $params
        );
        
        $installments = $this->db->fetchAll(
            "SELECT inst.*, i.invoice_number, i.customer_id,
                    c.full_name as customer_name, c.phone as customer_phone
             FROM installments inst
             JOIN invoices i ON inst.invoice_id = i.id
             LEFT JOIN customers c ON i.customer_id = c.id
             {$where}
             ORDER BY inst.due_date
             LIMIT {$pagination['per_page']} OFFSET {$pagination['offset']}",
            $params
        );
        
        $this->paginated($installments, $total, $pagination['page'], $pagination['per_page']);
    }
    
    /**
     * أقساط اليوم
     */
    public function installmentsToday(): void
    {
        $today = date('Y-m-d');
        
        $installments = $this->db->fetchAll(
            "SELECT inst.*, i.invoice_number, 
                    c.full_name as customer_name, c.phone as customer_phone
             FROM installments inst
             JOIN invoices i ON inst.invoice_id = i.id
             JOIN customers c ON i.customer_id = c.id
             WHERE inst.due_date = ? AND inst.status IN ('pending', 'partial')
             ORDER BY c.full_name",
            [$today]
        );
        
        $this->success($installments);
    }
    
    /**
     * الأقساط المتأخرة
     */
    public function installmentsOverdue(): void
    {
        $today = date('Y-m-d');
        
        $installments = $this->db->fetchAll(
            "SELECT inst.*, i.invoice_number, 
                    c.full_name as customer_name, c.phone as customer_phone,
                    JULIANDAY(?) - JULIANDAY(inst.due_date) as days_overdue
             FROM installments inst
             JOIN invoices i ON inst.invoice_id = i.id
             JOIN customers c ON i.customer_id = c.id
             WHERE inst.due_date < ? AND inst.status IN ('pending', 'partial', 'overdue')
             ORDER BY inst.due_date",
            [$today, $today]
        );
        
        $this->success($installments);
    }
    
    /**
     * دفع قسط
     */
    public function payInstallment(int $id): void
    {
        $installment = $this->db->fetch("SELECT * FROM installments WHERE id = ?", [$id]);
        if (!$installment) {
            $this->notFound('القسط غير موجود');
        }
        
        $data = $this->getJsonInput();
        $amount = (float) ($data['amount'] ?? 0);
        $method = $data['method'] ?? 'cash';
        
        if ($amount <= 0) {
            $this->validationError(['amount' => 'المبلغ يجب أن يكون أكبر من صفر']);
        }
        
        // إنشاء رقم إيصال
        $receiptNumber = 'RCP-' . date('Ymd') . '-' . str_pad(mt_rand(1, 9999), 4, '0', STR_PAD_LEFT);
        
        // تسجيل الدفعة
        $paymentId = $this->db->insert('payments', [
            'invoice_id' => $installment['invoice_id'],
            'installment_id' => $id,
            'amount' => $amount,
            'payment_method' => $method,
            'receipt_number' => $receiptNumber,
            'payment_date' => date('Y-m-d H:i:s'),
            'user_id' => $this->apiKey['created_by'] ?? 1,
            'notes' => $data['notes'] ?? null,
        ]);
        
        // تحديث القسط
        $paidAmount = $installment['paid_amount'] + $amount;
        $remainingAmount = $installment['amount'] - $paidAmount;
        $status = $paidAmount >= $installment['amount'] ? 'paid' : 'partial';
        
        $this->db->update('installments', [
            'paid_amount' => $paidAmount,
            'remaining_amount' => max(0, $remainingAmount),
            'status' => $status,
            'paid_date' => $status === 'paid' ? date('Y-m-d') : null,
            'updated_at' => date('Y-m-d H:i:s'),
        ], 'id = ?', [$id]);
        
        // تحديث الفاتورة
        $this->db->query(
            "UPDATE invoices SET 
             paid_amount = paid_amount + ?,
             remaining_amount = remaining_amount - ?,
             updated_at = ?
             WHERE id = ?",
            [$amount, $amount, date('Y-m-d H:i:s'), $installment['invoice_id']]
        );
        
        $this->logApiActivity('pay_installment', 'installments', $id);
        
        $this->success([
            'payment_id' => $paymentId,
            'receipt_number' => $receiptNumber,
            'status' => $status,
        ], 'تم تسجيل الدفعة بنجاح');
    }
    
    // ══════════════════════════════════════════════════════════════════
    // المدفوعات
    // ══════════════════════════════════════════════════════════════════
    
    /**
     * قائمة المدفوعات
     */
    public function payments(): void
    {
        $pagination = $this->getPagination();
        $invoiceId = $_GET['invoice_id'] ?? '';
        $customerId = $_GET['customer_id'] ?? '';
        
        $where = "WHERE 1=1";
        $params = [];
        
        if ($invoiceId) {
            $where .= " AND p.invoice_id = ?";
            $params[] = $invoiceId;
        }
        
        if ($customerId) {
            $where .= " AND i.customer_id = ?";
            $params[] = $customerId;
        }
        
        $total = (int) $this->db->fetchColumn(
            "SELECT COUNT(*) FROM payments p
             JOIN invoices i ON p.invoice_id = i.id
             {$where}",
            $params
        );
        
        $payments = $this->db->fetchAll(
            "SELECT p.*, i.invoice_number, c.full_name as customer_name
             FROM payments p
             JOIN invoices i ON p.invoice_id = i.id
             LEFT JOIN customers c ON i.customer_id = c.id
             {$where}
             ORDER BY p.payment_date DESC
             LIMIT {$pagination['per_page']} OFFSET {$pagination['offset']}",
            $params
        );
        
        $this->paginated($payments, $total, $pagination['page'], $pagination['per_page']);
    }
    
    /**
     * عرض مدفوعة
     */
    public function payment(int $id): void
    {
        $payment = $this->db->fetch(
            "SELECT p.*, i.invoice_number, c.full_name as customer_name
             FROM payments p
             JOIN invoices i ON p.invoice_id = i.id
             LEFT JOIN customers c ON i.customer_id = c.id
             WHERE p.id = ?",
            [$id]
        );
        
        if (!$payment) {
            $this->notFound('المدفوعة غير موجودة');
        }
        
        $this->success($payment);
    }
    
    // ══════════════════════════════════════════════════════════════════
    // لوحة التحكم
    // ══════════════════════════════════════════════════════════════════
    
    /**
     * إحصائيات لوحة التحكم
     */
    public function dashboardStats(): void
    {
        $today = date('Y-m-d');
        $monthStart = date('Y-m-01');
        
        $stats = [
            // إحصائيات عامة
            'total_customers' => (int) $this->db->fetchColumn("SELECT COUNT(*) FROM customers WHERE is_active = 1"),
            'total_products' => (int) $this->db->fetchColumn("SELECT COUNT(*) FROM products WHERE is_active = 1"),
            'total_invoices' => (int) $this->db->fetchColumn("SELECT COUNT(*) FROM invoices"),
            
            // المبيعات
            'total_sales' => (float) $this->db->fetchColumn("SELECT COALESCE(SUM(total_amount), 0) FROM invoices WHERE status != 'cancelled'"),
            'month_sales' => (float) $this->db->fetchColumn(
                "SELECT COALESCE(SUM(total_amount), 0) FROM invoices WHERE status != 'cancelled' AND DATE(created_at) >= ?",
                [$monthStart]
            ),
            'today_sales' => (float) $this->db->fetchColumn(
                "SELECT COALESCE(SUM(total_amount), 0) FROM invoices WHERE status != 'cancelled' AND DATE(created_at) = ?",
                [$today]
            ),
            
            // التحصيلات
            'total_collected' => (float) $this->db->fetchColumn("SELECT COALESCE(SUM(amount), 0) FROM payments"),
            'month_collected' => (float) $this->db->fetchColumn(
                "SELECT COALESCE(SUM(amount), 0) FROM payments WHERE DATE(payment_date) >= ?",
                [$monthStart]
            ),
            'today_collected' => (float) $this->db->fetchColumn(
                "SELECT COALESCE(SUM(amount), 0) FROM payments WHERE DATE(payment_date) = ?",
                [$today]
            ),
            
            // الأقساط
            'total_remaining' => (float) $this->db->fetchColumn(
                "SELECT COALESCE(SUM(remaining_amount), 0) FROM invoices WHERE status = 'active'"
            ),
            'overdue_installments' => (int) $this->db->fetchColumn(
                "SELECT COUNT(*) FROM installments WHERE status IN ('pending', 'partial', 'overdue') AND due_date < ?",
                [$today]
            ),
            'today_installments' => (int) $this->db->fetchColumn(
                "SELECT COUNT(*) FROM installments WHERE status IN ('pending', 'partial') AND due_date = ?",
                [$today]
            ),
            
            // المخزون
            'low_stock_products' => (int) $this->db->fetchColumn(
                "SELECT COUNT(*) FROM products WHERE quantity <= min_quantity AND is_active = 1"
            ),
        ];
        
        $this->success($stats);
    }
    
    // ══════════════════════════════════════════════════════════════════
    // المصادقة
    // ══════════════════════════════════════════════════════════════════
    
    /**
     * تسجيل الدخول (بدون API Key)
     */
    public function login(): void
    {
        // هذه الدالة لا تحتاج API Key
    }
}


============================================================
FILE: app/Controllers/AdvancedReportController.php
============================================================
<?php
/**
 * تقارير متقدمة - أرباح وتحليلات
 */

namespace App\Controllers;

use Core\Controller;

class AdvancedReportController extends Controller
{
    public function __construct()
    {
        parent::__construct();
        $this->db = \Core\Database::getInstance();
    }

    /**
     * تقرير الأرباح
     */
    public function profits(): void
    {
        $from = $_GET['from'] ?? date('Y-m-01');
        $to = $_GET['to'] ?? date('Y-m-d');
        $page = (int) ($_GET['page'] ?? 1);
        $perPage = (int) ($_GET['per_page'] ?? 15);

        // حساب الإجماليات أولاً (لكل المنتجات)
        $totals = $this->db->fetch(
            "SELECT 
                SUM(ii.total_price) as total_revenue,
                SUM(ii.quantity * p.cost_price) as total_cost,
                SUM(ii.total_price) - SUM(ii.quantity * p.cost_price) as total_profit
             FROM invoice_items ii
             JOIN products p ON ii.product_id = p.id
             JOIN invoices i ON ii.invoice_id = i.id
             WHERE DATE(i.created_at) >= ? AND DATE(i.created_at) <= ?",
            [$from, $to]
        );

        // عدد المنتجات المميزة
        $totalCount = $this->db->fetchColumn(
            "SELECT COUNT(DISTINCT p.id)
             FROM invoice_items ii
             JOIN products p ON ii.product_id = p.id
             JOIN invoices i ON ii.invoice_id = i.id
             WHERE DATE(i.created_at) >= ? AND DATE(i.created_at) <= ?",
            [$from, $to]
        );

        $pagination = new \Core\Pagination($totalCount, $perPage, $page);

        // أرباح المنتجات المباعة (مع pagination)
        $profits = $this->db->fetchAll(
            "SELECT p.id, p.name, p.cost_price,
                    SUM(ii.quantity) as total_quantity,
                    SUM(ii.total_price) as total_revenue,
                    SUM(ii.quantity * p.cost_price) as total_cost,
                    SUM(ii.total_price) - SUM(ii.quantity * p.cost_price) as total_profit
             FROM invoice_items ii
             JOIN products p ON ii.product_id = p.id
             JOIN invoices i ON ii.invoice_id = i.id
             WHERE DATE(i.created_at) >= ? AND DATE(i.created_at) <= ?
             GROUP BY p.id
             ORDER BY total_profit DESC
             LIMIT {$pagination->getLimit()} OFFSET {$pagination->getOffset()}",
            [$from, $to]
        );

        $this->view('reports/profits', [
            'title' => 'تقرير الأرباح',
            'profits' => $profits,
            'from' => $from,
            'to' => $to,
            'totalRevenue' => $totals['total_revenue'] ?? 0,
            'totalCost' => $totals['total_cost'] ?? 0,
            'totalProfit' => $totals['total_profit'] ?? 0,
            'pagination' => $pagination
        ]);
    }

    /**
     * تقرير أداء الموظفين
     */
    public function employees(): void
    {
        $from = $_GET['from'] ?? date('Y-m-01');
        $to = $_GET['to'] ?? date('Y-m-d');

        $performance = $this->db->fetchAll(
            "SELECT u.full_name,
                    COUNT(i.id) as invoices_count,
                    SUM(i.total_amount) as total_sales,
                    COUNT(CASE WHEN i.invoice_type = 'cash' THEN 1 END) as cash_sales,
                    COUNT(CASE WHEN i.invoice_type = 'installment' THEN 1 END) as installment_sales
             FROM invoices i
             JOIN users u ON i.user_id = u.id
             WHERE DATE(i.created_at) >= ? AND DATE(i.created_at) <= ?
             GROUP BY u.id
             ORDER BY total_sales DESC",
            [$from, $to]
        );

        $this->view('reports/employees', [
            'title' => 'تقرير أداء الموظفين',
            'performance' => $performance,
            'from' => $from,
            'to' => $to
        ]);
    }

    /**
     * تقرير التدفق النقدي
     */
    public function cashflow(): void
    {
        $from = $_GET['from'] ?? date('Y-m-01');
        $to = $_GET['to'] ?? date('Y-m-d');
        $page = (int) ($_GET['page'] ?? 1);
        $perPage = (int) ($_GET['per_page'] ?? 15);

        // المدخلات الكلية (للرسم البياني)
        $allInflows = $this->db->fetchAll(
            "SELECT DATE(payment_date) as date, SUM(amount) as total
             FROM payments
             WHERE DATE(payment_date) >= ? AND DATE(payment_date) <= ?
             GROUP BY DATE(payment_date)
             ORDER BY date",
            [$from, $to]
        );

        // عدد الأيام
        $totalCount = count($allInflows);
        $pagination = new \Core\Pagination($totalCount, $perPage, $page);

        // المدخلات (المدفوعات) مع pagination
        $inflows = $this->db->fetchAll(
            "SELECT DATE(payment_date) as date, SUM(amount) as total
             FROM payments
             WHERE DATE(payment_date) >= ? AND DATE(payment_date) <= ?
             GROUP BY DATE(payment_date)
             ORDER BY date DESC
             LIMIT {$pagination->getLimit()} OFFSET {$pagination->getOffset()}",
            [$from, $to]
        );

        // ملخص الفواتير
        $summary = $this->db->fetch(
            "SELECT 
                SUM(CASE WHEN invoice_type = 'cash' THEN total_amount ELSE 0 END) as cash_sales,
                SUM(CASE WHEN invoice_type = 'installment' THEN down_payment ELSE 0 END) as down_payments
             FROM invoices
             WHERE DATE(created_at) >= ? AND DATE(created_at) <= ? AND status != 'cancelled'",
            [$from, $to]
        );

        // تحصيلات الأقساط فقط (بدون الدفعات المقدمة التي تُسجل عند إنشاء الفاتورة)
        $installmentPayments = $this->db->fetchColumn(
            "SELECT COALESCE(SUM(p.amount), 0) FROM payments p
             JOIN installments inst ON p.installment_id = inst.id
             WHERE DATE(p.payment_date) >= ? AND DATE(p.payment_date) <= ?",
            [$from, $to]
        );

        // إجمالي النقد المحصّل فعلياً = مبيعات نقدية + دفعات مقدمة + تحصيلات أقساط
        $cashSales = $summary['cash_sales'] ?? 0;
        $downPayments = $summary['down_payments'] ?? 0;
        $totalCash = $cashSales + $downPayments + $installmentPayments;

        $this->view('reports/cashflow', [
            'title' => 'تقرير التدفق النقدي',
            'inflows' => $inflows,
            'allInflows' => $allInflows,
            'summary' => $summary,
            'totalPayments' => $installmentPayments ?: 0,
            'totalCash' => $totalCash,
            'from' => $from,
            'to' => $to,
            'pagination' => $pagination
        ]);
    }

    /**
     * المبيعات حسب الفترة (للرسم البياني)
     */
    public function salesChart(): void
    {
        $period = $_GET['period'] ?? 'daily';
        $days = $_GET['days'] ?? 30;

        $format = $period === 'monthly' ? '%Y-%m' : '%Y-%m-%d';
        
        $data = $this->db->fetchAll(
            "SELECT strftime(?, created_at) as period,
                    SUM(CASE WHEN invoice_type = 'cash' THEN total_amount ELSE 0 END) as cash,
                    SUM(CASE WHEN invoice_type = 'installment' THEN total_amount ELSE 0 END) as installment
             FROM invoices
             WHERE created_at >= date('now', ?)
             GROUP BY strftime(?, created_at)
             ORDER BY period",
            [$format, "-{$days} days", $format]
        );

        header('Content-Type: application/json');
        echo json_encode($data, JSON_UNESCAPED_UNICODE);
    }

    /**
     * تصدير PDF
     */
    public function exportPdf(): void
    {
        $report = $_GET['report'] ?? 'sales';
        // سيتم إضافة مكتبة PDF لاحقاً
        $_SESSION['flash']['info'] = 'سيتم إضافة تصدير PDF قريباً';
        header('Location: ' . url('/reports'));
        exit;
    }
}


============================================================
FILE: app/Controllers/ApiController.php
============================================================
<?php

namespace App\Controllers;

use Core\Controller;

class ApiController extends Controller
{
    public function __construct()
    {
        $this->db = \Core\Database::getInstance();
        header('Content-Type: application/json; charset=utf-8');
    }

    /**
     * قائمة المنتجات
     */
    public function products(): void
    {
        $search = $_GET['q'] ?? '';
        $category = $_GET['category'] ?? '';
        
        $sql = "SELECT p.*, c.name as category_name FROM products p 
                LEFT JOIN categories c ON p.category_id = c.id 
                WHERE p.is_active = 1";
        $params = [];
        
        if ($search) {
            $sql .= " AND (p.name LIKE ? OR p.barcode LIKE ?)";
            $params[] = "%{$search}%";
            $params[] = "%{$search}%";
        }
        
        if ($category) {
            $sql .= " AND p.category_id = ?";
            $params[] = $category;
        }
        
        $sql .= " ORDER BY p.name LIMIT 50";
        
        $products = $this->db->fetchAll($sql, $params);
        echo json_encode(['success' => true, 'data' => $products], JSON_UNESCAPED_UNICODE);
    }

    /**
     * منتج واحد
     */
    public function product(int $id): void
    {
        $product = $this->db->fetch(
            "SELECT p.*, c.name as category_name FROM products p 
             LEFT JOIN categories c ON p.category_id = c.id 
             WHERE p.id = ?", [$id]
        );
        
        if ($product) {
            echo json_encode(['success' => true, 'data' => $product], JSON_UNESCAPED_UNICODE);
        } else {
            http_response_code(404);
            echo json_encode(['success' => false, 'error' => 'المنتج غير موجود'], JSON_UNESCAPED_UNICODE);
        }
    }

    /**
     * قائمة العملاء
     */
    public function customers(): void
    {
        $search = $_GET['q'] ?? '';
        
        $sql = "SELECT * FROM customers WHERE 1=1";
        $params = [];
        
        if ($search) {
            $sql .= " AND (full_name LIKE ? OR phone LIKE ? OR national_id LIKE ?)";
            $params[] = "%{$search}%";
            $params[] = "%{$search}%";
            $params[] = "%{$search}%";
        }
        
        $sql .= " ORDER BY full_name LIMIT 50";
        
        $customers = $this->db->fetchAll($sql, $params);
        echo json_encode(['success' => true, 'data' => $customers], JSON_UNESCAPED_UNICODE);
    }

    /**
     * عميل واحد
     */
    public function customer(int $id): void
    {
        $customer = $this->db->fetch("SELECT * FROM customers WHERE id = ?", [$id]);
        
        if ($customer) {
            echo json_encode(['success' => true, 'data' => $customer], JSON_UNESCAPED_UNICODE);
        } else {
            http_response_code(404);
            echo json_encode(['success' => false, 'error' => 'العميل غير موجود'], JSON_UNESCAPED_UNICODE);
        }
    }

    /**
     * قائمة الفواتير
     */
    public function invoices(): void
    {
        $invoices = $this->db->fetchAll(
            "SELECT i.*, c.full_name as customer_name 
             FROM invoices i 
             LEFT JOIN customers c ON i.customer_id = c.id 
             ORDER BY i.created_at DESC LIMIT 100"
        );
        echo json_encode(['success' => true, 'data' => $invoices], JSON_UNESCAPED_UNICODE);
    }

    /**
     * قائمة الأقساط
     */
    public function installments(): void
    {
        $installments = $this->db->fetchAll(
            "SELECT inst.*, i.invoice_number, c.full_name as customer_name 
             FROM installments inst
             JOIN invoices i ON inst.invoice_id = i.id
             LEFT JOIN customers c ON i.customer_id = c.id
             WHERE inst.status IN ('pending', 'partial')
             ORDER BY inst.due_date LIMIT 100"
        );
        echo json_encode(['success' => true, 'data' => $installments], JSON_UNESCAPED_UNICODE);
    }

    /**
     * الأقساط المستحقة
     */
    public function dueInstallments(): void
    {
        $date = $_GET['date'] ?? date('Y-m-d');
        
        $installments = $this->db->fetchAll(
            "SELECT inst.*, i.invoice_number, c.full_name as customer_name, c.phone as customer_phone
             FROM installments inst
             JOIN invoices i ON inst.invoice_id = i.id
             JOIN customers c ON i.customer_id = c.id
             WHERE inst.status IN ('pending', 'partial') AND inst.due_date <= ?
             ORDER BY inst.due_date",
            [$date]
        );
        echo json_encode(['success' => true, 'data' => $installments], JSON_UNESCAPED_UNICODE);
    }

    /**
     * تسجيل الدخول API
     */
    public function login(): void
    {
        $username = $_POST['username'] ?? '';
        $password = $_POST['password'] ?? '';
        
        $user = $this->db->fetch(
            "SELECT * FROM users WHERE username = ? AND is_active = 1",
            [$username]
        );
        
        if ($user && password_verify($password, $user['password_hash'])) {
            unset($user['password_hash']);
            echo json_encode(['success' => true, 'data' => $user], JSON_UNESCAPED_UNICODE);
        } else {
            http_response_code(401);
            echo json_encode(['success' => false, 'error' => 'بيانات الدخول غير صحيحة'], JSON_UNESCAPED_UNICODE);
        }
    }

    /**
     * تسجيل دفعة
     */
    public function storePayment(): void
    {
        $installmentId = $_POST['installment_id'] ?? 0;
        $amount = $_POST['amount'] ?? 0;
        $method = $_POST['method'] ?? 'cash';
        
        if (!$installmentId || !$amount) {
            http_response_code(400);
            echo json_encode(['success' => false, 'error' => 'بيانات ناقصة'], JSON_UNESCAPED_UNICODE);
            return;
        }
        
        $installment = $this->db->fetch("SELECT * FROM installments WHERE id = ?", [$installmentId]);
        
        if (!$installment) {
            http_response_code(404);
            echo json_encode(['success' => false, 'error' => 'القسط غير موجود'], JSON_UNESCAPED_UNICODE);
            return;
        }
        
        // تسجيل الدفعة
        $receiptNumber = 'RCP-' . date('Ymd') . '-' . str_pad(mt_rand(1, 9999), 4, '0', STR_PAD_LEFT);
        
        $this->db->insert('payments', [
            'invoice_id' => $installment['invoice_id'],
            'installment_id' => $installmentId,
            'amount' => $amount,
            'payment_method' => $method,
            'receipt_number' => $receiptNumber,
            'payment_date' => date('Y-m-d H:i:s'),
            'created_by' => $_SESSION['user_id'] ?? 1
        ]);
        
        // تحديث القسط
        $paidAmount = $installment['paid_amount'] + $amount;
        $status = $paidAmount >= $installment['amount'] ? 'paid' : 'partial';
        
        $this->db->update('installments', [
            'paid_amount' => $paidAmount,
            'status' => $status
        ], 'id = ?', [$installmentId]);
        
        echo json_encode([
            'success' => true,
            'message' => 'تم تسجيل الدفعة بنجاح',
            'receipt_number' => $receiptNumber
        ], JSON_UNESCAPED_UNICODE);
    }
}


============================================================
FILE: app/Controllers/ApiKeyController.php
============================================================
<?php
namespace App\Controllers;

use Core\Controller;
use Core\ApiMiddleware;

/**
 * ╔══════════════════════════════════════════════════════════════════╗
 * ║                    نظام تقسيط - إدارة API Keys                    ║
 * ╚══════════════════════════════════════════════════════════════════╝
 */
class ApiKeyController extends Controller
{
    public function __construct()
    {
        parent::__construct();
        $this->requireAuth();
        $this->requireRole(['admin']);
    }
    
    /**
     * صفحة إدارة API Keys
     */
    public function index(): void
    {
        $apiKeys = $this->db->fetchAll(
            "SELECT ak.*, u.full_name as created_by_name 
             FROM api_keys ak 
             LEFT JOIN users u ON ak.created_by = u.id 
             ORDER BY ak.created_at DESC"
        );
        
        $this->view('settings/api', [
            'pageTitle' => 'إدارة API Keys',
            'apiKeys' => $apiKeys
        ]);
    }
    
    /**
     * إنشاء مفتاح جديد
     */
    public function generate(): void
    {
        $name = $this->input('name', 'مفتاح API');
        $expiresAt = $this->input('expires_at');
        
        $apiKey = ApiMiddleware::generateApiKey();
        
        $id = $this->db->insert('api_keys', [
            'name' => $name,
            'api_key' => $apiKey,
            'permissions' => null,
            'is_active' => 1,
            'expires_at' => $expiresAt ?: null,
            'created_by' => $_SESSION['user_id'],
        ]);
        
        $this->logActivity('create', 'api_keys', $id, 'إنشاء مفتاح API جديد');
        
        // إرجاع JSON للـ AJAX
        if ($this->isAjax()) {
            $this->json([
                'success' => true,
                'api_key' => $apiKey,
                'message' => 'تم إنشاء المفتاح بنجاح. احفظه في مكان آمن!'
            ]);
        }
        
        $this->success('تم إنشاء مفتاح API بنجاح');
        $this->redirect(url('/settings/api'));
    }
    
    /**
     * تفعيل/إيقاف مفتاح
     */
    public function toggle(int $id): void
    {
        $key = $this->db->fetch("SELECT * FROM api_keys WHERE id = ?", [$id]);
        
        if (!$key) {
            if ($this->isAjax()) {
                $this->json(['success' => false, 'message' => 'المفتاح غير موجود'], 404);
            }
            $this->error('المفتاح غير موجود');
            $this->redirect(url('/settings/api'));
            return;
        }
        
        $newStatus = $key['is_active'] ? 0 : 1;
        
        $this->db->update('api_keys', [
            'is_active' => $newStatus,
            'updated_at' => date('Y-m-d H:i:s')
        ], 'id = ?', [$id]);
        
        $this->logActivity('update', 'api_keys', $id, $newStatus ? 'تفعيل مفتاح API' : 'إيقاف مفتاح API');
        
        if ($this->isAjax()) {
            $this->json([
                'success' => true,
                'is_active' => $newStatus,
                'message' => $newStatus ? 'تم تفعيل المفتاح' : 'تم إيقاف المفتاح'
            ]);
            return;
        }
        
        $this->success($newStatus ? 'تم تفعيل المفتاح' : 'تم إيقاف المفتاح');
        $this->redirect(url('/settings/api'));
    }
    
    /**
     * حذف مفتاح
     */
    public function delete(int $id): void
    {
        $key = $this->db->fetch("SELECT * FROM api_keys WHERE id = ?", [$id]);
        
        if (!$key) {
            if ($this->isAjax()) {
                $this->json(['success' => false, 'message' => 'المفتاح غير موجود'], 404);
            }
            $this->error('المفتاح غير موجود');
            $this->redirect(url('/settings/api'));
            return;
        }
        
        $this->db->delete('api_keys', 'id = ?', [$id]);
        $this->logActivity('delete', 'api_keys', $id, 'حذف مفتاح API');
        
        if ($this->isAjax()) {
            $this->json(['success' => true, 'message' => 'تم حذف المفتاح بنجاح']);
            return;
        }
        
        $this->success('تم حذف المفتاح بنجاح');
        $this->redirect(url('/settings/api'));
    }
    
    /**
     * تحديث بيانات المفتاح
     */
    public function update(int $id): void
    {
        $key = $this->db->fetch("SELECT * FROM api_keys WHERE id = ?", [$id]);
        
        if (!$key) {
            if ($this->isAjax()) {
                $this->json(['success' => false, 'message' => 'المفتاح غير موجود'], 404);
            }
            $this->error('المفتاح غير موجود');
            $this->redirect(url('/settings/api'));
            return;
        }
        
        $name = $this->input('name');
        $expiresAt = $this->input('expires_at');
        
        if (empty($name)) {
            if ($this->isAjax()) {
                $this->json(['success' => false, 'message' => 'اسم المفتاح مطلوب'], 400);
            }
            $this->error('اسم المفتاح مطلوب');
            $this->redirect(url('/settings/api'));
            return;
        }
        
        $this->db->update('api_keys', [
            'name' => $name,
            'expires_at' => $expiresAt ?: null,
            'updated_at' => date('Y-m-d H:i:s')
        ], 'id = ?', [$id]);
        
        $this->logActivity('update', 'api_keys', $id, 'تحديث مفتاح API: ' . $name);
        
        if ($this->isAjax()) {
            $updatedKey = $this->db->fetch("SELECT * FROM api_keys WHERE id = ?", [$id]);
            $this->json([
                'success' => true, 
                'message' => 'تم تحديث المفتاح بنجاح',
                'key' => $updatedKey
            ]);
            return;
        }
        
        $this->success('تم تحديث المفتاح بنجاح');
        $this->redirect(url('/settings/api'));
    }
}


============================================================
FILE: app/Controllers/AuthController.php
============================================================
<?php
namespace App\Controllers;

use Core\Controller;
use App\Models\User;

/**
 * ╔══════════════════════════════════════════════════════════════════╗
 * ║                    نظام تقسيط - متحكم المصادقة                    ║
 * ╚══════════════════════════════════════════════════════════════════╝
 */
class AuthController extends Controller
{
    private User $userModel;
    
    public function __construct()
    {
        parent::__construct();
        $this->userModel = new User();
    }
    
    /**
     * عرض صفحة تسجيل الدخول
     */
    public function showLogin(): void
    {
        // إذا كان مسجل الدخول، توجيهه للوحة التحكم
        if (isset($_SESSION['user_id'])) {
            $this->redirect(url('/dashboard'));
        }
        
        $this->viewOnly('auth/login', [
            'pageTitle' => 'تسجيل الدخول'
        ]);
    }
    
    /**
     * معالجة تسجيل الدخول
     */
    public function login(): void
    {
        $username = $this->input('username');
        $password = $this->input('password');
        
        // التحقق من البيانات
        if (empty($username) || empty($password)) {
            $this->error('يرجى إدخال اسم المستخدم وكلمة المرور');
            $this->redirect(url('/login'));
            return;
        }
        
        // البحث عن المستخدم
        $user = $this->userModel->findByUsername($username);
        
        if (!$user) {
            $this->error('اسم المستخدم غير صحيح');
            $this->redirect(url('/login'));
            return;
        }
        
        // التحقق من كلمة المرور
        if (!$this->userModel->verifyPassword($password, $user['password_hash'])) {
            $this->error('كلمة المرور غير صحيحة');
            $this->redirect(url('/login'));
            return;
        }
        
        // التحقق من أن الحساب نشط
        if (!$user['is_active']) {
            $this->error('هذا الحساب معطل، يرجى التواصل مع المدير');
            $this->redirect(url('/login'));
            return;
        }
        
        // تسجيل الدخول
        $_SESSION['user_id'] = $user['id'];
        $_SESSION['user_name'] = $user['full_name'];
        $_SESSION['user_role'] = $user['role'];
        
        // تحديث آخر دخول
        $this->userModel->updateLastLogin($user['id']);
        
        // تسجيل النشاط
        $this->logActivity('login', 'user', $user['id'], 'تسجيل دخول');
        
        $this->success('مرحباً بك ' . $user['full_name']);
        $this->redirect(url('/dashboard'));
    }
    
    /**
     * تسجيل الخروج
     */
    public function logout(): void
    {
        if (isset($_SESSION['user_id'])) {
            $this->logActivity('logout', 'user', $_SESSION['user_id'], 'تسجيل خروج');
        }
        
        // مسح جميع بيانات الجلسة
        $_SESSION = [];
        
        // حذف كوكي الجلسة من المتصفح
        if (ini_get("session.use_cookies")) {
            $params = session_get_cookie_params();
            setcookie(session_name(), '', time() - 42000,
                $params["path"], $params["domain"],
                $params["secure"], $params["httponly"]
            );
        }
        
        // تدمير الجلسة
        session_destroy();
        
        $this->redirect(url('/login'));
    }
}


============================================================
FILE: app/Controllers/BackupController.php
============================================================
<?php
/**
 * نظام النسخ الاحتياطي
 */

namespace App\Controllers;

use Core\Controller;

class BackupController extends Controller
{
    private string $backupDir;

    public function __construct()
    {
        parent::__construct();
        $this->backupDir = dirname(dirname(__DIR__)) . '/storage/backups';
        
        if (!is_dir($this->backupDir)) {
            mkdir($this->backupDir, 0755, true);
        }
    }

    /**
     * صفحة النسخ الاحتياطي
     */
    public function index(): void
    {
        $backups = $this->getBackupsList();
        
        $this->view('settings/backup', [
            'title' => 'النسخ الاحتياطي',
            'backups' => $backups
        ]);
    }

    /**
     * إنشاء نسخة احتياطية
     */
    public function create(): void
    {
        $dbPath = dirname(dirname(__DIR__)) . '/database/database.sqlite';
        
        if (!file_exists($dbPath)) {
            $_SESSION['flash']['error'] = 'قاعدة البيانات غير موجودة';
            header('Location: ' . url('/settings/backup'));
            exit;
        }

        $filename = 'backup_' . date('Y-m-d_H-i-s') . '.sqlite';
        $backupPath = $this->backupDir . '/' . $filename;

        if (copy($dbPath, $backupPath)) {
            $_SESSION['flash']['success'] = 'تم إنشاء النسخة الاحتياطية بنجاح';
        } else {
            $_SESSION['flash']['error'] = 'فشل في إنشاء النسخة الاحتياطية';
        }

        header('Location: ' . url('/settings/backup'));
        exit;
    }

    /**
     * تحميل نسخة احتياطية
     */
    public function download(string $filename): void
    {
        $filepath = $this->backupDir . '/' . basename($filename);

        if (!file_exists($filepath)) {
            $_SESSION['flash']['error'] = 'الملف غير موجود';
            header('Location: ' . url('/settings/backup'));
            exit;
        }

        header('Content-Type: application/octet-stream');
        header('Content-Disposition: attachment; filename="' . basename($filename) . '"');
        header('Content-Length: ' . filesize($filepath));
        readfile($filepath);
        exit;
    }

    /**
     * استعادة نسخة احتياطية
     */
    public function restore(): void
    {
        if (!isset($_FILES['backup']) || $_FILES['backup']['error'] !== UPLOAD_ERR_OK) {
            $_SESSION['flash']['error'] = 'يرجى اختيار ملف النسخة الاحتياطية';
            header('Location: ' . url('/settings/backup'));
            exit;
        }

        $uploadedFile = $_FILES['backup']['tmp_name'];
        $dbPath = dirname(dirname(__DIR__)) . '/database/database.sqlite';

        // إنشاء نسخة من الحالية قبل الاستعادة
        $safeBackup = $this->backupDir . '/pre_restore_' . date('Y-m-d_H-i-s') . '.sqlite';
        copy($dbPath, $safeBackup);

        // استعادة النسخة
        if (copy($uploadedFile, $dbPath)) {
            $_SESSION['flash']['success'] = 'تم استعادة النسخة الاحتياطية بنجاح';
        } else {
            $_SESSION['flash']['error'] = 'فشل في استعادة النسخة الاحتياطية';
        }

        header('Location: ' . url('/settings/backup'));
        exit;
    }

    /**
     * حذف نسخة احتياطية
     */
    public function delete(string $filename): void
    {
        $filepath = $this->backupDir . '/' . basename($filename);

        if (file_exists($filepath) && unlink($filepath)) {
            $_SESSION['flash']['success'] = 'تم حذف النسخة الاحتياطية';
        } else {
            $_SESSION['flash']['error'] = 'فشل في حذف النسخة';
        }

        header('Location: ' . url('/settings/backup'));
        exit;
    }

    /**
     * الحصول على قائمة النسخ الاحتياطية
     */
    private function getBackupsList(): array
    {
        $files = glob($this->backupDir . '/*.sqlite');
        $backups = [];

        foreach ($files as $file) {
            $backups[] = [
                'filename' => basename($file),
                'size' => filesize($file),
                'date' => filemtime($file)
            ];
        }

        // ترتيب تنازلي
        usort($backups, fn($a, $b) => $b['date'] - $a['date']);

        return $backups;
    }
}


============================================================
FILE: app/Controllers/CategoryController.php
============================================================
<?php
namespace App\Controllers;

use Core\Controller;
use App\Models\Category;

/**
 * متحكم التصنيفات
 */
class CategoryController extends Controller
{
    private Category $categoryModel;
    
    public function __construct()
    {
        parent::__construct();
        $this->requireAuth();
        $this->categoryModel = new Category();
    }
    
    public function index(): void
    {
        $page = (int) ($_GET['page'] ?? 1);
        $perPage = (int) ($_GET['per_page'] ?? 10);
        $search = $_GET['q'] ?? '';
        
        // بناء الاستعلام
        $where = "WHERE 1=1";
        $params = [];
        
        if ($search) {
            $where .= " AND (c.name LIKE ? OR c.description LIKE ?)";
            $params[] = "%{$search}%";
            $params[] = "%{$search}%";
        }
        
        // عدد التصنيفات الإجمالي
        $totalCount = $this->db->fetchColumn("SELECT COUNT(*) FROM categories c $where", $params);
        
        // إنشاء Pagination
        $pagination = new \Core\Pagination($totalCount, $perPage, $page);
        
        // جلب التصنيفات مع الـ Limit
        $sql = "SELECT c.*, COUNT(p.id) as products_count 
                FROM categories c 
                LEFT JOIN products p ON c.id = p.category_id 
                $where 
                GROUP BY c.id 
                ORDER BY c.id DESC 
                LIMIT {$pagination->getLimit()} OFFSET {$pagination->getOffset()}";
        
        $categories = $this->db->fetchAll($sql, $params);
        
        // جلب جميع التصنيفات للـ modal
        $allCategories = $this->categoryModel->getAllWithProductCount();
        
        $this->view('categories/index', [
            'pageTitle' => 'إدارة التصنيفات',
            'categories' => $categories,
            'allCategories' => $allCategories,
            'pagination' => $pagination,
            'search' => $search,
            'totalCount' => $totalCount
        ]);
    }
    
    public function store(): void
    {
        $this->requireRole(['admin']);
        
        $data = [
            'name' => $this->input('name'),
            'description' => $this->input('description'),
            'parent_id' => $this->input('parent_id') ?: null,
            'icon' => $this->input('icon'),
            'color' => $this->input('color') ?: '#1e88e5',
            'sort_order' => (int) $this->input('sort_order', 0),
            'is_active' => 1
        ];
        
        if (empty($data['name'])) {
            if ($this->isAjax()) {
                $this->json(['success' => false, 'message' => 'اسم التصنيف مطلوب']);
                return;
            }
            $this->error('اسم التصنيف مطلوب');
            $this->redirect(url('/categories'));
            return;
        }
        
        $id = $this->categoryModel->create($data);
        
        $this->logActivity('create', 'category', $id, 'إضافة تصنيف: ' . $data['name']);
        
        if ($this->isAjax()) {
            $category = $this->categoryModel->find($id);
            $category['products_count'] = 0;
            $this->json([
                'success' => true, 
                'message' => 'تم إضافة التصنيف بنجاح',
                'category' => $category
            ]);
            return;
        }
        
        $this->success('تم إضافة التصنيف بنجاح');
        $this->redirect(url('/categories'));
    }
    
    public function update(int $id): void
    {
        $this->requireRole(['admin']);
        
        $category = $this->categoryModel->find($id);
        if (!$category) {
            if ($this->isAjax()) {
                $this->json(['success' => false, 'message' => 'التصنيف غير موجود']);
                return;
            }
            $this->error('التصنيف غير موجود');
            $this->redirect(url('/categories'));
            return;
        }
        
        $data = [
            'name' => $this->input('name'),
            'description' => $this->input('description'),
            'parent_id' => $this->input('parent_id') ?: null,
            'icon' => $this->input('icon'),
            'color' => $this->input('color') ?: '#1e88e5',
            'sort_order' => (int) $this->input('sort_order', 0),
            'is_active' => $this->input('is_active') !== null ? ($this->input('is_active') ? 1 : 0) : 1
        ];
        
        if (empty($data['name'])) {
            if ($this->isAjax()) {
                $this->json(['success' => false, 'message' => 'اسم التصنيف مطلوب']);
                return;
            }
            $this->error('اسم التصنيف مطلوب');
            $this->redirect(url('/categories'));
            return;
        }
        
        $this->categoryModel->update($id, $data);
        
        $this->logActivity('update', 'category', $id, 'تعديل تصنيف: ' . $data['name']);
        
        if ($this->isAjax()) {
            $updatedCategory = $this->categoryModel->find($id);
            $updatedCategory['products_count'] = $this->categoryModel->getProductCount($id);
            $this->json([
                'success' => true, 
                'message' => 'تم تحديث التصنيف بنجاح',
                'category' => $updatedCategory
            ]);
            return;
        }
        
        $this->success('تم تحديث التصنيف بنجاح');
        $this->redirect(url('/categories'));
    }
    
    public function destroy(int $id): void
    {
        $this->requireRole(['admin']);
        
        $category = $this->categoryModel->find($id);
        
        if (!$category) {
            $this->error('التصنيف غير موجود');
            $this->redirect(url('/categories'));
            return;
        }
        
        // التحقق من التأكيد على حذف المنتجات
        $confirmDelete = $this->input('confirm_delete');
        $moveToCategory = $this->input('move_to_category');
        
        // عدد المنتجات
        $productCount = $this->categoryModel->getProductCount($id);
        
        if ($productCount > 0 && !$confirmDelete) {
            // إذا لم يتم التأكيد، أظهر رسالة خطأ
            $this->error("لا يمكن حذف التصنيف لوجود {$productCount} منتج مرتبط به. استخدم خيار الحذف مع التأكيد.");
            $this->redirect(url('/categories'));
            return;
        }
        
        // إذا تم التأكيد، قم بمعالجة المنتجات
        if ($productCount > 0 && $confirmDelete) {
            // جلب المنتجات المرتبطة بهذا التصنيف
            $products = $this->db->fetchAll(
                "SELECT p.id, p.name FROM products p WHERE p.category_id = ?",
                [$id]
            );
            
            $deletedProducts = 0;
            $movedProducts = 0;
            
            foreach ($products as $product) {
                // التحقق مما إذا كان المنتج مرتبط بفاتورة
                $hasInvoice = $this->db->fetchColumn(
                    "SELECT COUNT(*) FROM invoice_items WHERE product_id = ?",
                    [$product['id']]
                );
                
                if ($hasInvoice > 0) {
                    // نقل المنتج لتصنيف آخر إذا تم تحديده
                    if ($moveToCategory && $moveToCategory != $id) {
                        $this->db->query(
                            "UPDATE products SET category_id = ? WHERE id = ?",
                            [$moveToCategory, $product['id']]
                        );
                        $movedProducts++;
                    } else {
                        // نقل لـ NULL (بدون تصنيف)
                        $this->db->query(
                            "UPDATE products SET category_id = NULL WHERE id = ?",
                            [$product['id']]
                        );
                        $movedProducts++;
                    }
                } else {
                    // حذف المنتج لأنه غير مرتبط بفاتورة
                    $this->db->delete('products', 'id = ?', [$product['id']]);
                    $deletedProducts++;
                }
            }
            
            $this->logActivity('delete', 'category', $id, 
                "حذف تصنيف: {$category['name']} (تم حذف {$deletedProducts} منتج، نقل {$movedProducts} منتج)"
            );
        }
        
        // حذف التصنيف
        $this->categoryModel->delete($id);
        
        $this->logActivity('delete', 'category', $id, 'حذف تصنيف: ' . $category['name']);
        
        if ($this->isAjax()) {
            $this->json([
                'success' => true,
                'message' => 'تم حذف التصنيف بنجاح'
            ]);
            return;
        }
        
        $this->success('تم حذف التصنيف بنجاح');
        $this->redirect(url('/categories'));
    }
    
    /**
     * عرض منتجات التصنيف
     */
    public function show(int $id): void
    {
        $category = $this->categoryModel->find($id);
        
        if (!$category) {
            $this->error('التصنيف غير موجود');
            $this->redirect(url('/categories'));
            return;
        }
        
        $page = (int) ($_GET['page'] ?? 1);
        $perPage = (int) ($_GET['per_page'] ?? 10);
        
        // عدد المنتجات الإجمالي في هذا التصنيف
        $totalCount = $this->db->fetchColumn(
            "SELECT COUNT(*) FROM products WHERE category_id = ?",
            [$id]
        );
        
        // إنشاء Pagination
        $pagination = new \Core\Pagination($totalCount, $perPage, $page);
        
        // جلب منتجات هذا التصنيف مع pagination
        $products = $this->db->fetchAll(
            "SELECT p.*, 
                    (SELECT COUNT(*) FROM invoice_items WHERE product_id = p.id) as invoice_count
             FROM products p 
             WHERE p.category_id = ? 
             ORDER BY p.id DESC
             LIMIT {$pagination->getLimit()} OFFSET {$pagination->getOffset()}",
            [$id]
        );
        
        // جلب جميع التصنيفات
        $categories = $this->categoryModel->getAllWithProductCount();
        
        $this->view('categories/show', [
            'pageTitle' => 'منتجات التصنيف: ' . $category['name'],
            'category' => $category,
            'products' => $products,
            'categories' => $categories,
            'pagination' => $pagination,
            'totalCount' => $totalCount
        ]);
    }
    
    /**
     * نقل جميع منتجات التصنيف إلى تصنيف آخر
     */
    public function moveAllProducts(int $id): void
    {
        $this->requireRole(['admin']);
        
        $category = $this->categoryModel->find($id);
        if (!$category) {
            $this->error('التصنيف غير موجود');
            $this->redirect(url('/categories'));
            return;
        }
        
        $newCategoryId = $this->input('new_category_id');
        
        if ($newCategoryId == $id) {
            $this->error('لا يمكن نقل المنتجات لنفس التصنيف');
            $this->redirect(url('/categories/' . $id));
            return;
        }
        
        // نقل جميع المنتجات
        $this->db->query(
            "UPDATE products SET category_id = ? WHERE category_id = ?",
            [$newCategoryId ?: null, $id]
        );
        
        $newCategory = $newCategoryId ? $this->categoryModel->find($newCategoryId) : null;
        $this->logActivity('update', 'category', $id, 
            'نقل جميع منتجات التصنيف "' . $category['name'] . '" إلى "' . ($newCategory['name'] ?? 'بدون تصنيف') . '"'
        );
        
        $this->success('تم نقل جميع المنتجات بنجاح');
        $this->redirect(url('/categories/' . $id));
    }
    
    /**
     * نقل منتج واحد لتصنيف آخر
     */
    public function moveProduct(int $categoryId): void
    {
        try {
            // التحقق من الصلاحية بطريقة AJAX-friendly
            $userRole = $_SESSION['user_role'] ?? '';
            if (!in_array($userRole, ['admin'])) {
                $this->json(['success' => false, 'message' => 'ليس لديك صلاحية لهذا الإجراء']);
                return;
            }
            
            $productId = $this->input('product_id');
            $newCategoryId = $this->input('new_category_id');
            
            if (!$productId) {
                $this->json(['success' => false, 'message' => 'معرف المنتج مطلوب']);
                return;
            }
            
            $product = $this->db->fetch("SELECT * FROM products WHERE id = ?", [$productId]);
            
            if (!$product) {
                $this->json(['success' => false, 'message' => 'المنتج غير موجود']);
                return;
            }
            
            $this->db->query(
                "UPDATE products SET category_id = ? WHERE id = ?",
                [$newCategoryId ?: null, $productId]
            );
            
            $this->logActivity('update', 'product', $productId, 
                'نقل المنتج "' . $product['name'] . '" إلى تصنيف جديد'
            );
            
            $this->json(['success' => true, 'message' => 'تم نقل المنتج بنجاح']);
        } catch (\Exception $e) {
            $this->json(['success' => false, 'message' => 'خطأ: ' . $e->getMessage()]);
        }
    }
    
    /**
     * حذف منتج من صفحة التصنيف
     */
    public function deleteProduct(int $categoryId): void
    {
        // التحقق من الصلاحية بطريقة AJAX-friendly
        $userRole = $_SESSION['user_role'] ?? '';
        if (!in_array($userRole, ['admin'])) {
            $this->json(['success' => false, 'message' => 'ليس لديك صلاحية لهذا الإجراء']);
            return;
        }
        
        $productId = $this->input('product_id');
        
        $product = $this->db->fetch("SELECT * FROM products WHERE id = ?", [$productId]);
        
        if (!$product) {
            $this->json(['success' => false, 'message' => 'المنتج غير موجود']);
            return;
        }
        
        // التحقق من وجود فواتير مرتبطة
        $invoiceCount = $this->db->fetchColumn(
            "SELECT COUNT(*) FROM invoice_items WHERE product_id = ?",
            [$productId]
        );
        
        if ($invoiceCount > 0) {
            $this->json(['success' => false, 'message' => 'لا يمكن حذف المنتج لوجود فواتير مرتبطة']);
            return;
        }
        
        $this->db->delete('products', 'id = ?', [$productId]);
        
        $this->logActivity('delete', 'product', $productId, 'حذف منتج: ' . $product['name']);
        
        $this->json(['success' => true, 'message' => 'تم حذف المنتج بنجاح']);
    }
}


============================================================
FILE: app/Controllers/CustomerController.php
============================================================
<?php
namespace App\Controllers;

use Core\Controller;
use App\Models\Customer;

/**
 * متحكم العملاء
 */
class CustomerController extends Controller
{
    private Customer $customerModel;
    
    public function __construct()
    {
        parent::__construct();
        $this->requireAuth();
        $this->customerModel = new Customer();
    }
    
    public function index(): void
    {
        $page = (int) ($_GET['page'] ?? 1);
        $perPage = (int) ($_GET['per_page'] ?? 10);
        $search = $_GET['q'] ?? '';
        
        $where = "WHERE 1=1";
        $params = [];
        
        if ($search) {
            $where .= " AND (full_name LIKE ? OR phone LIKE ? OR national_id LIKE ?)";
            $params[] = "%{$search}%";
            $params[] = "%{$search}%";
            $params[] = "%{$search}%";
        }
        
        $totalCount = $this->db->fetchColumn("SELECT COUNT(*) FROM customers $where", $params);
        $pagination = new \Core\Pagination($totalCount, $perPage, $page);
        
        $sql = "SELECT c.*, 
                COALESCE((SELECT SUM(remaining_amount) FROM invoices WHERE customer_id = c.id), 0) as balance
                FROM customers c 
                $where 
                ORDER BY c.id DESC 
                LIMIT {$pagination->getLimit()} OFFSET {$pagination->getOffset()}";
        
        $customers = $this->db->fetchAll($sql, $params);
        
        $this->view('customers/index', [
            'pageTitle' => 'إدارة العملاء',
            'customers' => $customers,
            'pagination' => $pagination,
            'search' => $search
        ]);
    }
    
    public function create(): void
    {
        $this->view('customers/create', [
            'pageTitle' => 'إضافة عميل جديد'
        ]);
    }
    
    public function store(): void
    {
        $data = [
            'full_name' => $this->input('full_name'),
            'phone' => $this->input('phone'),
            'phone2' => $this->input('phone2'),
            'national_id' => $this->input('national_id'),
            'address' => $this->input('address'),
            'city' => $this->input('city'),
            'work_address' => $this->input('work_address'),
            'work_phone' => $this->input('work_phone'),
            'guarantor_name' => $this->input('guarantor_name'),
            'guarantor_phone' => $this->input('guarantor_phone'),
            'guarantor_national_id' => $this->input('guarantor_national_id'),
            'credit_limit' => (float) $this->input('credit_limit', 0),
            'notes' => $this->input('notes'),
            'is_active' => 1
        ];
        
        // رفع صورة الهوية
        if (!empty($_FILES['national_id_image']['name'])) {
            $data['national_id_image'] = $this->uploadDocument($_FILES['national_id_image']);
        }
        
        $id = $this->customerModel->create($data);
        
        $this->logActivity('create', 'customer', $id, 'إضافة عميل: ' . $data['full_name']);
        $this->success('تم إضافة العميل بنجاح');
        
        // التوجيه حسب الصفحة المصدر مع تمرير معرف العميل الجديد
        $returnTo = $this->input('return_to');
        if ($returnTo === 'pos') {
            $this->redirect(url('/pos?new_customer_id=' . $id));
        } elseif ($returnTo === 'installment') {
            $this->redirect(url('/pos/installment?new_customer_id=' . $id));
        } else {
            $this->redirect(url('/customers'));
        }
    }

    public function storeAjax(): void
    {
        try {
            $data = [
                'full_name' => $this->input('full_name'),
                'phone' => $this->input('phone'),
                'phone2' => $this->input('phone2'),
                'national_id' => $this->input('national_id'),
                'address' => $this->input('address'),
                'credit_limit' => (float) $this->input('credit_limit', 5000),
                'is_active' => 1
            ];
            
            if (empty($data['full_name']) || empty($data['phone'])) {
                $this->json(['success' => false, 'message' => 'الاسم ورقم الهاتف مطلوبان']);
                return;
            }
            
            $id = $this->customerModel->create($data);
            $this->logActivity('create', 'customer', $id, 'إضافة عميل (POS): ' . $data['full_name']);
            
            $this->json([
                'success' => true, 
                'customer' => [
                    'id' => $id,
                    'full_name' => $data['full_name'],
                    'phone' => $data['phone']
                ]
            ]);
        } catch (\Exception $e) {
            $this->json(['success' => false, 'message' => $e->getMessage()]);
        }
    }
    
    public function show(int $id): void
    {
        $customer = $this->customerModel->find($id);
        
        if (!$customer) {
            $this->error('العميل غير موجود');
            $this->redirect(url('/customers'));
            return;
        }
        
        $invoices = $this->customerModel->getInvoices($id);
        $payments = $this->customerModel->getPayments($id);
        $balance = $this->customerModel->getBalance($id);
        
        $this->view('customers/show', [
            'pageTitle' => 'ملف العميل: ' . $customer['full_name'],
            'customer' => $customer,
            'invoices' => $invoices,
            'payments' => $payments,
            'balance' => $balance
        ]);
    }
    
    public function edit(int $id): void
    {
        $customer = $this->customerModel->find($id);
        
        if (!$customer) {
            $this->error('العميل غير موجود');
            $this->redirect(url('/customers'));
            return;
        }
        
        $this->view('customers/edit', [
            'pageTitle' => 'تعديل: ' . $customer['full_name'],
            'customer' => $customer
        ]);
    }
    
    public function update(int $id): void
    {
        $customer = $this->customerModel->find($id);
        
        if (!$customer) {
            $this->error('العميل غير موجود');
            $this->redirect(url('/customers'));
            return;
        }
        
        $data = [
            'full_name' => $this->input('full_name'),
            'phone' => $this->input('phone'),
            'phone2' => $this->input('phone2'),
            'national_id' => $this->input('national_id'),
            'address' => $this->input('address'),
            'city' => $this->input('city'),
            'work_address' => $this->input('work_address'),
            'work_phone' => $this->input('work_phone'),
            'guarantor_name' => $this->input('guarantor_name'),
            'guarantor_phone' => $this->input('guarantor_phone'),
            'guarantor_national_id' => $this->input('guarantor_national_id'),
            'credit_limit' => (float) $this->input('credit_limit', 0),
            'notes' => $this->input('notes'),
            'is_active' => $this->input('is_active') ? 1 : 0
        ];
        
        if (!empty($_FILES['national_id_image']['name'])) {
            $data['national_id_image'] = $this->uploadDocument($_FILES['national_id_image']);
        }
        
        $this->customerModel->update($id, $data);
        
        $this->logActivity('update', 'customer', $id, 'تعديل عميل: ' . $data['full_name']);
        $this->success('تم تحديث بيانات العميل بنجاح');
        $this->redirect(url('/customers'));
    }
    
    public function destroy(int $id): void
    {
        $this->requireRole(['admin']);
        
        $customer = $this->customerModel->find($id);
        
        if (!$customer) {
            $this->error('العميل غير موجود');
            $this->redirect(url('/customers'));
            return;
        }
        
        $invoiceCount = $this->db->fetchColumn(
            "SELECT COUNT(*) FROM invoices WHERE customer_id = ?",
            [$id]
        );
        
        if ($invoiceCount > 0) {
            $this->error('لا يمكن حذف العميل لوجود فواتير مرتبطة');
            $this->redirect(url('/customers'));
            return;
        }
        
        $this->customerModel->delete($id);
        
        $this->logActivity('delete', 'customer', $id, 'حذف عميل: ' . $customer['full_name']);
        $this->success('تم حذف العميل بنجاح');
        $this->redirect(url('/customers'));
    }
    
    /**
     * حذف متعدد للعملاء
     */
    public function bulkDelete(): void
    {
        $this->requireRole(['admin']);
        
        $ids = $this->input('ids', []);
        
        if (empty($ids)) {
            $this->json(['success' => false, 'message' => 'لم يتم تحديد أي عملاء']);
            return;
        }
        
        if (!is_array($ids)) {
            $ids = explode(',', $ids);
        }
        
        $ids = array_map('intval', $ids);
        $deletedCount = 0;
        $skippedCount = 0;
        
        foreach ($ids as $id) {
            $customer = $this->customerModel->find($id);
            if (!$customer) {
                continue;
            }
            
            // التحقق من عدم وجود فواتير مرتبطة
            $invoiceCount = $this->db->fetchColumn(
                "SELECT COUNT(*) FROM invoices WHERE customer_id = ?",
                [$id]
            );
            
            if ($invoiceCount > 0) {
                $skippedCount++;
                continue;
            }
            
            $this->customerModel->delete($id);
            $this->logActivity('delete', 'customer', $id, 'حذف عميل (حذف متعدد): ' . $customer['full_name']);
            $deletedCount++;
        }
        
        if ($deletedCount > 0) {
            $message = "تم حذف {$deletedCount} عميل بنجاح";
            if ($skippedCount > 0) {
                $message .= " (تم تخطي {$skippedCount} لوجود فواتير مرتبطة)";
            }
            $this->json(['success' => true, 'message' => $message]);
        } else {
            $this->json(['success' => false, 'message' => 'لم يتم حذف أي عميل - جميعهم لديهم فواتير مرتبطة']);
        }
    }
    
    public function search(): void
    {
        $query = $this->input('q', '');
        $customers = $this->customerModel->searchCustomers($query);
        $this->json($customers);
    }
    
    private function uploadDocument(array $file): ?string
    {
        $ext = pathinfo($file['name'], PATHINFO_EXTENSION);
        $filename = uniqid('doc_') . '.' . $ext;
        $uploadDir = dirname(dirname(__DIR__)) . '/public/uploads/customers/';
        
        if (!is_dir($uploadDir)) {
            mkdir($uploadDir, 0755, true);
        }
        
        if (move_uploaded_file($file['tmp_name'], $uploadDir . $filename)) {
            return $filename;
        }
        
        return null;
    }
}


============================================================
FILE: app/Controllers/DashboardController.php
============================================================
<?php
namespace App\Controllers;

use Core\Controller;
use App\Models\Invoice;
use App\Models\Installment;
use App\Models\Product;
use App\Models\Customer;
use App\Models\Payment;

/**
 * ╔══════════════════════════════════════════════════════════════════╗
 * ║                    نظام تقسيط - متحكم لوحة التحكم                 ║
 * ╚══════════════════════════════════════════════════════════════════╝
 */
class DashboardController extends Controller
{
    public function __construct()
    {
        parent::__construct();
        $this->requireAuth();
    }
    
    /**
     * لوحة التحكم الرئيسية
     */
    public function index(): void
    {
        $invoiceModel = new Invoice();
        $installmentModel = new Installment();
        $productModel = new Product();
        $customerModel = new Customer();
        $paymentModel = new Payment();
        
        // تحديث حالات الأقساط المتأخرة
        $installmentModel->updateOverdueStatus();
        
        // إحصائيات اليوم
        $todayStats = $invoiceModel->getTodayStats();
        $todayPayments = $paymentModel->getTodayTotal();
        
        // إحصائيات الأقساط
        $installmentStats = $installmentModel->getStats();
        
        // إحصائيات عامة
        $stats = [
            'products_count' => $productModel->count('is_active = 1'),
            'customers_count' => $customerModel->count(), // عد جميع العملاء
            'low_stock_count' => count($productModel->getLowStock()),
            'active_installments' => $invoiceModel->count("invoice_type = 'installment' AND status = 'active'"),
        ];
        
        // أقساط اليوم
        $todayInstallments = $installmentModel->getToday();
        
        // الأقساط المتأخرة
        $overdueInstallments = $installmentModel->getOverdue();
        
        // آخر الفواتير
        $recentInvoices = $this->db->fetchAll(
            "SELECT i.*, c.full_name as customer_name 
             FROM invoices i 
             LEFT JOIN customers c ON i.customer_id = c.id 
             ORDER BY i.id DESC 
             LIMIT 5"
        );
        
        // آخر المدفوعات
        $recentPayments = $paymentModel->getToday();
        
        $this->view('dashboard/index', [
            'pageTitle' => 'لوحة التحكم',
            'todayStats' => $todayStats,
            'todayPayments' => $todayPayments,
            'installmentStats' => $installmentStats,
            'stats' => $stats,
            'todayInstallments' => $todayInstallments,
            'overdueInstallments' => array_slice($overdueInstallments, 0, 5),
            'recentInvoices' => $recentInvoices,
            'recentPayments' => array_slice($recentPayments, 0, 5),
        ]);
    }
    
    /**
     * إحصائيات AJAX
     */
    public function stats(): void
    {
        $invoiceModel = new Invoice();
        $installmentModel = new Installment();
        $paymentModel = new Payment();
        
        $this->json([
            'today' => $invoiceModel->getTodayStats(),
            'installments' => $installmentModel->getStats(),
            'payments' => $paymentModel->getTodayTotal()
        ]);
    }
}


============================================================
FILE: app/Controllers/ExportController.php
============================================================
<?php
namespace App\Controllers;

use Core\Controller;

/**
 * متحكم التصدير - PDF و Excel
 */
class ExportController extends Controller
{
    public function __construct()
    {
        parent::__construct();
        $this->requireAuth();
    }
    
    /**
     * تصدير المنتجات
     */
    public function products(string $format): void
    {
        $search = $_GET['q'] ?? '';
        $categoryId = $_GET['category'] ?? '';
        $ids = $_GET['ids'] ?? '';
        
        $where = "WHERE 1=1";
        $params = [];
        
        // Filter by selected IDs
        if ($ids) {
            $idList = array_filter(explode(',', $ids), 'is_numeric');
            if (!empty($idList)) {
                $placeholders = implode(',', array_fill(0, count($idList), '?'));
                $where .= " AND p.id IN ($placeholders)";
                $params = array_merge($params, $idList);
            }
        } else {
            if ($search) {
                $where .= " AND (p.name LIKE ? OR p.barcode LIKE ?)";
                $params[] = "%{$search}%";
                $params[] = "%{$search}%";
            }
            
            if ($categoryId) {
                $where .= " AND p.category_id = ?";
                $params[] = $categoryId;
            }
        }
        
        $products = $this->db->fetchAll(
            "SELECT p.*, c.name as category_name 
             FROM products p 
             LEFT JOIN categories c ON p.category_id = c.id 
             $where 
             ORDER BY p.id DESC",
            $params
        );
        
        $headers = ['#', 'اسم المنتج', 'التصنيف', 'السعر نقدي', 'السعر تقسيط', 'الكمية', 'الحالة'];
        $rows = [];
        foreach ($products as $p) {
            $rows[] = [
                $p['id'],
                $p['name'],
                $p['category_name'] ?? '-',
                number_format($p['cash_price'], 2),
                number_format($p['installment_price'], 2),
                $p['quantity'],
                $p['is_active'] ? 'نشط' : 'معطل'
            ];
        }
        
        $this->export($format, 'المنتجات', $headers, $rows);
    }
    
    /**
     * تصدير التصنيفات
     */
    public function categories(string $format): void
    {
        $categories = $this->db->fetchAll(
            "SELECT c.*, (SELECT COUNT(*) FROM products WHERE category_id = c.id) as products_count 
             FROM categories c ORDER BY c.name"
        );
        
        $headers = ['#', 'الاسم', 'الوصف', 'عدد المنتجات'];
        $rows = [];
        foreach ($categories as $cat) {
            $rows[] = [
                $cat['id'],
                $cat['name'],
                $cat['description'] ?? '-',
                $cat['products_count']
            ];
        }
        
        $this->export($format, 'التصنيفات', $headers, $rows);
    }
    
    /**
     * تصدير العملاء
     */
    public function customers(string $format): void
    {
        $search = $_GET['q'] ?? '';
        
        $where = $search ? "WHERE full_name LIKE '%{$search}%' OR phone LIKE '%{$search}%'" : '';
        
        $customers = $this->db->fetchAll(
            "SELECT c.*, 
                    COALESCE((SELECT SUM(remaining_amount) FROM invoices WHERE customer_id = c.id), 0) as balance
             FROM customers c $where ORDER BY c.id DESC"
        );
        
        $headers = ['#', 'الاسم', 'الهاتف', 'رقم الهوية', 'المدينة', 'الرصيد المستحق'];
        $rows = [];
        foreach ($customers as $c) {
            $rows[] = [
                $c['id'],
                $c['full_name'],
                $c['phone'],
                $c['national_id'] ?? '-',
                $c['city'] ?? '-',
                number_format($c['balance'], 2)
            ];
        }
        
        $this->export($format, 'العملاء', $headers, $rows);
    }
    
    /**
     * تصدير المستخدمين
     */
    public function users(string $format): void
    {
        $ids = $_GET['ids'] ?? '';
        
        $where = '';
        $params = [];
        
        if ($ids) {
            $idList = array_filter(explode(',', $ids), 'is_numeric');
            if (!empty($idList)) {
                $placeholders = implode(',', array_fill(0, count($idList), '?'));
                $where = "WHERE id IN ($placeholders)";
                $params = $idList;
            }
        }
        
        $users = $this->db->fetchAll("SELECT * FROM users $where ORDER BY id DESC", $params);
        
        $headers = ['#', 'الاسم', 'اسم المستخدم', 'الهاتف', 'الدور', 'الحالة'];
        $rows = [];
        foreach ($users as $u) {
            $role = $u['role'] === 'admin' ? 'مدير' : ($u['role'] === 'cashier' ? 'كاشير' : 'موظف');
            $rows[] = [
                $u['id'],
                $u['full_name'],
                $u['username'],
                $u['phone'] ?? '-',
                $role,
                $u['is_active'] ? 'نشط' : 'معطل'
            ];
        }
        
        $this->export($format, 'المستخدمين', $headers, $rows);
    }
    
    /**
     * تصدير الفواتير
     */
    public function invoices(string $format): void
    {
        $search = $_GET['q'] ?? '';
        $type = $_GET['type'] ?? '';
        $status = $_GET['status'] ?? '';
        
        $where = "WHERE 1=1";
        $params = [];
        
        if ($search) {
            $where .= " AND (i.invoice_number LIKE ? OR c.full_name LIKE ?)";
            $params[] = "%{$search}%";
            $params[] = "%{$search}%";
        }
        if ($type) {
            $where .= " AND i.invoice_type = ?";
            $params[] = $type;
        }
        if ($status) {
            $where .= " AND i.status = ?";
            $params[] = $status;
        }
        
        $invoices = $this->db->fetchAll(
            "SELECT i.*, c.full_name as customer_name
             FROM invoices i 
             LEFT JOIN customers c ON i.customer_id = c.id 
             $where ORDER BY i.id DESC",
            $params
        );
        
        $headers = ['رقم الفاتورة', 'العميل', 'النوع', 'الإجمالي', 'المدفوع', 'المتبقي', 'الحالة', 'التاريخ'];
        $rows = [];
        foreach ($invoices as $inv) {
            $rows[] = [
                $inv['invoice_number'],
                $inv['customer_name'] ?? 'زبون نقدي',
                $inv['invoice_type'] === 'cash' ? 'نقدي' : 'تقسيط',
                number_format($inv['total_amount'], 2),
                number_format($inv['paid_amount'], 2),
                number_format($inv['remaining_amount'], 2),
                $this->getStatusArabic($inv['status']),
                date('Y-m-d', strtotime($inv['created_at']))
            ];
        }
        
        $this->export($format, 'الفواتير', $headers, $rows);
    }
    
    /**
     * تصدير عقود الأقساط
     */
    public function installments(string $format): void
    {
        $search = $_GET['q'] ?? '';
        $status = $_GET['status'] ?? '';
        $ids = $_GET['ids'] ?? '';
        
        $where = "WHERE i.invoice_type = 'installment'";
        $params = [];
        
        if ($ids) {
            $idList = array_filter(explode(',', $ids), 'is_numeric');
            if (!empty($idList)) {
                $placeholders = implode(',', array_fill(0, count($idList), '?'));
                $where .= " AND i.id IN ($placeholders)";
                $params = array_merge($params, $idList);
            }
        } else {
            if ($search) {
                $where .= " AND (i.invoice_number LIKE ? OR c.full_name LIKE ?)";
                $params[] = "%{$search}%";
                $params[] = "%{$search}%";
            }
            if ($status) {
                $where .= " AND i.status = ?";
                $params[] = $status;
            }
        }
        
        $invoices = $this->db->fetchAll(
            "SELECT i.*, c.full_name as customer_name, c.phone as customer_phone
             FROM invoices i 
             JOIN customers c ON i.customer_id = c.id 
             $where ORDER BY i.id DESC",
            $params
        );
        
        $headers = ['رقم الفاتورة', 'العميل', 'الهاتف', 'الإجمالي', 'المدفوع', 'المتبقي', 'القسط الشهري', 'الحالة'];
        $rows = [];
        foreach ($invoices as $inv) {
            $rows[] = [
                $inv['invoice_number'],
                $inv['customer_name'],
                $inv['customer_phone'],
                number_format($inv['total_amount'], 2),
                number_format($inv['paid_amount'], 2),
                number_format($inv['remaining_amount'], 2),
                number_format($inv['monthly_installment'] ?? 0, 2),
                $this->getStatusArabic($inv['status'])
            ];
        }
        
        $this->export($format, 'عقود_الأقساط', $headers, $rows);
    }
    
    /**
     * تصدير أقساط اليوم
     */
    public function todayInstallments(string $format): void
    {
        $installments = $this->db->fetchAll(
            "SELECT inst.*, i.invoice_number, c.full_name as customer_name, c.phone as customer_phone
             FROM installments inst
             JOIN invoices i ON inst.invoice_id = i.id
             JOIN customers c ON i.customer_id = c.id
             WHERE inst.due_date = date('now') AND inst.status IN ('pending', 'partial')
             ORDER BY c.full_name"
        );
        
        $headers = ['العميل', 'الهاتف', 'رقم الفاتورة', 'رقم القسط', 'المبلغ', 'تاريخ الاستحقاق'];
        $rows = [];
        foreach ($installments as $inst) {
            $rows[] = [
                $inst['customer_name'],
                $inst['customer_phone'],
                $inst['invoice_number'],
                $inst['installment_number'],
                number_format($inst['remaining_amount'], 2),
                $inst['due_date']
            ];
        }
        
        $this->export($format, 'أقساط_اليوم', $headers, $rows);
    }
    
    /**
     * تصدير الأقساط المتأخرة
     */
    public function overdueInstallments(string $format): void
    {
        $installments = $this->db->fetchAll(
            "SELECT inst.*, i.invoice_number, c.full_name as customer_name, c.phone as customer_phone,
                    julianday('now') - julianday(inst.due_date) as days_overdue
             FROM installments inst
             JOIN invoices i ON inst.invoice_id = i.id
             JOIN customers c ON i.customer_id = c.id
             WHERE inst.status IN ('pending', 'partial') AND inst.due_date < date('now')
             ORDER BY inst.due_date ASC"
        );
        
        $headers = ['العميل', 'الهاتف', 'رقم الفاتورة', 'رقم القسط', 'المبلغ', 'تاريخ الاستحقاق', 'أيام التأخير'];
        $rows = [];
        foreach ($installments as $inst) {
            $rows[] = [
                $inst['customer_name'],
                $inst['customer_phone'],
                $inst['invoice_number'],
                $inst['installment_number'],
                number_format($inst['remaining_amount'], 2),
                $inst['due_date'],
                (int)$inst['days_overdue']
            ];
        }
        
        $this->export($format, 'الأقساط_المتأخرة', $headers, $rows);
    }
    
    /**
     * تصدير المدفوعات
     */
    public function payments(string $format): void
    {
        $from = $_GET['from'] ?? date('Y-m-01');
        $to = $_GET['to'] ?? date('Y-m-d');
        
        $payments = $this->db->fetchAll(
            "SELECT p.*, i.invoice_number, c.full_name as customer_name
             FROM payments p
             INNER JOIN invoices i ON p.invoice_id = i.id
             LEFT JOIN customers c ON i.customer_id = c.id
             WHERE DATE(p.payment_date) >= ? AND DATE(p.payment_date) <= ?
             ORDER BY p.payment_date DESC",
            [$from, $to]
        );
        
        $headers = ['رقم الإيصال', 'العميل', 'رقم الفاتورة', 'المبلغ', 'طريقة الدفع', 'التاريخ'];
        $rows = [];
        foreach ($payments as $p) {
            $rows[] = [
                $p['receipt_number'],
                $p['customer_name'] ?? '-',
                $p['invoice_number'],
                number_format($p['amount'], 2),
                $this->getPaymentMethodArabic($p['payment_method']),
                date('Y-m-d H:i', strtotime($p['payment_date']))
            ];
        }
        
        $this->export($format, 'المدفوعات', $headers, $rows);
    }
    
    /**
     * تصدير تقرير المبيعات
     */
    public function salesReport(string $format): void
    {
        $from = $_GET['from'] ?? date('Y-m-01');
        $to = $_GET['to'] ?? date('Y-m-d');
        $ids = $_GET['ids'] ?? '';
        
        $where = "WHERE 1=1";
        $params = [];
        
        // فلترة حسب الفواتير المحددة
        if ($ids) {
            $idList = array_filter(explode(',', $ids), 'is_numeric');
            if (!empty($idList)) {
                $placeholders = implode(',', array_fill(0, count($idList), '?'));
                $where .= " AND i.id IN ($placeholders)";
                $params = array_merge($params, $idList);
            }
        } else {
            // فلترة حسب التاريخ فقط إذا لم يتم تحديد فواتير
            $where .= " AND DATE(i.created_at) >= ? AND DATE(i.created_at) <= ?";
            $params[] = $from;
            $params[] = $to;
        }
        
        $invoices = $this->db->fetchAll(
            "SELECT i.*, c.full_name as customer_name 
             FROM invoices i 
             LEFT JOIN customers c ON i.customer_id = c.id 
             $where
             ORDER BY i.created_at DESC",
            $params
        );
        
        $headers = ['رقم الفاتورة', 'العميل', 'النوع', 'الإجمالي', 'التاريخ'];
        $rows = [];
        foreach ($invoices as $inv) {
            $rows[] = [
                $inv['invoice_number'],
                $inv['customer_name'] ?? 'زبون نقدي',
                $inv['invoice_type'] === 'cash' ? 'نقدي' : 'تقسيط',
                number_format($inv['total_amount'], 2),
                date('Y-m-d', strtotime($inv['created_at']))
            ];
        }
        
        $this->export($format, 'تقرير_المبيعات', $headers, $rows);
    }
    
    /**
     * تصدير تقرير التحصيلات
     */
    public function collectionsReport(string $format): void
    {
        $from = $_GET['from'] ?? date('Y-m-01');
        $to = $_GET['to'] ?? date('Y-m-d');
        $ids = $_GET['ids'] ?? '';
        
        $where = "WHERE 1=1";
        $params = [];
        
        // فلترة حسب المدفوعات المحددة
        if ($ids) {
            $idList = array_filter(explode(',', $ids), 'is_numeric');
            if (!empty($idList)) {
                $placeholders = implode(',', array_fill(0, count($idList), '?'));
                $where .= " AND p.id IN ($placeholders)";
                $params = array_merge($params, $idList);
            }
        } else {
            $where .= " AND DATE(p.payment_date) >= ? AND DATE(p.payment_date) <= ?";
            $params[] = $from;
            $params[] = $to;
        }
        
        $payments = $this->db->fetchAll(
            "SELECT p.*, i.invoice_number, c.full_name as customer_name
             FROM payments p
             LEFT JOIN invoices i ON p.invoice_id = i.id
             LEFT JOIN customers c ON i.customer_id = c.id
             $where
             ORDER BY p.payment_date DESC",
            $params
        );
        
        $headers = ['رقم الإيصال', 'العميل', 'الفاتورة', 'المبلغ', 'التاريخ'];
        $rows = [];
        foreach ($payments as $p) {
            $rows[] = [
                $p['receipt_number'],
                $p['customer_name'] ?? '-',
                $p['invoice_number'],
                number_format($p['amount'], 2),
                date('Y-m-d', strtotime($p['payment_date']))
            ];
        }
        
        $this->export($format, 'تقرير_التحصيلات', $headers, $rows);
    }
    
    /**
     * تصدير تقرير المتأخرات
     */
    public function overdueReport(string $format): void
    {
        $ids = $_GET['ids'] ?? '';
        
        $where = "WHERE inst.status IN ('pending', 'partial', 'overdue') AND inst.due_date < date('now')";
        $params = [];
        
        // فلترة حسب الأقساط المحددة
        if ($ids) {
            $idList = array_filter(explode(',', $ids), 'is_numeric');
            if (!empty($idList)) {
                $placeholders = implode(',', array_fill(0, count($idList), '?'));
                $where .= " AND inst.id IN ($placeholders)";
                $params = array_merge($params, $idList);
            }
        }
        
        $installments = $this->db->fetchAll(
            "SELECT inst.*, i.invoice_number, c.full_name as customer_name, c.phone as customer_phone,
                    julianday('now') - julianday(inst.due_date) as days_overdue
             FROM installments inst
             JOIN invoices i ON inst.invoice_id = i.id
             JOIN customers c ON i.customer_id = c.id
             $where
             ORDER BY inst.due_date ASC",
            $params
        );
        
        $headers = ['العميل', 'الهاتف', 'رقم الفاتورة', 'رقم القسط', 'المبلغ', 'تاريخ الاستحقاق', 'أيام التأخير'];
        $rows = [];
        foreach ($installments as $inst) {
            $rows[] = [
                $inst['customer_name'],
                $inst['customer_phone'],
                $inst['invoice_number'],
                $inst['installment_number'],
                number_format($inst['remaining_amount'], 2),
                $inst['due_date'],
                (int)$inst['days_overdue']
            ];
        }
        
        $this->export($format, 'تقرير_المتأخرات', $headers, $rows);
    }
    
    /**
     * تصدير تقرير العملاء
     */
    public function customersReport(string $format): void
    {
        $search = $_GET['q'] ?? '';
        $where = $search ? "WHERE c.full_name LIKE '%{$search}%' OR c.phone LIKE '%{$search}%'" : '';
        
        $customers = $this->db->fetchAll(
            "SELECT c.*, 
                    COALESCE(SUM(CASE WHEN i.status = 'active' THEN i.remaining_amount ELSE 0 END), 0) as balance,
                    COUNT(CASE WHEN i.status = 'active' THEN 1 END) as active_invoices
             FROM customers c
             LEFT JOIN invoices i ON c.id = i.customer_id
             $where
             GROUP BY c.id ORDER BY balance DESC"
        );
        
        $headers = ['الاسم', 'الهاتف', 'المدينة', 'الرصيد المستحق', 'العقود النشطة'];
        $rows = [];
        foreach ($customers as $c) {
            $rows[] = [
                $c['full_name'],
                $c['phone'],
                $c['city'] ?? '-',
                number_format($c['balance'] ?? 0, 2),
                $c['active_invoices'] ?? 0
            ];
        }
        
        $this->export($format, 'تقرير_العملاء', $headers, $rows);
    }
    
    /**
     * تصدير تقرير المخزون
     */
    public function inventoryReport(string $format): void
    {
        $ids = $_GET['ids'] ?? '';
        
        if (!empty($ids)) {
            // تصدير المنتجات المحددة فقط
            $idList = array_map('intval', explode(',', $ids));
            $placeholders = implode(',', array_fill(0, count($idList), '?'));
            $products = $this->db->fetchAll(
                "SELECT p.*, c.name as category_name 
                 FROM products p
                 LEFT JOIN categories c ON p.category_id = c.id
                 WHERE p.id IN ($placeholders)
                 ORDER BY p.quantity ASC",
                $idList
            );
        } else {
            // تصدير جميع المنتجات
            $products = $this->db->fetchAll(
                "SELECT p.*, c.name as category_name 
                 FROM products p
                 LEFT JOIN categories c ON p.category_id = c.id
                 ORDER BY p.quantity ASC"
            );
        }
        
        $headers = ['المنتج', 'التصنيف', 'الكمية', 'حد التنبيه', 'السعر النقدي', 'قيمة المخزون', 'الحالة'];
        $rows = [];
        foreach ($products as $p) {
            $status = $p['quantity'] <= 0 ? 'نفذ' : ($p['quantity'] <= $p['min_quantity'] ? 'منخفض' : 'متوفر');
            $rows[] = [
                $p['name'],
                $p['category_name'] ?? '-',
                $p['quantity'],
                $p['min_quantity'],
                number_format($p['cash_price'], 2),
                number_format($p['cash_price'] * $p['quantity'], 2),
                $status
            ];
        }
        
        $this->export($format, 'تقرير_المخزون', $headers, $rows);
    }
    
    /**
     * تصدير تقرير الأرباح
     */
    public function profitsReport(string $format): void
    {
        $from = $_GET['from'] ?? date('Y-m-01');
        $to = $_GET['to'] ?? date('Y-m-d');
        $ids = $_GET['ids'] ?? '';
        
        $where = "WHERE DATE(i.created_at) >= ? AND DATE(i.created_at) <= ?";
        $params = [$from, $to];
        
        // فلترة حسب المنتجات المحددة
        if ($ids) {
            $idList = array_filter(explode(',', $ids), 'is_numeric');
            if (!empty($idList)) {
                $placeholders = implode(',', array_fill(0, count($idList), '?'));
                $where .= " AND p.id IN ($placeholders)";
                $params = array_merge($params, $idList);
            }
        }
        
        $profits = $this->db->fetchAll(
            "SELECT p.name, p.id,
                    SUM(ii.quantity) as total_quantity,
                    SUM(ii.total_price) as total_revenue,
                    SUM(ii.quantity * p.cost_price) as total_cost,
                    SUM(ii.total_price) - SUM(ii.quantity * p.cost_price) as total_profit
             FROM invoice_items ii
             JOIN products p ON ii.product_id = p.id
             JOIN invoices i ON ii.invoice_id = i.id
             $where
             GROUP BY p.id ORDER BY total_profit DESC",
            $params
        );
        
        $headers = ['المنتج', 'الكمية', 'الإيرادات', 'التكلفة', 'الربح', 'الهامش %'];
        $rows = [];
        foreach ($profits as $item) {
            $margin = $item['total_revenue'] > 0 ? round(($item['total_profit'] / $item['total_revenue']) * 100, 1) : 0;
            $rows[] = [
                $item['name'],
                $item['total_quantity'],
                number_format($item['total_revenue'], 2),
                number_format($item['total_cost'], 2),
                number_format($item['total_profit'], 2),
                $margin . '%'
            ];
        }
        
        $this->export($format, 'تقرير_الأرباح', $headers, $rows);
    }
    
    /**
     * تصدير تقرير أداء الموظفين
     */
    public function employeesReport(string $format): void
    {
        $from = $_GET['from'] ?? date('Y-m-01');
        $to = $_GET['to'] ?? date('Y-m-d');
        
        $performance = $this->db->fetchAll(
            "SELECT u.full_name, 
                    COUNT(i.id) as invoices_count,
                    SUM(CASE WHEN i.invoice_type = 'cash' THEN 1 ELSE 0 END) as cash_sales,
                    SUM(CASE WHEN i.invoice_type = 'installment' THEN 1 ELSE 0 END) as installment_sales,
                    SUM(i.total_amount) as total_sales
             FROM users u
             LEFT JOIN invoices i ON u.id = i.user_id AND DATE(i.created_at) >= ? AND DATE(i.created_at) <= ?
             GROUP BY u.id ORDER BY total_sales DESC",
            [$from, $to]
        );
        
        $headers = ['الموظف', 'عدد الفواتير', 'مبيعات نقدية', 'مبيعات تقسيط', 'الإجمالي'];
        $rows = [];
        foreach ($performance as $emp) {
            $rows[] = [
                $emp['full_name'],
                $emp['invoices_count'],
                $emp['cash_sales'],
                $emp['installment_sales'],
                number_format($emp['total_sales'] ?? 0, 2)
            ];
        }
        
        $this->export($format, 'تقرير_أداء_الموظفين', $headers, $rows);
    }
    
    /**
     * تصدير تقرير التدفق النقدي
     */
    public function cashflowReport(string $format): void
    {
        $from = $_GET['from'] ?? date('Y-m-01');
        $to = $_GET['to'] ?? date('Y-m-d');
        $ids = $_GET['ids'] ?? '';
        
        if (!empty($ids)) {
            // تصدير التواريخ المحددة فقط
            $dates = explode(',', $ids);
            $placeholders = implode(',', array_fill(0, count($dates), '?'));
            $inflows = $this->db->fetchAll(
                "SELECT DATE(payment_date) as date, SUM(amount) as total
                 FROM payments
                 WHERE DATE(payment_date) IN ($placeholders)
                 GROUP BY DATE(payment_date) ORDER BY date DESC",
                $dates
            );
        } else {
            // تصدير كل التواريخ
            $inflows = $this->db->fetchAll(
                "SELECT DATE(payment_date) as date, SUM(amount) as total
                 FROM payments
                 WHERE DATE(payment_date) >= ? AND DATE(payment_date) <= ?
                 GROUP BY DATE(payment_date) ORDER BY date DESC",
                [$from, $to]
            );
        }
        
        $headers = ['التاريخ', 'المبلغ'];
        $rows = [];
        foreach ($inflows as $flow) {
            $rows[] = [
                $flow['date'],
                number_format($flow['total'], 2)
            ];
        }
        
        $this->export($format, 'تقرير_التدفق_النقدي', $headers, $rows);
    }
    
    /**
     * دالة التصدير الرئيسية
     */
    private function export(string $format, string $filename, array $headers, array $rows): void
    {
        // تطبيق حد التصدير إذا وجد
        $limit = $_GET['export_limit'] ?? 'all';
        if ($limit !== 'all' && is_numeric($limit)) {
            $rows = array_slice($rows, 0, (int)$limit);
        }
        
        if ($format === 'excel') {
            $this->exportExcel($filename, $headers, $rows);
        } else {
            $this->exportPdf($filename, $headers, $rows);
        }
    }
    
    /**
     * تصدير Excel (CSV)
     */
    private function exportExcel(string $filename, array $headers, array $rows): void
    {
        $filename = $filename . '_' . date('Y-m-d') . '.csv';
        
        header('Content-Type: text/csv; charset=utf-8');
        header('Content-Disposition: attachment; filename="' . $filename . '"');
        header('Pragma: no-cache');
        header('Expires: 0');
        
        // BOM for UTF-8
        echo "\xEF\xBB\xBF";
        
        $output = fopen('php://output', 'w');
        fputcsv($output, $headers);
        
        foreach ($rows as $row) {
            fputcsv($output, $row);
        }
        
        fclose($output);
        exit;
    }
    
    /**
     * تصدير PDF (HTML للطباعة)
     */
    private function exportPdf(string $filename, array $headers, array $rows): void
    {
        $settings = $this->getSettings();
        $companyName = $settings['company_name'] ?? 'نظام تقسيط';
        
        ?>
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <title><?= $filename ?></title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; direction: rtl; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header p { color: #666; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px 8px; text-align: right; font-size: 12px; }
        th { background: #f5f5f5; font-weight: bold; }
        tr:nth-child(even) { background: #fafafa; }
        .footer { margin-top: 30px; text-align: center; color: #999; font-size: 11px; }
        @media print { 
            body { padding: 0; } 
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><?= $companyName ?></h1>
        <p><?= str_replace('_', ' ', $filename) ?> - <?= date('Y-m-d H:i') ?></p>
    </div>
    
    <button class="no-print" onclick="window.print()" style="padding:10px 20px;margin-bottom:20px;cursor:pointer">طباعة / حفظ PDF</button>
    
    <table>
        <thead>
            <tr>
                <?php foreach ($headers as $h): ?>
                <th><?= $h ?></th>
                <?php endforeach; ?>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($rows as $row): ?>
            <tr>
                <?php foreach ($row as $cell): ?>
                <td><?= $cell ?></td>
                <?php endforeach; ?>
            </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
    
    <div class="footer">
        تم التصدير بواسطة <?= $companyName ?> - <?= date('Y-m-d H:i:s') ?>
    </div>
    
    <script>window.onload = function() { window.print(); }</script>
</body>
</html>
        <?php
        exit;
    }
    
    private function getStatusArabic(string $status): string
    {
        return match($status) {
            'active' => 'نشط',
            'completed' => 'مكتمل',
            'cancelled' => 'ملغي',
            default => $status
        };
    }
    
    private function getPaymentMethodArabic(string $method): string
    {
        return match($method) {
            'cash' => 'نقدي',
            'card' => 'بطاقة',
            'bank' => 'تحويل بنكي',
            default => $method
        };
    }
}


============================================================
FILE: app/Controllers/InstallmentController.php
============================================================
<?php
namespace App\Controllers;

use Core\Controller;
use App\Models\Installment;
use App\Models\Invoice;

/**
 * متحكم الأقساط
 */
class InstallmentController extends Controller
{
    private Installment $installmentModel;
    
    public function __construct()
    {
        parent::__construct();
        $this->requireAuth();
        $this->installmentModel = new Installment();
    }
    
    public function index(): void
    {
        $page = (int) ($_GET['page'] ?? 1);
        $perPage = (int) ($_GET['per_page'] ?? 10);
        $search = $_GET['q'] ?? '';
        $status = $_GET['status'] ?? '';
        
        $where = "WHERE i.invoice_type = 'installment'";
        $params = [];
        
        if ($search) {
            $where .= " AND (i.invoice_number LIKE ? OR c.full_name LIKE ?)";
            $params[] = "%{$search}%";
            $params[] = "%{$search}%";
        }
        
        if ($status) {
            $where .= " AND i.status = ?";
            $params[] = $status;
        }
        
        $totalCount = $this->db->fetchColumn(
            "SELECT COUNT(*) FROM invoices i LEFT JOIN customers c ON i.customer_id = c.id $where", 
            $params
        );
        $pagination = new \Core\Pagination($totalCount, $perPage, $page);
        
        $sql = "SELECT i.*, c.full_name as customer_name,
                (SELECT COUNT(*) FROM installments WHERE invoice_id = i.id AND status = 'paid') as paid_count,
                (SELECT COUNT(*) FROM installments WHERE invoice_id = i.id AND status = 'pending') as pending_count
                FROM invoices i 
                LEFT JOIN customers c ON i.customer_id = c.id 
                $where 
                ORDER BY i.id DESC 
                LIMIT {$pagination->getLimit()} OFFSET {$pagination->getOffset()}";
        
        $invoices = $this->db->fetchAll($sql, $params);
        
        $this->view('installments/index', [
            'pageTitle' => 'إدارة الأقساط',
            'invoices' => $invoices,
            'pagination' => $pagination,
            'search' => $search,
            'status' => $status
        ]);
    }
    
    public function today(): void
    {
        $installments = $this->installmentModel->getToday();
        
        $this->view('installments/today', [
            'pageTitle' => 'أقساط اليوم',
            'installments' => $installments
        ]);
    }
    
    public function overdue(): void
    {
        $page = (int) ($_GET['page'] ?? 1);
        $perPage = (int) ($_GET['per_page'] ?? 10);
        
        // Include 'overdue' status since updateOverdueStatus() changes pending/partial to 'overdue'
        $totalCount = $this->db->fetchColumn(
            "SELECT COUNT(*) FROM installments WHERE status IN ('pending', 'partial', 'overdue') AND due_date < date('now')"
        );
        $pagination = new \Core\Pagination($totalCount, $perPage, $page);
        
        $installments = $this->db->fetchAll(
            "SELECT inst.*, i.invoice_number, c.full_name as customer_name, c.phone as customer_phone,
                    julianday('now') - julianday(inst.due_date) as days_overdue
             FROM installments inst
             JOIN invoices i ON inst.invoice_id = i.id
             JOIN customers c ON i.customer_id = c.id
             WHERE inst.status IN ('pending', 'partial', 'overdue') AND inst.due_date < date('now')
             ORDER BY inst.due_date ASC
             LIMIT {$pagination->getLimit()} OFFSET {$pagination->getOffset()}"
        );
        
        $total = $this->db->fetchColumn(
            "SELECT SUM(remaining_amount) FROM installments WHERE status IN ('pending', 'partial', 'overdue') AND due_date < date('now')"
        );
        
        $this->view('installments/overdue', [
            'pageTitle' => 'الأقساط المتأخرة',
            'installments' => $installments,
            'pagination' => $pagination,
            'total' => $total ?? 0
        ]);
    }
    
    public function upcoming(): void
    {
        $days = (int) $this->input('days', 7);
        $installments = $this->installmentModel->getUpcoming($days);
        
        $this->view('installments/upcoming', [
            'pageTitle' => 'الأقساط القادمة',
            'installments' => $installments,
            'days' => $days
        ]);
    }
    
    public function show(int $id): void
    {
        $installment = $this->installmentModel->getWithDetails($id);
        
        if (!$installment) {
            $this->error('القسط غير موجود');
            $this->redirect(url('/installments'));
            return;
        }
        
        // جلب مدفوعات هذا القسط
        $payments = $this->db->fetchAll(
            "SELECT p.*, u.full_name as user_name 
             FROM payments p 
             LEFT JOIN users u ON p.user_id = u.id 
             WHERE p.installment_id = ? 
             ORDER BY p.payment_date DESC",
            [$id]
        );
        
        $this->view('installments/show', [
            'pageTitle' => 'تفاصيل القسط',
            'installment' => $installment,
            'payments' => $payments
        ]);
    }
    
    public function pay(int $id): void
    {
        $installment = $this->installmentModel->find($id);
        
        if (!$installment) {
            $this->json(['success' => false, 'message' => 'القسط غير موجود'], 404);
            return;
        }
        
        $amount = (float) $this->input('amount');
        
        if ($amount <= 0) {
            $this->json(['success' => false, 'message' => 'المبلغ غير صالح'], 400);
            return;
        }
        
        if ($amount > $installment['remaining_amount']) {
            $amount = $installment['remaining_amount'];
        }
        
        try {
            $this->installmentModel->pay($id, $amount, $_SESSION['user_id']);
            
            $this->logActivity('payment', 'installment', $id, "سداد قسط بمبلغ {$amount}");
            
            $this->json([
                'success' => true,
                'message' => 'تم تسجيل الدفعة بنجاح',
                'receipt_number' => $this->db->fetchColumn(
                    "SELECT receipt_number FROM payments WHERE installment_id = ? ORDER BY id DESC LIMIT 1",
                    [$id]
                )
            ]);
            
        } catch (\Exception $e) {
            $this->json(['success' => false, 'message' => 'حدث خطأ: ' . $e->getMessage()], 500);
        }
    }
}


============================================================
FILE: app/Controllers/InvoiceController.php
============================================================
<?php
namespace App\Controllers;

use Core\Controller;
use App\Models\Invoice;
use App\Models\Product;
use App\Models\Customer;
use App\Models\Category;
use App\Models\InstallmentPlan;
use App\Models\Installment;

/**
 * ╔══════════════════════════════════════════════════════════════════╗
 * ║                    نظام تقسيط - متحكم الفواتير                    ║
 * ╚══════════════════════════════════════════════════════════════════╝
 */
class InvoiceController extends Controller
{
    private Invoice $invoiceModel;
    private Product $productModel;
    private Customer $customerModel;
    
    public function __construct()
    {
        parent::__construct();
        $this->requireAuth();
        $this->invoiceModel = new Invoice();
        $this->productModel = new Product();
        $this->customerModel = new Customer();
    }
    
    /**
     * قائمة الفواتير
     */
    public function index(): void
    {
        $page = (int) ($_GET['page'] ?? 1);
        $perPage = (int) ($_GET['per_page'] ?? 10);
        $search = $_GET['q'] ?? '';
        $type = $_GET['type'] ?? '';
        $status = $_GET['status'] ?? '';
        
        $where = "WHERE 1=1";
        $params = [];
        
        if ($search) {
            $where .= " AND (i.invoice_number LIKE ? OR c.full_name LIKE ?)";
            $params[] = "%{$search}%";
            $params[] = "%{$search}%";
        }
        
        if ($type) {
            $where .= " AND i.invoice_type = ?";
            $params[] = $type;
        }
        
        if ($status) {
            $where .= " AND i.status = ?";
            $params[] = $status;
        }
        
        $totalCount = $this->db->fetchColumn(
            "SELECT COUNT(*) FROM invoices i LEFT JOIN customers c ON i.customer_id = c.id $where", 
            $params
        );
        $pagination = new \Core\Pagination($totalCount, $perPage, $page);
        
        $sql = "SELECT i.*, c.full_name as customer_name, u.full_name as user_name
                FROM invoices i 
                LEFT JOIN customers c ON i.customer_id = c.id 
                LEFT JOIN users u ON i.user_id = u.id
                $where 
                ORDER BY i.id DESC 
                LIMIT {$pagination->getLimit()} OFFSET {$pagination->getOffset()}";
        
        $invoices = $this->db->fetchAll($sql, $params);
        
        $this->view('invoices/index', [
            'pageTitle' => 'الفواتير',
            'invoices' => $invoices,
            'pagination' => $pagination,
            'search' => $search,
            'type' => $type,
            'status' => $status
        ]);
    }
    
    /**
     * نقطة البيع - نقدي
     */
    public function pos(): void
    {
        $categoryModel = new Category();
        
        $products = $this->productModel->getActive();
        $categories = $categoryModel->getActive();
        $customers = $this->customerModel->all('full_name');
        
        $this->view('pos/index', [
            'pageTitle' => 'نقطة البيع',
            'products' => $products,
            'categories' => $categories,
            'customers' => $customers
        ]);
    }
    
    /**
     * نقطة البيع - تقسيط
     */
    public function posInstallment(): void
    {
        $categoryModel = new Category();
        $planModel = new InstallmentPlan();
        
        $products = $this->productModel->getActive();
        $categories = $categoryModel->getActive();
        $customers = $this->customerModel->all('full_name');
        $plans = $planModel->getActive();
        
        $this->view('pos/installment', [
            'pageTitle' => 'بيع بالتقسيط',
            'products' => $products,
            'categories' => $categories,
            'customers' => $customers,
            'plans' => $plans
        ]);
    }
    
    /**
     * حفظ فاتورة نقدي
     */
    public function storeCash(): void
    {
        $items = json_decode($this->input('items'), true);
        
        if (empty($items)) {
            $this->error('يجب إضافة منتجات للفاتورة');
            $this->redirect(url('/pos'));
            return;
        }
        
        $this->db->beginTransaction();
        
        try {
            $subtotal = 0;
            foreach ($items as $item) {
                $subtotal += $item['price'] * $item['quantity'];
            }
            
            $discount = (float) $this->input('discount', 0);
            $total = $subtotal - $discount;
            
            // إنشاء الفاتورة
            $invoiceId = $this->invoiceModel->create([
                'invoice_number' => $this->invoiceModel->generateNumber(),
                'invoice_type' => 'cash',
                'customer_id' => $this->input('customer_id') ?: null,
                'user_id' => $_SESSION['user_id'],
                'subtotal' => $subtotal,
                'discount_amount' => $discount,
                'total_amount' => $total,
                'paid_amount' => $total,
                'remaining_amount' => 0,
                'status' => 'completed',
                'notes' => $this->input('notes')
            ]);
            
            // إضافة البنود
            foreach ($items as $item) {
                $product = $this->productModel->find($item['id']);
                
                $this->db->insert('invoice_items', [
                    'invoice_id' => $invoiceId,
                    'product_id' => $item['id'],
                    'product_name' => $product['name'],
                    'quantity' => $item['quantity'],
                    'unit_price' => $item['price'],
                    'total_price' => $item['price'] * $item['quantity'],
                    'serial_number' => $item['serial'] ?? null,
                    'created_at' => date('Y-m-d H:i:s')
                ]);
                
                // تحديث المخزون
                $this->productModel->updateQuantity($item['id'], -$item['quantity']);
            }
            
            // تسجيل الدفع
            $this->db->insert('payments', [
                'invoice_id' => $invoiceId,
                'amount' => $total,
                'payment_method' => $this->input('payment_method', 'cash'),
                'receipt_number' => generateReceiptNumber(),
                'user_id' => $_SESSION['user_id'],
                'created_at' => date('Y-m-d H:i:s')
            ]);
            
            $this->db->commit();
            
            $this->logActivity('create', 'invoice', $invoiceId, 'فاتورة نقدي جديدة');
            $this->success('تم إنشاء الفاتورة بنجاح');
            $this->redirect(url("/invoices/{$invoiceId}/print"));
            
        } catch (\Exception $e) {
            $this->db->rollback();
            $this->error('حدث خطأ: ' . $e->getMessage());
            $this->redirect(url('/pos'));
        }
    }
    
    /**
     * حفظ فاتورة تقسيط
     */
    public function storeInstallment(): void
    {
        $items = json_decode($this->input('items'), true);
        $customerId = $this->input('customer_id');
        $planId = $this->input('plan_id');
        $downPayment = (float) $this->input('down_payment', 0);
        
        if (empty($items)) {
            $this->error('يجب إضافة منتجات للفاتورة');
            $this->redirect(url('/pos/installment'));
            return;
        }
        
        if (!$customerId) {
            $this->error('يجب اختيار عميل للتقسيط');
            $this->redirect(url('/pos/installment'));
            return;
        }
        
        if (!$planId) {
            $this->error('يجب اختيار خطة تقسيط');
            $this->redirect(url('/pos/installment'));
            return;
        }
        
        $planModel = new InstallmentPlan();
        $plan = $planModel->find($planId);
        
        $this->db->beginTransaction();
        
        try {
            // حساب المجموع
            $subtotal = 0;
            foreach ($items as $item) {
                $subtotal += $item['price'] * $item['quantity'];
            }
            
            // حساب سعر التقسيط
            $increasePercent = $plan['increase_percent'] / 100;
            $installmentTotal = $subtotal * (1 + $increasePercent);
            
            // حساب القسط الشهري
            $remaining = $installmentTotal - $downPayment;
            $monthlyInstallment = round($remaining / $plan['months'], 2);
            
            // تاريخ أول قسط
            $firstInstallmentDate = date('Y-m-d', strtotime('+1 month'));
            
            // إنشاء الفاتورة
            $invoiceId = $this->invoiceModel->create([
                'invoice_number' => $this->invoiceModel->generateNumber(),
                'invoice_type' => 'installment',
                'customer_id' => $customerId,
                'user_id' => $_SESSION['user_id'],
                'subtotal' => $subtotal,
                'total_amount' => $installmentTotal,
                'paid_amount' => $downPayment,
                'remaining_amount' => $remaining,
                'installment_plan_id' => $planId,
                'down_payment' => $downPayment,
                'monthly_installment' => $monthlyInstallment,
                'installments_count' => $plan['months'],
                'first_installment_date' => $firstInstallmentDate,
                'status' => 'active',
                'notes' => $this->input('notes')
            ]);
            
            // إضافة البنود
            foreach ($items as $item) {
                $product = $this->productModel->find($item['id']);
                
                $this->db->insert('invoice_items', [
                    'invoice_id' => $invoiceId,
                    'product_id' => $item['id'],
                    'product_name' => $product['name'],
                    'quantity' => $item['quantity'],
                    'unit_price' => $item['price'],
                    'total_price' => $item['price'] * $item['quantity'],
                    'serial_number' => $item['serial'] ?? null,
                    'warranty_end_date' => $product['warranty_months'] ? date('Y-m-d', strtotime("+{$product['warranty_months']} months")) : null,
                    'created_at' => date('Y-m-d H:i:s')
                ]);
                
                // تحديث المخزون
                $this->productModel->updateQuantity($item['id'], -$item['quantity']);
            }
            
            // إنشاء جدول الأقساط
            for ($i = 1; $i <= $plan['months']; $i++) {
                $dueDate = date('Y-m-d', strtotime("+{$i} months"));
                
                $this->db->insert('installments', [
                    'invoice_id' => $invoiceId,
                    'installment_number' => $i,
                    'amount' => $monthlyInstallment,
                    'due_date' => $dueDate,
                    'remaining_amount' => $monthlyInstallment,
                    'status' => 'pending',
                    'created_at' => date('Y-m-d H:i:s'),
                    'updated_at' => date('Y-m-d H:i:s')
                ]);
            }
            
            // تسجيل الدفعة المقدمة
            if ($downPayment > 0) {
                $this->db->insert('payments', [
                    'invoice_id' => $invoiceId,
                    'amount' => $downPayment,
                    'payment_method' => 'cash',
                    'receipt_number' => generateReceiptNumber(),
                    'user_id' => $_SESSION['user_id'],
                    'notes' => 'دفعة مقدمة',
                    'created_at' => date('Y-m-d H:i:s')
                ]);
            }
            
            $this->db->commit();
            
            $this->logActivity('create', 'invoice', $invoiceId, 'فاتورة تقسيط جديدة');
            $this->success('تم إنشاء عقد التقسيط بنجاح');
            $this->redirect(url("/invoices/{$invoiceId}/contract"));
            
        } catch (\Exception $e) {
            $this->db->rollback();
            $this->error('حدث خطأ: ' . $e->getMessage());
            $this->redirect(url('/pos/installment'));
        }
    }
    
    /**
     * عرض فاتورة
     */
    public function show(int $id): void
    {
        $invoice = $this->invoiceModel->getWithDetails($id);
        
        if (!$invoice) {
            $this->error('الفاتورة غير موجودة');
            $this->redirect(url('/invoices'));
            return;
        }
        
        $this->view('invoices/show', [
            'pageTitle' => 'فاتورة رقم ' . $invoice['invoice_number'],
            'invoice' => $invoice
        ]);
    }
    
    /**
     * طباعة فاتورة
     */
    public function print(int $id): void
    {
        $invoice = $this->invoiceModel->getWithDetails($id);
        
        if (!$invoice) {
            $this->error('الفاتورة غير موجودة');
            $this->redirect(url('/invoices'));
            return;
        }
        
        $this->viewOnly('invoices/print', [
            'invoice' => $invoice,
            'settings' => $this->getSettings()
        ]);
    }
    
    /**
     * عقد التقسيط
     */
    public function contract(int $id): void
    {
        $invoice = $this->invoiceModel->getWithDetails($id);
        
        if (!$invoice || $invoice['invoice_type'] !== 'installment') {
            $this->error('العقد غير موجود');
            $this->redirect(url('/invoices'));
            return;
        }
        
        $this->viewOnly('invoices/contract', [
            'invoice' => $invoice,
            'settings' => $this->getSettings()
        ]);
    }
    
    /**
     * صفحة تعديل فاتورة
     */
    public function edit(int $id): void
    {
        $invoice = $this->invoiceModel->getWithDetails($id);
        
        if (!$invoice) {
            $this->error('الفاتورة غير موجودة');
            $this->redirect(url('/invoices'));
            return;
        }
        
        // لا يمكن تعديل الفواتير الملغية
        if ($invoice['status'] === 'cancelled') {
            $this->error('لا يمكن تعديل فاتورة ملغية');
            $this->redirect(url('/invoices/' . $id));
            return;
        }
        
        $categoryModel = new Category();
        
        $products = $this->productModel->getActive();
        $categories = $categoryModel->getActive();
        $customers = $this->customerModel->all('full_name');
        
        $this->view('invoices/edit', [
            'pageTitle' => 'تعديل فاتورة ' . $invoice['invoice_number'],
            'invoice' => $invoice,
            'products' => $products,
            'categories' => $categories,
            'customers' => $customers
        ]);
    }
    
    /**
     * تحديث فاتورة
     */
    public function update(int $id): void
    {
        $invoice = $this->invoiceModel->find($id);
        
        if (!$invoice) {
            $this->error('الفاتورة غير موجودة');
            $this->redirect(url('/invoices'));
            return;
        }
        
        // لا يمكن تعديل الفواتير الملغية
        if ($invoice['status'] === 'cancelled') {
            $this->error('لا يمكن تعديل فاتورة ملغية');
            $this->redirect(url('/invoices/' . $id));
            return;
        }
        
        $this->db->beginTransaction();
        
        try {
            // للفواتير النقدية: تعديل كامل
            if ($invoice['invoice_type'] === 'cash') {
                $items = json_decode($this->input('items'), true);
                
                if (empty($items)) {
                    $this->error('يجب إضافة منتجات للفاتورة');
                    $this->redirect(url('/invoices/' . $id . '/edit'));
                    return;
                }
                
                // إرجاع المخزون القديم
                $oldItems = $this->invoiceModel->getItems($id);
                foreach ($oldItems as $item) {
                    $this->productModel->updateQuantity($item['product_id'], $item['quantity']);
                }
                
                // حذف البنود القديمة
                $this->db->delete('invoice_items', 'invoice_id = ?', [$id]);
                
                // حساب المجموع الجديد
                $subtotal = 0;
                foreach ($items as $item) {
                    $subtotal += $item['price'] * $item['quantity'];
                }
                
                $discount = (float) $this->input('discount', 0);
                $total = $subtotal - $discount;
                
                // تحديث الفاتورة
                $this->invoiceModel->update($id, [
                    'customer_id' => $this->input('customer_id') ?: null,
                    'subtotal' => $subtotal,
                    'discount_amount' => $discount,
                    'total_amount' => $total,
                    'paid_amount' => $total,
                    'notes' => $this->input('notes')
                ]);
                
                // إضافة البنود الجديدة
                foreach ($items as $item) {
                    $product = $this->productModel->find($item['id']);
                    
                    $this->db->insert('invoice_items', [
                        'invoice_id' => $id,
                        'product_id' => $item['id'],
                        'product_name' => $product['name'],
                        'quantity' => $item['quantity'],
                        'unit_price' => $item['price'],
                        'total_price' => $item['price'] * $item['quantity'],
                        'serial_number' => $item['serial'] ?? null,
                        'created_at' => date('Y-m-d H:i:s')
                    ]);
                    
                    // خصم من المخزون
                    $this->productModel->updateQuantity($item['id'], -$item['quantity']);
                }
            } else {
                // فواتير التقسيط: تعديل الملاحظات فقط
                $this->invoiceModel->update($id, [
                    'notes' => $this->input('notes')
                ]);
            }
            
            $this->db->commit();
            
            $this->logActivity('update', 'invoice', $id, 'تعديل فاتورة');
            $this->success('تم تحديث الفاتورة بنجاح');
            $this->redirect(url('/invoices/' . $id));
            
        } catch (\Exception $e) {
            $this->db->rollback();
            $this->error('حدث خطأ: ' . $e->getMessage());
            $this->redirect(url('/invoices/' . $id . '/edit'));
        }
    }
    
    /**
     * إلغاء فاتورة
     */
    public function cancel(int $id): void
    {
        $this->requireRole(['admin']);
        
        $invoice = $this->invoiceModel->find($id);
        
        if (!$invoice) {
            $this->error('الفاتورة غير موجودة');
            $this->redirect(url('/invoices'));
            return;
        }
        
        $this->invoiceModel->update($id, ['status' => 'cancelled']);
        
        // إرجاع المخزون
        $items = $this->invoiceModel->getItems($id);
        foreach ($items as $item) {
            $this->productModel->updateQuantity($item['product_id'], $item['quantity']);
        }
        
        $this->logActivity('cancel', 'invoice', $id, 'إلغاء فاتورة');
        $this->success('تم إلغاء الفاتورة');
        $this->redirect(url('/invoices'));
    }
    
    /**
     * حساب التقسيط (AJAX)
     */
    public function calculateInstallment(): void
    {
        $total = (float) $this->input('total');
        $planId = (int) $this->input('plan_id');
        $downPayment = (float) $this->input('down_payment', 0);
        
        $planModel = new InstallmentPlan();
        $plan = $planModel->find($planId);
        
        if (!$plan) {
            $this->json(['error' => 'خطة التقسيط غير موجودة'], 404);
            return;
        }
        
        $increasePercent = $plan['increase_percent'] / 100;
        $installmentTotal = $total * (1 + $increasePercent);
        $minDownPayment = $installmentTotal * ($plan['min_down_payment_percent'] / 100);
        
        if ($downPayment < $minDownPayment) {
            $downPayment = $minDownPayment;
        }
        
        $remaining = $installmentTotal - $downPayment;
        $monthlyInstallment = round($remaining / $plan['months'], 2);
        
        $this->json([
            'cash_price' => $total,
            'installment_total' => round($installmentTotal, 2),
            'increase_amount' => round($installmentTotal - $total, 2),
            'min_down_payment' => round($minDownPayment, 2),
            'down_payment' => round($downPayment, 2),
            'remaining' => round($remaining, 2),
            'monthly_installment' => $monthlyInstallment,
            'months' => $plan['months'],
            'plan' => $plan
        ]);
    }
    
    /**
     * حذف فاتورة
     */
    public function destroy(int $id): void
    {
        $this->requireRole(['admin']);
        
        $invoice = $this->invoiceModel->find($id);
        
        if (!$invoice) {
            $this->error('الفاتورة غير موجودة');
            $this->redirect(url('/invoices'));
            return;
        }
        
        $this->db->beginTransaction();
        
        try {
            // إرجاع المخزون
            $items = $this->invoiceModel->getItems($id);
            foreach ($items as $item) {
                $this->productModel->updateQuantity($item['product_id'], $item['quantity']);
            }
            
            // حذف البيانات المرتبطة
            $this->db->delete('invoice_items', 'invoice_id = ?', [$id]);
            $this->db->delete('installments', 'invoice_id = ?', [$id]);
            $this->db->delete('payments', 'invoice_id = ?', [$id]);
            
            // حذف الفاتورة
            $this->invoiceModel->delete($id);
            
            $this->db->commit();
            
            $this->logActivity('delete', 'invoice', $id, 'حذف فاتورة: ' . $invoice['invoice_number']);
            $this->success('تم حذف الفاتورة بنجاح');
            
        } catch (\Exception $e) {
            $this->db->rollback();
            $this->error('حدث خطأ أثناء الحذف: ' . $e->getMessage());
        }
        
        $this->redirect(url('/invoices'));
    }
    
    /**
     * حذف متعدد للفواتير
     */
    public function bulkDelete(): void
    {
        $this->requireRole(['admin']);
        
        $ids = $this->input('ids', []);
        
        if (empty($ids)) {
            $this->json(['success' => false, 'message' => 'لم يتم تحديد أي فواتير']);
            return;
        }
        
        if (!is_array($ids)) {
            $ids = explode(',', $ids);
        }
        
        $ids = array_map('intval', $ids);
        $deletedCount = 0;
        $errors = [];
        
        foreach ($ids as $id) {
            $invoice = $this->invoiceModel->find($id);
            if (!$invoice) {
                continue;
            }
            
            $this->db->beginTransaction();
            
            try {
                // إرجاع المخزون
                $items = $this->invoiceModel->getItems($id);
                foreach ($items as $item) {
                    $this->productModel->updateQuantity($item['product_id'], $item['quantity']);
                }
                
                // حذف البيانات المرتبطة
                $this->db->delete('invoice_items', 'invoice_id = ?', [$id]);
                $this->db->delete('installments', 'invoice_id = ?', [$id]);
                $this->db->delete('payments', 'invoice_id = ?', [$id]);
                
                // حذف الفاتورة
                $this->invoiceModel->delete($id);
                
                $this->db->commit();
                
                $this->logActivity('delete', 'invoice', $id, 'حذف فاتورة (حذف متعدد): ' . $invoice['invoice_number']);
                $deletedCount++;
                
            } catch (\Exception $e) {
                $this->db->rollback();
                $errors[] = $invoice['invoice_number'];
            }
        }
        
        if ($deletedCount > 0) {
            $message = "تم حذف {$deletedCount} فاتورة بنجاح";
            if (!empty($errors)) {
                $message .= " (فشل حذف: " . implode(', ', $errors) . ")";
            }
            $this->json(['success' => true, 'message' => $message]);
        } else {
            $this->json(['success' => false, 'message' => 'لم يتم حذف أي فاتورة']);
        }
    }
}


============================================================
FILE: app/Controllers/NotificationController.php
============================================================
<?php

namespace App\Controllers;

use Core\Controller;

class NotificationController extends Controller
{
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * عرض التنبيهات
     */
    public function index(): void
    {
        $db = \Core\Database::getInstance();
        
        // الأقساط المتأخرة
        $overdueCount = $db->fetchColumn(
            "SELECT COUNT(*) FROM installments 
             WHERE status IN ('pending', 'partial') AND due_date < date('now')"
        );
        
        // أقساط اليوم
        $todayCount = $db->fetchColumn(
            "SELECT COUNT(*) FROM installments 
             WHERE status IN ('pending', 'partial') AND due_date = date('now')"
        );
        
        // منتجات منخفضة المخزون
        $lowStockCount = $db->fetchColumn(
            "SELECT COUNT(*) FROM products WHERE quantity <= min_quantity AND is_active = 1"
        );

        $notifications = [];
        
        if ($overdueCount > 0) {
            $notifications[] = [
                'type' => 'danger',
                'icon' => 'warning',
                'title' => 'أقساط متأخرة',
                'message' => "يوجد {$overdueCount} قسط متأخر عن السداد",
                'link' => url('/installments/overdue')
            ];
        }
        
        if ($todayCount > 0) {
            $notifications[] = [
                'type' => 'primary',
                'icon' => 'event',
                'title' => 'أقساط اليوم',
                'message' => "يوجد {$todayCount} قسط مستحق اليوم",
                'link' => url('/installments/today')
            ];
        }
        
        if ($lowStockCount > 0) {
            $notifications[] = [
                'type' => 'warning',
                'icon' => 'inventory',
                'title' => 'مخزون منخفض',
                'message' => "يوجد {$lowStockCount} منتج بمخزون منخفض",
                'link' => url('/reports/inventory')
            ];
        }

        $this->view('notifications/index', [
            'title' => 'التنبيهات',
            'notifications' => $notifications
        ]);
    }

    /**
     * تحديد كمقروء
     */
    public function markAsRead(int $id): void
    {
        header('Location: ' . url('/notifications'));
        exit;
    }

    /**
     * تحديد الكل كمقروء
     */
    public function markAllAsRead(): void
    {
        $_SESSION['flash']['success'] = 'تم تحديد جميع التنبيهات كمقروءة';
        header('Location: ' . url('/notifications'));
        exit;
    }
}


============================================================
FILE: app/Controllers/PaymentController.php
============================================================
<?php
namespace App\Controllers;

use Core\Controller;
use App\Models\Payment;

class PaymentController extends Controller
{
    private Payment $paymentModel;
    
    public function __construct()
    {
        parent::__construct();
        $this->requireAuth();
        $this->paymentModel = new Payment();
    }
    
    public function index(): void
    {
        $from = $this->input('from', date('Y-m-01'));
        $to = $this->input('to', date('Y-m-d'));
        $page = (int) ($_GET['page'] ?? 1);
        $perPage = (int) ($_GET['per_page'] ?? 10);
        
        // Count total
        $totalCount = $this->db->fetchColumn(
            "SELECT COUNT(*) FROM payments p WHERE DATE(p.payment_date) >= ? AND DATE(p.payment_date) <= ?",
            [$from, $to]
        );
        
        $pagination = new \Core\Pagination($totalCount, $perPage, $page);
        
        // Get paginated payments
        $payments = $this->db->fetchAll(
            "SELECT p.*, i.invoice_number, c.full_name as customer_name, u.full_name as user_name
             FROM payments p
             INNER JOIN invoices i ON p.invoice_id = i.id
             LEFT JOIN customers c ON i.customer_id = c.id
             LEFT JOIN users u ON p.user_id = u.id
             WHERE DATE(p.payment_date) >= ? AND DATE(p.payment_date) <= ?
             ORDER BY p.payment_date DESC
             LIMIT {$pagination->getLimit()} OFFSET {$pagination->getOffset()}",
            [$from, $to]
        );
        
        $total = $this->paymentModel->getTotalByDateRange($from, $to);
        
        $this->view('payments/index', [
            'pageTitle' => 'سجل المدفوعات',
            'payments' => $payments,
            'total' => $total,
            'from' => $from,
            'to' => $to,
            'pagination' => $pagination
        ]);
    }
    
    public function receipt(int $id): void
    {
        $payment = $this->db->fetch(
            "SELECT p.*, i.invoice_number, c.full_name as customer_name, 
                    c.phone as customer_phone, u.full_name as user_name
             FROM payments p
             INNER JOIN invoices i ON p.invoice_id = i.id
             LEFT JOIN customers c ON i.customer_id = c.id
             LEFT JOIN users u ON p.user_id = u.id
             WHERE p.id = ?",
            [$id]
        );
        
        if (!$payment) {
            $this->error('الإيصال غير موجود');
            $this->redirect(url('/payments'));
            return;
        }
        
        $this->viewOnly('payments/receipt', [
            'payment' => $payment,
            'settings' => $this->getSettings()
        ]);
    }
}


============================================================
FILE: app/Controllers/ProductController.php
============================================================
<?php
namespace App\Controllers;

use Core\Controller;
use App\Models\Product;
use App\Models\Category;

/**
 * ╔══════════════════════════════════════════════════════════════════╗
 * ║                    نظام تقسيط - متحكم المنتجات                    ║
 * ╚══════════════════════════════════════════════════════════════════╝
 */
class ProductController extends Controller
{
    private Product $productModel;
    private Category $categoryModel;
    
    public function __construct()
    {
        parent::__construct();
        $this->requireAuth();
        $this->productModel = new Product();
        $this->categoryModel = new Category();
    }
    
    /**
     * قائمة المنتجات
     */
    public function index(): void
    {
        $page = (int) ($_GET['page'] ?? 1);
        $perPage = (int) ($_GET['per_page'] ?? 10);
        $search = $_GET['q'] ?? '';
        $categoryId = $_GET['category'] ?? '';
        
        // بناء الاستعلام
        $where = "WHERE 1=1";
        $params = [];
        
        if ($search) {
            $where .= " AND (p.name LIKE ? OR p.barcode LIKE ?)";
            $params[] = "%{$search}%";
            $params[] = "%{$search}%";
        }
        
        if ($categoryId) {
            $where .= " AND p.category_id = ?";
            $params[] = $categoryId;
        }
        
        // عدد المنتجات الإجمالي
        $totalCount = $this->db->fetchColumn("SELECT COUNT(*) FROM products p $where", $params);
        
        // إنشاء Pagination
        $pagination = new \Core\Pagination($totalCount, $perPage, $page);
        
        // جلب المنتجات مع الـ Limit
        $sql = "SELECT p.*, c.name as category_name 
                FROM products p 
                LEFT JOIN categories c ON p.category_id = c.id 
                $where 
                ORDER BY p.id DESC 
                LIMIT {$pagination->getLimit()} OFFSET {$pagination->getOffset()}";
        
        $products = $this->db->fetchAll($sql, $params);
        $categories = $this->categoryModel->getActive();
        
        $this->view('products/index', [
            'pageTitle' => 'إدارة المنتجات',
            'products' => $products,
            'categories' => $categories,
            'pagination' => $pagination,
            'search' => $search,
            'categoryId' => $categoryId
        ]);
    }
    
    /**
     * صفحة إضافة منتج
     */
    public function create(): void
    {
        $this->requireRole(['admin']);
        
        $categories = $this->categoryModel->getActive();
        
        $this->view('products/create', [
            'pageTitle' => 'إضافة منتج جديد',
            'categories' => $categories
        ]);
    }
    
    /**
     * حفظ منتج جديد
     */
    public function store(): void
    {
        $this->requireRole(['admin']);
        
        $data = [
            'name' => $this->input('name'),
            'description' => $this->input('description'),
            'category_id' => $this->input('category_id') ?: null,
            'barcode' => $this->input('barcode') ?: null,
            'sku' => $this->input('sku') ?: null,
            'cash_price' => (float) $this->input('cash_price'),
            'installment_price' => (float) $this->input('installment_price') ?: null,
            'cost_price' => (float) $this->input('cost_price') ?: null,
            'quantity' => (int) $this->input('quantity', 0),
            'min_quantity' => (int) $this->input('min_quantity', 5),
            'brand' => $this->input('brand'),
            'model' => $this->input('model'),
            'warranty_months' => (int) $this->input('warranty_months', 0),
            'is_active' => $this->input('is_active') ? 1 : 0
        ];
        
        // رفع الصورة
        if (!empty($_FILES['image']['name'])) {
            $data['image'] = $this->uploadImage($_FILES['image']);
        }
        
        // حساب سعر التقسيط التلقائي إن لم يُحدد
        if (empty($data['installment_price'])) {
            $data['installment_price'] = $data['cash_price'] * 1.15; // زيادة 15%
        }
        
        $id = $this->productModel->create($data);
        
        $this->logActivity('create', 'product', $id, 'إضافة منتج: ' . $data['name']);
        $this->success('تم إضافة المنتج بنجاح');
        $this->redirect(url('/products'));
    }
    
    /**
     * عرض منتج
     */
    public function show(int $id): void
    {
        $product = $this->productModel->find($id);
        
        if (!$product) {
            $this->error('المنتج غير موجود');
            $this->redirect(url('/products'));
            return;
        }
        
        // جلب التصنيف
        if ($product['category_id']) {
            $product['category'] = $this->categoryModel->find($product['category_id']);
        }
        
        $this->view('products/show', [
            'pageTitle' => $product['name'],
            'product' => $product
        ]);
    }
    
    /**
     * صفحة تعديل منتج
     */
    public function edit(int $id): void
    {
        $this->requireRole(['admin']);
        
        $product = $this->productModel->find($id);
        
        if (!$product) {
            $this->error('المنتج غير موجود');
            $this->redirect(url('/products'));
            return;
        }
        
        $categories = $this->categoryModel->getActive();
        
        $this->view('products/edit', [
            'pageTitle' => 'تعديل: ' . $product['name'],
            'product' => $product,
            'categories' => $categories
        ]);
    }
    
    /**
     * تحديث منتج
     */
    public function update(int $id): void
    {
        $this->requireRole(['admin']);
        
        $product = $this->productModel->find($id);
        
        if (!$product) {
            $this->error('المنتج غير موجود');
            $this->redirect(url('/products'));
            return;
        }
        
        $data = [
            'name' => $this->input('name'),
            'description' => $this->input('description'),
            'category_id' => $this->input('category_id') ?: null,
            'barcode' => $this->input('barcode') ?: null,
            'sku' => $this->input('sku') ?: null,
            'cash_price' => (float) $this->input('cash_price'),
            'installment_price' => (float) $this->input('installment_price') ?: null,
            'cost_price' => (float) $this->input('cost_price') ?: null,
            'quantity' => (int) $this->input('quantity', 0),
            'min_quantity' => (int) $this->input('min_quantity', 5),
            'brand' => $this->input('brand'),
            'model' => $this->input('model'),
            'warranty_months' => (int) $this->input('warranty_months', 0),
            'is_active' => $this->input('is_active') ? 1 : 0
        ];
        
        // رفع صورة جديدة
        if (!empty($_FILES['image']['name'])) {
            $data['image'] = $this->uploadImage($_FILES['image']);
            // حذف الصورة القديمة
            if ($product['image']) {
                $oldPath = dirname(dirname(__DIR__)) . '/public/uploads/products/' . $product['image'];
                if (file_exists($oldPath)) {
                    unlink($oldPath);
                }
            }
        }
        
        $this->productModel->update($id, $data);
        
        $this->logActivity('update', 'product', $id, 'تعديل منتج: ' . $data['name']);
        $this->success('تم تحديث المنتج "' . $data['name'] . '" بنجاح');
        
        // الرجوع للصفحة الأصلية إن وجدت مع تمييز المنتج المعدّل
        $return = $this->input('return', $_GET['return'] ?? '');
        if ($return === 'inventory') {
            $this->redirect(url('/reports/inventory') . '?edited=' . $id);
        } else {
            $this->redirect(url('/products'));
        }
    }
    
    /**
     * حذف منتج
     */
    public function destroy(int $id): void
    {
        $this->requireRole(['admin']);
        
        $product = $this->productModel->find($id);
        
        if (!$product) {
            $this->error('المنتج غير موجود');
            $this->redirect(url('/products'));
            return;
        }
        
        // التحقق من عدم وجود فواتير مرتبطة
        $invoiceCount = $this->db->fetchColumn(
            "SELECT COUNT(*) FROM invoice_items WHERE product_id = ?",
            [$id]
        );
        
        if ($invoiceCount > 0) {
            $this->error('لا يمكن حذف المنتج لوجود فواتير مرتبطة به');
            $this->redirect(url('/products'));
            return;
        }
        
        $this->productModel->delete($id);
        
        $this->logActivity('delete', 'product', $id, 'حذف منتج: ' . $product['name']);
        $this->success('تم حذف المنتج بنجاح');
        $this->redirect(url('/products'));
    }
    
    /**
     * حذف متعدد للمنتجات
     */
    public function bulkDelete(): void
    {
        $this->requireRole(['admin']);
        
        $ids = $this->input('ids', []);
        
        if (empty($ids)) {
            $this->json(['success' => false, 'message' => 'لم يتم تحديد أي منتجات']);
            return;
        }
        
        if (!is_array($ids)) {
            $ids = explode(',', $ids);
        }
        
        $ids = array_map('intval', $ids);
        $deletedCount = 0;
        $skippedCount = 0;
        
        foreach ($ids as $id) {
            $product = $this->productModel->find($id);
            if (!$product) {
                continue;
            }
            
            // التحقق من عدم وجود فواتير مرتبطة
            $invoiceCount = $this->db->fetchColumn(
                "SELECT COUNT(*) FROM invoice_items WHERE product_id = ?",
                [$id]
            );
            
            if ($invoiceCount > 0) {
                $skippedCount++;
                continue;
            }
            
            $this->productModel->delete($id);
            $this->logActivity('delete', 'product', $id, 'حذف منتج (حذف متعدد): ' . $product['name']);
            $deletedCount++;
        }
        
        if ($deletedCount > 0) {
            $message = "تم حذف {$deletedCount} منتج بنجاح";
            if ($skippedCount > 0) {
                $message .= " (تم تخطي {$skippedCount} لوجود فواتير مرتبطة)";
            }
            $this->json(['success' => true, 'message' => $message]);
        } else {
            $this->json(['success' => false, 'message' => 'لم يتم حذف أي منتج - جميعها لديها فواتير مرتبطة']);
        }
    }
    
    /**
     * بحث في المنتجات
     */
    public function search(): void
    {
        $query = $this->input('q', '');
        $products = $this->productModel->searchProducts($query);
        $this->json($products);
    }
    
    /**
     * البحث بالباركود
     */
    public function findByBarcode(string $code): void
    {
        $product = $this->productModel->findByBarcode($code);
        
        if ($product) {
            $this->json(['success' => true, 'product' => $product]);
        } else {
            $this->json(['success' => false, 'message' => 'المنتج غير موجود'], 404);
        }
    }
    
    /**
     * رفع صورة المنتج
     */
    private function uploadImage(array $file): ?string
    {
        $allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        
        if (!in_array($file['type'], $allowedTypes)) {
            return null;
        }
        
        $ext = pathinfo($file['name'], PATHINFO_EXTENSION);
        $filename = uniqid('product_') . '.' . $ext;
        $uploadDir = dirname(dirname(__DIR__)) . '/public/uploads/products/';
        
        if (!is_dir($uploadDir)) {
            mkdir($uploadDir, 0755, true);
        }
        
        if (move_uploaded_file($file['tmp_name'], $uploadDir . $filename)) {
            return $filename;
        }
        
        return null;
    }
}


============================================================
FILE: app/Controllers/ReportController.php
============================================================
<?php

namespace App\Controllers;

use Core\Controller;
use App\Models\Invoice;
use App\Models\Payment;
use App\Models\Installment;
use App\Models\Customer;
use App\Models\Product;

class ReportController extends Controller
{
    private Invoice $invoiceModel;
    private Payment $paymentModel;
    private Installment $installmentModel;
    private Customer $customerModel;
    private Product $productModel;

    public function __construct()
    {
        parent::__construct();
        $this->invoiceModel = new Invoice();
        $this->paymentModel = new Payment();
        $this->installmentModel = new Installment();
        $this->customerModel = new Customer();
        $this->productModel = new Product();
    }

    /**
     * صفحة التقارير الرئيسية
     */
    public function index(): void
    {
        $this->view('reports/index', [
            'title' => 'التقارير'
        ]);
    }

    /**
     * تقرير المبيعات
     */
    public function sales(): void
    {
        $from = $_GET['from'] ?? date('Y-m-01');
        $to = $_GET['to'] ?? date('Y-m-d');
        $page = (int) ($_GET['page'] ?? 1);
        $perPage = (int) ($_GET['per_page'] ?? 10);

        $db = \Core\Database::getInstance();
        
        $totalCount = $db->fetchColumn(
            "SELECT COUNT(*) FROM invoices WHERE DATE(created_at) >= ? AND DATE(created_at) <= ?",
            [$from, $to]
        );
        
        $pagination = new \Core\Pagination($totalCount, $perPage, $page);
        
        $invoices = $db->fetchAll(
            "SELECT i.*, c.full_name as customer_name 
             FROM invoices i 
             LEFT JOIN customers c ON i.customer_id = c.id 
             WHERE DATE(i.created_at) >= ? AND DATE(i.created_at) <= ?
             ORDER BY i.created_at DESC
             LIMIT {$pagination->getLimit()} OFFSET {$pagination->getOffset()}",
            [$from, $to]
        );

        // Get totals (full, not paginated)
        $totals = $db->fetch(
            "SELECT 
                SUM(CASE WHEN invoice_type = 'cash' THEN total_amount ELSE 0 END) as total_cash,
                SUM(CASE WHEN invoice_type = 'installment' THEN total_amount ELSE 0 END) as total_installment
             FROM invoices 
             WHERE DATE(created_at) >= ? AND DATE(created_at) <= ?",
            [$from, $to]
        );

        $this->view('reports/sales', [
            'title' => 'تقرير المبيعات',
            'invoices' => $invoices,
            'from' => $from,
            'to' => $to,
            'totalCash' => $totals['total_cash'] ?? 0,
            'totalInstallment' => $totals['total_installment'] ?? 0,
            'total' => ($totals['total_cash'] ?? 0) + ($totals['total_installment'] ?? 0),
            'pagination' => $pagination
        ]);
    }

    /**
     * تقرير التحصيلات
     */
    public function collections(): void
    {
        $from = $_GET['from'] ?? date('Y-m-01');
        $to = $_GET['to'] ?? date('Y-m-d');
        $page = (int) ($_GET['page'] ?? 1);
        $perPage = (int) ($_GET['per_page'] ?? 10);

        $db = \Core\Database::getInstance();
        
        $totalCount = $db->fetchColumn(
            "SELECT COUNT(*) FROM payments p WHERE DATE(p.payment_date) >= ? AND DATE(p.payment_date) <= ?",
            [$from, $to]
        );
        $pagination = new \Core\Pagination($totalCount, $perPage, $page);
        
        $payments = $db->fetchAll(
            "SELECT p.*, i.invoice_number, c.full_name as customer_name
             FROM payments p
             LEFT JOIN invoices i ON p.invoice_id = i.id
             LEFT JOIN customers c ON i.customer_id = c.id
             WHERE DATE(p.payment_date) >= ? AND DATE(p.payment_date) <= ?
             ORDER BY p.payment_date DESC
             LIMIT {$pagination->getLimit()} OFFSET {$pagination->getOffset()}",
            [$from, $to]
        );
        
        $total = $db->fetchColumn(
            "SELECT SUM(amount) FROM payments WHERE DATE(payment_date) >= ? AND DATE(payment_date) <= ?",
            [$from, $to]
        );

        $this->view('reports/collections', [
            'title' => 'تقرير التحصيلات',
            'payments' => $payments,
            'from' => $from,
            'to' => $to,
            'total' => $total ?? 0,
            'pagination' => $pagination
        ]);
    }

    /**
     * تقرير المتأخرات
     */
    public function overdue(): void
    {
        $page = (int) ($_GET['page'] ?? 1);
        $perPage = (int) ($_GET['per_page'] ?? 10);
        
        $db = \Core\Database::getInstance();
        
        // Include 'overdue' status since updateOverdueStatus() changes pending/partial to 'overdue'
        $totalCount = $db->fetchColumn(
            "SELECT COUNT(*) FROM installments inst WHERE inst.status IN ('pending', 'partial', 'overdue') AND inst.due_date < date('now')"
        );
        $pagination = new \Core\Pagination($totalCount, $perPage, $page);
        
        $installments = $db->fetchAll(
            "SELECT inst.*, i.invoice_number, c.full_name as customer_name, c.phone as customer_phone,
                    julianday('now') - julianday(inst.due_date) as days_overdue
             FROM installments inst
             JOIN invoices i ON inst.invoice_id = i.id
             JOIN customers c ON i.customer_id = c.id
             WHERE inst.status IN ('pending', 'partial', 'overdue') AND inst.due_date < date('now')
             ORDER BY inst.due_date ASC
             LIMIT {$pagination->getLimit()} OFFSET {$pagination->getOffset()}"
        );
        
        $total = $db->fetchColumn(
            "SELECT SUM(remaining_amount) FROM installments WHERE status IN ('pending', 'partial', 'overdue') AND due_date < date('now')"
        );

        $this->view('reports/overdue', [
            'title' => 'تقرير المتأخرات',
            'installments' => $installments,
            'total' => $total ?? 0,
            'pagination' => $pagination
        ]);
    }

    /**
     * تقرير العملاء
     */
    public function customers(): void
    {
        $page = (int) ($_GET['page'] ?? 1);
        $perPage = (int) ($_GET['per_page'] ?? 10);
        $search = $_GET['q'] ?? '';
        
        $db = \Core\Database::getInstance();
        
        $where = $search ? "WHERE c.full_name LIKE '%{$search}%' OR c.phone LIKE '%{$search}%'" : '';
        
        $totalCount = $db->fetchColumn("SELECT COUNT(*) FROM customers c $where");
        $pagination = new \Core\Pagination($totalCount, $perPage, $page);
        
        $customers = $db->fetchAll(
            "SELECT c.*, 
                    COALESCE(SUM(CASE WHEN i.status = 'active' THEN i.remaining_amount ELSE 0 END), 0) as balance,
                    COUNT(CASE WHEN i.status = 'active' THEN 1 END) as active_invoices
             FROM customers c
             LEFT JOIN invoices i ON c.id = i.customer_id
             $where
             GROUP BY c.id
             ORDER BY balance DESC
             LIMIT {$pagination->getLimit()} OFFSET {$pagination->getOffset()}"
        );

        $this->view('reports/customers', [
            'title' => 'تقرير العملاء',
            'customers' => $customers,
            'pagination' => $pagination,
            'search' => $search
        ]);
    }

    /**
     * تقرير المخزون
     */
    public function inventory(): void
    {
        $perPage = (int) ($_GET['per_page'] ?? 15);
        $editedId = (int) ($_GET['edited'] ?? 0);
        
        $db = \Core\Database::getInstance();
        
        // إذا كان هناك منتج معدّل، احسب صفحته
        $page = (int) ($_GET['page'] ?? 1);
        if ($editedId && !isset($_GET['page'])) {
            // ابحث عن موقع المنتج في الترتيب
            $position = $db->fetchColumn(
                "SELECT COUNT(*) FROM products WHERE quantity < (SELECT quantity FROM products WHERE id = ?) 
                 OR (quantity = (SELECT quantity FROM products WHERE id = ?) AND id <= ?)",
                [$editedId, $editedId, $editedId]
            );
            if ($position) {
                $page = ceil($position / $perPage);
            }
        }
        
        $totalCount = $db->fetchColumn("SELECT COUNT(*) FROM products");
        $pagination = new \Core\Pagination($totalCount, $perPage, $page);
        
        $products = $db->fetchAll(
            "SELECT p.*, c.name as category_name 
             FROM products p
             LEFT JOIN categories c ON p.category_id = c.id
             ORDER BY p.quantity ASC
             LIMIT {$pagination->getLimit()} OFFSET {$pagination->getOffset()}"
        );
        
        // المنتجات منخفضة المخزون (للتنبيه فقط)
        $lowStock = $db->fetchAll(
            "SELECT * FROM products WHERE quantity <= min_quantity"
        );

        $this->view('reports/inventory', [
            'title' => 'تقرير المخزون',
            'products' => $products,
            'lowStock' => $lowStock,
            'pagination' => $pagination
        ]);
    }
}



============================================================
FILE: app/Controllers/SettingController.php
============================================================
<?php
namespace App\Controllers;

use Core\Controller;
use App\Models\Setting;
use App\Models\InstallmentPlan;
use App\Models\User;

class SettingController extends Controller
{
    public function __construct()
    {
        parent::__construct();
        $this->requireAuth();
    }
    
    public function index(): void
    {
        $this->requireRole(['admin']);
        
        $settingModel = new Setting();
        $settings = $settingModel->getAll();
        
        // Load user's menu config for settings page
        $userModel = new User();
        $menuConfig = $userModel->getMenuConfig($_SESSION['user_id']);
        
        $this->view('settings/index', [
            'pageTitle' => 'الإعدادات',
            'settings' => $settings,
            'menuConfig' => $menuConfig
        ]);
    }
    
    public function update(): void
    {
        $this->requireRole(['admin']);
        
        $settingModel = new Setting();
        
        $fields = [
            'store_name', 'store_phone', 'store_phone2', 'store_address',
            'currency', 'tax_rate', 'invoice_prefix', 'receipt_prefix',
            'invoice_footer', 'dark_mode', 'primary_color', 'sidebar_color'
        ];
        
        foreach ($fields as $field) {
            $value = $this->input($field);
            if ($value !== null) {
                $settingModel->set($field, $value);
            }
        }
        
        if (!empty($_FILES['store_logo']['name'])) {
            $logo = $this->uploadLogo($_FILES['store_logo']);
            if ($logo) {
                $settingModel->set('store_logo', $logo);
            }
        }
        
        $this->logActivity('update', 'settings', null, 'تحديث الإعدادات');
        $this->success('تم حفظ الإعدادات بنجاح');
        $this->redirect(url('/settings'));
    }
    
    /**
     * حفظ إعدادات القائمة للمستخدم الحالي
     */
    public function saveMenuConfig(): void
    {
        header('Content-Type: application/json');
        
        $input = json_decode(file_get_contents('php://input'), true);
        
        if (!$input) {
            echo json_encode(['success' => false, 'message' => 'بيانات غير صالحة']);
            return;
        }
        
        $userModel = new User();
        $userId = $_SESSION['user_id'];
        
        $result = $userModel->saveMenuConfig($userId, $input);
        
        if ($result) {
            echo json_encode(['success' => true, 'message' => 'تم حفظ إعدادات القائمة']);
        } else {
            echo json_encode(['success' => false, 'message' => 'فشل في حفظ الإعدادات']);
        }
    }
    
    /**
     * جلب إعدادات القائمة للمستخدم الحالي (API endpoint)
     */
    public function fetchMenuConfig(): void
    {
        header('Content-Type: application/json');
        
        $userModel = new User();
        $userId = $_SESSION['user_id'];
        
        $config = $userModel->getMenuConfig($userId);
        
        echo json_encode([
            'success' => true,
            'config' => $config
        ]);
    }
    
    /**
     * حفظ إعدادات المظهر للمستخدم الحالي
     */
    public function saveThemeConfig(): void
    {
        header('Content-Type: application/json');
        
        $input = json_decode(file_get_contents('php://input'), true);
        
        if ($input === null) {
            $input = []; // Empty config to reset
        }
        
        $userModel = new User();
        $userId = $_SESSION['user_id'];
        
        $result = $userModel->saveThemeConfig($userId, $input);
        
        if ($result) {
            echo json_encode(['success' => true, 'message' => 'تم حفظ إعدادات المظهر']);
        } else {
            echo json_encode(['success' => false, 'message' => 'فشل في حفظ الإعدادات']);
        }
    }
    
    public function installmentPlans(): void
    {
        $this->requireRole(['admin']);
        
        $planModel = new InstallmentPlan();
        $plans = $planModel->all('months');
        
        $this->view('settings/installment', [
            'pageTitle' => 'خطط التقسيط',
            'plans' => $plans
        ]);
    }
    
    public function updateInstallmentPlan(?int $id = null): void
    {
        $this->requireRole(['admin']);
        
        $planModel = new InstallmentPlan();
        
        // Use route parameter if provided, otherwise fallback to POST data
        $id = $id ?? $this->input('id');
        $data = [
            'name' => $this->input('name'),
            'months' => (int) $this->input('months'),
            'increase_percent' => (float) $this->input('increase_percent'),
            'min_down_payment_percent' => (float) $this->input('min_down_payment_percent'),
            'is_active' => $this->input('is_active') ? 1 : 0
        ];
        
        if ($id) {
            $planModel->update($id, $data);
        } else {
            $planModel->create($data);
        }
        
        $this->success('تم حفظ خطة التقسيط');
        $this->redirect(url('/settings/installment'));
    }
    
    public function deleteInstallmentPlan(int $id): void
    {
        $this->requireRole(['admin']);
        
        $planModel = new InstallmentPlan();
        $plan = $planModel->find($id);
        
        if (!$plan) {
            $this->error('خطة التقسيط غير موجودة');
            $this->redirect(url('/settings/installment'));
            return;
        }
        
        $planModel->delete($id);
        $this->logActivity('delete', 'installment_plan', $id, "حذف خطة التقسيط: {$plan['name']}");
        $this->success('تم حذف خطة التقسيط بنجاح');
        $this->redirect(url('/settings/installment'));
    }
    
    private function uploadLogo(array $file): ?string
    {
        $ext = pathinfo($file['name'], PATHINFO_EXTENSION);
        $filename = 'logo.' . $ext;
        $uploadDir = dirname(dirname(__DIR__)) . '/public/assets/images/';
        
        if (move_uploaded_file($file['tmp_name'], $uploadDir . $filename)) {
            return $filename;
        }
        return null;
    }
}


============================================================
FILE: app/Controllers/UserController.php
============================================================
<?php

namespace App\Controllers;

use Core\Controller;
use App\Models\User;

class UserController extends Controller
{
    private User $userModel;

    public function __construct()
    {
        parent::__construct();
        // التحقق من تسجيل الدخول وصلاحية المدير
        $this->requireRole('admin');
        $this->userModel = new User();
    }

    /**
     * عرض قائمة المستخدمين
     */
    public function index(): void
    {
        $page = (int) ($_GET['page'] ?? 1);
        $perPage = (int) ($_GET['per_page'] ?? 15);
        
        $totalCount = $this->db->fetchColumn("SELECT COUNT(*) FROM users");
        $pagination = new \Core\Pagination($totalCount, $perPage, $page);
        
        $users = $this->db->fetchAll(
            "SELECT * FROM users ORDER BY id DESC LIMIT {$pagination->getLimit()} OFFSET {$pagination->getOffset()}"
        );
        
        $this->view('users/index', [
            'title' => 'إدارة المستخدمين',
            'users' => $users,
            'pagination' => $pagination
        ]);
    }

    /**
     * صفحة إضافة مستخدم
     */
    public function create(): void
    {
        $this->view('users/create', [
            'title' => 'إضافة مستخدم'
        ]);
    }

    /**
     * حفظ مستخدم جديد
     */
    public function store(): void
    {
        $data = [
            'username' => $_POST['username'],
            'password_hash' => password_hash($_POST['password'], PASSWORD_DEFAULT),
            'full_name' => $_POST['full_name'],
            'phone' => $_POST['phone'] ?? null,
            'role' => $_POST['role'] ?? 'sales',
            'is_active' => isset($_POST['is_active']) ? 1 : 0
        ];

        $this->userModel->create($data);
        
        $_SESSION['flash']['success'] = 'تم إضافة المستخدم بنجاح';
        header('Location: ' . url('/users'));
        exit;
    }

    /**
     * صفحة تعديل مستخدم
     */
    public function edit(int $id): void
    {
        $user = $this->userModel->find($id);
        
        if (!$user) {
            header('Location: ' . url('/users'));
            exit;
        }

        $this->view('users/edit', [
            'title' => 'تعديل مستخدم',
            'user' => $user
        ]);
    }

    /**
     * تحديث مستخدم
     */
    public function update(int $id): void
    {
        $data = [
            'username' => $_POST['username'],
            'full_name' => $_POST['full_name'],
            'phone' => $_POST['phone'] ?? null,
            'role' => $_POST['role'] ?? 'sales',
            'is_active' => isset($_POST['is_active']) ? 1 : 0
        ];

        // تحديث كلمة المرور إذا تم إدخالها
        if (!empty($_POST['password'])) {
            $data['password_hash'] = password_hash($_POST['password'], PASSWORD_DEFAULT);
        }

        $this->userModel->update($id, $data);
        
        $_SESSION['flash']['success'] = 'تم تحديث المستخدم بنجاح';
        header('Location: ' . url('/users'));
        exit;
    }

    /**
     * حذف مستخدم
     */
    public function destroy(int $id): void
    {
        // منع حذف المستخدم الحالي
        if ($id == $_SESSION['user_id']) {
            $_SESSION['flash']['error'] = 'لا يمكنك حذف حسابك الحالي';
            header('Location: ' . url('/users'));
            exit;
        }

        $this->userModel->delete($id);
        
        $_SESSION['flash']['success'] = 'تم حذف المستخدم بنجاح';
        header('Location: ' . url('/users'));
        exit;
    }
}


============================================================
FILE: app/Helpers/functions.php
============================================================
<?php
/**
 * ╔══════════════════════════════════════════════════════════════════╗
 * ║                    نظام تقسيط - الدوال المساعدة                   ║
 * ╚══════════════════════════════════════════════════════════════════╝
 */

/**
 * الحصول على URL أساسي
 */
function url(string $path = ''): string
{
    // للسيرفر المدمج في PHP استخدم مسار فارغ
    // لـ Apache/htdocs استخدم '/nizam-taqsit/public'
    $baseUrl = '';
    return $baseUrl . '/' . ltrim($path, '/');
}

/**
 * الحصول على مسار الأصول مع دعم cache busting
 */
function asset(string $path): string
{
    $assetPath = 'assets/' . ltrim($path, '/');
    $fullPath = BASE_PATH . '/public/' . $assetPath;
    
    // إضافة version query string بناءً على وقت تعديل الملف
    $version = '';
    if (file_exists($fullPath)) {
        $version = '?v=' . filemtime($fullPath);
    }
    
    return url($assetPath) . $version;
}

/**
 * الحصول على مسار الرفع
 */
function upload(string $path): string
{
    return url('uploads/' . ltrim($path, '/'));
}

/**
 * تنسيق المبلغ
 */
function formatMoney(float $amount, string $currency = 'ج.م'): string
{
    return number_format($amount, 2) . ' ' . $currency;
}

/**
 * تنسيق التاريخ بالعربي
 */
function formatDate(string $date, string $format = 'd/m/Y'): string
{
    return date($format, strtotime($date));
}

/**
 * تنسيق التاريخ والوقت بالعربي
 */
function formatDateTime(string $datetime): string
{
    return date('d/m/Y h:i A', strtotime($datetime));
}

/**
 * الحصول على التاريخ بالهجري (تقريبي)
 */
function hijriDate(string $date = null): string
{
    $timestamp = $date ? strtotime($date) : time();
    // تحويل تقريبي - يمكن استخدام مكتبة متخصصة
    return date('d/m/Y', $timestamp);
}

/**
 * تحويل الأرقام للعربية
 */
function arabicNumber($number): string
{
    $arabic = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
    $english = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
    return str_replace($english, $arabic, (string)$number);
}

/**
 * تنسيق رقم الهاتف
 */
function formatPhone(string $phone): string
{
    // إزالة أي أحرف غير رقمية
    $phone = preg_replace('/[^0-9]/', '', $phone);
    
    // تنسيق رقم مصري
    if (strlen($phone) === 11 && substr($phone, 0, 2) === '01') {
        return substr($phone, 0, 4) . '-' . substr($phone, 4, 3) . '-' . substr($phone, 7);
    }
    
    return $phone;
}

/**
 * اختصار النص
 */
function truncate(string $text, int $length = 50): string
{
    if (mb_strlen($text) <= $length) {
        return $text;
    }
    return mb_substr($text, 0, $length) . '...';
}

/**
 * إنشاء رقم فاتورة فريد
 */
function generateInvoiceNumber(string $prefix = 'INV'): string
{
    return $prefix . '-' . date('Y') . '-' . str_pad(mt_rand(1, 99999), 5, '0', STR_PAD_LEFT);
}

/**
 * إنشاء رقم إيصال فريد
 */
function generateReceiptNumber(): string
{
    return 'RCP-' . date('Ymd') . '-' . str_pad(mt_rand(1, 9999), 4, '0', STR_PAD_LEFT);
}

/**
 * حالة القسط بالعربي
 */
function installmentStatus(string $status): string
{
    return match ($status) {
        'pending' => 'قيد الانتظار',
        'partial' => 'مدفوع جزئياً',
        'paid' => 'مدفوع',
        'overdue' => 'متأخر',
        default => $status
    };
}

/**
 * لون حالة القسط
 */
function installmentStatusColor(string $status): string
{
    return match ($status) {
        'pending' => 'warning',
        'partial' => 'info',
        'paid' => 'success',
        'overdue' => 'danger',
        default => 'secondary'
    };
}

/**
 * حالة الفاتورة بالعربي
 */
function invoiceStatus(string $status): string
{
    return match ($status) {
        'pending' => 'معلقة',
        'active' => 'نشطة',
        'completed' => 'مكتملة',
        'cancelled' => 'ملغاة',
        default => $status
    };
}

/**
 * نوع الفاتورة بالعربي
 */
function invoiceType(string $type): string
{
    return match ($type) {
        'cash' => 'نقدي',
        'installment' => 'تقسيط',
        default => $type
    };
}

/**
 * دور المستخدم بالعربي
 */
function userRole(string $role): string
{
    return match ($role) {
        'admin' => 'مدير',
        'sales' => 'موظف مبيعات',
        'accountant' => 'محاسب',
        default => $role
    };
}

/**
 * طريقة الدفع بالعربي
 */
function paymentMethod(string $method): string
{
    return match ($method) {
        'cash' => 'نقداً',
        'card' => 'بطاقة',
        'transfer' => 'تحويل',
        'other' => 'أخرى',
        default => $method
    };
}

/**
 * تنظيف المدخلات
 */
function clean(mixed $data): mixed
{
    if (is_array($data)) {
        return array_map('clean', $data);
    }
    return htmlspecialchars(trim($data ?? ''), ENT_QUOTES, 'UTF-8');
}

/**
 * قيمة قديمة من الطلب
 */
function old(string $key, mixed $default = ''): mixed
{
    $value = $_SESSION['old'][$key] ?? $default;
    unset($_SESSION['old'][$key]);
    return $value;
}

/**
 * خطأ في حقل معين
 */
function error(string $key): ?string
{
    $error = $_SESSION['errors'][$key] ?? null;
    unset($_SESSION['errors'][$key]);
    return $error;
}

/**
 * رسالة Flash
 */
function flash(string $key): ?string
{
    $message = $_SESSION['flash'][$key] ?? null;
    unset($_SESSION['flash'][$key]);
    return $message;
}

/**
 * التحقق من تسجيل الدخول
 */
function isLoggedIn(): bool
{
    return isset($_SESSION['user_id']);
}

/**
 * التحقق من الصلاحية
 */
function hasRole(string|array $roles): bool
{
    if (!isLoggedIn()) {
        return false;
    }
    
    $userRole = $_SESSION['user_role'] ?? '';
    $roles = is_array($roles) ? $roles : [$roles];
    
    return in_array($userRole, $roles);
}

/**
 * الحصول على إعداد
 */
function setting(string $key, mixed $default = null): mixed
{
    static $settings = null;
    
    if ($settings === null) {
        $db = \Core\Database::getInstance();
        $rows = $db->fetchAll("SELECT setting_key, setting_value FROM settings");
        $settings = [];
        foreach ($rows as $row) {
            $settings[$row['setting_key']] = $row['setting_value'];
        }
    }
    
    return $settings[$key] ?? $default;
}

/**
 * رقم CSRF Token
 */
function csrfToken(): string
{
    if (!isset($_SESSION['csrf_token'])) {
        $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
    }
    return $_SESSION['csrf_token'];
}

/**
 * حقل CSRF المخفي
 */
function csrfField(): string
{
    return '<input type="hidden" name="_token" value="' . csrfToken() . '">';
}

/**
 * التحقق من CSRF
 */
function verifyCsrf(): bool
{
    $token = $_POST['_token'] ?? '';
    return $token === ($_SESSION['csrf_token'] ?? '');
}

/**
 * حساب الفرق بين تاريخين بالأيام
 */
function daysDiff(string $date1, string $date2 = null): int
{
    $d1 = new DateTime($date1);
    $d2 = $date2 ? new DateTime($date2) : new DateTime();
    return $d1->diff($d2)->days;
}

/**
 * هل التاريخ متأخر
 */
function isOverdue(string $date): bool
{
    return strtotime($date) < strtotime('today');
}

/**
 * هل التاريخ اليوم
 */
function isToday(string $date): bool
{
    return date('Y-m-d', strtotime($date)) === date('Y-m-d');
}


============================================================
FILE: app/Models/Category.php
============================================================
<?php
namespace App\Models;

/**
 * نموذج التصنيف
 */
class Category extends Model
{
    protected string $table = 'categories';
    protected array $fillable = [
        'name', 'description', 'parent_id', 'icon', 'color', 'sort_order', 'is_active'
    ];
    
    /**
     * جلب التصنيفات النشطة
     */
    public function getActive(): array
    {
        return $this->db->fetchAll(
            "SELECT * FROM {$this->table} WHERE is_active = 1 ORDER BY sort_order, name"
        );
    }
    
    /**
     * جلب التصنيفات الرئيسية
     */
    public function getParents(): array
    {
        return $this->db->fetchAll(
            "SELECT * FROM {$this->table} WHERE parent_id IS NULL AND is_active = 1 ORDER BY sort_order"
        );
    }
    
    /**
     * جلب التصنيفات الفرعية
     */
    public function getChildren(int $parentId): array
    {
        return $this->where('parent_id', $parentId, 'sort_order');
    }
    
    /**
     * عدد المنتجات في التصنيف
     */
    public function getProductCount(int $categoryId): int
    {
        return (int) $this->db->fetchColumn(
            "SELECT COUNT(*) FROM products WHERE category_id = ?",
            [$categoryId]
        );
    }
    
    /**
     * جلب التصنيفات مع عدد المنتجات
     */
    public function getAllWithProductCount(): array
    {
        return $this->db->fetchAll(
            "SELECT c.*, COUNT(p.id) as products_count 
             FROM {$this->table} c 
             LEFT JOIN products p ON c.id = p.category_id 
             GROUP BY c.id 
             ORDER BY c.id DESC"
        );
    }
}


============================================================
FILE: app/Models/Customer.php
============================================================
<?php
namespace App\Models;

/**
 * نموذج العميل
 */
class Customer extends Model
{
    protected string $table = 'customers';
    protected array $fillable = [
        'full_name', 'phone', 'phone2', 'national_id', 'national_id_image',
        'address', 'city', 'work_address', 'work_phone',
        'guarantor_name', 'guarantor_phone', 'guarantor_national_id',
        'credit_limit', 'notes', 'is_active'
    ];
    
    /**
     * جلب عميل برقم الهاتف
     */
    public function findByPhone(string $phone): ?array
    {
        return $this->findWhere('phone', $phone);
    }
    
    /**
     * جلب عميل برقم الهوية
     */
    public function findByNationalId(string $nationalId): ?array
    {
        return $this->findWhere('national_id', $nationalId);
    }
    
    /**
     * بحث في العملاء
     */
    public function searchCustomers(string $query, int $limit = 20): array
    {
        return $this->db->fetchAll(
            "SELECT * FROM {$this->table} 
             WHERE is_active = 1 AND (full_name LIKE ? OR phone LIKE ? OR national_id LIKE ?)
             ORDER BY full_name 
             LIMIT ?",
            ["%{$query}%", "%{$query}%", "%{$query}%", $limit]
        );
    }
    
    /**
     * الرصيد المستحق للعميل
     */
    public function getBalance(int $customerId): float
    {
        return (float) $this->db->fetchColumn(
            "SELECT COALESCE(SUM(remaining_amount), 0) 
             FROM invoices 
             WHERE customer_id = ? AND status = 'active' AND invoice_type = 'installment'",
            [$customerId]
        );
    }
    
    /**
     * عدد الأقساط المتأخرة
     */
    public function getOverdueCount(int $customerId): int
    {
        return (int) $this->db->fetchColumn(
            "SELECT COUNT(*) FROM installments inst
             INNER JOIN invoices inv ON inst.invoice_id = inv.id
             WHERE inv.customer_id = ? AND inst.status = 'overdue'",
            [$customerId]
        );
    }
    
    /**
     * جلب العملاء مع الأرصدة
     */
    public function getAllWithBalance(): array
    {
        return $this->db->fetchAll(
            "SELECT c.*, 
                    COALESCE(SUM(i.remaining_amount), 0) as balance,
                    COUNT(DISTINCT CASE WHEN i.status = 'active' THEN i.id END) as active_invoices
             FROM {$this->table} c
             LEFT JOIN invoices i ON c.id = i.customer_id AND i.invoice_type = 'installment'
             GROUP BY c.id
             ORDER BY c.full_name"
        );
    }
    
    /**
     * فواتير العميل
     */
    public function getInvoices(int $customerId): array
    {
        return $this->db->fetchAll(
            "SELECT * FROM invoices WHERE customer_id = ? ORDER BY created_at DESC",
            [$customerId]
        );
    }
    
    /**
     * مدفوعات العميل
     */
    public function getPayments(int $customerId): array
    {
        return $this->db->fetchAll(
            "SELECT p.*, i.invoice_number 
             FROM payments p
             INNER JOIN invoices i ON p.invoice_id = i.id
             WHERE i.customer_id = ?
             ORDER BY p.payment_date DESC",
            [$customerId]
        );
    }
    
    /**
     * العملاء المتأخرين
     */
    public function getOverdueCustomers(): array
    {
        return $this->db->fetchAll(
            "SELECT DISTINCT c.*, COUNT(inst.id) as overdue_count, SUM(inst.remaining_amount) as overdue_amount
             FROM {$this->table} c
             INNER JOIN invoices inv ON c.id = inv.customer_id
             INNER JOIN installments inst ON inv.id = inst.invoice_id
             WHERE inst.status = 'overdue'
             GROUP BY c.id
             ORDER BY overdue_amount DESC"
        );
    }
}


============================================================
FILE: app/Models/Installment.php
============================================================
<?php
namespace App\Models;

/**
 * نموذج القسط
 */
class Installment extends Model
{
    protected string $table = 'installments';
    protected array $fillable = [
        'invoice_id', 'installment_number', 'amount', 'due_date',
        'paid_amount', 'remaining_amount', 'status', 'paid_date', 'notes'
    ];
    
    /**
     * جلب أقساط اليوم
     */
    public function getToday(): array
    {
        return $this->db->fetchAll(
            "SELECT inst.*, inv.invoice_number, c.full_name as customer_name, c.phone as customer_phone
             FROM {$this->table} inst
             INNER JOIN invoices inv ON inst.invoice_id = inv.id
             INNER JOIN customers c ON inv.customer_id = c.id
             WHERE inst.due_date = ? AND inst.status IN ('pending', 'partial')
             ORDER BY c.full_name",
            [date('Y-m-d')]
        );
    }
    
    /**
     * جلب الأقساط المتأخرة
     */
    public function getOverdue(): array
    {
        return $this->db->fetchAll(
            "SELECT inst.*, inv.invoice_number, c.full_name as customer_name, c.phone as customer_phone,
                    julianday('now') - julianday(inst.due_date) as days_overdue
             FROM {$this->table} inst
             INNER JOIN invoices inv ON inst.invoice_id = inv.id
             INNER JOIN customers c ON inv.customer_id = c.id
             WHERE inst.due_date < ? AND inst.status IN ('pending', 'partial', 'overdue')
             ORDER BY inst.due_date",
            [date('Y-m-d')]
        );
    }
    
    /**
     * جلب الأقساط القادمة
     */
    public function getUpcoming(int $days = 7): array
    {
        $endDate = date('Y-m-d', strtotime("+{$days} days"));
        
        return $this->db->fetchAll(
            "SELECT inst.*, inv.invoice_number, c.full_name as customer_name, c.phone as customer_phone
             FROM {$this->table} inst
             INNER JOIN invoices inv ON inst.invoice_id = inv.id
             INNER JOIN customers c ON inv.customer_id = c.id
             WHERE inst.due_date > ? AND inst.due_date <= ? AND inst.status = 'pending'
             ORDER BY inst.due_date",
            [date('Y-m-d'), $endDate]
        );
    }
    
    /**
     * جلب القسط مع التفاصيل
     */
    public function getWithDetails(int $id): ?array
    {
        return $this->db->fetch(
            "SELECT inst.*, inv.invoice_number, inv.total_amount as invoice_total,
                    c.full_name as customer_name, c.phone as customer_phone, c.address as customer_address
             FROM {$this->table} inst
             INNER JOIN invoices inv ON inst.invoice_id = inv.id
             INNER JOIN customers c ON inv.customer_id = c.id
             WHERE inst.id = ?",
            [$id]
        );
    }
    
    /**
     * سداد قسط
     */
    public function pay(int $id, float $amount, int $userId): bool
    {
        $installment = $this->find($id);
        if (!$installment) {
            return false;
        }
        
        $this->db->beginTransaction();
        
        try {
            // حساب المبالغ
            $newPaidAmount = $installment['paid_amount'] + $amount;
            $newRemaining = $installment['amount'] - $newPaidAmount;
            
            // تحديد الحالة
            if ($newRemaining <= 0) {
                $status = 'paid';
                $newRemaining = 0;
                $paidDate = date('Y-m-d');
            } elseif ($newPaidAmount > 0) {
                $status = 'partial';
                $paidDate = null;
            } else {
                $status = 'pending';
                $paidDate = null;
            }
            
            // تحديث القسط
            $this->update($id, [
                'paid_amount' => $newPaidAmount,
                'remaining_amount' => $newRemaining,
                'status' => $status,
                'paid_date' => $paidDate
            ]);
            
            // إضافة الدفعة
            $this->db->insert('payments', [
                'invoice_id' => $installment['invoice_id'],
                'installment_id' => $id,
                'amount' => $amount,
                'payment_method' => 'cash',
                'receipt_number' => generateReceiptNumber(),
                'user_id' => $userId,
                'created_at' => date('Y-m-d H:i:s')
            ]);
            
            // تحديث الفاتورة
            $invoice = $this->db->fetch(
                "SELECT * FROM invoices WHERE id = ?",
                [$installment['invoice_id']]
            );
            
            $this->db->update('invoices', [
                'paid_amount' => $invoice['paid_amount'] + $amount,
                'remaining_amount' => $invoice['remaining_amount'] - $amount,
                'updated_at' => date('Y-m-d H:i:s')
            ], 'id = :id', ['id' => $installment['invoice_id']]);
            
            // تحديث حالة الفاتورة
            $invoiceModel = new Invoice();
            $invoiceModel->updateStatus($installment['invoice_id']);
            
            $this->db->commit();
            return true;
            
        } catch (\Exception $e) {
            $this->db->rollback();
            throw $e;
        }
    }
    
    /**
     * تحديث حالات الأقساط المتأخرة
     */
    public function updateOverdueStatus(): int
    {
        return $this->db->query(
            "UPDATE {$this->table} SET status = 'overdue', updated_at = ? 
             WHERE due_date < ? AND status IN ('pending', 'partial')",
            [date('Y-m-d H:i:s'), date('Y-m-d')]
        )->rowCount();
    }
    
    /**
     * إحصائيات الأقساط
     */
    public function getStats(): array
    {
        // Count overdue using same logic as getOverdue() method
        $overdueCount = (int) $this->db->fetchColumn(
            "SELECT COUNT(*) FROM {$this->table} 
             WHERE due_date < ? AND status IN ('pending', 'partial', 'overdue')",
            [date('Y-m-d')]
        );
        
        $overdueAmount = (float) $this->db->fetchColumn(
            "SELECT COALESCE(SUM(remaining_amount), 0) FROM {$this->table} 
             WHERE due_date < ? AND status IN ('pending', 'partial', 'overdue')",
            [date('Y-m-d')]
        );
        
        return [
            'today_count' => count($this->getToday()),
            'today_amount' => (float) $this->db->fetchColumn(
                "SELECT COALESCE(SUM(remaining_amount), 0) FROM {$this->table} 
                 WHERE due_date = ? AND status IN ('pending', 'partial')",
                [date('Y-m-d')]
            ),
            'overdue_count' => $overdueCount,
            'overdue_amount' => $overdueAmount,
            'upcoming_week' => count($this->getUpcoming(7)),
        ];
    }
}


============================================================
FILE: app/Models/InstallmentPlan.php
============================================================
<?php
namespace App\Models;

/**
 * نموذج خطة التقسيط
 */
class InstallmentPlan extends Model
{
    protected string $table = 'installment_plans';
    protected array $fillable = [
        'name', 'months', 'increase_percent', 'min_down_payment_percent', 'is_active'
    ];
    
    /**
     * جلب الخطط النشطة
     */
    public function getActive(): array
    {
        return $this->db->fetchAll(
            "SELECT * FROM {$this->table} WHERE is_active = 1 ORDER BY months"
        );
    }
    
    /**
     * حساب سعر التقسيط
     */
    public function calculateInstallmentPrice(float $cashPrice, int $planId): array
    {
        $plan = $this->find($planId);
        if (!$plan) {
            return [];
        }
        
        $increasePercent = $plan['increase_percent'] / 100;
        $installmentPrice = $cashPrice * (1 + $increasePercent);
        $minDownPayment = $installmentPrice * ($plan['min_down_payment_percent'] / 100);
        
        return [
            'plan' => $plan,
            'cash_price' => $cashPrice,
            'installment_price' => round($installmentPrice, 2),
            'increase_amount' => round($installmentPrice - $cashPrice, 2),
            'min_down_payment' => round($minDownPayment, 2),
            'min_down_payment_percent' => $plan['min_down_payment_percent']
        ];
    }
    
    /**
     * حساب القسط الشهري
     */
    public function calculateMonthlyInstallment(float $total, float $downPayment, int $months): float
    {
        $remaining = $total - $downPayment;
        return round($remaining / $months, 2);
    }
}


============================================================
FILE: app/Models/Invoice.php
============================================================
<?php
namespace App\Models;

/**
 * نموذج الفاتورة
 */
class Invoice extends Model
{
    protected string $table = 'invoices';
    protected array $fillable = [
        'invoice_number', 'invoice_type', 'customer_id', 'user_id',
        'subtotal', 'discount_amount', 'discount_percent', 'tax_amount', 'total_amount',
        'paid_amount', 'remaining_amount',
        'installment_plan_id', 'down_payment', 'monthly_installment', 'installments_count',
        'first_installment_date', 'notes', 'status'
    ];
    
    /**
     * إنشاء رقم فاتورة جديد
     */
    public function generateNumber(): string
    {
        $prefix = setting('invoice_prefix', 'INV');
        $year = date('Y');
        
        $lastNumber = $this->db->fetchColumn(
            "SELECT invoice_number FROM {$this->table} 
             WHERE invoice_number LIKE ? 
             ORDER BY id DESC LIMIT 1",
            ["{$prefix}-{$year}-%"]
        );
        
        if ($lastNumber) {
            $parts = explode('-', $lastNumber);
            $number = (int) end($parts) + 1;
        } else {
            $number = 1;
        }
        
        return sprintf("%s-%s-%05d", $prefix, $year, $number);
    }
    
    /**
     * جلب الفاتورة مع التفاصيل
     */
    public function getWithDetails(int $id): ?array
    {
        $invoice = $this->db->fetch(
            "SELECT i.*, c.full_name as customer_name, c.phone as customer_phone,
                    u.full_name as user_name, ip.name as plan_name
             FROM {$this->table} i
             LEFT JOIN customers c ON i.customer_id = c.id
             LEFT JOIN users u ON i.user_id = u.id
             LEFT JOIN installment_plans ip ON i.installment_plan_id = ip.id
             WHERE i.id = ?",
            [$id]
        );
        
        if ($invoice) {
            $invoice['items'] = $this->getItems($id);
            if ($invoice['invoice_type'] === 'installment') {
                $invoice['installments'] = $this->getInstallments($id);
            }
        }
        
        return $invoice;
    }
    
    /**
     * جلب بنود الفاتورة
     */
    public function getItems(int $invoiceId): array
    {
        return $this->db->fetchAll(
            "SELECT ii.*, p.image as product_image
             FROM invoice_items ii
             LEFT JOIN products p ON ii.product_id = p.id
             WHERE ii.invoice_id = ?",
            [$invoiceId]
        );
    }
    
    /**
     * جلب أقساط الفاتورة
     */
    public function getInstallments(int $invoiceId): array
    {
        return $this->db->fetchAll(
            "SELECT * FROM installments WHERE invoice_id = ? ORDER BY installment_number",
            [$invoiceId]
        );
    }
    
    /**
     * جلب الفواتير مع بيانات العميل
     */
    public function getAllWithCustomer(): array
    {
        return $this->db->fetchAll(
            "SELECT i.*, c.full_name as customer_name, c.phone as customer_phone,
                    u.full_name as user_name
             FROM {$this->table} i
             LEFT JOIN customers c ON i.customer_id = c.id
             LEFT JOIN users u ON i.user_id = u.id
             ORDER BY i.id DESC"
        );
    }
    
    /**
     * فواتير التقسيط النشطة
     */
    public function getActiveInstallments(): array
    {
        return $this->db->fetchAll(
            "SELECT i.*, c.full_name as customer_name, c.phone as customer_phone
             FROM {$this->table} i
             LEFT JOIN customers c ON i.customer_id = c.id
             WHERE i.invoice_type = 'installment' AND i.status = 'active'
             ORDER BY i.id DESC"
        );
    }
    
    /**
     * إحصائيات اليوم
     */
    public function getTodayStats(): array
    {
        $today = date('Y-m-d');
        
        return [
            'cash_count' => (int) $this->db->fetchColumn(
                "SELECT COUNT(*) FROM {$this->table} 
                 WHERE DATE(created_at) = ? AND invoice_type = 'cash' AND status != 'cancelled'",
                [$today]
            ),
            'cash_total' => (float) $this->db->fetchColumn(
                "SELECT COALESCE(SUM(total_amount), 0) FROM {$this->table} 
                 WHERE DATE(created_at) = ? AND invoice_type = 'cash' AND status != 'cancelled'",
                [$today]
            ),
            'installment_count' => (int) $this->db->fetchColumn(
                "SELECT COUNT(*) FROM {$this->table} 
                 WHERE DATE(created_at) = ? AND invoice_type = 'installment' AND status != 'cancelled'",
                [$today]
            ),
            'installment_total' => (float) $this->db->fetchColumn(
                "SELECT COALESCE(SUM(total_amount), 0) FROM {$this->table} 
                 WHERE DATE(created_at) = ? AND invoice_type = 'installment' AND status != 'cancelled'",
                [$today]
            ),
        ];
    }
    
    /**
     * تحديث الحالة
     */
    public function updateStatus(int $id): void
    {
        $invoice = $this->find($id);
        if (!$invoice || $invoice['invoice_type'] !== 'installment') {
            return;
        }
        
        // التحقق من اكتمال جميع الأقساط
        $unpaidCount = (int) $this->db->fetchColumn(
            "SELECT COUNT(*) FROM installments WHERE invoice_id = ? AND status != 'paid'",
            [$id]
        );
        
        if ($unpaidCount === 0) {
            $this->update($id, ['status' => 'completed', 'remaining_amount' => 0]);
        }
    }
}


============================================================
FILE: app/Models/Model.php
============================================================
<?php
namespace App\Models;

use Core\Database;

/**
 * ╔══════════════════════════════════════════════════════════════════╗
 * ║                    نظام تقسيط - النموذج الأساسي                   ║
 * ╚══════════════════════════════════════════════════════════════════╝
 */
abstract class Model
{
    protected Database $db;
    protected string $table;
    protected string $primaryKey = 'id';
    protected array $fillable = [];
    
    public function __construct()
    {
        $this->db = Database::getInstance();
    }
    
    /**
     * جلب كل السجلات
     */
    public function all(string $orderBy = 'id DESC'): array
    {
        return $this->db->fetchAll(
            "SELECT * FROM {$this->table} ORDER BY {$orderBy}"
        );
    }
    
    /**
     * جلب سجل بالمعرف
     */
    public function find(int $id): ?array
    {
        return $this->db->fetch(
            "SELECT * FROM {$this->table} WHERE {$this->primaryKey} = ?",
            [$id]
        );
    }
    
    /**
     * جلب سجل بشرط
     */
    public function findWhere(string $column, mixed $value): ?array
    {
        return $this->db->fetch(
            "SELECT * FROM {$this->table} WHERE {$column} = ?",
            [$value]
        );
    }
    
    /**
     * جلب سجلات بشرط
     */
    public function where(string $column, mixed $value, string $orderBy = 'id DESC'): array
    {
        return $this->db->fetchAll(
            "SELECT * FROM {$this->table} WHERE {$column} = ? ORDER BY {$orderBy}",
            [$value]
        );
    }
    
    /**
     * جلب سجلات بشروط متعددة
     */
    public function whereMultiple(array $conditions, string $orderBy = 'id DESC'): array
    {
        $where = [];
        $params = [];
        
        foreach ($conditions as $column => $value) {
            $where[] = "{$column} = ?";
            $params[] = $value;
        }
        
        $whereString = implode(' AND ', $where);
        
        return $this->db->fetchAll(
            "SELECT * FROM {$this->table} WHERE {$whereString} ORDER BY {$orderBy}",
            $params
        );
    }
    
    /**
     * إنشاء سجل جديد
     */
    public function create(array $data): int
    {
        // تصفية البيانات
        $data = $this->filterData($data);
        $data['created_at'] = date('Y-m-d H:i:s');
        $data['updated_at'] = date('Y-m-d H:i:s');
        
        return $this->db->insert($this->table, $data);
    }
    
    /**
     * تحديث سجل
     */
    public function update(int $id, array $data): bool
    {
        $data = $this->filterData($data);
        $data['updated_at'] = date('Y-m-d H:i:s');
        
        return $this->db->update(
            $this->table,
            $data,
            "{$this->primaryKey} = :id",
            ['id' => $id]
        ) > 0;
    }
    
    /**
     * حذف سجل
     */
    public function delete(int $id): bool
    {
        return $this->db->delete(
            $this->table,
            "{$this->primaryKey} = ?",
            [$id]
        ) > 0;
    }
    
    /**
     * عدد السجلات
     */
    public function count(string $where = '1=1', array $params = []): int
    {
        return (int) $this->db->fetchColumn(
            "SELECT COUNT(*) FROM {$this->table} WHERE {$where}",
            $params
        );
    }
    
    /**
     * مجموع عمود
     */
    public function sum(string $column, string $where = '1=1', array $params = []): float
    {
        return (float) $this->db->fetchColumn(
            "SELECT COALESCE(SUM({$column}), 0) FROM {$this->table} WHERE {$where}",
            $params
        );
    }
    
    /**
     * البحث
     */
    public function search(string $query, array $columns, int $limit = 20): array
    {
        $where = [];
        $params = [];
        
        foreach ($columns as $column) {
            $where[] = "{$column} LIKE ?";
            $params[] = "%{$query}%";
        }
        
        $whereString = implode(' OR ', $where);
        
        return $this->db->fetchAll(
            "SELECT * FROM {$this->table} WHERE {$whereString} LIMIT {$limit}",
            $params
        );
    }
    
    /**
     * التصفح
     */
    public function paginate(int $page = 1, int $perPage = 15, string $where = '1=1', array $params = []): array
    {
        $offset = ($page - 1) * $perPage;
        
        $total = $this->count($where, $params);
        $data = $this->db->fetchAll(
            "SELECT * FROM {$this->table} WHERE {$where} ORDER BY {$this->primaryKey} DESC LIMIT {$perPage} OFFSET {$offset}",
            $params
        );
        
        return [
            'data' => $data,
            'total' => $total,
            'per_page' => $perPage,
            'current_page' => $page,
            'last_page' => ceil($total / $perPage)
        ];
    }
    
    /**
     * تصفية البيانات
     */
    protected function filterData(array $data): array
    {
        if (empty($this->fillable)) {
            return $data;
        }
        
        return array_intersect_key($data, array_flip($this->fillable));
    }
    
    /**
     * استعلام مخصص
     */
    public function raw(string $sql, array $params = []): array
    {
        return $this->db->fetchAll($sql, $params);
    }
    
    /**
     * استعلام مخصص - صف واحد
     */
    public function rawOne(string $sql, array $params = []): ?array
    {
        return $this->db->fetch($sql, $params);
    }
}


============================================================
FILE: app/Models/Payment.php
============================================================
<?php
namespace App\Models;

/**
 * نموذج الدفعة
 */
class Payment extends Model
{
    protected string $table = 'payments';
    protected array $fillable = [
        'invoice_id', 'installment_id', 'amount', 'payment_method',
        'payment_date', 'receipt_number', 'user_id', 'notes'
    ];
    
    /**
     * جلب المدفوعات مع التفاصيل
     */
    public function getAllWithDetails(): array
    {
        return $this->db->fetchAll(
            "SELECT p.*, i.invoice_number, c.full_name as customer_name, u.full_name as user_name
             FROM {$this->table} p
             INNER JOIN invoices i ON p.invoice_id = i.id
             LEFT JOIN customers c ON i.customer_id = c.id
             LEFT JOIN users u ON p.user_id = u.id
             ORDER BY p.payment_date DESC"
        );
    }
    
    /**
     * مدفوعات اليوم
     */
    public function getToday(): array
    {
        return $this->db->fetchAll(
            "SELECT p.*, i.invoice_number, c.full_name as customer_name
             FROM {$this->table} p
             INNER JOIN invoices i ON p.invoice_id = i.id
             LEFT JOIN customers c ON i.customer_id = c.id
             WHERE DATE(p.payment_date) = ?
             ORDER BY p.payment_date DESC",
            [date('Y-m-d')]
        );
    }
    
    /**
     * إجمالي مدفوعات اليوم
     */
    public function getTodayTotal(): float
    {
        return (float) $this->db->fetchColumn(
            "SELECT COALESCE(SUM(amount), 0) FROM {$this->table} WHERE DATE(payment_date) = ?",
            [date('Y-m-d')]
        );
    }
    
    /**
     * مدفوعات فترة معينة
     */
    public function getByDateRange(string $from, string $to): array
    {
        return $this->db->fetchAll(
            "SELECT p.*, i.invoice_number, c.full_name as customer_name
             FROM {$this->table} p
             INNER JOIN invoices i ON p.invoice_id = i.id
             LEFT JOIN customers c ON i.customer_id = c.id
             WHERE DATE(p.payment_date) BETWEEN ? AND ?
             ORDER BY p.payment_date DESC",
            [$from, $to]
        );
    }
    
    /**
     * إجمالي مدفوعات فترة
     */
    public function getTotalByDateRange(string $from, string $to): float
    {
        return (float) $this->db->fetchColumn(
            "SELECT COALESCE(SUM(amount), 0) FROM {$this->table} 
             WHERE DATE(payment_date) BETWEEN ? AND ?",
            [$from, $to]
        );
    }
    
    /**
     * مدفوعات مستخدم معين
     */
    public function getByUser(int $userId): array
    {
        return $this->db->fetchAll(
            "SELECT p.*, i.invoice_number, c.full_name as customer_name
             FROM {$this->table} p
             INNER JOIN invoices i ON p.invoice_id = i.id
             LEFT JOIN customers c ON i.customer_id = c.id
             WHERE p.user_id = ?
             ORDER BY p.payment_date DESC",
            [$userId]
        );
    }
}


============================================================
FILE: app/Models/Product.php
============================================================
<?php
namespace App\Models;

/**
 * نموذج المنتج
 */
class Product extends Model
{
    protected string $table = 'products';
    protected array $fillable = [
        'name', 'description', 'category_id', 'barcode', 'sku',
        'cash_price', 'installment_price', 'cost_price',
        'quantity', 'min_quantity', 'image',
        'brand', 'model', 'warranty_months', 'is_active'
    ];
    
    /**
     * جلب المنتجات النشطة
     */
    public function getActive(): array
    {
        return $this->where('is_active', 1);
    }
    
    /**
     * جلب منتج بالباركود
     */
    public function findByBarcode(string $barcode): ?array
    {
        return $this->findWhere('barcode', $barcode);
    }
    
    /**
     * جلب منتجات تصنيف معين
     */
    public function getByCategory(int $categoryId): array
    {
        return $this->where('category_id', $categoryId);
    }
    
    /**
     * بحث في المنتجات
     */
    public function searchProducts(string $query, int $limit = 20): array
    {
        return $this->db->fetchAll(
            "SELECT p.*, c.name as category_name 
             FROM {$this->table} p 
             LEFT JOIN categories c ON p.category_id = c.id 
             WHERE p.is_active = 1 AND (p.name LIKE ? OR p.barcode LIKE ? OR p.brand LIKE ?)
             ORDER BY p.name 
             LIMIT ?",
            ["%{$query}%", "%{$query}%", "%{$query}%", $limit]
        );
    }
    
    /**
     * جلب المنتجات مع التصنيف
     */
    public function getAllWithCategory(): array
    {
        return $this->db->fetchAll(
            "SELECT p.*, c.name as category_name 
             FROM {$this->table} p 
             LEFT JOIN categories c ON p.category_id = c.id 
             ORDER BY p.id DESC"
        );
    }
    
    /**
     * المنتجات منخفضة المخزون
     */
    public function getLowStock(): array
    {
        return $this->db->fetchAll(
            "SELECT * FROM {$this->table} WHERE quantity <= min_quantity AND is_active = 1"
        );
    }
    
    /**
     * تحديث الكمية
     */
    public function updateQuantity(int $id, int $change): bool
    {
        return $this->db->query(
            "UPDATE {$this->table} SET quantity = quantity + ?, updated_at = ? WHERE id = ?",
            [$change, date('Y-m-d H:i:s'), $id]
        )->rowCount() > 0;
    }
    
    /**
     * أفضل المنتجات مبيعاً
     */
    public function getTopSelling(int $limit = 10): array
    {
        return $this->db->fetchAll(
            "SELECT p.*, SUM(ii.quantity) as sold_quantity, SUM(ii.total_price) as total_sales
             FROM {$this->table} p
             INNER JOIN invoice_items ii ON p.id = ii.product_id
             INNER JOIN invoices i ON ii.invoice_id = i.id
             WHERE i.status != 'cancelled'
             GROUP BY p.id
             ORDER BY sold_quantity DESC
             LIMIT ?",
            [$limit]
        );
    }
}


============================================================
FILE: app/Models/Setting.php
============================================================
<?php
namespace App\Models;

/**
 * نموذج الإعداد
 */
class Setting extends Model
{
    protected string $table = 'settings';
    protected array $fillable = ['setting_key', 'setting_value', 'setting_group'];
    
    /**
     * جلب قيمة إعداد
     */
    public function get(string $key, mixed $default = null): mixed
    {
        $row = $this->findWhere('setting_key', $key);
        return $row ? $row['setting_value'] : $default;
    }
    
    /**
     * تعيين قيمة إعداد
     */
    public function set(string $key, mixed $value, string $group = 'general'): bool
    {
        $existing = $this->findWhere('setting_key', $key);
        
        if ($existing) {
            return $this->db->update($this->table, [
                'setting_value' => $value,
                'updated_at' => date('Y-m-d H:i:s')
            ], 'setting_key = :key', ['key' => $key]) > 0;
        }
        
        return $this->create([
            'setting_key' => $key,
            'setting_value' => $value,
            'setting_group' => $group
        ]) > 0;
    }
    
    /**
     * جلب إعدادات مجموعة
     */
    public function getGroup(string $group): array
    {
        $rows = $this->where('setting_group', $group);
        $settings = [];
        foreach ($rows as $row) {
            $settings[$row['setting_key']] = $row['setting_value'];
        }
        return $settings;
    }
    
    /**
     * جلب كل الإعدادات
     */
    public function getAll(): array
    {
        $rows = $this->all('setting_group, setting_key');
        $settings = [];
        foreach ($rows as $row) {
            $settings[$row['setting_key']] = $row['setting_value'];
        }
        return $settings;
    }
    
    /**
     * تحديث مجموعة إعدادات
     */
    public function updateMultiple(array $settings): void
    {
        foreach ($settings as $key => $value) {
            $this->set($key, $value);
        }
    }
}


============================================================
FILE: app/Models/User.php
============================================================
<?php
namespace App\Models;

/**
 * نموذج المستخدم
 */
class User extends Model
{
    protected string $table = 'users';
    protected array $fillable = [
        'username', 'password_hash', 'full_name', 'phone', 'email', 'role', 'is_active', 'menu_config'
    ];
    
    /**
     * جلب مستخدم بالاسم
     */
    public function findByUsername(string $username): ?array
    {
        return $this->findWhere('username', $username);
    }
    
    /**
     * التحقق من كلمة المرور
     */
    public function verifyPassword(string $password, string $hash): bool
    {
        return password_verify($password, $hash);
    }
    
    /**
     * تشفير كلمة المرور
     */
    public function hashPassword(string $password): string
    {
        return password_hash($password, PASSWORD_DEFAULT);
    }
    
    /**
     * تحديث آخر دخول
     */
    public function updateLastLogin(int $id): void
    {
        $this->db->update($this->table, [
            'last_login' => date('Y-m-d H:i:s')
        ], 'id = :id', ['id' => $id]);
    }
    
    /**
     * جلب المستخدمين النشطين
     */
    public function getActive(): array
    {
        return $this->where('is_active', 1);
    }
    
    /**
     * حفظ إعدادات القائمة للمستخدم
     */
    public function saveMenuConfig(int $userId, array $config): bool
    {
        return $this->db->update(
            $this->table,
            ['menu_config' => json_encode($config, JSON_UNESCAPED_UNICODE)],
            'id = :id',
            ['id' => $userId]
        ) > 0;
    }
    
    /**
     * جلب إعدادات القائمة للمستخدم
     */
    public function getMenuConfig(int $userId): ?array
    {
        $user = $this->find($userId);
        if ($user && !empty($user['menu_config'])) {
            return json_decode($user['menu_config'], true);
        }
        return null;
    }
    
    /**
     * حفظ إعدادات المظهر للمستخدم
     */
    public function saveThemeConfig(int $userId, array $config): bool
    {
        return $this->db->update(
            $this->table,
            ['theme_config' => json_encode($config, JSON_UNESCAPED_UNICODE)],
            'id = :id',
            ['id' => $userId]
        ) > 0;
    }
    
    /**
     * جلب إعدادات المظهر للمستخدم
     */
    public function getThemeConfig(int $userId): ?array
    {
        $user = $this->find($userId);
        if ($user && !empty($user['theme_config'])) {
            return json_decode($user['theme_config'], true);
        }
        return null;
    }
}


============================================================
FILE: app/Views/auth/login.php
============================================================
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل الدخول - نظام تقسيط</title>
     <?php 
    // رقم الإصدار لتجاوز الـ Cache - غير هذا الرقم عند كل تحديث
    $version = '1.0.1.' . date('Ymd');
    ?>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
     <!-- Icons -->
    <link rel="icon" type="image/x-icon" href="<?= asset('icons/app_icon.ico') ?>">
    <link rel="apple-touch-icon" href="<?= asset('icons/app_icon.ico') ?>">
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
   
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1a237e 0%, #0d47a1 50%, #01579b 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 420px;
            padding: 50px 40px;
            text-align: center;
        }
        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #1e88e5, #1565c0);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
        }
        .logo .material-icons-round { font-size: 40px; }
        h1 { color: #1a237e; font-size: 28px; margin-bottom: 10px; }
        p.subtitle { color: #666; margin-bottom: 30px; }
        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        .input-wrapper {
            position: relative;
        }
        .input-wrapper .material-icons-round {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        .form-group input {
            width: 100%;
            padding: 15px 45px 15px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #1e88e5;
            box-shadow: 0 0 0 3px rgba(30,136,229,0.1);
        }
        .btn-login {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #1e88e5, #1565c0);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(30,136,229,0.3);
        }
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: right;
        }
        .alert-danger {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }
        .footer-text {
            margin-top: 30px;
            color: #999;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <!-- <div class="logo">
            <span class="material-icons-round">store</span>
        </div>
        <h1>نظام تقسيط</h1> -->
        <div >
        <?php if (!empty($settings['store_logo'])): ?>
                <img src="<?= asset('images/' . $settings['store_logo']) ?>" alt="الشعار" style="max-width: 900px; max-height: 187px; margin-bottom: 10px;">
            <?php else: ?>
                <img src="<?= asset('images/logo.png') ?>" alt="الشعار" style="max-width: 900px; max-height: 187px; margin-bottom: 10px;">
            <?php endif; ?>
        </div>
        <p class="subtitle">مرحباً بك، قم بتسجيل الدخول للمتابعة</p>
        
        <?php if ($error = flash('error')): ?>
            <div class="alert alert-danger"><?= $error ?></div>
        <?php endif; ?>
        
        <?php if ($success = flash('success')): ?>
            <div class="alert alert-success"><?= $success ?></div>
        <?php endif; ?>
        
        <form method="POST" action="<?= url('/login') ?>">
            <div class="form-group">
                <label>اسم المستخدم</label>
                <div class="input-wrapper">
                    <span class="material-icons-round">person</span>
                    <input type="text" name="username" placeholder="أدخل اسم المستخدم" required autofocus>
                </div>
            </div>
            
            <div class="form-group">
                <label>كلمة المرور</label>
                <div class="input-wrapper">
                    <span class="material-icons-round">lock</span>
                    <input type="password" name="password" placeholder="أدخل كلمة المرور" required>
                </div>
            </div>
            
            <button type="submit" class="btn-login">
                <span class="material-icons-round">login</span>
                تسجيل الدخول
            </button>
        </form>
        
        <p class="footer-text">
            نظام إدارة مبيعات التقسيط &copy; <?= date('Y') ?>
        </p>
    </div>
</body>
</html>


============================================================
FILE: app/Views/categories/index.php
============================================================
<?php $exportUrl = url('/export/categories'); ?>
<div class="page-header">
    <h2><span class="material-icons-round">category</span> إدارة التصنيفات</h2>
    <div class="header-actions">
        <?php include dirname(__DIR__) . '/partials/export_buttons.php'; ?>
        <button class="btn btn-primary" onclick="showAddModal()"><span class="material-icons-round">add</span> إضافة تصنيف</button>
    </div>
</div>

<!-- شريط البحث -->
<div class="filters-bar" style="margin-bottom: 20px;">
    <form method="GET" class="search-form" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <div class="search-box" style="flex: 1; min-width: 200px;">
            <input type="text" name="q" class="form-control" placeholder="ابحث بالاسم أو الوصف..." value="<?= htmlspecialchars($search ?? '') ?>">
        </div>
        <button type="submit" class="btn btn-primary"><span class="material-icons-round">search</span> بحث</button>
        <?php if (!empty($search)): ?>
        <a href="<?= url('/categories') ?>" class="btn btn-secondary"><span class="material-icons-round">clear</span> مسح</a>
        <?php endif; ?>
    </form>
</div>

<div class="summary-bar">
    <div class="summary-item">
        <span class="material-icons-round" style="color:var(--primary)">category</span>
        <div><strong><?= $totalCount ?? count($categories) ?></strong><span>تصنيف</span></div>
    </div>
    <div class="summary-item">
        <span class="material-icons-round" style="color:var(--success)">inventory_2</span>
        <div><strong><?= array_sum(array_column($allCategories ?? $categories, 'products_count')) ?></strong><span>منتج</span></div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table" id="categoriesTable">
                <thead>
                    <tr>
                        <th style="width:50px; cursor:pointer" onclick="sortTable(0, 'num')"># <span class="sort-icon">↕</span></th>
                        <th>الأيقونة</th>
                        <th>اللون</th>
                        <th style="cursor:pointer" onclick="sortTable(3, 'text')">اسم التصنيف <span class="sort-icon">↕</span></th>
                        <th>الوصف</th>
                        <th style="cursor:pointer" onclick="sortTable(5, 'num')">عدد المنتجات <span class="sort-icon">↕</span></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($categories as $cat): ?>
                    <tr>
                        <td><?= $cat['id'] ?></td>
                        <td>
                            <div class="category-icon-sm" style="background:<?= $cat['color'] ?? '#1e88e5' ?>">
                                <span class="material-icons-round"><?= $cat['icon'] ?: 'category' ?></span>
                            </div>
                        </td>
                        <td>
                            <div class="color-box" style="background:<?= $cat['color'] ?? '#1e88e5' ?>"></div>
                            <small class="text-muted"><?= $cat['color'] ?? '#1e88e5' ?></small>
                        </td>
                        <td><strong><?= $cat['name'] ?></strong></td>
                        <td><small class="text-muted"><?= $cat['description'] ?? '-' ?></small></td>
                        <td>
                            <span class="badge badge-<?= ($cat['products_count'] ?? 0) > 0 ? 'primary' : 'secondary' ?>">
                                <?= $cat['products_count'] ?? 0 ?> منتج
                            </span>
                        </td>
                        <td>
                            <div class="actions">
                                <a href="<?= url('/categories/' . $cat['id']) ?>" class="btn btn-sm btn-primary" title="عرض المنتجات"><span class="material-icons-round">visibility</span></a>
                                <button class="btn btn-sm btn-secondary" onclick="editCategory(<?= htmlspecialchars(json_encode($cat)) ?>)" title="تعديل"><span class="material-icons-round">edit</span></button>
                                <button class="btn btn-sm btn-danger" onclick="showDeleteModal(<?= $cat['id'] ?>, '<?= htmlspecialchars($cat['name'], ENT_QUOTES) ?>', <?= $cat['products_count'] ?? 0 ?>)" title="حذف"><span class="material-icons-round">delete</span></button>
                            </div>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
        
        <?php include dirname(__DIR__) . '/partials/pagination.php'; ?>
    </div>
</div>

<!-- Modal تأكيد الحذف -->
<div class="modal" id="deleteModal">
    <div class="modal-content" style="max-width:450px">
        <div class="modal-header">
            <h3>تأكيد حذف التصنيف</h3>
            <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="deleteForm" method="POST">
                <input type="hidden" name="confirm_delete" value="1">
                
                <div class="alert alert-warning" id="deleteWarning" style="display:none;">
                    <span class="material-icons-round">warning</span>
                    <span id="deleteWarningText"></span>
                </div>
                
                <p id="deleteMessage"></p>
                
                <div class="form-group" id="moveToCategoryGroup" style="display:none;">
                    <label>نقل المنتجات المرتبطة بفواتير إلى:</label>
                    <select name="move_to_category" id="moveToCategory" class="form-control">
                        <option value="">-- بدون تصنيف --</option>
                        <?php foreach ($allCategories ?? $categories as $cat): ?>
                        <option value="<?= $cat['id'] ?>" data-cat-id="<?= $cat['id'] ?>"><?= $cat['name'] ?></option>
                        <?php endforeach; ?>
                    </select>
                    <small class="text-muted">سيتم حذف المنتجات غير المرتبطة بفواتير ونقل الباقي</small>
                </div>
                
                <div class="btn-group" style="display:flex; gap:10px; margin-top:20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">إلغاء</button>
                    <button type="submit" class="btn btn-danger" id="confirmDeleteBtn">حذف</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal" id="categoryModal">
    <div class="modal-content" style="max-width:400px">
        <div class="modal-header">
            <h3 id="modalTitle">إضافة تصنيف</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="categoryForm" method="POST">
                <input type="hidden" id="categoryId" name="id">
                <div class="form-group">
                    <label>اسم التصنيف *</label>
                    <input type="text" id="categoryName" name="name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>الوصف</label>
                    <textarea id="categoryDesc" name="description" class="form-control" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>الأيقونة</label>
                    <input type="text" id="categoryIcon" name="icon" class="form-control" placeholder="مثال: smartphone">
                    <small>أيقونات <a href="https://fonts.google.com/icons" target="_blank">Material Icons</a></small>
                </div>
                <div class="form-group">
                    <label>اللون</label>
                    <input type="color" id="categoryColor" name="color" class="form-control" value="#1e88e5" style="height:45px">
                </div>
                <button type="submit" class="btn btn-primary btn-block">حفظ</button>
            </form>
        </div>
    </div>
</div>

<style>
.summary-bar { display: flex; gap: 20px; margin-bottom: 25px; }
.summary-item { background: var(--bg-card); border-radius: var(--radius); padding: 20px 25px; display: flex; align-items: center; gap: 15px; box-shadow: var(--shadow); }
.summary-item .material-icons-round { font-size: 36px; }
.summary-item strong { display: block; font-size: 24px; }
.summary-item span { font-size: 13px; color: var(--text-muted); }
.category-icon-sm { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
.category-icon-sm .material-icons-round { color: white; font-size: 18px; }
.color-box { width: 24px; height: 24px; border-radius: 4px; display: inline-block; vertical-align: middle; margin-left: 8px; border: 1px solid rgba(0,0,0,0.1); }
.actions { display: flex; gap: 5px; }
.actions .btn { padding: 5px 8px; }
.actions .material-icons-round { font-size: 18px; }
th[onclick] { user-select: none; }
th[onclick]:hover { background: var(--bg-main); }
.sort-icon { font-size: 12px; color: var(--text-muted); margin-right: 5px; }
</style>

<script>
let currentCategoryId = null;

function showAddModal() {
    document.getElementById('modalTitle').textContent = 'إضافة تصنيف';
    document.getElementById('categoryId').value = '';
    document.getElementById('categoryName').value = '';
    document.getElementById('categoryDesc').value = '';
    document.getElementById('categoryIcon').value = '';
    document.getElementById('categoryColor').value = '#1e88e5';
    currentCategoryId = null;
    document.getElementById('categoryModal').classList.add('show');
}

function editCategory(cat) {
    document.getElementById('modalTitle').textContent = 'تعديل تصنيف';
    document.getElementById('categoryId').value = cat.id;
    document.getElementById('categoryName').value = cat.name;
    document.getElementById('categoryDesc').value = cat.description || '';
    document.getElementById('categoryIcon').value = cat.icon || '';
    document.getElementById('categoryColor').value = cat.color || '#1e88e5';
    currentCategoryId = cat.id;
    document.getElementById('categoryModal').classList.add('show');
}

function closeModal() {
    document.getElementById('categoryModal').classList.remove('show');
}

// معالجة النموذج بـ AJAX
document.getElementById('categoryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const id = document.getElementById('categoryId').value;
    const isEdit = id ? true : false;
    const url = isEdit ? '<?= url('/categories/') ?>' + id : '<?= url('/categories') ?>';
    
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = 'جاري الحفظ...';
    
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error('HTTP ' + response.status + ': ' + text);
            });
        }
        return response.json();
    })
    .then(data => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'حفظ';
        
        if (data.success) {
            closeModal();
            showToast(data.message);
            
            if (isEdit) {
                // تحديث الصف في الجدول
                updateTableRow(data.category);
            } else {
                // إضافة صف جديد
                addTableRow(data.category);
                updateCounts(1);
            }
        } else {
            alert(data.message || 'حدث خطأ');
        }
    })
    .catch(error => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'حفظ';
        console.error('Error:', error);
        alert('حدث خطأ: ' + error.message);
    });
});

function showDeleteModal(id, name, productsCount) {
    currentCategoryId = id;
    
    const warning = document.getElementById('deleteWarning');
    const warningText = document.getElementById('deleteWarningText');
    const message = document.getElementById('deleteMessage');
    const moveToCategoryGroup = document.getElementById('moveToCategoryGroup');
    const moveToCategory = document.getElementById('moveToCategory');
    
    if (productsCount > 0) {
        warning.style.display = 'flex';
        warningText.textContent = 'هذا التصنيف يحتوي على ' + productsCount + ' منتج';
        message.innerHTML = '<strong>عند الحذف:</strong><br>• المنتجات غير المرتبطة بفواتير سيتم حذفها<br>• المنتجات المرتبطة بفواتير سيتم نقلها';
        moveToCategoryGroup.style.display = 'block';
        
        // إخفاء التصنيف الحالي من القائمة
        const options = moveToCategory.querySelectorAll('option');
        options.forEach(opt => {
            if (opt.dataset.catId == id) {
                opt.style.display = 'none';
            } else {
                opt.style.display = '';
            }
        });
    } else {
        warning.style.display = 'none';
        message.textContent = 'هل أنت متأكد من حذف تصنيف "' + name + '"؟';
        moveToCategoryGroup.style.display = 'none';
    }
    
    document.getElementById('deleteModal').classList.add('show');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('show');
}

// معالجة الحذف بـ AJAX
document.getElementById('deleteForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!currentCategoryId) return;
    
    const formData = new FormData(this);
    const submitBtn = document.getElementById('confirmDeleteBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = 'جاري الحذف...';
    
    fetch('<?= url('/categories/') ?>' + currentCategoryId + '/delete', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error('HTTP ' + response.status + ': ' + text);
            });
        }
        return response.json();
    })
    .then(data => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'حذف';
        
        if (data.success) {
            closeDeleteModal();
            showToast(data.message);
            
            // حذف الصف من الجدول
            const row = document.querySelector(`tr td:first-child`);
            const rows = document.querySelectorAll('#categoriesTable tbody tr');
            rows.forEach(r => {
                if (r.cells[0].textContent.trim() == currentCategoryId) {
                    r.remove();
                }
            });
            updateCounts(-1);
        } else {
            alert(data.message || 'حدث خطأ');
        }
    })
    .catch(error => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'حذف';
        console.error('Error:', error);
        alert('حدث خطأ: ' + error.message);
    });
});

function addTableRow(cat) {
    const tbody = document.querySelector('#categoriesTable tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td>${cat.id}</td>
        <td>
            <div class="category-icon-sm" style="background:${cat.color || '#1e88e5'}">
                <span class="material-icons-round">${cat.icon || 'category'}</span>
            </div>
        </td>
        <td>
            <div class="color-box" style="background:${cat.color || '#1e88e5'}"></div>
            <small class="text-muted">${cat.color || '#1e88e5'}</small>
        </td>
        <td><strong>${escapeHtml(cat.name)}</strong></td>
        <td><small class="text-muted">${cat.description || '-'}</small></td>
        <td><span class="badge badge-secondary">0 منتج</span></td>
        <td>
            <div class="actions">
                <a href="<?= url('/categories/') ?>${cat.id}" class="btn btn-sm btn-primary" title="عرض المنتجات"><span class="material-icons-round">visibility</span></a>
                <button class="btn btn-sm btn-secondary" onclick="editCategory(${JSON.stringify(cat).replace(/"/g, '&quot;')})" title="تعديل"><span class="material-icons-round">edit</span></button>
                <button class="btn btn-sm btn-danger" onclick="showDeleteModal(${cat.id}, '${escapeHtml(cat.name)}', 0)" title="حذف"><span class="material-icons-round">delete</span></button>
            </div>
        </td>
    `;
    tbody.insertBefore(tr, tbody.firstChild);
}

function updateTableRow(cat) {
    const rows = document.querySelectorAll('#categoriesTable tbody tr');
    rows.forEach(r => {
        if (r.cells[0].textContent.trim() == cat.id) {
            r.cells[1].innerHTML = `<div class="category-icon-sm" style="background:${cat.color || '#1e88e5'}"><span class="material-icons-round">${cat.icon || 'category'}</span></div>`;
            r.cells[2].innerHTML = `<div class="color-box" style="background:${cat.color || '#1e88e5'}"></div><small class="text-muted">${cat.color || '#1e88e5'}</small>`;
            r.cells[3].innerHTML = `<strong>${escapeHtml(cat.name)}</strong>`;
            r.cells[4].innerHTML = `<small class="text-muted">${cat.description || '-'}</small>`;
        }
    });
}

function updateCounts(delta) {
    const countEl = document.querySelector('.summary-item strong');
    if (countEl) {
        const current = parseInt(countEl.textContent) || 0;
        countEl.textContent = current + delta;
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    toast.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 24px;border-radius:8px;z-index:9999;';
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// ترتيب الجدول
let sortDirection = {};
function sortTable(columnIndex, type) {
    const table = document.getElementById('categoriesTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // تبديل اتجاه الترتيب
    sortDirection[columnIndex] = !sortDirection[columnIndex];
    const isAsc = sortDirection[columnIndex];
    
    rows.sort((a, b) => {
        let aVal = a.cells[columnIndex].textContent.trim();
        let bVal = b.cells[columnIndex].textContent.trim();
        
        if (type === 'num') {
            aVal = parseInt(aVal) || 0;
            bVal = parseInt(bVal) || 0;
            return isAsc ? aVal - bVal : bVal - aVal;
        } else {
            return isAsc ? aVal.localeCompare(bVal, 'ar') : bVal.localeCompare(aVal, 'ar');
        }
    });
    
    // إعادة ترتيب الصفوف
    rows.forEach(row => tbody.appendChild(row));
    
    // تحديث أيقونات الترتيب
    document.querySelectorAll('.sort-icon').forEach(icon => icon.textContent = '↕');
    const clickedIcon = table.querySelectorAll('th')[columnIndex].querySelector('.sort-icon');
    if (clickedIcon) {
        clickedIcon.textContent = isAsc ? '↑' : '↓';
    }
}
</script>


============================================================
FILE: app/Views/categories/show.php
============================================================
<?php $exportUrl = url('/export/products?category=' . $category['id']); ?>
<div class="page-header">
    <h2><span class="material-icons-round">category</span> منتجات التصنيف: <?= htmlspecialchars($category['name']) ?></h2>
    <div class="header-actions">
        <a href="<?= url('/categories') ?>" class="btn btn-secondary"><span class="material-icons-round">arrow_back</span> رجوع</a>
    </div>
</div>

<!-- شريط التصنيف -->
<div class="card" style="margin-bottom: 20px;">
    <div class="card-body">
        <form method="POST" action="<?= url('/categories/' . $category['id'] . '/move-all') ?>" class="move-all-form">
            <div class="form-row" style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label style="white-space: nowrap; font-weight: 600;"><span class="material-icons-round" style="vertical-align: middle;">swap_horiz</span> نقل جميع المنتجات (<?= $totalCount ?? count($products) ?>) إلى:</label>
                    <select name="new_category_id" class="form-control" style="width: 200px;">
                        <option value="">-- بدون تصنيف --</option>
                        <?php foreach ($categories as $cat): ?>
                        <?php if ($cat['id'] != $category['id']): ?>
                        <option value="<?= $cat['id'] ?>"><?= $cat['name'] ?> (<?= $cat['products_count'] ?>)</option>
                        <?php endif; ?>
                        <?php endforeach; ?>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" onclick="return confirm('هل أنت متأكد من نقل جميع المنتجات؟')">
                    <span class="material-icons-round">check</span> نقل الكل
                </button>
            </div>
        </form>
    </div>
</div>

<!-- قائمة المنتجات -->
<div class="card">
    <div class="card-header">
        <h3>المنتجات (<?= $totalCount ?? count($products) ?>)</h3>
    </div>
    <div class="card-body">
        <?php if (empty($products)): ?>
        <div class="empty-state">
            <span class="material-icons-round" style="font-size: 48px; color: var(--text-muted);">inventory_2</span>
            <p>لا توجد منتجات في هذا التصنيف</p>
        </div>
        <?php else: ?>
        <div class="table-responsive">
            <table class="table" id="productsTable">
                <thead>
                    <tr>
                        <th>اسم المنتج</th>
                        <th>السعر النقدي</th>
                        <th>سعر التقسيط</th>
                        <th>الكمية</th>
                        <th>الفواتير</th>
                        <th>التصنيف</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($products as $product): ?>
                    <tr id="product-row-<?= $product['id'] ?>">
                        <td>
                            <strong><?= htmlspecialchars($product['name']) ?></strong>
                            <?php if ($product['barcode']): ?>
                            <br><small class="text-muted"><?= $product['barcode'] ?></small>
                            <?php endif; ?>
                        </td>
                        <td><?= formatMoney($product['cash_price']) ?></td>
                        <td><?= formatMoney($product['installment_price']) ?></td>
                        <td>
                            <span class="badge badge-<?= $product['quantity'] <= $product['min_quantity'] ? 'danger' : 'success' ?>">
                                <?= $product['quantity'] ?>
                            </span>
                        </td>
                        <td>
                            <?php if ($product['invoice_count'] > 0): ?>
                            <span class="badge badge-warning" title="مرتبط بفواتير"><?= $product['invoice_count'] ?></span>
                            <?php else: ?>
                            <span class="badge badge-secondary">0</span>
                            <?php endif; ?>
                        </td>
                        <td>
                            <select class="form-control form-control-sm category-select" 
                                    data-product-id="<?= $product['id'] ?>" 
                                    data-original-value="<?= $category['id'] ?>"
                                    onchange="moveProduct(this)">
                                <option value="">-- بدون تصنيف --</option>
                                <?php foreach ($categories as $cat): ?>
                                <option value="<?= $cat['id'] ?>" <?= $cat['id'] == $category['id'] ? 'selected' : '' ?>><?= $cat['name'] ?></option>
                                <?php endforeach; ?>
                            </select>
                        </td>
                        <td>
                            <div class="actions">
                                <a href="<?= url('/products/' . $product['id'] . '/edit') ?>" class="btn btn-sm btn-warning" title="تعديل">
                                    <span class="material-icons-round">edit</span>
                                </a>
                                <?php if ($product['invoice_count'] == 0): ?>
                                <button type="button" class="btn btn-sm btn-danger" title="حذف" onclick="deleteProduct(<?= $product['id'] ?>, '<?= htmlspecialchars($product['name'], ENT_QUOTES) ?>')">
                                    <span class="material-icons-round">delete</span>
                                </button>
                                <?php else: ?>
                                <button type="button" class="btn btn-sm btn-secondary" title="لا يمكن الحذف - مرتبط بفواتير" disabled>
                                    <span class="material-icons-round">lock</span>
                                </button>
                                <?php endif; ?>
                            </div>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
        
        <?php include dirname(__DIR__) . '/partials/pagination.php'; ?>
        <?php endif; ?>
    </div>
</div>

<style>
.page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.page-header h2 { display: flex; align-items: center; gap: 10px; font-size: 22px; }
.actions { display: flex; gap: 5px; }
.actions .btn { padding: 5px 8px; }
.actions .material-icons-round { font-size: 18px; }
.empty-state { text-align: center; padding: 40px; color: var(--text-muted); }
.category-select { min-width: 150px; }
.form-control-sm { padding: 5px 10px; font-size: 13px; }
</style>

<script>
function moveProduct(select) {
    const productId = select.dataset.productId;
    const newCategoryId = select.value;
    const originalValue = select.dataset.originalValue;
    
    if (newCategoryId === originalValue) {
        return;
    }
    
    fetch('<?= url('/categories/' . $category['id'] . '/move-product') ?>', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: 'product_id=' + productId + '&new_category_id=' + newCategoryId
    })
    .then(response => {
        // التحقق من حالة الـ response
        if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
        }
        return response.text();
    })
    .then(text => {
        // محاولة تحويل النص إلى JSON
        if (!text || text.trim() === '') {
            throw new Error('Empty response');
        }
        try {
            return JSON.parse(text);
        } catch (e) {
            console.error('Response text:', text);
            throw new Error('Invalid JSON response');
        }
    })
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            // إزالة الصف من الجدول
            const row = document.getElementById('product-row-' + productId);
            row.style.opacity = '0.5';
            setTimeout(() => {
                row.remove();
                updateProductCount();
            }, 500);
        } else {
            showToast(data.message || 'حدث خطأ', 'error');
            select.value = originalValue;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('حدث خطأ: ' + error.message, 'error');
        select.value = originalValue;
    });
}

function deleteProduct(productId, productName) {
    if (!confirm('هل أنت متأكد من حذف المنتج "' + productName + '"؟')) {
        return;
    }
    
    fetch('<?= url('/categories/' . $category['id'] . '/delete-product') ?>', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: 'product_id=' + productId
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            // إزالة الصف
            const row = document.getElementById('product-row-' + productId);
            row.style.opacity = '0.5';
            setTimeout(() => {
                row.remove();
                updateProductCount();
            }, 500);
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('حدث خطأ في الاتصال', 'error');
    });
}

function updateProductCount() {
    const count = document.querySelectorAll('#productsTable tbody tr').length;
    document.querySelector('.card-header h3').textContent = 'المنتجات (' + count + ')';
}

// دالة إظهار التنبيهات
function showToast(message, type = 'success') {
    // إزالة أي توست سابق
    const existingToast = document.querySelector('.toast-notification');
    if (existingToast) existingToast.remove();
    
    const toast = document.createElement('div');
    toast.className = 'toast-notification toast-' + type;
    toast.innerHTML = '<span class="material-icons-round">' + (type === 'success' ? 'check_circle' : 'error') + '</span> ' + message;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>

<style>
.toast-notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    padding: 15px 25px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    transition: transform 0.3s ease;
}
.toast-notification.show { transform: translateX(-50%) translateY(0); }
.toast-success { background: linear-gradient(135deg, #28a745, #20c997); }
.toast-error { background: linear-gradient(135deg, #dc3545, #e74c3c); }
</style>


============================================================
FILE: app/Views/customers/create.php
============================================================
<?php
$returnTo = $_GET['return_to'] ?? '';
$backUrl = match($returnTo) {
    'pos' => url('/pos'),
    'installment' => url('/pos/installment'),
    default => url('/customers')
};
?>
<div class="page-header">
    <h2><span class="material-icons-round">person_add</span> إضافة عميل جديد</h2>
    <a href="<?= $backUrl ?>" class="btn btn-secondary">
        <span class="material-icons-round">arrow_forward</span> رجوع
    </a>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST" action="<?= url('/customers') ?>" enctype="multipart/form-data">
            <input type="hidden" name="return_to" value="<?= htmlspecialchars($returnTo) ?>">
            <h4 class="section-title">البيانات الأساسية</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label>الاسم الكامل *</label>
                    <input type="text" name="full_name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>رقم الهاتف *</label>
                    <input type="tel" name="phone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>هاتف إضافي</label>
                    <input type="tel" name="phone2" class="form-control">
                </div>
                <div class="form-group">
                    <label>رقم الهوية *</label>
                    <input type="text" name="national_id" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>صورة الهوية</label>
                    <input type="file" name="national_id_image" class="form-control" accept="image/*">
                </div>
                <div class="form-group">
                    <label>الحد الائتماني</label>
                    <input type="number" name="credit_limit" class="form-control" value="0" step="0.01">
                </div>
            </div>

            <h4 class="section-title">العنوان</h4>
            <div class="form-grid">
                <div class="form-group" style="grid-column: span 2">
                    <label>العنوان</label>
                    <input type="text" name="address" class="form-control">
                </div>
                <div class="form-group">
                    <label>المدينة</label>
                    <input type="text" name="city" class="form-control">
                </div>
            </div>

            <h4 class="section-title">بيانات العمل</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label>عنوان العمل</label>
                    <input type="text" name="work_address" class="form-control">
                </div>
                <div class="form-group">
                    <label>هاتف العمل</label>
                    <input type="tel" name="work_phone" class="form-control">
                </div>
            </div>

            <h4 class="section-title">بيانات الضامن</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label>اسم الضامن</label>
                    <input type="text" name="guarantor_name" class="form-control">
                </div>
                <div class="form-group">
                    <label>هاتف الضامن</label>
                    <input type="tel" name="guarantor_phone" class="form-control">
                </div>
                <div class="form-group">
                    <label>هوية الضامن</label>
                    <input type="text" name="guarantor_national_id" class="form-control">
                </div>
            </div>

            <div class="form-group">
                <label>ملاحظات</label>
                <textarea name="notes" class="form-control" rows="3"></textarea>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <span class="material-icons-round">save</span> حفظ العميل
                </button>
                <a href="<?= $backUrl ?>" class="btn btn-secondary">إلغاء</a>
            </div>
        </form>
    </div>
</div>

<style>
.section-title { margin: 25px 0 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); color: var(--primary); }
.form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
.form-actions { display: flex; gap: 15px; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); }
@media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }
</style>


============================================================
FILE: app/Views/customers/edit.php
============================================================
<div class="page-header">
    <h2><span class="material-icons-round">edit</span> تعديل بيانات: <?= $customer['full_name'] ?></h2>
    <a href="<?= url('/customers/' . $customer['id']) ?>" class="btn btn-secondary"><span class="material-icons-round">arrow_forward</span> رجوع</a>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST" action="<?= url('/customers/' . $customer['id']) ?>" enctype="multipart/form-data">
            <h4 class="section-title">البيانات الأساسية</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label>الاسم الكامل *</label>
                    <input type="text" name="full_name" class="form-control" value="<?= $customer['full_name'] ?>" required>
                </div>
                <div class="form-group">
                    <label>رقم الهاتف *</label>
                    <input type="tel" name="phone" class="form-control" value="<?= $customer['phone'] ?>" required>
                </div>
                <div class="form-group">
                    <label>هاتف إضافي</label>
                    <input type="tel" name="phone2" class="form-control" value="<?= $customer['phone2'] ?>">
                </div>
                <div class="form-group">
                    <label>رقم الهوية *</label>
                    <input type="text" name="national_id" class="form-control" value="<?= $customer['national_id'] ?>" required>
                </div>
                <div class="form-group">
                    <label>صورة الهوية</label>
                    <?php if ($customer['national_id_image']): ?>
                    <div style="margin-bottom:10px"><img src="<?= upload('customers/' . $customer['national_id_image']) ?>" alt="" style="max-height:80px;border-radius:8px"></div>
                    <?php endif; ?>
                    <input type="file" name="national_id_image" class="form-control" accept="image/*">
                </div>
                <div class="form-group">
                    <label>الحد الائتماني</label>
                    <input type="number" name="credit_limit" class="form-control" value="<?= $customer['credit_limit'] ?>" step="0.01">
                </div>
            </div>

            <h4 class="section-title">العنوان</h4>
            <div class="form-grid">
                <div class="form-group" style="grid-column: span 2">
                    <label>العنوان</label>
                    <input type="text" name="address" class="form-control" value="<?= $customer['address'] ?>">
                </div>
                <div class="form-group">
                    <label>المدينة</label>
                    <input type="text" name="city" class="form-control" value="<?= $customer['city'] ?>">
                </div>
            </div>

            <h4 class="section-title">بيانات العمل</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label>عنوان العمل</label>
                    <input type="text" name="work_address" class="form-control" value="<?= $customer['work_address'] ?>">
                </div>
                <div class="form-group">
                    <label>هاتف العمل</label>
                    <input type="tel" name="work_phone" class="form-control" value="<?= $customer['work_phone'] ?>">
                </div>
            </div>

            <h4 class="section-title">بيانات الضامن</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label>اسم الضامن</label>
                    <input type="text" name="guarantor_name" class="form-control" value="<?= $customer['guarantor_name'] ?>">
                </div>
                <div class="form-group">
                    <label>هاتف الضامن</label>
                    <input type="tel" name="guarantor_phone" class="form-control" value="<?= $customer['guarantor_phone'] ?>">
                </div>
                <div class="form-group">
                    <label>هوية الضامن</label>
                    <input type="text" name="guarantor_national_id" class="form-control" value="<?= $customer['guarantor_national_id'] ?>">
                </div>
            </div>

            <div class="form-group">
                <label>ملاحظات</label>
                <textarea name="notes" class="form-control" rows="3"><?= $customer['notes'] ?></textarea>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary"><span class="material-icons-round">save</span> حفظ التعديلات</button>
                <a href="<?= url('/customers/' . $customer['id']) ?>" class="btn btn-secondary">إلغاء</a>
            </div>
        </form>
    </div>
</div>

<style>
.section-title { margin: 25px 0 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); color: var(--primary); }
.form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
.form-actions { display: flex; gap: 15px; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); }
@media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }
</style>


============================================================
FILE: app/Views/customers/index.php
============================================================
<?php $exportUrl = url('/export/customers'); ?>
<div class="page-header">
    <h2><span class="material-icons-round">people</span> إدارة العملاء</h2>
    <div class="header-actions">
        <?php include dirname(__DIR__) . '/partials/export_buttons.php'; ?>
        <a href="<?= url('/customers/create') ?>" class="btn btn-primary">
            <span class="material-icons-round">person_add</span> إضافة عميل
        </a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <form method="GET" class="filters">
            <input type="text" name="q" class="form-control" style="width:300px" placeholder="بحث بالاسم أو الهاتف..." value="<?= htmlspecialchars($search) ?>">
            <button type="submit" class="btn btn-primary"><span class="material-icons-round">search</span></button>
            <?php if ($search): ?>
            <a href="<?= url('/customers') ?>" class="btn btn-secondary"><span class="material-icons-round">clear</span></a>
            <?php endif; ?>
        </form>
    </div>
    <div class="card-body">
        <?php $selectionType = 'customers'; $allowDelete = true; include dirname(__DIR__) . '/partials/table_selection.php'; ?>
        
        <div class="table-responsive">
            <table class="table" id="customersTable">
                <thead>
                    <tr>
                        <th class="select-checkbox"><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>
                        <th>#</th>
                        <th>اسم العميل</th>
                        <th>الهاتف</th>
                        <th>رقم الهوية</th>
                        <th>المدينة</th>
                        <th>الرصيد المستحق</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($customers as $customer): ?>
                    <tr>
                        <td class="select-checkbox"><input type="checkbox" class="row-checkbox" data-id="<?= $customer['id'] ?>" onclick="toggleRowSelect(this)"></td>
                        <td><?= $customer['id'] ?></td>
                        <td><strong><?= $customer['full_name'] ?></strong></td>
                        <td><a href="tel:<?= $customer['phone'] ?>"><?= $customer['phone'] ?></a></td>
                        <td><?= $customer['national_id'] ?></td>
                        <td><?= $customer['city'] ?? '-' ?></td>
                        <td>
                            <strong class="<?= $customer['balance'] > 0 ? 'text-danger' : 'text-success' ?>">
                                <?= formatMoney($customer['balance'] ?? 0) ?>
                            </strong>
                        </td>
                        <td>
                            <div class="actions">
                                <a href="<?= url('/customers/' . $customer['id']) ?>" class="btn btn-sm btn-secondary" title="عرض">
                                    <span class="material-icons-round">visibility</span>
                                </a>
                                <a href="<?= url('/customers/' . $customer['id'] . '/edit') ?>" class="btn btn-sm btn-primary" title="تعديل">
                                    <span class="material-icons-round">edit</span>
                                </a>
                            </div>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
        
        <?php include dirname(__DIR__) . '/partials/pagination.php'; ?>
    </div>
</div>

<style>
.page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.page-header h2 { display: flex; align-items: center; gap: 10px; font-size: 22px; }
.actions { display: flex; gap: 5px; }
.actions .btn { padding: 5px 8px; }
.actions .material-icons-round { font-size: 18px; }
</style>

<script>
function filterCustomers() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('#customersTable tbody tr').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
    });
}
</script>


============================================================
FILE: app/Views/customers/show.php
============================================================
<div class="page-header">
    <h2><span class="material-icons-round">person</span> ملف العميل: <?= $customer['full_name'] ?></h2>
    <div class="header-actions">
        <a href="<?= url('/customers/' . $customer['id'] . '/edit') ?>" class="btn btn-primary">
            <span class="material-icons-round">edit</span> تعديل
        </a>
        <a href="<?= url('/customers') ?>" class="btn btn-secondary">
            <span class="material-icons-round">arrow_forward</span> رجوع
        </a>
    </div>
</div>

<div class="customer-profile">
    <div class="profile-sidebar">
        <div class="profile-card">
            <div class="profile-avatar">
                <span class="material-icons-round">account_circle</span>
            </div>
            <h3><?= $customer['full_name'] ?></h3>
            <p><a href="tel:<?= $customer['phone'] ?>"><?= $customer['phone'] ?></a></p>
            
            <div class="profile-stats">
                <div class="stat">
                    <strong class="<?= $balance > 0 ? 'text-danger' : 'text-success' ?>"><?= formatMoney($balance) ?></strong>
                    <span>الرصيد المستحق</span>
                </div>
                <div class="stat">
                    <strong><?= count($invoices) ?></strong>
                    <span>الفواتير</span>
                </div>
            </div>
        </div>
        
        <div class="profile-info">
            <h4>معلومات العميل</h4>
            <ul>
                <li><strong>رقم الهوية:</strong> <?= $customer['national_id'] ?></li>
                <li><strong>هاتف إضافي:</strong> <?= $customer['phone2'] ?: '-' ?></li>
                <li><strong>العنوان:</strong> <?= $customer['address'] ?: '-' ?></li>
                <li><strong>المدينة:</strong> <?= $customer['city'] ?: '-' ?></li>
                <li><strong>عنوان العمل:</strong> <?= $customer['work_address'] ?: '-' ?></li>
                <li><strong>هاتف العمل:</strong> <?= $customer['work_phone'] ?: '-' ?></li>
            </ul>
            
            <?php if ($customer['guarantor_name']): ?>
            <h4>بيانات الضامن</h4>
            <ul>
                <li><strong>الاسم:</strong> <?= $customer['guarantor_name'] ?></li>
                <li><strong>الهاتف:</strong> <?= $customer['guarantor_phone'] ?></li>
                <li><strong>الهوية:</strong> <?= $customer['guarantor_national_id'] ?></li>
            </ul>
            <?php endif; ?>
        </div>
    </div>
    
    <div class="profile-content">
        <div class="card">
            <div class="card-header">
                <h3><span class="material-icons-round">receipt_long</span> الفواتير</h3>
            </div>
            <div class="card-body">
                <?php if (empty($invoices)): ?>
                <p class="empty-message">لا توجد فواتير</p>
                <?php else: ?>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>النوع</th>
                                <th>الإجمالي</th>
                                <th>المتبقي</th>
                                <th>الحالة</th>
                                <th>التاريخ</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($invoices as $inv): ?>
                            <tr>
                                <td><?= $inv['invoice_number'] ?></td>
                                <td><span class="badge badge-<?= $inv['invoice_type'] === 'cash' ? 'success' : 'primary' ?>"><?= invoiceType($inv['invoice_type']) ?></span></td>
                                <td><?= formatMoney($inv['total_amount']) ?></td>
                                <td><?= formatMoney($inv['remaining_amount']) ?></td>
                                <td><span class="badge badge-<?= $inv['status'] === 'completed' ? 'success' : ($inv['status'] === 'active' ? 'warning' : 'secondary') ?>"><?= invoiceStatus($inv['status']) ?></span></td>
                                <td><?= formatDate($inv['created_at']) ?></td>
                                <td><a href="<?= url('/invoices/' . $inv['id']) ?>" class="btn btn-sm btn-secondary">عرض</a></td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
                <?php endif; ?>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3><span class="material-icons-round">payments</span> سجل المدفوعات</h3>
            </div>
            <div class="card-body">
                <?php if (empty($payments)): ?>
                <p class="empty-message">لا توجد مدفوعات</p>
                <?php else: ?>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>رقم الإيصال</th>
                                <th>الفاتورة</th>
                                <th>المبلغ</th>
                                <th>التاريخ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($payments as $pay): ?>
                            <tr>
                                <td><?= $pay['receipt_number'] ?></td>
                                <td><?= $pay['invoice_number'] ?></td>
                                <td><strong class="text-success"><?= formatMoney($pay['amount']) ?></strong></td>
                                <td><?= formatDateTime($pay['payment_date']) ?></td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
                <?php endif; ?>
            </div>
        </div>
    </div>
</div>

<style>
.page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.header-actions { display: flex; gap: 10px; }
.customer-profile { display: grid; grid-template-columns: 320px 1fr; gap: 25px; }
.profile-sidebar { display: flex; flex-direction: column; gap: 20px; }
.profile-card { background: var(--bg-card); border-radius: var(--radius); padding: 30px; text-align: center; }
.profile-avatar { width: 80px; height: 80px; background: var(--primary); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; }
.profile-avatar .material-icons-round { font-size: 48px; color: white; }
.profile-card h3 { margin-bottom: 5px; }
.profile-stats { display: flex; gap: 20px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); }
.profile-stats .stat { flex: 1; text-align: center; }
.profile-stats .stat strong { display: block; font-size: 18px; }
.profile-stats .stat span { font-size: 12px; color: var(--text-muted); }
.profile-info { background: var(--bg-card); border-radius: var(--radius); padding: 20px; }
.profile-info h4 { margin-bottom: 15px; font-size: 14px; color: var(--text-muted); }
.profile-info ul { list-style: none; }
.profile-info li { padding: 8px 0; border-bottom: 1px solid var(--border-color); }
.profile-info li:last-child { border: none; }
.profile-info li strong { color: var(--text-muted); display: inline-block; width: 100px; }
@media (max-width: 1024px) { .customer-profile { grid-template-columns: 1fr; } }
</style>


============================================================
FILE: app/Views/dashboard/index.php
============================================================
<div class="dashboard">
    <!-- إحصائيات سريعة -->
    <div class="stats-grid">
        <div class="stat-card primary">
            <div class="stat-icon">
                <span class="material-icons-round">shopping_cart</span>
            </div>
            <div class="stat-info">
                <h3>مبيعات اليوم النقدية</h3>
                <p class="stat-value"><?= formatMoney($todayStats['cash_total'] ?? 0) ?></p>
                <small><?= $todayStats['cash_count'] ?? 0 ?> فاتورة</small>
            </div>
        </div>
        
        <div class="stat-card success">
            <div class="stat-icon">
                <span class="material-icons-round">credit_score</span>
            </div>
            <div class="stat-info">
                <h3>مبيعات اليوم بالتقسيط</h3>
                <p class="stat-value"><?= formatMoney($todayStats['installment_total'] ?? 0) ?></p>
                <small><?= $todayStats['installment_count'] ?? 0 ?> عقد</small>
            </div>
        </div>
        
        <div class="stat-card warning">
            <div class="stat-icon">
                <span class="material-icons-round">payments</span>
            </div>
            <div class="stat-info">
                <h3>تحصيلات اليوم</h3>
                <p class="stat-value"><?= formatMoney($todayPayments ?? 0) ?></p>
                <small>من الأقساط</small>
            </div>
        </div>
        
        <div class="stat-card danger">
            <div class="stat-icon">
                <span class="material-icons-round">warning</span>
            </div>
            <div class="stat-info">
                <h3>أقساط متأخرة</h3>
                <p class="stat-value"><?= formatMoney($installmentStats['overdue_amount'] ?? 0) ?></p>
                <small><?= $installmentStats['overdue_count'] ?? 0 ?> قسط</small>
            </div>
        </div>
    </div>
    
    <!-- صف ثاني -->
    <div class="stats-grid small">
        <div class="stat-card-mini">
            <span class="material-icons-round">inventory_2</span>
            <div>
                <strong><?= $stats['products_count'] ?? 0 ?></strong>
                <span>منتج</span>
            </div>
        </div>
        <div class="stat-card-mini">
            <span class="material-icons-round">people</span>
            <div>
                <strong><?= $stats['customers_count'] ?? 0 ?></strong>
                <span>عميل</span>
            </div>
        </div>
        <div class="stat-card-mini">
            <span class="material-icons-round">receipt_long</span>
            <div>
                <strong><?= $stats['active_installments'] ?? 0 ?></strong>
                <span>عقد نشط</span>
            </div>
        </div>
        <div class="stat-card-mini <?= ($stats['low_stock_count'] ?? 0) > 0 ? 'alert' : '' ?>">
            <span class="material-icons-round">inventory</span>
            <div>
                <strong><?= $stats['low_stock_count'] ?? 0 ?></strong>
                <span>منتج منخفض</span>
            </div>
        </div>
    </div>
    
    <div class="dashboard-grid">
        <!-- أقساط اليوم -->
        <div class="card">
            <div class="card-header">
                <h3><span class="material-icons-round">today</span> أقساط اليوم</h3>
                <a href="<?= url('/installments/today') ?>" class="btn-link">عرض الكل</a>
            </div>
            <div class="card-body">
                <?php if (empty($todayInstallments)): ?>
                    <p class="empty-message">لا توجد أقساط مستحقة اليوم</p>
                <?php else: ?>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>العميل</th>
                                    <th>القسط</th>
                                    <th>المبلغ</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach ($todayInstallments as $inst): ?>
                                <tr>
                                    <td><?= $inst['customer_name'] ?></td>
                                    <td>القسط <?= $inst['installment_number'] ?></td>
                                    <td><strong><?= formatMoney($inst['remaining_amount']) ?></strong></td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="payInstallment(<?= $inst['id'] ?>, <?= $inst['remaining_amount'] ?>)">
                                            تحصيل
                                        </button>
                                    </td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                <?php endif; ?>
            </div>
        </div>
        
        <!-- الأقساط المتأخرة -->
        <div class="card">
            <div class="card-header danger">
                <h3><span class="material-icons-round">warning</span> أقساط متأخرة</h3>
                <a href="<?= url('/installments/overdue') ?>" class="btn-link">عرض الكل</a>
            </div>
            <div class="card-body">
                <?php if (empty($overdueInstallments)): ?>
                    <p class="empty-message success-message">
                        <span class="material-icons-round">check_circle</span>
                        لا توجد أقساط متأخرة
                    </p>
                <?php else: ?>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>العميل</th>
                                    <th>الهاتف</th>
                                    <th>المبلغ</th>
                                    <th>التأخير</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach ($overdueInstallments as $inst): ?>
                                <tr class="overdue-row">
                                    <td><?= $inst['customer_name'] ?></td>
                                    <td><a href="tel:<?= $inst['customer_phone'] ?>"><?= $inst['customer_phone'] ?></a></td>
                                    <td><strong class="text-danger"><?= formatMoney($inst['remaining_amount']) ?></strong></td>
                                    <td><span class="badge badge-danger"><?= (int)$inst['days_overdue'] ?> يوم</span></td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                <?php endif; ?>
            </div>
        </div>
    </div>
    
    <!-- آخر الفواتير -->
    <div class="card">
        <div class="card-header">
            <h3><span class="material-icons-round">receipt_long</span> آخر الفواتير</h3>
            <a href="<?= url('/invoices') ?>" class="btn-link">عرض الكل</a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>رقم الفاتورة</th>
                            <th>العميل</th>
                            <th>النوع</th>
                            <th>الإجمالي</th>
                            <th>الحالة</th>
                            <th>التاريخ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($recentInvoices as $invoice): ?>
                        <tr>
                            <td><a href="<?= url('/invoices/' . $invoice['id']) ?>"><?= $invoice['invoice_number'] ?></a></td>
                            <td><?= $invoice['customer_name'] ?? 'زبون نقدي' ?></td>
                            <td>
                                <span class="badge badge-<?= $invoice['invoice_type'] === 'cash' ? 'success' : 'primary' ?>">
                                    <?= invoiceType($invoice['invoice_type']) ?>
                                </span>
                            </td>
                            <td><strong><?= formatMoney($invoice['total_amount']) ?></strong></td>
                            <td><span class="badge badge-<?= $invoice['status'] === 'completed' ? 'success' : 'warning' ?>"><?= invoiceStatus($invoice['status']) ?></span></td>
                            <td><?= formatDateTime($invoice['created_at']) ?></td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- نافذة الدفع -->
<div class="modal" id="payModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>تحصيل قسط</h3>
            <button class="close-btn" onclick="closeModal('payModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="payForm">
                <input type="hidden" id="payInstallmentId">
                <div class="form-group">
                    <label>المبلغ المستحق</label>
                    <input type="text" id="dueAmount" readonly class="form-control">
                </div>
                <div class="form-group">
                    <label>المبلغ المدفوع</label>
                    <input type="number" id="payAmount" step="0.01" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    <span class="material-icons-round">check</span>
                    تأكيد الدفع
                </button>
            </form>
        </div>
    </div>
</div>

<script>
function payInstallment(id, amount) {
    document.getElementById('payInstallmentId').value = id;
    document.getElementById('dueAmount').value = amount.toFixed(2) + ' <?= $settings['currency'] ?? 'ج.م' ?>';
    document.getElementById('payAmount').value = amount.toFixed(2);
    document.getElementById('payAmount').max = amount;
    document.getElementById('payModal').classList.add('show');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('show');
}

document.getElementById('payForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const id = document.getElementById('payInstallmentId').value;
    const amount = document.getElementById('payAmount').value;
    
    const formData = new FormData();
    formData.append('amount', amount);
    
    try {
        const response = await fetch('<?= url('/installments/') ?>' + id + '/pay', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('تم تسجيل الدفعة بنجاح\nرقم الإيصال: ' + result.receipt_number);
            location.reload();
        } else {
            alert(result.message || 'حدث خطأ');
        }
    } catch (error) {
        alert('حدث خطأ في الاتصال');
    }
});
</script>


============================================================
FILE: app/Views/errors/404.php
============================================================
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>404 - الصفحة غير موجودة</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }
        .error-container {
            max-width: 500px;
            padding: 40px;
        }
        .error-code {
            font-size: 150px;
            font-weight: 700;
            line-height: 1;
            opacity: 0.3;
            margin-bottom: -20px;
        }
        .error-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.8;
        }
        h1 {
            font-size: 28px;
            margin-bottom: 15px;
        }
        p {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 30px;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 30px;
            background: white;
            color: #1a237e;
            text-decoration: none;
            border-radius: 30px;
            font-weight: 600;
            font-size: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div class="error-container">
        <div class="error-code">404</div>
        <span class="material-icons-round error-icon">search_off</span>
        <h1>الصفحة غير موجودة</h1>
        <p>عذراً، الصفحة التي تبحث عنها غير موجودة أو تم نقلها إلى مكان آخر.</p>
        <a href="<?= url('/') ?>" class="btn">
            <span class="material-icons-round">home</span>
            العودة للرئيسية
        </a>
    </div>
</body>
</html>


============================================================
FILE: app/Views/errors/500.php
============================================================
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>500 - خطأ في الخادم</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #b71c1c 0%, #c62828 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }
        .error-container {
            max-width: 500px;
            padding: 40px;
        }
        .error-code {
            font-size: 150px;
            font-weight: 700;
            line-height: 1;
            opacity: 0.3;
            margin-bottom: -20px;
        }
        .error-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.8;
        }
        h1 {
            font-size: 28px;
            margin-bottom: 15px;
        }
        p {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 30px;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 30px;
            background: white;
            color: #b71c1c;
            text-decoration: none;
            border-radius: 30px;
            font-weight: 600;
            font-size: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div class="error-container">
        <div class="error-code">500</div>
        <span class="material-icons-round error-icon">error_outline</span>
        <h1>خطأ في الخادم</h1>
        <p>عذراً، حدث خطأ غير متوقع. يرجى المحاولة مرة أخرى لاحقاً.</p>
        <a href="<?= url('/') ?>" class="btn">
            <span class="material-icons-round">refresh</span>
            حاول مجدداً
        </a>
    </div>
</body>
</html>


============================================================
FILE: app/Views/installments/index.php
============================================================
<?php $exportUrl = url('/export/installments'); ?>
<div class="page-header">
    <h2><span class="material-icons-round">payments</span> إدارة الأقساط</h2>
    <div class="header-actions">
        <?php include dirname(__DIR__) . '/partials/export_buttons.php'; ?>
        <a href="<?= url('/installments/today') ?>" class="btn btn-primary"><span class="material-icons-round">today</span> أقساط اليوم</a>
        <a href="<?= url('/installments/overdue') ?>" class="btn btn-danger"><span class="material-icons-round">warning</span> المتأخرات</a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>عقود التقسيط</h3>
        <form method="GET" class="filters">
            <select name="status" class="form-control" onchange="this.form.submit()">
                <option value="">كل الحالات</option>
                <option value="active" <?= $status === 'active' ? 'selected' : '' ?>>نشط</option>
                <option value="completed" <?= $status === 'completed' ? 'selected' : '' ?>>مكتمل</option>
            </select>
            <input type="text" name="q" class="form-control" style="width:250px" placeholder="بحث..." value="<?= htmlspecialchars($search) ?>">
            <button type="submit" class="btn btn-primary"><span class="material-icons-round">search</span></button>
            <?php if ($search || $status): ?>
            <a href="<?= url('/installments') ?>" class="btn btn-secondary"><span class="material-icons-round">clear</span></a>
            <?php endif; ?>
        </form>
    </div>
    <div class="card-body">
        <?php $selectionType = 'installments'; $allowDelete = false; include dirname(__DIR__) . '/partials/table_selection.php'; ?>
        
        <div class="table-responsive">
            <table class="table" id="dataTable">
                <thead>
                    <tr>
                        <th class="select-checkbox"><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>
                        <th>رقم الفاتورة</th>
                        <th>العميل</th>
                        <th>الإجمالي</th>
                        <th>المدفوع</th>
                        <th>المتبقي</th>
                        <th>القسط الشهري</th>
                        <th>الأقساط</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($invoices as $inv): ?>
                    <tr>
                        <td class="select-checkbox"><input type="checkbox" class="row-checkbox" data-id="<?= $inv['id'] ?>" onclick="toggleRowSelect(this)"></td>
                        <td><a href="<?= url('/invoices/' . $inv['id']) ?>"><?= $inv['invoice_number'] ?></a></td>
                        <td><strong><?= $inv['customer_name'] ?></strong></td>
                        <td><?= formatMoney($inv['total_amount']) ?></td>
                        <td class="text-success"><?= formatMoney($inv['paid_amount']) ?></td>
                        <td class="text-danger"><?= formatMoney($inv['remaining_amount']) ?></td>
                        <td><?= formatMoney($inv['monthly_installment']) ?></td>
                        <td><span class="badge badge-success"><?= $inv['paid_count'] ?? 0 ?></span> / <span class="badge badge-warning"><?= $inv['pending_count'] ?? 0 ?></span></td>
                        <td><a href="<?= url('/invoices/' . $inv['id']) ?>" class="btn btn-sm btn-secondary">عرض</a></td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
        
        <?php include dirname(__DIR__) . '/partials/pagination.php'; ?>
    </div>
</div>

<style>
.page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.quick-links { display: flex; gap: 10px; }
</style>

<script>
function filterTable() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('#dataTable tbody tr').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
    });
}
</script>


============================================================
FILE: app/Views/installments/overdue.php
============================================================
<?php $exportUrl = url('/export/installments/overdue'); ?>
<div class="page-header">
    <h2><span class="material-icons-round">warning</span> الأقساط المتأخرة</h2>
    <div class="header-actions">
        <?php include dirname(__DIR__) . '/partials/export_buttons.php'; ?>
        <a href="<?= url('/installments') ?>" class="btn btn-secondary"><span class="material-icons-round">arrow_forward</span> رجوع</a>
    </div>
</div>

<?php if (empty($installments)): ?>
<div class="card">
    <div class="card-body">
        <p class="empty-message success-message"><span class="material-icons-round">check_circle</span> لا توجد أقساط متأخرة - ممتاز!</p>
    </div>
</div>
<?php else: ?>

<div class="summary-bar">
    <div class="summary-item">
        <span class="material-icons-round">error</span>
        <div><strong><?= $pagination->getTotalItems() ?></strong><span>قسط متأخر</span></div>
    </div>
    <div class="summary-item">
        <span class="material-icons-round">payments</span>
        <div><strong><?= formatMoney($total) ?></strong><span>إجمالي المتأخرات</span></div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <?php $selectionType = 'installments/overdue'; $allowDelete = false; include dirname(__DIR__) . '/partials/table_selection.php'; ?>
        
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th class="select-checkbox"><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>
                        <th>العميل</th>
                        <th>الهاتف</th>
                        <th>رقم الفاتورة</th>
                        <th>القسط</th>
                        <th>المبلغ</th>
                        <th>تاريخ الاستحقاق</th>
                        <th>أيام التأخير</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($installments as $inst): ?>
                    <tr class="overdue-row">
                        <td class="select-checkbox"><input type="checkbox" class="row-checkbox" data-id="<?= $inst['id'] ?>" onclick="toggleRowSelect(this)"></td>
                        <td><strong><?= $inst['customer_name'] ?></strong></td>
                        <td><a href="tel:<?= $inst['customer_phone'] ?>"><?= $inst['customer_phone'] ?></a></td>
                        <td><a href="<?= url('/invoices/' . $inst['invoice_id']) ?>"><?= $inst['invoice_number'] ?></a></td>
                        <td>القسط <?= $inst['installment_number'] ?></td>
                        <td><strong class="text-danger"><?= formatMoney($inst['remaining_amount']) ?></strong></td>
                        <td><?= formatDate($inst['due_date']) ?></td>
                        <td><span class="badge badge-danger"><?= (int)$inst['days_overdue'] ?> يوم</span></td>
                        <td>
                            <div class="actions">
                                <a href="https://wa.me/<?= preg_replace('/[^0-9]/', '', $inst['customer_phone']) ?>?text=<?= urlencode('السلام عليكم، نذكركم بقسط متأخر بمبلغ ' . formatMoney($inst['remaining_amount'])) ?>" class="btn btn-sm btn-success" target="_blank" title="تذكير واتساب"><span class="material-icons-round">chat</span></a>
                                <button class="btn btn-sm btn-primary" onclick="payInstallment(<?= $inst['id'] ?>, <?= $inst['remaining_amount'] ?>, '<?= $inst['customer_name'] ?>')">تحصيل</button>
                            </div>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
        
        <?php include dirname(__DIR__) . '/partials/pagination.php'; ?>
    </div>
</div>
<?php endif; ?>

<div class="modal" id="payModal">
    <div class="modal-content">
        <div class="modal-header"><h3>تحصيل قسط</h3><button class="close-btn" onclick="closeModal('payModal')">&times;</button></div>
        <div class="modal-body">
            <p id="customerName" style="margin-bottom:15px;font-weight:600"></p>
            <form id="payForm">
                <input type="hidden" id="payInstallmentId">
                <div class="form-group"><label>المبلغ المستحق</label><input type="text" id="dueAmount" readonly class="form-control"></div>
                <div class="form-group"><label>المبلغ المدفوع</label><input type="number" id="payAmount" step="0.01" class="form-control" required></div>
                <button type="submit" class="btn btn-primary btn-block">تأكيد الدفع</button>
            </form>
        </div>
    </div>
</div>

<style>
.summary-bar { display: flex; gap: 20px; margin-bottom: 25px; }
.summary-item { background: var(--bg-card); border-radius: var(--radius); padding: 20px 25px; display: flex; align-items: center; gap: 15px; box-shadow: var(--shadow); }
.summary-item .material-icons-round { font-size: 36px; color: var(--danger); }
.summary-item strong { display: block; font-size: 24px; }
.summary-item span { font-size: 13px; color: var(--text-muted); }
.overdue-row { background: rgba(229, 57, 53, 0.05); }
.actions { display: flex; gap: 8px; }
</style>

<script>
function payInstallment(id, amount, name) {
    document.getElementById('payInstallmentId').value = id;
    document.getElementById('customerName').textContent = name;
    document.getElementById('dueAmount').value = amount.toFixed(2) + ' <?= $settings['currency'] ?? 'ج.م' ?>';
    document.getElementById('payAmount').value = amount.toFixed(2);
    document.getElementById('payModal').classList.add('show');
}
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
document.getElementById('payForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const id = document.getElementById('payInstallmentId').value;
    const amount = document.getElementById('payAmount').value;
    const formData = new FormData();
    formData.append('amount', amount);
    const response = await fetch('<?= url('/installments/') ?>' + id + '/pay', { method: 'POST', body: formData });
    const result = await response.json();
    if (result.success) { alert('تم تسجيل الدفعة'); location.reload(); } else { alert(result.message); }
});
</script>


============================================================
FILE: app/Views/installments/today.php
============================================================
<?php 
$exportUrl = url('/export/installments/today');
$todayTotal = array_sum(array_column($installments, 'remaining_amount'));
?>
<div class="page-header">
    <h2><span class="material-icons-round">today</span> أقساط اليوم - <?= formatDate(date('Y-m-d')) ?></h2>
    <div class="header-actions">
        <?php include dirname(__DIR__) . '/partials/export_buttons.php'; ?>
        <a href="<?= url('/installments') ?>" class="btn btn-secondary"><span class="material-icons-round">arrow_forward</span> رجوع</a>
    </div>
</div>

<?php if (empty($installments)): ?>
<div class="card">
    <div class="card-body">
        <p class="empty-message success-message"><span class="material-icons-round">check_circle</span> لا توجد أقساط مستحقة اليوم</p>
    </div>
</div>
<?php else: ?>

<div class="summary-bar">
    <div class="summary-item">
        <span class="material-icons-round" style="color:var(--primary)">event</span>
        <div><strong><?= count($installments) ?></strong><span>قسط مستحق</span></div>
    </div>
    <div class="summary-item">
        <span class="material-icons-round" style="color:var(--success)">payments</span>
        <div><strong><?= formatMoney($todayTotal) ?></strong><span>إجمالي المستحق</span></div>
    </div>
</div>
<div class="installments-grid">
    <?php foreach ($installments as $inst): ?>
    <div class="installment-card">
        <div class="card-top">
            <div class="customer-avatar"><span class="material-icons-round">account_circle</span></div>
            <div class="customer-info">
                <h4><?= $inst['customer_name'] ?></h4>
                <a href="tel:<?= $inst['customer_phone'] ?>"><?= $inst['customer_phone'] ?></a>
            </div>
            <div class="amount">
                <strong><?= formatMoney($inst['remaining_amount']) ?></strong>
                <small>القسط <?= $inst['installment_number'] ?></small>
            </div>
        </div>
        <div class="card-bottom">
            <span class="invoice-num">فاتورة: <?= $inst['invoice_number'] ?></span>
            <div class="actions">
                <a href="https://wa.me/<?= preg_replace('/[^0-9]/', '', $inst['customer_phone']) ?>" class="btn btn-sm btn-success" target="_blank" title="واتساب"><span class="material-icons-round">chat</span></a>
                <button class="btn btn-sm btn-primary" onclick="payInstallment(<?= $inst['id'] ?>, <?= $inst['remaining_amount'] ?>, '<?= $inst['customer_name'] ?>')">تحصيل</button>
            </div>
        </div>
    </div>
    <?php endforeach; ?>
</div>
<?php endif; ?>

<div class="modal" id="payModal">
    <div class="modal-content">
        <div class="modal-header"><h3>تحصيل قسط</h3><button class="close-btn" onclick="closeModal('payModal')">&times;</button></div>
        <div class="modal-body">
            <p id="customerName" style="margin-bottom:15px;font-weight:600"></p>
            <form id="payForm">
                <input type="hidden" id="payInstallmentId">
                <div class="form-group"><label>المبلغ المستحق</label><input type="text" id="dueAmount" readonly class="form-control"></div>
                <div class="form-group"><label>المبلغ المدفوع</label><input type="number" id="payAmount" step="0.01" class="form-control" required></div>
                <button type="submit" class="btn btn-primary btn-block"><span class="material-icons-round">check</span> تأكيد الدفع</button>
            </form>
        </div>
    </div>
</div>

<style>
.summary-bar { display: flex; gap: 20px; margin-bottom: 25px; }
.summary-item { background: var(--bg-card); border-radius: var(--radius); padding: 20px 25px; display: flex; align-items: center; gap: 15px; box-shadow: var(--shadow); }
.summary-item .material-icons-round { font-size: 36px; }
.summary-item strong { display: block; font-size: 24px; }
.summary-item span { font-size: 13px; color: var(--text-muted); }
.installments-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
.installment-card { background: var(--bg-card); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); }
.card-top { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
.customer-avatar { width: 50px; height: 50px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
.customer-avatar .material-icons-round { font-size: 30px; color: white; }
.customer-info { flex: 1; }
.customer-info h4 { margin-bottom: 3px; }
.customer-info a { color: var(--text-muted); font-size: 14px; }
.amount { text-align: left; }
.amount strong { display: block; font-size: 20px; color: var(--primary); }
.amount small { color: var(--text-muted); }
.card-bottom { display: flex; justify-content: space-between; align-items: center; }
.invoice-num { font-size: 13px; color: var(--text-muted); }
.actions { display: flex; gap: 8px; }
</style>

<script>
function payInstallment(id, amount, name) {
    document.getElementById('payInstallmentId').value = id;
    document.getElementById('customerName').textContent = name;
    document.getElementById('dueAmount').value = amount.toFixed(2) + ' <?= $settings['currency'] ?? 'ج.م' ?>';
    document.getElementById('payAmount').value = amount.toFixed(2);
    document.getElementById('payModal').classList.add('show');
}
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
document.getElementById('payForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const id = document.getElementById('payInstallmentId').value;
    const amount = document.getElementById('payAmount').value;
    const formData = new FormData();
    formData.append('amount', amount);
    const response = await fetch('<?= url('/installments/') ?>' + id + '/pay', { method: 'POST', body: formData });
    const result = await response.json();
    if (result.success) { alert('تم تسجيل الدفعة بنجاح\nرقم الإيصال: ' + result.receipt_number); location.reload(); } else { alert(result.message); }
});
</script>


============================================================
FILE: app/Views/invoices/contract.php
============================================================
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>عقد تقسيط - <?= $invoice['invoice_number'] ?></title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cairo', sans-serif; background: #fff; color: #333; padding: 30px; font-size: 14px; line-height: 1.8; }
        .contract { max-width: 800px; margin: 0 auto; border: 2px solid #1a237e; padding: 30px; }
        .header { text-align: center; border-bottom: 2px solid #1a237e; padding-bottom: 20px; margin-bottom: 20px; }
        .header h1 { color: #1a237e; font-size: 24px; margin-bottom: 5px; }
        .header h2 { font-size: 18px; color: #666; }
        .header p { color: #666; font-size: 12px; }
        .contract-info { display: flex; justify-content: space-between; margin-bottom: 25px; padding: 15px; background: #f5f5f5; border-radius: 8px; }
        .contract-info div { text-align: center; }
        .contract-info strong { display: block; font-size: 16px; color: #1a237e; }
        .section { margin-bottom: 25px; }
        .section-title { background: #1a237e; color: white; padding: 8px 15px; border-radius: 5px; margin-bottom: 15px; }
        .party-info { padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; }
        .party-info h4 { color: #1a237e; margin-bottom: 10px; }
        .party-info p { margin-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: right; }
        th { background: #f5f5f5; }
        .summary-box { background: #e3f2fd; padding: 20px; border-radius: 8px; }
        .summary-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .summary-row:last-child { border: none; font-size: 18px; font-weight: 700; color: #1a237e; }
        .installments-table th { background: #1a237e; color: white; }
        .terms { padding: 15px; background: #fff3e0; border-radius: 8px; font-size: 13px; }
        .terms h4 { margin-bottom: 10px; color: #e65100; }
        .terms ol { padding-right: 20px; }
        .terms li { margin-bottom: 8px; }
        .signatures { display: flex; justify-content: space-between; margin-top: 40px; padding-top: 20px; }
        .signature { text-align: center; width: 200px; }
        .signature-line { border-top: 1px solid #333; margin-top: 60px; padding-top: 10px; }
        .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
        @media print { body { padding: 0; } .no-print { display: none; } .contract { border: none; } }
    </style>
</head>
<body>
    <div class="contract">
        <div class="header">
            <?php if (!empty($settings['store_logo'])): ?>
                <img src="<?= asset('images/' . $settings['store_logo']) ?>" alt="الشعار" style="max-width: 150px; max-height: 80px; margin-bottom: 10px;">
            <?php else: ?>
                <img src="<?= asset('images/logo.png') ?>" alt="الشعار" style="max-width: 150px; max-height: 80px; margin-bottom: 10px;">
            <?php endif; ?>
            <h1><?= $settings['store_name'] ?? 'نظام تقسيط' ?></h1>
            <h2>عقد بيع بالتقسيط</h2>
            <p><?= $settings['store_address'] ?? '' ?> | هاتف: <?= $settings['store_phone'] ?? '' ?></p>
        </div>
        
        <div class="contract-info">
            <div><span>رقم العقد</span><strong><?= $invoice['invoice_number'] ?></strong></div>
            <div><span>تاريخ العقد</span><strong><?= formatDate($invoice['created_at']) ?></strong></div>
            <div><span>تاريخ أول قسط</span><strong><?= formatDate($invoice['first_installment_date']) ?></strong></div>
        </div>
        
        <div class="section">
            <div class="party-info">
                <h4>الطرف الأول (البائع)</h4>
                <p><strong><?= $settings['store_name'] ?? 'نظام تقسيط' ?></strong></p>
                <p>العنوان: <?= $settings['store_address'] ?? '' ?></p>
                <p>الهاتف: <?= $settings['store_phone'] ?? '' ?></p>
            </div>
            <div class="party-info">
                <h4>الطرف الثاني (المشتري)</h4>
                <p><strong><?= $invoice['customer_name'] ?></strong></p>
                <p>رقم الهوية: <?= $invoice['customer_id'] ?></p>
                <p>الهاتف: <?= $invoice['customer_phone'] ?></p>
            </div>
        </div>
        
        <div class="section">
            <h3 class="section-title">البضاعة المباعة</h3>
            <table>
                <thead><tr><th>#</th><th>الصنف</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th></tr></thead>
                <tbody>
                    <?php $i = 1; foreach ($invoice['items'] as $item): ?>
                    <tr>
                        <td><?= $i++ ?></td>
                        <td><?= $item['product_name'] ?><?php if ($item['serial_number']): ?><br><small>السيريال: <?= $item['serial_number'] ?></small><?php endif; ?></td>
                        <td><?= $item['quantity'] ?></td>
                        <td><?= formatMoney($item['unit_price']) ?></td>
                        <td><?= formatMoney($item['total_price']) ?></td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h3 class="section-title">ملخص الأسعار</h3>
            <div class="summary-box">
                <div class="summary-row"><span>السعر النقدي:</span><span><?= formatMoney($invoice['subtotal']) ?></span></div>
                <div class="summary-row"><span>سعر التقسيط:</span><span><?= formatMoney($invoice['total_amount']) ?></span></div>
                <div class="summary-row"><span>الدفعة المقدمة:</span><span><?= formatMoney($invoice['down_payment']) ?></span></div>
                <div class="summary-row"><span>المبلغ المتبقي:</span><span><?= formatMoney($invoice['remaining_amount']) ?></span></div>
                <div class="summary-row"><span>عدد الأقساط:</span><span><?= $invoice['installments_count'] ?> شهر</span></div>
                <div class="summary-row"><span>القسط الشهري:</span><span><?= formatMoney($invoice['monthly_installment']) ?></span></div>
            </div>
        </div>
        
        <div class="section">
            <h3 class="section-title">جدول الأقساط</h3>
            <table class="installments-table">
                <thead><tr><th>#</th><th>تاريخ الاستحقاق</th><th>المبلغ</th><th>الحالة</th></tr></thead>
                <tbody>
                    <?php foreach ($invoice['installments'] as $inst): ?>
                    <tr>
                        <td>القسط <?= $inst['installment_number'] ?></td>
                        <td><?= formatDate($inst['due_date']) ?></td>
                        <td><?= formatMoney($inst['amount']) ?></td>
                        <td><?= installmentStatus($inst['status']) ?></td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
        
        <div class="section terms">
            <h4>الشروط والأحكام</h4>
            <ol>
                <li>يلتزم الطرف الثاني بسداد الأقساط في مواعيدها المحددة.</li>
                <li>في حالة التأخر عن سداد قسطين متتاليين يحق للطرف الأول استرداد البضاعة.</li>
                <li>تبقى ملكية البضاعة للطرف الأول حتى سداد كامل المبلغ.</li>
                <li>لا يحق للطرف الثاني بيع أو رهن البضاعة قبل السداد الكامل.</li>
                <li>الضامن ملتزم بالسداد في حالة تعثر الطرف الثاني.</li>
            </ol>
        </div>
        
        <div class="signatures">
            <div class="signature"><div class="signature-line">توقيع البائع</div></div>
            <div class="signature"><div class="signature-line">توقيع المشتري</div></div>
            <div class="signature"><div class="signature-line">توقيع الضامن</div></div>
        </div>
        
        <div class="footer">
            <p>تم إنشاء هذا العقد بتاريخ <?= formatDateTime($invoice['created_at']) ?></p>
        </div>
    </div>
    
    <div class="no-print" style="text-align:center;margin-top:30px">
        <button onclick="window.print()" style="padding:12px 40px;font-size:16px;cursor:pointer;background:#1a237e;color:white;border:none;border-radius:8px">طباعة العقد</button>
    </div>
</body>
</html>


============================================================
FILE: app/Views/invoices/edit.php
============================================================
<?php $isInstallment = $invoice['invoice_type'] === 'installment'; ?>
<div class="page-header">
    <h2><span class="material-icons-round">edit</span> تعديل فاتورة <?= $invoice['invoice_number'] ?></h2>
    <div class="header-actions">
        <a href="<?= url('/invoices/' . $invoice['id']) ?>" class="btn btn-secondary"><span class="material-icons-round">arrow_forward</span> رجوع</a>
    </div>
</div>

<?php if ($isInstallment): ?>
<!-- تعديل فاتورة التقسيط - الملاحظات فقط -->
<div class="card">
    <div class="card-header">
        <h3><span class="material-icons-round">info</span> تعديل فاتورة التقسيط</h3>
    </div>
    <div class="card-body">
        <div class="alert alert-warning">
            <span class="material-icons-round">warning</span>
            فواتير التقسيط لا يمكن تعديل مبالغها لأنها مرتبطة بجدول الأقساط. يمكنك تعديل الملاحظات فقط.
        </div>
        
        <form method="POST" action="<?= url('/invoices/' . $invoice['id']) ?>">
            <div class="form-group">
                <label>الملاحظات</label>
                <textarea name="notes" class="form-control" rows="4"><?= htmlspecialchars($invoice['notes'] ?? '') ?></textarea>
            </div>
            <button type="submit" class="btn btn-primary"><span class="material-icons-round">save</span> حفظ التعديلات</button>
        </form>
    </div>
</div>

<?php else: ?>
<!-- تعديل فاتورة نقدي -->
<div class="pos-container">
    <div class="pos-products">
        <div class="pos-header">
            <div class="search-wrapper">
                <span class="material-icons-round">search</span>
                <input type="text" id="productSearch" placeholder="بحث عن منتج..." autocomplete="off">
            </div>
            <div class="category-filter">
                <button class="cat-btn active" data-category="all">الكل</button>
                <?php foreach ($categories as $cat): ?>
                <button class="cat-btn" data-category="<?= $cat['id'] ?>"><?= $cat['name'] ?></button>
                <?php endforeach; ?>
            </div>
        </div>
        
        <div class="products-grid" id="productsGrid">
            <?php foreach ($products as $product): ?>
            <div class="product-card" data-id="<?= $product['id'] ?>" 
                 data-name="<?= htmlspecialchars($product['name']) ?>"
                 data-price="<?= $product['cash_price'] ?>"
                 data-category="<?= $product['category_id'] ?>"
                 data-quantity="<?= $product['quantity'] ?>">
                <div class="product-image">
                    <?php if ($product['image']): ?>
                        <img src="<?= upload('products/' . $product['image']) ?>" alt="<?= $product['name'] ?>">
                    <?php else: ?>
                        <img src="<?= upload('products/default.png') ?>" alt="<?= $product['name'] ?>">
                    <?php endif; ?>
                </div>
                <div class="product-info">
                    <h4><?= $product['name'] ?></h4>
                    <p class="product-price"><?= formatMoney($product['cash_price']) ?></p>
                    <small class="stock">المخزون: <?= $product['quantity'] ?></small>
                </div>
            </div>
            <?php endforeach; ?>
        </div>
    </div>
    
    <div class="pos-cart">
        <div class="cart-header">
            <h3><span class="material-icons-round">shopping_cart</span> بنود الفاتورة</h3>
            <button class="btn-clear" onclick="clearCart()">
                <span class="material-icons-round">delete_sweep</span>
            </button>
        </div>
        
        <div class="cart-items" id="cartItems">
            <p class="empty-cart">السلة فارغة</p>
        </div>
        
        <div class="cart-summary">
            <div class="summary-row">
                <span>المجموع:</span>
                <strong id="subtotal">0.00 <?= $settings['currency'] ?? 'ج.م' ?></strong>
            </div>
            <div class="summary-row">
                <span>الخصم:</span>
                <input type="number" id="discountInput" value="<?= $invoice['discount_amount'] ?>" min="0" step="0.01" onchange="updateTotals()">
            </div>
            <div class="summary-row total">
                <span>الإجمالي:</span>
                <strong id="grandTotal">0.00 <?= $settings['currency'] ?? 'ج.م' ?></strong>
            </div>
        </div>
        
        <div class="cart-customer">
            <label>العميل:</label>
            <select id="customerSelect">
                <option value="">زبون نقدي</option>
                <?php foreach ($customers as $customer): ?>
                <option value="<?= $customer['id'] ?>" <?= $customer['id'] == $invoice['customer_id'] ? 'selected' : '' ?>><?= $customer['full_name'] ?> - <?= $customer['phone'] ?></option>
                <?php endforeach; ?>
            </select>
        </div>
        
        <div class="cart-notes">
            <label>الملاحظات:</label>
            <textarea id="notesInput" class="form-control" rows="2"><?= htmlspecialchars($invoice['notes'] ?? '') ?></textarea>
        </div>
        
        <div class="cart-actions">
            <button class="btn btn-primary btn-block" onclick="saveChanges()">
                <span class="material-icons-round">save</span>
                حفظ التعديلات
            </button>
        </div>
    </div>
</div>

<style>
.pos-container { display: grid; grid-template-columns: 1fr 380px; gap: 25px; height: calc(100vh - var(--header-height) - 120px); }
.pos-products { background: var(--bg-card); border-radius: var(--radius); overflow: hidden; display: flex; flex-direction: column; }
.pos-header { padding: 20px; border-bottom: 1px solid var(--border-color); }
.search-wrapper { display: flex; align-items: center; background: var(--bg-main); border-radius: 12px; padding: 0 15px; margin-bottom: 15px; }
.search-wrapper input { flex: 1; padding: 12px; border: none; background: transparent; font-family: inherit; font-size: 15px; color: var(--text-primary); }
.search-wrapper input:focus { outline: none; }
.category-filter { display: flex; gap: 8px; flex-wrap: wrap; }
.cat-btn { padding: 8px 16px; border: none; background: var(--bg-main); border-radius: 20px; font-family: inherit; font-size: 13px; cursor: pointer; transition: all 0.2s; }
.cat-btn:hover, .cat-btn.active { background: var(--primary); color: white; }
.products-grid { flex: 1; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; overflow-y: auto; align-content: start; }
.product-card { background: var(--bg-main); border-radius: var(--radius); padding: 12px; cursor: pointer; transition: all 0.2s; text-align: center; }
.product-card:hover { transform: translateY(-3px); box-shadow: var(--shadow); }
.product-image { width: 60px; height: 60px; margin: 0 auto 10px; background: var(--bg-card); border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.product-image img { max-width: 100%; max-height: 100%; object-fit: contain; }
.product-info h4 { font-size: 12px; margin-bottom: 5px; }
.product-price { color: var(--primary); font-weight: 700; font-size: 13px; }
.stock { color: var(--text-muted); font-size: 11px; }
.pos-cart { background: var(--bg-card); border-radius: var(--radius); display: flex; flex-direction: column; }
.cart-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
.cart-header h3 { display: flex; align-items: center; gap: 10px; font-size: 16px; }
.btn-clear { background: none; border: none; color: var(--danger); cursor: pointer; }
.cart-items { flex: 1; padding: 15px; overflow-y: auto; }
.empty-cart { text-align: center; color: var(--text-muted); padding: 40px 0; }
.cart-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-main); border-radius: var(--radius-sm); margin-bottom: 10px; }
.cart-item-info { flex: 1; }
.cart-item-info h5 { font-size: 13px; margin-bottom: 3px; }
.cart-item-info small { color: var(--text-muted); }
.cart-item-qty { display: flex; align-items: center; gap: 5px; }
.cart-item-qty button { width: 28px; height: 28px; border: none; background: var(--bg-card); border-radius: 6px; cursor: pointer; font-size: 16px; }
.cart-item-qty span { width: 30px; text-align: center; font-weight: 600; }
.cart-item-remove { background: none; border: none; color: var(--danger); cursor: pointer; }
.cart-summary { padding: 15px 20px; border-top: 1px solid var(--border-color); }
.summary-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.summary-row.total { font-size: 18px; padding-top: 10px; border-top: 2px solid var(--border-color); }
.summary-row input { width: 100px; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; text-align: center; font-family: inherit; }
.cart-customer, .cart-notes { padding: 10px 20px; border-top: 1px solid var(--border-color); }
.cart-customer label, .cart-notes label { display: block; margin-bottom: 8px; font-size: 13px; }
.cart-customer select, .cart-notes textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit; background: var(--bg-main); }
.cart-actions { padding: 20px; }
.alert { padding: 15px; border-radius: var(--radius-sm); display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
.alert-warning { background: rgba(255, 193, 7, 0.1); color: #856404; border: 1px solid rgba(255, 193, 7, 0.3); }
</style>

<script>
// تحميل بنود الفاتورة الحالية
let cart = <?= json_encode(array_map(function($item) {
    return [
        'id' => $item['product_id'],
        'name' => $item['product_name'],
        'price' => (float) $item['unit_price'],
        'quantity' => (int) $item['quantity'],
        'stock' => 999 // سنسمح بأي كمية لأن المخزون سيُرجع أولاً
    ];
}, $invoice['items'])) ?>;

const currency = '<?= $settings['currency'] ?? 'ج.م' ?>';
const invoiceId = <?= $invoice['id'] ?>;

// عرض السلة
function renderCart() {
    const container = document.getElementById('cartItems');
    
    if (cart.length === 0) {
        container.innerHTML = '<p class="empty-cart">السلة فارغة</p>';
        updateTotals();
        return;
    }
    
    container.innerHTML = cart.map((item, index) => `
        <div class="cart-item">
            <div class="cart-item-info">
                <h5>${item.name}</h5>
                <small>${item.price.toFixed(2)} ${currency}</small>
            </div>
            <div class="cart-item-qty">
                <button onclick="changeQty(${index}, -1)">-</button>
                <span>${item.quantity}</span>
                <button onclick="changeQty(${index}, 1)">+</button>
            </div>
            <button class="cart-item-remove" onclick="removeItem(${index})">
                <span class="material-icons-round">close</span>
            </button>
        </div>
    `).join('');
    
    updateTotals();
}

// إضافة منتج للسلة
document.querySelectorAll('.product-card').forEach(card => {
    card.addEventListener('click', function() {
        const id = this.dataset.id;
        const name = this.dataset.name;
        const price = parseFloat(this.dataset.price);
        const stock = parseInt(this.dataset.quantity);
        
        const existing = cart.find(item => item.id === id);
        
        if (existing) {
            existing.quantity++;
        } else {
            cart.push({ id, name, price, quantity: 1, stock });
        }
        
        renderCart();
    });
});

// تغيير الكمية
function changeQty(index, change) {
    const item = cart[index];
    const newQty = item.quantity + change;
    
    if (newQty <= 0) {
        removeItem(index);
    } else {
        item.quantity = newQty;
        renderCart();
    }
}

// حذف عنصر
function removeItem(index) {
    cart.splice(index, 1);
    renderCart();
}

// تفريغ السلة
function clearCart() {
    if (cart.length === 0) return;
    if (confirm('هل تريد تفريغ السلة؟')) {
        cart = [];
        renderCart();
    }
}

// تحديث الإجماليات
function updateTotals() {
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const discount = parseFloat(document.getElementById('discountInput').value) || 0;
    const total = subtotal - discount;
    
    document.getElementById('subtotal').textContent = subtotal.toFixed(2) + ' ' + currency;
    document.getElementById('grandTotal').textContent = total.toFixed(2) + ' ' + currency;
}

// حفظ التعديلات
async function saveChanges() {
    if (cart.length === 0) {
        alert('يجب إضافة منتجات للفاتورة');
        return;
    }
    
    const items = cart.map(item => ({
        id: item.id,
        quantity: item.quantity,
        price: item.price
    }));
    
    const formData = new FormData();
    formData.append('items', JSON.stringify(items));
    formData.append('discount', document.getElementById('discountInput').value);
    formData.append('customer_id', document.getElementById('customerSelect').value);
    formData.append('notes', document.getElementById('notesInput').value);
    
    try {
        const response = await fetch('<?= url('/invoices/' . $invoice['id']) ?>', {
            method: 'POST',
            body: formData
        });
        
        if (response.redirected) {
            window.location.href = response.url;
        }
    } catch (error) {
        alert('حدث خطأ في العملية');
    }
}

// تصفية بالتصنيف
document.querySelectorAll('.cat-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        const category = this.dataset.category;
        
        document.querySelectorAll('.product-card').forEach(card => {
            if (category === 'all' || card.dataset.category === category) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    });
});

// البحث
document.getElementById('productSearch').addEventListener('input', function() {
    const query = this.value.toLowerCase();
    
    document.querySelectorAll('.product-card').forEach(card => {
        const name = card.dataset.name.toLowerCase();
        card.style.display = name.includes(query) ? '' : 'none';
    });
});

// عرض السلة عند التحميل
renderCart();
</script>
<?php endif; ?>


============================================================
FILE: app/Views/invoices/index.php
============================================================
<?php $exportUrl = url('/export/invoices'); ?>
<div class="page-header">
    <h2><span class="material-icons-round">receipt_long</span> الفواتير</h2>
    <div class="header-actions">
        <?php include dirname(__DIR__) . '/partials/export_buttons.php'; ?>
        <a href="<?= url('/pos') ?>" class="btn btn-success"><span class="material-icons-round">add</span> فاتورة نقدي</a>
        <a href="<?= url('/pos/installment') ?>" class="btn btn-primary"><span class="material-icons-round">credit_score</span> فاتورة تقسيط</a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <form method="GET" class="filters">
            <select name="type" class="form-control" onchange="this.form.submit()">
                <option value="">كل الأنواع</option>
                <option value="cash" <?= $type === 'cash' ? 'selected' : '' ?>>نقدي</option>
                <option value="installment" <?= $type === 'installment' ? 'selected' : '' ?>>تقسيط</option>
            </select>
            <select name="status" class="form-control" onchange="this.form.submit()">
                <option value="">كل الحالات</option>
                <option value="active" <?= $status === 'active' ? 'selected' : '' ?>>نشط</option>
                <option value="completed" <?= $status === 'completed' ? 'selected' : '' ?>>مكتمل</option>
                <option value="cancelled" <?= $status === 'cancelled' ? 'selected' : '' ?>>ملغي</option>
            </select>
            <input type="text" name="q" class="form-control" placeholder="بحث..." value="<?= htmlspecialchars($search) ?>">
            <button type="submit" class="btn btn-primary"><span class="material-icons-round">search</span></button>
            <?php if ($search || $type || $status): ?>
            <a href="<?= url('/invoices') ?>" class="btn btn-secondary"><span class="material-icons-round">clear</span></a>
            <?php endif; ?>
        </form>
    </div>
    <div class="card-body">
        <?php $selectionType = 'invoices'; $allowDelete = true; include dirname(__DIR__) . '/partials/table_selection.php'; ?>
        
        <div class="table-responsive">
            <table class="table" id="invoicesTable">
                <thead>
                    <tr>
                        <th class="select-checkbox"><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>
                        <th>رقم الفاتورة</th>
                        <th>العميل</th>
                        <th>النوع</th>
                        <th>الإجمالي</th>
                        <th>المدفوع</th>
                        <th>المتبقي</th>
                        <th>الحالة</th>
                        <th>التاريخ</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($invoices as $inv): ?>
                    <tr>
                        <td class="select-checkbox"><input type="checkbox" class="row-checkbox" data-id="<?= $inv['id'] ?>" onclick="toggleRowSelect(this)"></td>
                        <td><a href="<?= url('/invoices/' . $inv['id']) ?>"><?= $inv['invoice_number'] ?></a></td>
                        <td><?= $inv['customer_name'] ?? 'زبون نقدي' ?></td>
                        <td><span class="badge badge-<?= $inv['invoice_type'] === 'cash' ? 'success' : 'primary' ?>"><?= invoiceType($inv['invoice_type']) ?></span></td>
                        <td><strong><?= formatMoney($inv['total_amount']) ?></strong></td>
                        <td class="text-success"><?= formatMoney($inv['paid_amount']) ?></td>
                        <td class="<?= $inv['remaining_amount'] > 0 ? 'text-danger' : '' ?>"><?= formatMoney($inv['remaining_amount']) ?></td>
                        <td><span class="badge badge-<?= $inv['status'] === 'completed' ? 'success' : ($inv['status'] === 'active' ? 'warning' : 'secondary') ?>"><?= invoiceStatus($inv['status']) ?></span></td>
                        <td><?= formatDate($inv['created_at']) ?></td>
                        <td>
                            <div class="actions">
                                <a href="<?= url('/invoices/' . $inv['id']) ?>" class="btn btn-sm btn-secondary" title="عرض"><span class="material-icons-round">visibility</span></a>
                                <?php if ($inv['status'] !== 'cancelled'): ?>
                                <a href="<?= url('/invoices/' . $inv['id'] . '/edit') ?>" class="btn btn-sm btn-warning" title="تعديل"><span class="material-icons-round">edit</span></a>
                                <?php endif; ?>
                                <a href="<?= url('/invoices/' . $inv['id'] . '/print') ?>" class="btn btn-sm btn-primary" title="طباعة" target="_blank"><span class="material-icons-round">print</span></a>
                                <?php if ($inv['invoice_type'] === 'installment'): ?>
                                <a href="<?= url('/invoices/' . $inv['id'] . '/contract') ?>" class="btn btn-sm btn-success" title="العقد" target="_blank"><span class="material-icons-round">description</span></a>
                                <?php endif; ?>
                            </div>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
        
        <?php include dirname(__DIR__) . '/partials/pagination.php'; ?>
    </div>
</div>

<style>
.page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.header-actions { display: flex; gap: 10px; }
.filters { display: flex; gap: 15px; }
.filters select, .filters input { width: 180px; }
.actions { display: flex; gap: 5px; }
.actions .btn { padding: 5px 8px; }
</style>

<script>
function filterInvoices() {
    const type = document.getElementById('typeFilter').value;
    const status = document.getElementById('statusFilter').value;
    const search = document.getElementById('searchInput').value.toLowerCase();
    
    document.querySelectorAll('#invoicesTable tbody tr').forEach(row => {
        const matchType = !type || row.dataset.type === type;
        const matchStatus = !status || row.dataset.status === status;
        const matchSearch = !search || row.textContent.toLowerCase().includes(search);
        row.style.display = matchType && matchStatus && matchSearch ? '' : 'none';
    });
}
</script>


============================================================
FILE: app/Views/invoices/print.php
============================================================
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>فاتورة <?= $invoice['invoice_number'] ?></title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cairo', sans-serif; background: #fff; color: #333; padding: 20px; }
        .invoice { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #1a237e; }
        .header h1 { color: #1a237e; font-size: 24px; margin-bottom: 5px; }
        .header p { color: #666; }
        .invoice-info { display: flex; justify-content: space-between; margin-bottom: 30px; }
        .invoice-info div { flex: 1; }
        .invoice-info h3 { font-size: 14px; color: #999; margin-bottom: 10px; }
        .invoice-info p { margin-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #ddd; }
        th { background: #f5f5f5; font-weight: 600; }
        tfoot td { font-weight: 600; }
        tfoot tr:last-child { font-size: 18px; background: #1a237e; color: white; }
        .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px; }
        .badge { display: inline-block; padding: 5px 15px; border-radius: 15px; font-size: 12px; }
        .badge-cash { background: #e8f5e9; color: #2e7d32; }
        .badge-installment { background: #e3f2fd; color: #1565c0; }
        @media print { body { padding: 0; } .no-print { display: none; } }
    </style>
</head>
<body>
    <div class="invoice">
        <div class="header">
            <?php if (!empty($settings['store_logo'])): ?>
                <img src="<?= asset('images/' . $settings['store_logo']) ?>" alt="الشعار" style="max-width: auto; max-height: 195px; margin-bottom: 10px;">
            <?php else: ?>
                <img src="<?= asset('images/logo.png') ?>" alt="الشعار" style="max-width: auto; max-height: 195px; margin-bottom: 10px;">
            <?php endif; ?>
            <!--<h1><?= $settings['store_name'] ?? 'نظام تقسيط' ?></h1>
            <p><?= $settings['store_address'] ?? '' ?></p>
            <p>هاتف: <?= $settings['store_phone'] ?? '' ?></p>-->
        </div>
        
        <div class="invoice-info">
            <div>
                <h3>بيانات الفاتورة</h3>
                <p><strong>رقم الفاتورة:</strong> <?= $invoice['invoice_number'] ?></p>
                <p><strong>التاريخ:</strong> <?= formatDateTime($invoice['created_at']) ?></p>
                <p><strong>النوع:</strong> <span class="badge badge-<?= $invoice['invoice_type'] ?>"><?= invoiceType($invoice['invoice_type']) ?></span></p>
            </div>
            <div>
                <h3>بيانات العميل</h3>
                <?php if ($invoice['customer_name']): ?>
                <p><strong>الاسم:</strong> <?= $invoice['customer_name'] ?></p>
                <p><strong>الهاتف:</strong> <?= $invoice['customer_phone'] ?></p>
                <?php else: ?>
                <p>زبون نقدي</p>
                <?php endif; ?>
            </div>
        </div>
        
        <table>
            <thead>
                <tr><th>#</th><th>المنتج</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th></tr>
            </thead>
            <tbody>
                <?php $i = 1; foreach ($invoice['items'] as $item): ?>
                <tr>
                    <td><?= $i++ ?></td>
                    <td><?= $item['product_name'] ?></td>
                    <td><?= $item['quantity'] ?></td>
                    <td><?= formatMoney($item['unit_price']) ?></td>
                    <td><?= formatMoney($item['total_price']) ?></td>
                </tr>
                <?php endforeach; ?>
            </tbody>
            <tfoot>
                <tr><td colspan="4">المجموع الفرعي:</td><td><?= formatMoney($invoice['subtotal']) ?></td></tr>
                <?php if ($invoice['discount_amount'] > 0): ?>
                <tr><td colspan="4">الخصم:</td><td>-<?= formatMoney($invoice['discount_amount']) ?></td></tr>
                <?php endif; ?>
                <tr><td colspan="4">الإجمالي:</td><td><?= formatMoney($invoice['total_amount']) ?></td></tr>
            </tfoot>
        </table>
        
        <?php if ($invoice['invoice_type'] === 'installment'): ?>
        <div style="background:#f5f5f5;padding:15px;border-radius:8px;margin-bottom:20px">
            <p><strong>الدفعة المقدمة:</strong> <?= formatMoney($invoice['down_payment']) ?></p>
            <p><strong>القسط الشهري:</strong> <?= formatMoney($invoice['monthly_installment']) ?></p>
            <p><strong>عدد الأقساط:</strong> <?= $invoice['installments_count'] ?> شهر</p>
        </div>
        <?php endif; ?>
        
        <div class="footer">
            <p><?= $settings['invoice_footer'] ?? 'شكراً لتعاملكم معنا' ?></p>
            <p style="margin-top:10px">تم الطباعة: <?= date('Y-m-d H:i') ?></p>
        </div>
    </div>
    
    <div class="no-print" style="text-align:center;margin-top:30px">
        <button onclick="window.print()" style="padding:10px 30px;font-size:16px;cursor:pointer">طباعة</button>
    </div>
</body>
</html>


============================================================
FILE: app/Views/invoices/show.php
============================================================
<div class="page-header">
    <h2><span class="material-icons-round">receipt</span> فاتورة رقم <?= $invoice['invoice_number'] ?></h2>
    <div class="header-actions">
        <?php if ($invoice['status'] !== 'cancelled'): ?>
        <a href="<?= url('/invoices/' . $invoice['id'] . '/edit') ?>" class="btn btn-warning"><span class="material-icons-round">edit</span> تعديل</a>
        <?php endif; ?>
        <a href="<?= url('/invoices/' . $invoice['id'] . '/print') ?>" class="btn btn-primary" target="_blank"><span class="material-icons-round">print</span> طباعة</a>
        <?php if ($invoice['invoice_type'] === 'installment'): ?>
        <a href="<?= url('/invoices/' . $invoice['id'] . '/contract') ?>" class="btn btn-success" target="_blank"><span class="material-icons-round">description</span> العقد</a>
        <?php endif; ?>
        <a href="<?= url('/invoices') ?>" class="btn btn-secondary"><span class="material-icons-round">arrow_forward</span> رجوع</a>
    </div>
</div>

<div class="invoice-details">
    <div class="invoice-main">
        <div class="card">
            <div class="card-header">
                <h3>تفاصيل الفاتورة</h3>
                <span class="badge badge-<?= $invoice['status'] === 'completed' ? 'success' : ($invoice['status'] === 'active' ? 'warning' : 'secondary') ?> badge-lg"><?= invoiceStatus($invoice['status']) ?></span>
            </div>
            <div class="card-body">
                <div class="info-grid">
                    <div><strong>النوع:</strong> <?= invoiceType($invoice['invoice_type']) ?></div>
                    <div><strong>التاريخ:</strong> <?= formatDateTime($invoice['created_at']) ?></div>
                    <div><strong>البائع:</strong> <?= $invoice['user_name'] ?></div>
                    <?php if ($invoice['invoice_type'] === 'installment'): ?>
                    <div><strong>خطة التقسيط:</strong> <?= $invoice['plan_name'] ?></div>
                    <div><strong>عدد الأقساط:</strong> <?= $invoice['installments_count'] ?> شهر</div>
                    <div><strong>القسط الشهري:</strong> <?= formatMoney($invoice['monthly_installment']) ?></div>
                    <?php endif; ?>
                </div>
                
                <h4 class="section-title">المنتجات</h4>
                <table class="table">
                    <thead>
                        <tr><th>المنتج</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th></tr>
                    </thead>
                    <tbody>
                        <?php foreach ($invoice['items'] as $item): ?>
                        <tr>
                            <td><?= $item['product_name'] ?><?php if ($item['serial_number']): ?><br><small class="text-muted">السيريال: <?= $item['serial_number'] ?></small><?php endif; ?></td>
                            <td><?= $item['quantity'] ?></td>
                            <td><?= formatMoney($item['unit_price']) ?></td>
                            <td><strong><?= formatMoney($item['total_price']) ?></strong></td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                    <tfoot>
                        <tr><td colspan="3" class="text-left">المجموع الفرعي:</td><td><?= formatMoney($invoice['subtotal']) ?></td></tr>
                        <?php if ($invoice['discount_amount'] > 0): ?>
                        <tr><td colspan="3" class="text-left">الخصم:</td><td class="text-danger">-<?= formatMoney($invoice['discount_amount']) ?></td></tr>
                        <?php endif; ?>
                        <tr class="total-row"><td colspan="3" class="text-left">الإجمالي:</td><td><strong><?= formatMoney($invoice['total_amount']) ?></strong></td></tr>
                        <?php if ($invoice['invoice_type'] === 'installment'): ?>
                        <tr><td colspan="3" class="text-left">الدفعة المقدمة:</td><td><?= formatMoney($invoice['down_payment']) ?></td></tr>
                        <tr><td colspan="3" class="text-left">المدفوع:</td><td class="text-success"><?= formatMoney($invoice['paid_amount']) ?></td></tr>
                        <tr><td colspan="3" class="text-left">المتبقي:</td><td class="text-danger"><?= formatMoney($invoice['remaining_amount']) ?></td></tr>
                        <?php endif; ?>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <?php if ($invoice['invoice_type'] === 'installment' && !empty($invoice['installments'])): ?>
        <div class="card">
            <div class="card-header"><h3><span class="material-icons-round">event</span> جدول الأقساط</h3></div>
            <div class="card-body">
                <table class="table">
                    <thead><tr><th>#</th><th>تاريخ الاستحقاق</th><th>المبلغ</th><th>المدفوع</th><th>المتبقي</th><th>الحالة</th><th></th></tr></thead>
                    <tbody>
                        <?php foreach ($invoice['installments'] as $inst): ?>
                        <tr>
                            <td>القسط <?= $inst['installment_number'] ?></td>
                            <td><?= formatDate($inst['due_date']) ?></td>
                            <td><?= formatMoney($inst['amount']) ?></td>
                            <td class="text-success"><?= formatMoney($inst['paid_amount']) ?></td>
                            <td class="text-danger"><?= formatMoney($inst['remaining_amount']) ?></td>
                            <td><span class="badge badge-<?= $inst['status'] === 'paid' ? 'success' : ($inst['status'] === 'overdue' ? 'danger' : 'warning') ?>"><?= installmentStatus($inst['status']) ?></span></td>
                            <td>
                                <?php if ($inst['status'] !== 'paid'): ?>
                                <button class="btn btn-sm btn-primary" onclick="payInstallment(<?= $inst['id'] ?>, <?= $inst['remaining_amount'] ?>)">تحصيل</button>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>
        <?php endif; ?>
    </div>
    
    <div class="invoice-sidebar">
        <?php if ($invoice['customer_name']): ?>
        <div class="card">
            <div class="card-header"><h3><span class="material-icons-round">person</span> العميل</h3></div>
            <div class="card-body">
                <p><strong><?= $invoice['customer_name'] ?></strong></p>
                <p><a href="tel:<?= $invoice['customer_phone'] ?>"><?= $invoice['customer_phone'] ?></a></p>
                <a href="<?= url('/customers/' . $invoice['customer_id']) ?>" class="btn btn-outline btn-block">عرض ملف العميل</a>
            </div>
        </div>
        <?php endif; ?>
        
        <?php if ($invoice['notes']): ?>
        <div class="card">
            <div class="card-header"><h3>ملاحظات</h3></div>
            <div class="card-body"><p><?= nl2br($invoice['notes']) ?></p></div>
        </div>
        <?php endif; ?>
    </div>
</div>

<div class="modal" id="payModal">
    <div class="modal-content">
        <div class="modal-header"><h3>تحصيل قسط</h3><button class="close-btn" onclick="closeModal('payModal')">&times;</button></div>
        <div class="modal-body">
            <form id="payForm">
                <input type="hidden" id="payInstallmentId">
                <div class="form-group"><label>المبلغ المستحق</label><input type="text" id="dueAmount" readonly class="form-control"></div>
                <div class="form-group"><label>المبلغ المدفوع</label><input type="number" id="payAmount" step="0.01" class="form-control" required></div>
                <button type="submit" class="btn btn-primary btn-block">تأكيد الدفع</button>
            </form>
        </div>
    </div>
</div>

<style>
.invoice-details { display: grid; grid-template-columns: 1fr 300px; gap: 25px; }
.info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
.section-title { margin: 25px 0 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
.total-row { background: var(--bg-main); font-size: 16px; }
.badge-lg { font-size: 14px; padding: 8px 16px; }
@media (max-width: 1024px) { .invoice-details { grid-template-columns: 1fr; } }
</style>

<script>
function payInstallment(id, amount) {
    document.getElementById('payInstallmentId').value = id;
    document.getElementById('dueAmount').value = amount.toFixed(2);
    document.getElementById('payAmount').value = amount.toFixed(2);
    document.getElementById('payModal').classList.add('show');
}
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
document.getElementById('payForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const id = document.getElementById('payInstallmentId').value;
    const amount = document.getElementById('payAmount').value;
    const formData = new FormData();
    formData.append('amount', amount);
    const response = await fetch('<?= url('/installments/') ?>' + id + '/pay', { method: 'POST', body: formData });
    const result = await response.json();
    if (result.success) { alert('تم تسجيل الدفعة'); location.reload(); } else { alert(result.message); }
});
</script>


============================================================
FILE: app/Views/layouts/header.php
============================================================
<header class="header">
    <div class="header-right">
        <button class="menu-toggle" onclick="toggleSidebar()">
            <span class="material-icons-round">menu</span>
        </button>
        <h2 class="page-title"><?= $pageTitle ?? '' ?></h2>
    </div>
    
    <div class="header-left">
        <div class="search-box">
            <span class="material-icons-round">search</span>
            <input type="text" id="globalSearch" placeholder="بحث..." autocomplete="off">
            <button type="button" class="voice-btn" onclick="startVoiceSearch()" title="بحث صوتي">
                <span class="material-icons-round">mic</span>
            </button>
        </div>
        
        <div class="header-actions">
            <button class="action-btn" onclick="toggleDarkMode()" title="الوضع الليلي">
                <span class="material-icons-round">dark_mode</span>
            </button>
            
            <div class="notifications-dropdown">
                <button class="action-btn notification-btn" onclick="toggleNotifications()">
                    <span class="material-icons-round">notifications</span>
                    <span class="badge" id="notificationBadge" style="display:none;">0</span>
                </button>
                <div class="dropdown-menu" id="notificationsMenu">
                    <div class="dropdown-header">
                        <strong>التنبيهات</strong>
                    </div>
                    <div id="notificationsList">
                        <p class="empty-message">لا توجد تنبيهات</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="current-date">
            <span class="material-icons-round">calendar_today</span>
            <span><?= date('Y/m/d') ?></span>
        </div>
    </div>
</header>


============================================================
FILE: app/Views/layouts/master.php
============================================================
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e88e5">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="تقسيط">
    <meta name="description" content="نظام متكامل لإدارة التقسيط والمبيعات">
    
    <title><?= $pageTitle ?? 'نظام تقسيط' ?> - <?= $settings['store_name'] ?? 'نظام تقسيط' ?></title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/x-icon" href="<?= asset('icons/app_icon.ico') ?>">
    <link rel="apple-touch-icon" href="<?= asset('icons/app_icon.ico') ?>">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <!-- Cache Control -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <?php 
    // رقم الإصدار لتجاوز الـ Cache - غير هذا الرقم عند كل تحديث
    $version = '1.0.1.' . date('Ymd');
    ?>
    
    <!-- Stylesheets with Cache Busting -->
    <link rel="stylesheet" href="<?= asset('css/app.css') ?>?v=<?= $version ?>">
    <link rel="stylesheet" href="<?= asset('css/responsive.css') ?>?v=<?= $version ?>"><?php 
    // تطبيق إعدادات المظهر للمستخدم (تتجاوز الإعدادات الافتراضية)
    $userTheme = $themeConfig ?? null;
    $systemDarkMode = ($settings['dark_mode'] ?? 0);
    $userDarkMode = isset($userTheme['dark_mode']) ? $userTheme['dark_mode'] : $systemDarkMode;
    ?>
    
    <style>
        :root {
            /* Dynamic theme variables */
            <?php if ($userDarkMode && !empty($userTheme)): ?>
                /* ألوان الوضع الليلي */
                <?php if (!empty($userTheme['dark_primary_color'])): ?>
                --primary: <?= $userTheme['dark_primary_color'] ?>;
                <?php endif; ?>
                <?php if (!empty($userTheme['dark_sidebar_color'])): ?>
                --bg-sidebar: <?= $userTheme['dark_sidebar_color'] ?>;
                <?php endif; ?>
                <?php if (!empty($userTheme['dark_sidebar_text_color'])): ?>
                --text-light: <?= $userTheme['dark_sidebar_text_color'] ?>;
                <?php endif; ?>
                <?php if (!empty($userTheme['dark_bg_color'])): ?>
                --bg-main: <?= $userTheme['dark_bg_color'] ?>;
                <?php endif; ?>
                <?php if (!empty($userTheme['dark_card_color'])): ?>
                --bg-card: <?= $userTheme['dark_card_color'] ?>;
                --bg-header: <?= $userTheme['dark_card_color'] ?>;
                <?php endif; ?>
                <?php if (!empty($userTheme['dark_text_color'])): ?>
                --text-primary: <?= $userTheme['dark_text_color'] ?>;
                <?php endif; ?>
                <?php if (!empty($userTheme['dark_section_header_color'])): ?>
                --primary-dark: <?= $userTheme['dark_section_header_color'] ?>;
                <?php endif; ?>
                <?php if (!empty($userTheme['dark_secondary_color'])): ?>
                --secondary: <?= $userTheme['dark_secondary_color'] ?>;
                <?php endif; ?>
                <?php if (!empty($userTheme['dark_border_color'])): ?>
                --border-color: <?= $userTheme['dark_border_color'] ?>;
                <?php endif; ?>
                <?php if (!empty($userTheme['dark_text_secondary_color'])): ?>
                --text-secondary: <?= $userTheme['dark_text_secondary_color'] ?>;
                <?php endif; ?>
            <?php else: ?>
                /* ألوان الوضع النهاري */
                <?php if (!empty($userTheme['primary_color'])): ?>
                --primary: <?= $userTheme['primary_color'] ?>;
                <?php elseif (!empty($settings['primary_color'])): ?>
                --primary: <?= $settings['primary_color'] ?>;
                <?php endif; ?>
                <?php if (!empty($userTheme['sidebar_color'])): ?>
                --bg-sidebar: <?= $userTheme['sidebar_color'] ?>;
                <?php elseif (!empty($settings['sidebar_color'])): ?>
                --bg-sidebar: <?= $settings['sidebar_color'] ?>;
                <?php endif; ?>
                <?php if (!empty($userTheme['sidebar_text_color'])): ?>
                --text-light: <?= $userTheme['sidebar_text_color'] ?>;
                <?php endif; ?>
                <?php if (!empty($userTheme['bg_color'])): ?>
                --bg-main: <?= $userTheme['bg_color'] ?>;
                <?php endif; ?>
                <?php if (!empty($userTheme['card_color'])): ?>
                --bg-card: <?= $userTheme['card_color'] ?>;
                --bg-header: <?= $userTheme['card_color'] ?>;
                <?php endif; ?>
                <?php if (!empty($userTheme['text_color'])): ?>
                --text-primary: <?= $userTheme['text_color'] ?>;
                <?php endif; ?>
                <?php if (!empty($userTheme['section_header_color'])): ?>
                --primary-dark: <?= $userTheme['section_header_color'] ?>;
                <?php endif; ?>
                <?php if (!empty($userTheme['secondary_color'])): ?>
                --secondary: <?= $userTheme['secondary_color'] ?>;
                <?php endif; ?>
                <?php if (!empty($userTheme['border_color'])): ?>
                --border-color: <?= $userTheme['border_color'] ?>;
                <?php endif; ?>
                <?php if (!empty($userTheme['text_secondary_color'])): ?>
                --text-secondary: <?= $userTheme['text_secondary_color'] ?>;
                <?php endif; ?>
            <?php endif; ?>
        }
    </style>
</head>
<body class="<?= $userDarkMode ? 'dark-mode' : '' ?>">
    <div class="app-container">
        <?php include __DIR__ . '/sidebar.php'; ?>
        
        <main class="main-content">
            <?php include __DIR__ . '/header.php'; ?>
            
            <div class="page-content">
                <?php if ($successMsg = flash('success')): ?>
                    <div class="alert alert-success">
                        <span class="material-icons-round">check_circle</span>
                        <?= $successMsg ?>
                    </div>
                <?php endif; ?>
                
                <?php if ($errorMsg = flash('error')): ?>
                    <div class="alert alert-danger">
                        <span class="material-icons-round">error</span>
                        <?= $errorMsg ?>
                    </div>
                <?php endif; ?>
                
                <?= $content ?>
            </div>
        </main>
    </div>
    
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
        <span class="material-icons-round">menu</span>
    </button>
    
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" onclick="toggleMobileMenu()"></div>
    
    <script src="<?= asset('js/app.js') ?>?v=<?= $version ?>"></script>
    
    <!-- Mobile Menu Script -->
    <script>
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const menuBtn = document.querySelector('.mobile-menu-toggle .material-icons-round');
            
            if (!sidebar || !overlay || !menuBtn) return;
            
            const isOpen = sidebar.classList.contains('active');
            
            if (isOpen) {
                // إغلاق القائمة
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                menuBtn.textContent = 'menu';
                document.body.style.overflow = '';
            } else {
                // فتح القائمة
                sidebar.classList.add('active');
                overlay.classList.add('active');
                menuBtn.textContent = 'close';
                document.body.style.overflow = 'hidden';
            }
        }
        
        // إغلاق القائمة عند الضغط على Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const sidebar = document.querySelector('.sidebar');
                if (sidebar && sidebar.classList.contains('active')) {
                    toggleMobileMenu();
                }
            }
        });
        
        // إغلاق القائمة عند النقر على رابط
        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        const sidebar = document.querySelector('.sidebar');
                        if (sidebar && sidebar.classList.contains('active')) {
                            toggleMobileMenu();
                        }
                    }, 100);
                }
            });
        });
        
        // إعادة تعيين حالة القائمة عند تغيير حجم الشاشة
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                const sidebar = document.querySelector('.sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                const menuBtn = document.querySelector('.mobile-menu-toggle .material-icons-round');
                
                if (sidebar) sidebar.classList.remove('active');
                if (overlay) overlay.classList.remove('active');
                if (menuBtn) menuBtn.textContent = 'menu';
                document.body.style.overflow = '';
            }
        });
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            });
        }
    </script>
    
    <!-- PWA Install Prompt -->
    <script>
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWA: beforeinstallprompt event fired');
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Show custom install button
            console.log('PWA: Showing custom install button');
            showInstallButton();
        });
        
        function showInstallButton() {
            // لا تظهر الزر إذا تم إغلاقه في هذه الجلسة
            if (sessionStorage.getItem('pwa-install-dismissed')) {
                console.log('PWA: Install button was dismissed this session');
                return;
            }
            
            // إنشاء زر التثبيت إذا لم يكن موجوداً
            if (document.getElementById('pwa-install-btn')) {
                document.getElementById('pwa-install-btn').style.display = 'flex';
                return;
            }
            
            const btnContainer = document.createElement('div');
            btnContainer.id = 'pwa-install-btn';
            btnContainer.className = 'pwa-install-btn';
            
            // زر التثبيت
            const installBtn = document.createElement('span');
            installBtn.className = 'pwa-install-text';
            installBtn.innerHTML = '<span class="material-icons-round">install_mobile</span> تثبيت التطبيق';
            installBtn.onclick = installPWA;
            
            // زر الإغلاق
            const closeBtn = document.createElement('span');
            closeBtn.className = 'pwa-close-btn';
            closeBtn.innerHTML = '<span class="material-icons-round">close</span>';
            closeBtn.onclick = dismissPWAButton;
            
            btnContainer.appendChild(installBtn);
            btnContainer.appendChild(closeBtn);
            document.body.appendChild(btnContainer);
        }
        
        function dismissPWAButton(e) {
            if (e) e.stopPropagation();
            // حفظ حالة الإغلاق في sessionStorage (تُمسح عند إغلاق المتصفح)
            sessionStorage.setItem('pwa-install-dismissed', 'true');
            const btn = document.getElementById('pwa-install-btn');
            if (btn) btn.style.display = 'none';
        }
        
        async function installPWA() {
            console.log('PWA: installPWA called, deferredPrompt:', deferredPrompt ? 'exists' : 'null');
            
            if (!deferredPrompt) {
                alert('التطبيق مثبت بالفعل أو لا يمكن تثبيته الآن');
                return;
            }
            
            // Show the install prompt
            deferredPrompt.prompt();
            
            // Wait for the user to respond to the prompt
            const { outcome } = await deferredPrompt.userChoice;
            console.log('PWA: User response to the install prompt:', outcome);
            
            // Clear the deferredPrompt
            deferredPrompt = null;
            
            // Hide the install button
            dismissPWAButton();
        }
        
        // Hide button if app is already installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA: App was installed successfully');
            dismissPWAButton();
            deferredPrompt = null;
        });
        
        // Check if running in standalone mode (already installed)
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('PWA: Running as installed PWA (standalone mode)');
        }
    </script>
    
    <style>
        .pwa-install-btn {
            position: fixed;
            bottom: 90px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #1e88e5, #1565c0);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Cairo', sans-serif;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(30, 136, 229, 0.4);
            z-index: 998;
            animation: pwa-pulse 2s infinite;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .pwa-install-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 25px rgba(30, 136, 229, 0.5);
        }
        
        .pwa-install-btn .pwa-install-text {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        
        .pwa-install-btn .pwa-install-text .material-icons-round {
            font-size: 20px;
        }
        
        .pwa-install-btn .pwa-close-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            cursor: pointer;
            margin-right: -4px;
            transition: background 0.2s;
        }
        
        .pwa-install-btn .pwa-close-btn:hover {
            background: rgba(255, 255, 255, 0.35);
        }
        
        .pwa-install-btn .pwa-close-btn .material-icons-round {
            font-size: 16px;
        }
        
        @keyframes pwa-pulse {
            0%, 100% { box-shadow: 0 4px 20px rgba(30, 136, 229, 0.4); }
            50% { box-shadow: 0 4px 30px rgba(30, 136, 229, 0.6); }
        }
        
        @media (max-width: 480px) {
            .pwa-install-btn {
                bottom: 80px;
                left: 10px;
                right: 80px;
                padding: 10px 15px;
                font-size: 13px;
            }
        }
    </style>
</body>
</html>



============================================================
FILE: app/Views/layouts/sidebar.php
============================================================
<aside class="sidebar">
    <div class="sidebar-header">
        <div class="logo">
            <?php if (!empty($settings['store_logo'])): ?>
                <img src="<?= asset('images/' . $settings['store_logo']) ?>" alt="الشعار">
            <?php else: ?>
                <img src="<?= asset('images/logo.png') ?>" alt="الشعار">
            <?php endif; ?>
        </div>
        <h1><?= $settings['store_name'] ?? 'نظام تقسيط' ?></h1>
    </div>
    
    <nav class="sidebar-nav" id="sidebarNav">
        <!-- الإدارة -->
        <div class="nav-section open" data-section="admin">
            <div class="nav-section-header" onclick="toggleSection(this)">
                <span class="nav-section-title">الإدارة</span>
                <span class="material-icons-round section-arrow">expand_more</span>
            </div>
            <div class="nav-section-content">
                <a href="<?= url('/dashboard') ?>" data-item="dashboard" class="nav-item <?= strpos($_SERVER['REQUEST_URI'], '/dashboard') !== false ? 'active' : '' ?>">
                    <span class="material-icons-round">dashboard</span>
                    <span>لوحة التحكم</span>
                </a>
                
                <a href="<?= url('/pos') ?>" data-item="pos" class="nav-item <?= strpos($_SERVER['REQUEST_URI'], '/pos') !== false && strpos($_SERVER['REQUEST_URI'], 'installment') === false ? 'active' : '' ?>">
                    <span class="material-icons-round">point_of_sale</span>
                    <span>نقطة البيع</span>
                </a>
                
                <a href="<?= url('/pos/installment') ?>" data-item="pos-installment" class="nav-item <?= strpos($_SERVER['REQUEST_URI'], '/pos/installment') !== false ? 'active' : '' ?>">
                    <span class="material-icons-round">credit_score</span>
                    <span>بيع بالتقسيط</span>
                </a>
            </div>
        </div>
        
        <!-- المخزون -->
        <div class="nav-section" data-section="inventory">
            <div class="nav-section-header" onclick="toggleSection(this)">
                <span class="nav-section-title">المخزون</span>
                <span class="material-icons-round section-arrow">expand_more</span>
            </div>
            <div class="nav-section-content">
                <a href="<?= url('/products') ?>" data-item="products" class="nav-item <?= strpos($_SERVER['REQUEST_URI'], '/products') !== false ? 'active' : '' ?>">
                    <span class="material-icons-round">inventory_2</span>
                    <span>المنتجات</span>
                </a>
                
                <a href="<?= url('/categories') ?>" data-item="categories" class="nav-item <?= strpos($_SERVER['REQUEST_URI'], '/categories') !== false ? 'active' : '' ?>">
                    <span class="material-icons-round">category</span>
                    <span>التصنيفات</span>
                </a>
                
                <a href="<?= url('/customers') ?>" data-item="customers" class="nav-item <?= strpos($_SERVER['REQUEST_URI'], '/customers') !== false ? 'active' : '' ?>">
                    <span class="material-icons-round">people</span>
                    <span>العملاء</span>
                </a>
            </div>
        </div>
        
        <!-- المالية -->
        <div class="nav-section" data-section="finance">
            <div class="nav-section-header" onclick="toggleSection(this)">
                <span class="nav-section-title">المالية</span>
                <span class="material-icons-round section-arrow">expand_more</span>
            </div>
            <div class="nav-section-content">
                <a href="<?= url('/invoices') ?>" data-item="invoices" class="nav-item <?= strpos($_SERVER['REQUEST_URI'], '/invoices') !== false ? 'active' : '' ?>">
                    <span class="material-icons-round">receipt_long</span>
                    <span>الفواتير</span>
                </a>
                
                <a href="<?= url('/installments') ?>" data-item="installments" class="nav-item <?= strpos($_SERVER['REQUEST_URI'], '/installments') !== false && strpos($_SERVER['REQUEST_URI'], 'today') === false && strpos($_SERVER['REQUEST_URI'], 'overdue') === false ? 'active' : '' ?>">
                    <span class="material-icons-round">payments</span>
                    <span>الأقساط</span>
                </a>
                
                <a href="<?= url('/installments/today') ?>" data-item="installments-today" class="nav-item <?= strpos($_SERVER['REQUEST_URI'], 'today') !== false ? 'active' : '' ?>">
                    <span class="material-icons-round">today</span>
                    <span>أقساط اليوم</span>
                </a>
                
                <a href="<?= url('/installments/overdue') ?>" data-item="installments-overdue" class="nav-item <?= strpos($_SERVER['REQUEST_URI'], 'overdue') !== false ? 'active' : '' ?>">
                    <span class="material-icons-round">warning</span>
                    <span>متأخرات</span>
                </a>
                
                <a href="<?= url('/payments') ?>" data-item="payments" class="nav-item <?= strpos($_SERVER['REQUEST_URI'], '/payments') !== false ? 'active' : '' ?>">
                    <span class="material-icons-round">account_balance_wallet</span>
                    <span>المدفوعات</span>
                </a>
            </div>
        </div>
        
        <?php if (hasRole('admin')): ?>
        <!-- النظام -->
        <div class="nav-section" data-section="system">
            <div class="nav-section-header" onclick="toggleSection(this)">
                <span class="nav-section-title">النظام</span>
                <span class="material-icons-round section-arrow">expand_more</span>
            </div>
            <div class="nav-section-content">
                <a href="<?= url('/reports') ?>" data-item="reports" class="nav-item <?= strpos($_SERVER['REQUEST_URI'], '/reports') !== false ? 'active' : '' ?>">
                    <span class="material-icons-round">analytics</span>
                    <span>التقارير</span>
                </a>
                
                <a href="<?= url('/users') ?>" data-item="users" class="nav-item <?= strpos($_SERVER['REQUEST_URI'], '/users') !== false ? 'active' : '' ?>">
                    <span class="material-icons-round">manage_accounts</span>
                    <span>المستخدمين</span>
                </a>
                
                <a href="<?= url('/settings') ?>" data-item="settings" class="nav-item <?= strpos($_SERVER['REQUEST_URI'], '/settings') !== false ? 'active' : '' ?>">
                    <span class="material-icons-round">settings</span>
                    <span>الإعدادات</span>
                </a>
            </div>
        </div>
        <?php endif; ?>
    </nav>
    
    <div class="sidebar-footer">
        <div class="user-info">
            <span class="material-icons-round">account_circle</span>
            <div>
                <strong><?= $user['full_name'] ?? 'مستخدم' ?></strong>
                <small><?= userRole($user['role'] ?? '') ?></small>
            </div>
        </div>
        <a href="<?= url('/logout') ?>" class="logout-btn" title="تسجيل خروج" onclick="clearAllSiteData(event)">
            <span class="material-icons-round">logout</span>
        </a>
    </div>
</aside>

<script>
function toggleSection(header) {
    const section = header.parentElement;
    const nav = document.getElementById('sidebarNav');
    const isOpening = !section.classList.contains('open');
    
    // إذا كنا نفتح قسم جديد، أغلق جميع الأقسام الأخرى
    if (isOpening) {
        nav.querySelectorAll('.nav-section.open').forEach(openSection => {
            if (openSection !== section) {
                openSection.classList.remove('open');
            }
        });
    }
    
    section.classList.toggle('open');
    
    // Save state to localStorage - حفظ القسم المفتوح فقط
    const sectionName = section.dataset.section;
    
    if (section.classList.contains('open')) {
        localStorage.setItem('openSections', JSON.stringify([sectionName]));
    } else {
        localStorage.setItem('openSections', JSON.stringify([]));
    }
}

// Initialize sidebar on page load
document.addEventListener('DOMContentLoaded', function() {
    const nav = document.getElementById('sidebarNav');
    
    // Load menu config from PHP (database) - this is per-user from the server
    const config = <?= json_encode($menuConfig ?? null, JSON_UNESCAPED_UNICODE) ?> || {};
    
    console.log('Sidebar loading menuConfig from server:', config);
    
    // Apply section order from new config
    if (config.sectionOrder && config.sectionOrder.length > 0) {
        console.log('Applying section order:', config.sectionOrder);
        config.sectionOrder.forEach(sectionName => {
            const section = nav.querySelector(`[data-section="${sectionName}"]`);
            if (section) nav.appendChild(section);
        });
    }
    
    // Apply item order within each section (move items from any section to target section)
    if (config.itemOrder) {
        console.log('Applying item order:', config.itemOrder);
        Object.keys(config.itemOrder).forEach(sectionId => {
            const section = nav.querySelector(`[data-section="${sectionId}"]`);
            const itemsContainer = section?.querySelector('.nav-section-content');
            if (itemsContainer && config.itemOrder[sectionId]) {
                config.itemOrder[sectionId].forEach(itemId => {
                    // Search for item in the ENTIRE nav, not just current section
                    const item = nav.querySelector(`[data-item="${itemId}"]`);
                    if (item) {
                        console.log(`Moving item ${itemId} to section ${sectionId}`);
                        itemsContainer.appendChild(item);
                    }
                });
            }
        });
    }
    
    // Hide hidden sections
    if (config.hidden?.sections) {
        config.hidden.sections.forEach(sectionId => {
            const section = nav.querySelector(`[data-section="${sectionId}"]`);
            if (section) section.style.display = 'none';
        });
    }
    
    // Hide hidden items
    if (config.hidden?.items) {
        config.hidden.items.forEach(itemId => {
            const item = nav.querySelector(`[data-item="${itemId}"]`);
            if (item) item.style.display = 'none';
        });
    }
    
    // أغلق جميع الأقسام أولاً
    nav.querySelectorAll('.nav-section').forEach(section => {
        section.classList.remove('open');
    });
    
    // افتح فقط القسم الذي يحتوي على العنصر النشط
    const activeItem = nav.querySelector('.nav-item.active');
    if (activeItem) {
        const parentSection = activeItem.closest('.nav-section');
        if (parentSection) {
            parentSection.classList.add('open');
            // حفظ القسم المفتوح في localStorage
            localStorage.setItem('openSections', JSON.stringify([parentSection.dataset.section]));
        }
    } else {
        // إذا لم يكن هناك عنصر نشط، افتح القسم المحفوظ أو الافتراضي
        const openSections = JSON.parse(localStorage.getItem('openSections') || '["admin"]');
        if (openSections.length > 0) {
            const section = nav.querySelector(`[data-section="${openSections[0]}"]`);
            if (section) section.classList.add('open');
        }
    }
});

// دالة مسح جميع بيانات الموقع عند تسجيل الخروج
async function clearAllSiteData(event) {
    event.preventDefault();
    const logoutUrl = event.currentTarget.href;
    
    try {
        // مسح localStorage
        localStorage.clear();
        console.log('localStorage cleared');
        
        // مسح sessionStorage
        sessionStorage.clear();
        console.log('sessionStorage cleared');
        
        // مسح جميع Cookies الخاصة بالموقع
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const cookieName = cookie.split('=')[0].trim();
            document.cookie = cookieName + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/';
            document.cookie = cookieName + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=' + window.location.hostname;
        }
        console.log('Cookies cleared');
        
        // مسح IndexedDB
        if (window.indexedDB && indexedDB.databases) {
            const databases = await indexedDB.databases();
            for (let db of databases) {
                indexedDB.deleteDatabase(db.name);
            }
            console.log('IndexedDB cleared');
        }
        
        // مسح Cache Storage (للـ PWA)
        if ('caches' in window) {
            const cacheNames = await caches.keys();
            for (let name of cacheNames) {
                await caches.delete(name);
            }
            console.log('Cache Storage cleared');
        }
        
        // إلغاء تسجيل Service Workers
        if ('serviceWorker' in navigator) {
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (let registration of registrations) {
                await registration.unregister();
            }
            console.log('Service Workers unregistered');
        }
        
    } catch (error) {
        console.error('Error clearing site data:', error);
    }
    
    // الانتقال لصفحة تسجيل الخروج
    window.location.href = logoutUrl;
}
</script>


============================================================
FILE: app/Views/notifications/index.php
============================================================
<div class="page-header">
    <h2><span class="material-icons-round">notifications</span> التنبيهات</h2>
</div>

<?php if (empty($notifications)): ?>
<div class="empty-state">
    <span class="material-icons-round">notifications_off</span>
    <h3>لا توجد تنبيهات</h3>
    <p>كل شيء على ما يرام!</p>
</div>
<?php else: ?>
<div class="notifications-list">
    <?php foreach ($notifications as $notif): ?>
    <a href="<?= $notif['link'] ?>" class="notification-item notification-<?= $notif['type'] ?>">
        <div class="notification-icon">
            <span class="material-icons-round"><?= $notif['icon'] ?></span>
        </div>
        <div class="notification-content">
            <h4><?= $notif['title'] ?></h4>
            <p><?= $notif['message'] ?></p>
        </div>
        <span class="material-icons-round">arrow_back</span>
    </a>
    <?php endforeach; ?>
</div>
<?php endif; ?>

<style>
.empty-state { text-align: center; padding: 80px 20px; background: var(--bg-card); border-radius: var(--radius); }
.empty-state .material-icons-round { font-size: 80px; color: var(--text-muted); opacity: 0.5; }
.empty-state h3 { margin: 20px 0 10px; color: var(--text-muted); }
.notifications-list { display: flex; flex-direction: column; gap: 15px; }
.notification-item { display: flex; align-items: center; gap: 20px; padding: 20px 25px; background: var(--bg-card); border-radius: var(--radius); text-decoration: none; color: inherit; transition: all 0.2s; }
.notification-item:hover { transform: translateX(-5px); box-shadow: var(--shadow); }
.notification-icon { width: 50px; height: 50px; border-radius: 12px; display: flex;align-items: center; justify-content: center; }
.notification-icon .material-icons-round { font-size: 24px; color: white; }
.notification-danger .notification-icon { background: linear-gradient(135deg, #e53935, #c62828); }
.notification-warning .notification-icon { background: linear-gradient(135deg, #ff9800, #f57c00); }
.notification-primary .notification-icon { background: linear-gradient(135deg, #1e88e5, #1565c0); }
.notification-content { flex: 1; }
.notification-content h4 { margin-bottom: 5px; }
.notification-content p { color: var(--text-muted); font-size: 14px; }
</style>


============================================================
FILE: app/Views/partials/export_buttons.php
============================================================
<?php if (isset($exportUrl)): ?>
<div class="export-buttons">
    <div class="export-dropdown">
        <button class="btn btn-sm btn-secondary dropdown-toggle" onclick="toggleExportMenu(this)">
            <span class="material-icons-round">download</span> تصدير
        </button>
        <div class="export-menu">
            <div class="export-menu-section">
                <label>عدد السجلات:</label>
                <select id="exportCount" class="form-control form-control-sm">
                    <option value="10">10 سجل</option>
                    <option value="25">25 سجل</option>
                    <option value="50">50 سجل</option>
                    <option value="100">100 سجل</option>
                    <option value="all" selected>الكل</option>
                </select>
            </div>
            <div class="export-menu-buttons">
                <a href="#" class="btn btn-sm btn-danger export-btn" data-format="pdf" onclick="doExport(this, 'pdf')">
                    <span class="material-icons-round">picture_as_pdf</span> PDF
                </a>
                <a href="#" class="btn btn-sm btn-success export-btn" data-format="excel" onclick="doExport(this, 'excel')">
                    <span class="material-icons-round">table_chart</span> Excel
                </a>
            </div>
        </div>
    </div>
</div>

<style>
.export-buttons { display: flex; gap: 8px; }
.export-dropdown { position: relative; }
.export-menu { 
    display: none; position: absolute; top: 100%; left: 0; z-index: 1000;
    background: var(--bg-card); border-radius: var(--radius-sm); box-shadow: var(--shadow-lg);
    padding: 15px; min-width: 200px; margin-top: 5px;
}
.export-dropdown.open .export-menu { display: block; }
.export-menu-section { margin-bottom: 12px; }
.export-menu-section label { display: block; margin-bottom: 5px; font-size: 12px; color: var(--text-muted); }
.export-menu-buttons { display: flex; gap: 8px; }
.export-menu-buttons .btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px; }
.dropdown-toggle { display: flex; align-items: center; gap: 5px; }
</style>

<script>
function toggleExportMenu(btn) {
    btn.closest('.export-dropdown').classList.toggle('open');
}
function doExport(btn, format) {
    const count = document.getElementById('exportCount').value;
    let baseUrl = '<?= $exportUrl ?>/' + format;
    let queryString = '<?= !empty($_SERVER['QUERY_STRING']) ? $_SERVER['QUERY_STRING'] : '' ?>';
    
    if (count !== 'all') {
        queryString += (queryString ? '&' : '') + 'export_limit=' + count;
    }
    
    window.open(baseUrl + (queryString ? '?' + queryString : ''), '_blank');
    btn.closest('.export-dropdown').classList.remove('open');
    return false;
}
document.addEventListener('click', function(e) {
    if (!e.target.closest('.export-dropdown')) {
        document.querySelectorAll('.export-dropdown.open').forEach(d => d.classList.remove('open'));
    }
});
</script>
<?php endif; ?>



============================================================
FILE: app/Views/partials/pagination.php
============================================================
<?php if (isset($pagination) && $pagination !== null): ?>
<div class="pagination-container">
    <div class="pagination-info">
        عرض <?= $pagination->getStartItem() ?> - <?= $pagination->getEndItem() ?> من <?= $pagination->getTotalItems() ?>
    </div>
    
    <div class="per-page-selector">
        <label>عرض:</label>
        <select onchange="window.location.href=this.value">
            <?php foreach ([10, 25, 50, 100] as $option): ?>
            <option value="<?= \Core\Pagination::buildUrl(1, $option) ?>" <?= $pagination->getPerPage() == $option ? 'selected' : '' ?>><?= $option ?></option>
            <?php endforeach; ?>
        </select>
    </div>
    
    <?php if ($pagination->getTotalPages() > 1): ?>
    <div class="pagination">
        <?php if ($pagination->hasPrev()): ?>
        <a href="<?= \Core\Pagination::buildUrl($pagination->getCurrentPage() - 1, $pagination->getPerPage()) ?>" class="page-btn">
            <span class="material-icons-round">chevron_right</span>
        </a>
        <?php endif; ?>
        
        <?php foreach ($pagination->getPageNumbers() as $page): ?>
            <?php if ($page === '...'): ?>
                <span class="page-dots">...</span>
            <?php else: ?>
                <a href="<?= \Core\Pagination::buildUrl($page, $pagination->getPerPage()) ?>" 
                   class="page-btn <?= $page == $pagination->getCurrentPage() ? 'active' : '' ?>">
                    <?= $page ?>
                </a>
            <?php endif; ?>
        <?php endforeach; ?>
        
        <?php if ($pagination->hasNext()): ?>
        <a href="<?= \Core\Pagination::buildUrl($pagination->getCurrentPage() + 1, $pagination->getPerPage()) ?>" class="page-btn">
            <span class="material-icons-round">chevron_left</span>
        </a>
        <?php endif; ?>
    </div>
    <?php endif; ?>
</div>

<style>
.pagination-container { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px; margin-top: 25px; padding: 15px; background: var(--bg-card); border-radius: var(--radius); }
.pagination-info { color: var(--text-muted); font-size: 14px; }
.per-page-selector { display: flex; align-items: center; gap: 10px; }
.per-page-selector label { color: var(--text-muted); font-size: 14px; }
.per-page-selector select { padding: 8px 15px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-main); color: var(--text-primary); }
.pagination { display: flex; align-items: center; gap: 5px; }
.page-btn { display: flex; align-items: center; justify-content: center; min-width: 40px; height: 40px; padding: 0 12px; border-radius: 8px; background: var(--bg-main); color: var(--text-primary); text-decoration: none; transition: all 0.2s; font-weight: 500; }
.page-btn:hover { background: var(--primary); color: white; }
.page-btn.active { background: var(--primary); color: white; }
.page-btn .material-icons-round { font-size: 20px; }
.page-dots { padding: 0 8px; color: var(--text-muted); }
@media (max-width: 768px) { .pagination-container { justify-content: center; } }
</style>
<?php endif; ?>



============================================================
FILE: app/Views/partials/table_selection.php
============================================================
<?php 
/**
 * Checkbox Selection Partial
 * Include this in table views to enable row selection
 * Required: $selectionType = 'products' | 'customers' | 'invoices' | 'payments' etc.
 */
?>

<style>
.selection-bar {
    display: none;
    background: var(--primary);
    color: white;
    padding: 10px 20px;
    border-radius: var(--radius-sm);
    margin-bottom: 15px;
    align-items: center;
    justify-content: space-between;
    animation: slideDown 0.2s ease;
}
.selection-bar.show { display: flex; }
.selection-bar .selected-count { font-weight: 600; }
.selection-bar .selection-actions { display: flex; gap: 10px; }
.selection-bar .btn { background: rgba(255,255,255,0.2); color: white; border: none; }
.selection-bar .btn:hover { background: rgba(255,255,255,0.3); }
.selection-bar .btn-danger { background: var(--danger); }

.table .select-checkbox {
    width: 40px;
    text-align: center;
}
.table .select-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}
.table tbody tr.selected { background: rgba(var(--primary-rgb), 0.1) !important; }

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Toast Notifications */
.bulk-toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    padding: 15px 25px;
    border-radius: var(--radius-sm);
    color: white;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 9999;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transition: transform 0.3s ease, opacity 0.3s ease;
    opacity: 0;
}
.bulk-toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}
.bulk-toast-success { background: var(--success, #28a745); }
.bulk-toast-error { background: var(--danger, #dc3545); }
.bulk-toast-warning { background: var(--warning, #ffc107); color: #333; }
.bulk-toast-info { background: var(--primary, #007bff); }
.bulk-toast .material-icons-round { font-size: 20px; }
</style>

<div class="selection-bar" id="selectionBar">
    <div>
        <span class="selected-count"><span id="selectedCount">0</span> عنصر محدد</span>
    </div>
    <div class="selection-actions">
        <button class="btn btn-sm" onclick="exportSelected('pdf')">
            <span class="material-icons-round">picture_as_pdf</span> تصدير PDF
        </button>
        <button class="btn btn-sm" onclick="exportSelected('excel')">
            <span class="material-icons-round">table_chart</span> تصدير Excel
        </button>
        <?php if (isset($allowDelete) && $allowDelete): ?>
        <button class="btn btn-sm btn-danger" onclick="deleteSelected()">
            <span class="material-icons-round">delete</span> حذف المحدد
        </button>
        <?php endif; ?>
        <button class="btn btn-sm" onclick="clearSelection()">
            <span class="material-icons-round">close</span> إلغاء
        </button>
    </div>
</div>

<script>
const selectionType = '<?= $selectionType ?? 'items' ?>';
const exportBaseUrl = '<?= $exportUrl ?? '' ?>';
let selectedIds = [];

function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        updateRowSelection(cb);
    });
    updateSelectionBar();
}

function toggleRowSelect(checkbox) {
    updateRowSelection(checkbox);
    updateSelectAllCheckbox();
    updateSelectionBar();
}

function updateRowSelection(checkbox) {
    const id = checkbox.dataset.id;
    const row = checkbox.closest('tr');
    
    if (checkbox.checked) {
        if (!selectedIds.includes(id)) {
            selectedIds.push(id);
        }
        row.classList.add('selected');
    } else {
        selectedIds = selectedIds.filter(i => i !== id);
        row.classList.remove('selected');
    }
}

function updateSelectAllCheckbox() {
    const allCheckbox = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.row-checkbox');
    const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
    
    if (allCheckbox) {
        allCheckbox.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
        allCheckbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
    }
}

function updateSelectionBar() {
    const bar = document.getElementById('selectionBar');
    const countEl = document.getElementById('selectedCount');
    
    countEl.textContent = selectedIds.length;
    
    if (selectedIds.length > 0) {
        bar.classList.add('show');
    } else {
        bar.classList.remove('show');
    }
}

function clearSelection() {
    selectedIds = [];
    document.querySelectorAll('.row-checkbox, #selectAll').forEach(cb => cb.checked = false);
    document.querySelectorAll('tr.selected').forEach(tr => tr.classList.remove('selected'));
    updateSelectionBar();
}

function exportSelected(format) {
    if (selectedIds.length === 0) {
        alert('لم يتم تحديد أي عناصر');
        return;
    }
    
    const ids = selectedIds.join(',');
    let url = exportBaseUrl + '/' + format + '?ids=' + ids;
    window.open(url, '_blank');
}

function deleteSelected() {
    if (selectedIds.length === 0) {
        showToast('لم يتم تحديد أي عناصر', 'warning');
        return;
    }
    
    if (!confirm('هل أنت متأكد من حذف ' + selectedIds.length + ' عنصر؟')) {
        return;
    }
    
    // Use AJAX to delete and stay on same page
    const deleteUrl = '<?= url('/' . ($selectionType ?? 'items') . '/bulk-delete') ?>';
    
    fetch(deleteUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: 'ids=' + selectedIds.join(',')
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            // Remove deleted rows from table
            selectedIds.forEach(id => {
                const checkbox = document.querySelector('.row-checkbox[data-id="' + id + '"]');
                if (checkbox) {
                    const row = checkbox.closest('tr');
                    if (row) {
                        row.style.transition = 'opacity 0.3s, transform 0.3s';
                        row.style.opacity = '0';
                        row.style.transform = 'translateX(-20px)';
                        setTimeout(() => row.remove(), 300);
                    }
                }
            });
            clearSelection();
        } else {
            showToast(data.message || 'حدث خطأ أثناء الحذف', 'error');
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        showToast('حدث خطأ في الاتصال بالخادم', 'error');
    });
}

// Toast notification function
function showToast(message, type = 'info') {
    // Remove existing toast
    const existingToast = document.querySelector('.bulk-toast');
    if (existingToast) existingToast.remove();
    
    const toast = document.createElement('div');
    toast.className = 'bulk-toast bulk-toast-' + type;
    
    const icons = {
        success: 'check_circle',
        error: 'error',
        warning: 'warning',
        info: 'info'
    };
    
    toast.innerHTML = '<span class="material-icons-round">' + (icons[type] || 'info') + '</span> ' + message;
    document.body.appendChild(toast);
    
    // Trigger animation
    setTimeout(() => toast.classList.add('show'), 10);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}
</script>


============================================================
FILE: app/Views/payments/index.php
============================================================
<?php $exportUrl = url('/export/payments'); ?>
<div class="page-header">
    <h2><span class="material-icons-round">سجل المدفوعات</span> سجل المدفوعات</h2>
    <div class="header-actions">
        <?php include dirname(__DIR__) . '/partials/export_buttons.php'; ?>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <form method="GET" class="filters">
            <div class="form-group" style="margin:0">
                <label>من تاريخ</label>
                <input type="date" name="from" class="form-control" value="<?= $from ?>">
            </div>
            <div class="form-group" style="margin:0">
                <label>إلى تاريخ</label>
                <input type="date" name="to" class="form-control" value="<?= $to ?>">
            </div>
            <button type="submit" class="btn btn-primary" style="align-self:flex-end">بحث</button>
        </form>
    </div>
    <div class="card-body">
        <div class="summary-bar">
            <div class="summary-item">
                <span class="material-icons-round">payments</span>
                <div><strong><?= formatMoney($total) ?></strong><span>إجمالي المدفوعات</span></div>
            </div>
            <div class="summary-item">
                <span class="material-icons-round">receipt</span>
                <div><strong><?= count($payments) ?></strong><span>عدد العمليات</span></div>
            </div>
        </div>
        
        <?php $selectionType = 'payments'; $allowDelete = false; include dirname(__DIR__) . '/partials/table_selection.php'; ?>
        
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th class="select-checkbox"><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>
                        <th>رقم الإيصال</th>
                        <th>العميل</th>
                        <th>الفاتورة</th>
                        <th>المبلغ</th>
                        <th>طريقة الدفع</th>
                        <th>التاريخ</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($payments as $pay): ?>
                    <tr>
                        <td class="select-checkbox"><input type="checkbox" class="row-checkbox" data-id="<?= $pay['id'] ?>" onclick="toggleRowSelect(this)"></td>
                        <td><?= $pay['receipt_number'] ?></td>
                        <td><?= $pay['customer_name'] ?? '-' ?></td>
                        <td><a href="<?= url('/invoices/' . $pay['invoice_id']) ?>"><?= $pay['invoice_number'] ?></a></td>
                        <td><strong class="text-success"><?= formatMoney($pay['amount']) ?></strong></td>
                        <td><?= paymentMethod($pay['payment_method']) ?></td>
                        <td><?= formatDateTime($pay['payment_date']) ?></td>
                        <td><a href="<?= url('/payments/' . $pay['id'] . '/receipt') ?>" class="btn btn-sm btn-secondary" target="_blank"><span class="material-icons-round">print</span></a></td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
        
        <?php include dirname(__DIR__) . '/partials/pagination.php'; ?>
    </div>
</div>

<style>
.filters { display: flex; gap: 20px; align-items: flex-end; }
.summary-bar { display: flex; gap: 20px; margin-bottom: 25px; }
.summary-item { background: var(--bg-main); border-radius: var(--radius-sm); padding: 15px 20px; display: flex; align-items: center; gap: 15px; }
.summary-item .material-icons-round { font-size: 30px; color: var(--success); }
.summary-item strong { display: block; font-size: 20px; }
.summary-item span { font-size: 12px; color: var(--text-muted); }
</style>


============================================================
FILE: app/Views/payments/receipt.php
============================================================
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>إيصال دفع - <?= $payment['receipt_number'] ?></title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cairo', sans-serif; background: #fff; color: #333; padding: 20px; }
        .receipt { max-width: 400px; margin: 0 auto; border: 1px solid #ddd; padding: 25px; }
        .header { text-align: center; border-bottom: 2px dashed #ddd; padding-bottom: 15px; margin-bottom: 15px; }
        .header h1 { font-size: 18px; margin-bottom: 5px; }
        .header p { font-size: 12px; color: #666; }
        .receipt-number { text-align: center; background: #f5f5f5; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        .receipt-number strong { font-size: 18px; color: #1a237e; }
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #ddd; }
        .info-row:last-of-type { border: none; }
        .amount-box { text-align: center; background: #e8f5e9; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .amount-box span { display: block; font-size: 12px; color: #666; }
        .amount-box strong { font-size: 28px; color: #2e7d32; }
        .footer { text-align: center; margin-top: 20px; padding-top: 15px; border-top: 2px dashed #ddd; }
        .footer p { font-size: 11px; color: #666; margin-bottom: 5px; }
        @media print { body { padding: 0; } .no-print { display: none; } }
    </style>
</head>
<body>
    <div class="receipt">
        <div class="header">
            <h1><?= $settings['store_name'] ?? 'نظام تقسيط' ?></h1>
            <p><?= $settings['store_address'] ?? '' ?></p>
            <p>هاتف: <?= $settings['store_phone'] ?? '' ?></p>
        </div>
        
        <div class="receipt-number">
            <span>رقم الإيصال</span>
            <strong><?= $payment['receipt_number'] ?></strong>
        </div>
        
        <div class="info-row"><span>التاريخ:</span><span><?= formatDateTime($payment['payment_date']) ?></span></div>
        <div class="info-row"><span>رقم الفاتورة:</span><span><?= $payment['invoice_number'] ?></span></div>
        <?php if ($payment['customer_name']): ?>
        <div class="info-row"><span>العميل:</span><span><?= $payment['customer_name'] ?></span></div>
        <?php endif; ?>
        <div class="info-row"><span>طريقة الدفع:</span><span><?= paymentMethod($payment['payment_method']) ?></span></div>
        <?php if ($payment['installment_number']): ?>
        <div class="info-row"><span>القسط:</span><span>القسط رقم <?= $payment['installment_number'] ?></span></div>
        <?php endif; ?>
        
        <div class="amount-box">
            <span>المبلغ المدفوع</span>
            <strong><?= formatMoney($payment['amount']) ?></strong>
        </div>
        
        <?php if ($payment['notes']): ?>
        <p style="font-size:12px;color:#666;margin-bottom:15px">ملاحظات: <?= $payment['notes'] ?></p>
        <?php endif; ?>
        
        <div class="footer">
            <p>شكراً لتعاملكم معنا</p>
            <p>تم الطباعة: <?= date('Y-m-d H:i') ?></p>
        </div>
    </div>
    
    <div class="no-print" style="text-align:center;margin-top:30px">
        <button onclick="window.print()" style="padding:10px 30px;font-size:16px;cursor:pointer">طباعة</button>
    </div>
</body>
</html>


============================================================
FILE: app/Views/pos/index.php
============================================================
<div class="pos-container">
    <div class="pos-products">
        <div class="pos-header">
            <div class="search-wrapper">
                <span class="material-icons-round">search</span>
                <input type="text" id="productSearch" placeholder="بحث عن منتج بالاسم أو الباركود..." autocomplete="off">
                <button type="button" class="voice-btn" onclick="voiceSearchProduct()" title="بحث صوتي">
                    <span class="material-icons-round">mic</span>
                </button>
            </div>
            <div class="category-filter">
                <button class="cat-btn active" data-category="all">الكل</button>
                <?php foreach ($categories as $cat): ?>
                <button class="cat-btn" data-category="<?= $cat['id'] ?>"><?= $cat['name'] ?></button>
                <?php endforeach; ?>
            </div>
        </div>
        
        <!-- Pagination Controls - Top -->
        <div class="pagination-controls" id="paginationControlsTop">
            <button class="pagination-btn" id="prevPageTop" onclick="changePage(-1)">
                <span class="material-icons-round">chevron_right</span>
                السابق
            </button>
            <div class="pagination-info">
                <span class="currentPageNum">1</span> / <span class="totalPagesNum">1</span>
            </div>
            <button class="pagination-btn" id="nextPageTop" onclick="changePage(1)">
                التالي
                <span class="material-icons-round">chevron_left</span>
            </button>
        </div>
        
        <div class="products-grid" id="productsGrid">
            <?php foreach ($products as $product): ?>
            <div class="product-card" data-id="<?= $product['id'] ?>" 
                 data-name="<?= htmlspecialchars($product['name']) ?>"
                 data-price="<?= $product['cash_price'] ?>"
                 data-category="<?= $product['category_id'] ?>"
                 data-barcode="<?= $product['barcode'] ?>"
                 data-quantity="<?= $product['quantity'] ?>">
                <div class="product-qty-badge" style="display: none;">0</div>
                <div class="product-image">
                    <?php if ($product['image']): ?>
                        <img src="<?= upload('products/' . $product['image']) ?>" alt="<?= $product['name'] ?>" loading="lazy" decoding="async">
                    <?php else: ?>
                        <img src="<?= upload('products/default.png') ?>" alt="<?= $product['name'] ?>" loading="lazy" decoding="async">
                    <?php endif; ?>
                </div>
                <div class="product-info">
                    <h4><?= $product['name'] ?></h4>
                    <p class="product-price"><?= formatMoney($product['cash_price']) ?></p>
                    <small class="stock <?= $product['quantity'] <= $product['min_quantity'] ? 'low' : '' ?>">
                        المخزون: <?= $product['quantity'] ?>
                    </small>
                </div>
            </div>
            <?php endforeach; ?>
        </div>
        
        <!-- Pagination Controls - Bottom -->
        <div class="pagination-controls" id="paginationControlsBottom">
            <button class="pagination-btn" id="prevPageBottom" onclick="changePage(-1)">
                <span class="material-icons-round">chevron_right</span>
                السابق
            </button>
            <div class="pagination-info">
                <span class="currentPageNum">1</span> / <span class="totalPagesNum">1</span>
            </div>
            <button class="pagination-btn" id="nextPageBottom" onclick="changePage(1)">
                التالي
                <span class="material-icons-round">chevron_left</span>
            </button>
        </div>
    </div>
    
    <div class="pos-cart" id="posCart">
        <!-- Handle للسحب (يظهر فقط على الموبايل) -->
        <div class="cart-handle" id="cartHandle">
            <div class="handle-bar"></div>
        </div>
        
        <div class="cart-header" id="cartHeader">
            <div class="cart-header-left">
                <h3><span class="material-icons-round">shopping_cart</span> السلة</h3>
                <span class="cart-count" id="cartCount">0</span>
            </div>
            <div class="cart-header-right">
                <span class="cart-mini-total" id="cartMiniTotal">0.00 <?= $settings['currency'] ?? 'ج.م' ?></span>
                <button class="btn-expand" id="btnExpandCart" onclick="toggleCart()">
                    <span class="material-icons-round">expand_less</span>
                </button>
                <button class="btn-clear" onclick="clearCart()">
                    <span class="material-icons-round">delete_sweep</span>
                </button>
            </div>
        </div>
        
        <!-- اختيار العميل -->
        <div class="customer-select">
            <label>العميل (اختياري):</label>
            <select id="customerSelect">
                <option value="">زبون نقدي</option>
                <?php foreach ($customers as $customer): ?>
                <option value="<?= $customer['id'] ?>"><?= $customer['full_name'] ?> - <?= $customer['phone'] ?></option>
                <?php endforeach; ?>
            </select>
            <a href="<?= url('/customers/create?return_to=pos') ?>" class="btn-add-customer" onclick="saveCartBeforeAddCustomer()">+ إضافة عميل جديد</a>
        </div>
        
        <div class="cart-body" id="cartBody">
            <div class="cart-items" id="cartItems">
                <p class="empty-cart">السلة فارغة</p>
            </div>
        
        <div class="cart-summary">
            <div class="total-items-badge">
                <span class="material-icons-round">shopping_basket</span>
                <span>إجمالي المنتجات:</span>
                <strong id="totalItemsCount">0</strong>
            </div>
            <div class="summary-row">
                <span>المجموع:</span>
                <strong id="subtotal">0.00 <?= $settings['currency'] ?? 'ج.م' ?></strong>
            </div>
            <div class="summary-row">
                <span>الخصم:</span>
                <input type="number" id="discountInput" value="0" min="0" step="0.01" onchange="updateTotals()">
            </div>
            <div class="summary-row total">
                <span>الإجمالي:</span>
                <strong id="grandTotal">0.00 <?= $settings['currency'] ?? 'ج.م' ?></strong>
            </div>
        </div>
        
        <div class="cart-actions">
            <button class="btn btn-success btn-block" onclick="completeSale()">
                <span class="material-icons-round">check_circle</span>
                إتمام البيع
            </button>
            <button class="btn btn-primary btn-block" onclick="goToInstallment()">
                <span class="material-icons-round">credit_score</span>
                بيع بالتقسيط
            </button>
        </div>
        </div><!-- end cart-body -->
    </div>
</div>

<style>
.pos-container {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 25px;
    height: calc(100vh - var(--header-height) - 60px);
}

.pos-products {
    background: var(--bg-card);
    border-radius: var(--radius);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.pos-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
}

.search-wrapper {
    display: flex;
    align-items: center;
    background: var(--bg-main);
    border-radius: 12px;
    padding: 0 15px;
    margin-bottom: 15px;
}

.search-wrapper input {
    flex: 1;
    padding: 12px;
    border: none;
    background: transparent;
    font-family: inherit;
    font-size: 15px;
    color: var(--text-primary);
}

.search-wrapper input:focus { outline: none; }

.category-filter {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.cat-btn {
    padding: 8px 16px;
    border: none;
    background: var(--bg-main);
    border-radius: 20px;
    font-family: inherit;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
}

.cat-btn:hover, .cat-btn.active {
    background: var(--primary);
    color: white;
}

.products-grid {
    flex: 1;
    padding: 20px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 15px;
    overflow-y: auto;
    align-content: start;
}

.product-card {
    background: var(--bg-main);
    border-radius: var(--radius);
    padding: 15px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    position: relative;
    border: 2px solid transparent;
}

.product-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow);
}

.product-card.selected {
    border-color: var(--primary);
    background: linear-gradient(135deg, rgba(30, 136, 229, 0.08), rgba(30, 136, 229, 0.03));
    box-shadow: 0 0 15px rgba(30, 136, 229, 0.3);
}

.product-card.out-of-stock {
    opacity: 0.5;
    pointer-events: none;
}

/* شارة الكمية على كارت المنتج */
.product-qty-badge {
    position: absolute;
    top: -10px;
    right: -10px;
    min-width: 28px;
    height: 28px;
    padding: 0 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark, #1565C0));
    color: white;
    border-radius: 14px;
    font-size: 14px;
    font-weight: 700;
    box-shadow: 0 3px 10px rgba(30, 136, 229, 0.4);
    z-index: 10;
    animation: badge-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes badge-pop {
    0% { transform: scale(0); }
    80% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.product-image {
    width: 80px;
    height: 80px;
    margin: 0 auto 10px;
    background: var(--bg-card);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.product-image img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

.product-image .material-icons-round {
    font-size: 36px;
    color: var(--text-muted);
}

.product-info h4 {
    font-size: 13px;
    margin-bottom: 5px;
    line-height: 1.3;
}

.product-price {
    color: var(--primary);
    font-weight: 700;
    font-size: 14px;
}

.stock {
    color: var(--text-muted);
    font-size: 11px;
}

.stock.low {
    color: var(--warning);
}

/* Pagination Controls */
.pagination-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    padding: 15px;
    background: var(--bg-card);
    border-radius: var(--radius);
    margin-top: 15px;
    box-shadow: var(--shadow);
}

.pagination-btn {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 10px 20px;
    border: none;
    background: var(--bg-main);
    border-radius: var(--radius-sm);
    font-family: inherit;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--text-primary);
}

.pagination-btn:hover:not(:disabled) {
    background: var(--primary);
    color: white;
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pagination-info {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    padding: 10px 20px;
    background: var(--bg-main);
    border-radius: var(--radius-sm);
}

.pagination-info #currentPage {
    color: var(--primary);
    font-weight: 700;
}

/* Product card hidden by pagination */
.product-card.hidden {
    display: none !important;
}

/* السلة */
.pos-cart {
    background: var(--bg-card);
    border-radius: var(--radius);
    display: flex;
    flex-direction: column;
}

.cart-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.cart-header h3 {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 16px;
}

.btn-clear {
    background: none;
    border: none;
    color: var(--danger);
    cursor: pointer;
}

/* اختيار العميل */
.customer-select {
    padding: 15px 20px;
    border-bottom: 1px solid var(--border-color);
}

.customer-select label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
}

.customer-select select {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-family: inherit;
    background: var(--bg-main);
    color: var(--text-primary);
}

.btn-add-customer {
    display: block;
    margin-top: 10px;
    font-size: 13px;
    color: var(--primary);
    text-decoration: none;
    transition: all 0.2s;
}

.btn-add-customer:hover {
    color: var(--primary-dark);
    text-decoration: underline;
}

.cart-items {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
}

.empty-cart {
    text-align: center;
    color: var(--text-muted);
    padding: 40px 0;
}

.cart-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: var(--bg-main);
    border-radius: var(--radius-sm);
    margin-bottom: 10px;
}

/* رقم المنتج في السلة */
.item-number {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 28px;
    height: 28px;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark, #1565C0));
    color: white;
    border-radius: 50%;
    font-size: 13px;
    font-weight: 700;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(30, 136, 229, 0.3);
}

.cart-item-info {
    flex: 1;
}

.cart-item-info h5 {
    font-size: 13px;
    margin-bottom: 3px;
}

.cart-item-info small {
    color: var(--text-muted);
}

.cart-item-qty {
    display: flex;
    align-items: center;
    gap: 5px;
}

.cart-item-qty button {
    width: 28px;
    height: 28px;
    border: none;
    background: var(--bg-card);
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
}

.cart-item-qty span {
    width: 30px;
    text-align: center;
    font-weight: 600;
}

.cart-item-remove {
    background: none;
    border: none;
    color: var(--danger);
    cursor: pointer;
}

/* شارة إجمالي المنتجات */
.total-items-badge {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.total-items-badge .material-icons-round {
    font-size: 24px;
    opacity: 0.9;
}

.total-items-badge span {
    font-size: 14px;
}

.total-items-badge strong {
    margin-right: auto;
    font-size: 20px;
    background: rgba(255,255,255,0.2);
    padding: 4px 14px;
    border-radius: 20px;
    min-width: 40px;
    text-align: center;
}

.cart-summary {
    padding: 15px 20px;
    border-top: 1px solid var(--border-color);
}

.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.summary-row.total {
    font-size: 18px;
    padding-top: 10px;
    border-top: 2px solid var(--border-color);
}

.summary-row input {
    width: 100px;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    text-align: center;
    font-family: inherit;
}

.cart-customer {
    padding: 15px 20px;
    border-top: 1px solid var(--border-color);
}

.cart-customer label {
    display: block;
    margin-bottom: 8px;
    font-size: 13px;
}

.cart-customer select {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-family: inherit;
    background: var(--bg-main);
}

.cart-actions {
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* ═══════════════════════════════════════════════════════════════
   Pull-up Cart Styles - للموبايل فقط
   ═══════════════════════════════════════════════════════════════ */

/* Handle للسحب - مخفي على الديسكتوب */
.cart-handle {
    display: none;
}

/* عناصر الهيدر الجديدة - مخفية على الديسكتوب */
.cart-header-left,
.cart-header-right {
    display: contents;
}

.cart-count,
.cart-mini-total,
.btn-expand {
    display: none;
}

/* Cart Body wrapper */
.cart-body {
    display: contents;
}

@media (max-width: 768px) {
    /* السلة القابلة للسحب */
    .pos-cart {
        position: fixed !important;
        bottom: 0;
        left: 0;
        right: 0;
        border-radius: 24px 24px 0 0 !important;
        box-shadow: 0 -8px 40px rgba(0, 0, 0, 0.2);
        z-index: 100;
        background: var(--bg-card);
        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        max-height: 70px; /* الارتفاع المصغر */
        overflow: hidden;
    }
    
    .pos-cart.expanded {
        max-height: 85vh;
        overflow: visible;
    }
    
    /* Handle للسحب */
    .cart-handle {
        display: flex;
        justify-content: center;
        padding: 12px 0 4px;
        cursor: grab;
        touch-action: none;
    }
    
    .cart-handle:active {
        cursor: grabbing;
    }
    
    .handle-bar {
        width: 48px;
        height: 5px;
        background: linear-gradient(90deg, var(--primary-light), var(--primary));
        border-radius: 10px;
        transition: all 0.3s;
    }
    
    .pos-cart.expanded .handle-bar {
        background: var(--text-muted);
        width: 36px;
    }
    
    /* هيدر السلة المحسن */
    .cart-header {
        padding: 8px 16px 12px !important;
        border-bottom: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .cart-header-left,
    .cart-header-right {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .cart-header h3 {
        font-size: 15px !important;
        margin: 0;
    }
    
    /* عداد المنتجات */
    .cart-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 24px;
        height: 24px;
        padding: 0 8px;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark, #1565C0));
        color: white;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 700;
        animation: pulse-badge 2s infinite;
    }
    
    @keyframes pulse-badge {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.08); }
    }
    
    .cart-count:empty,
    .cart-count:contains("0") {
        display: none;
    }
    
    /* الإجمالي المصغر */
    .cart-mini-total {
        display: inline-block;
        font-size: 14px;
        font-weight: 700;
        color: var(--success);
        background: rgba(76, 175, 80, 0.1);
        padding: 4px 12px;
        border-radius: 8px;
    }
    
    /* زر التوسيع */
    .btn-expand {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border: none;
        background: var(--bg-main);
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-expand:hover {
        background: var(--primary-light);
    }
    
    .btn-expand .material-icons-round {
        transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        color: var(--primary);
        font-size: 22px;
    }
    
    .pos-cart.expanded .btn-expand .material-icons-round {
        transform: rotate(180deg);
    }
    
    /* Cart Body */
    .cart-body {
        display: block;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .pos-cart.expanded .cart-body {
        max-height: calc(85vh - 70px);
        overflow-y: auto;
    }
    
    /* عناصر السلة */
    .cart-items {
        padding: 10px 16px !important;
        max-height: 30vh;
        overflow-y: auto;
        border-top: 1px solid var(--border-color);
    }
    
    .cart-item {
        padding: 12px !important;
        margin-bottom: 8px;
        background: linear-gradient(135deg, var(--bg-main), rgba(255,255,255,0.05));
        border: 1px solid var(--border-color);
        border-radius: 12px !important;
        transition: all 0.2s;
    }
    
    .cart-item:active {
        transform: scale(0.98);
    }
    
    .cart-item-info h5 {
        font-size: 13px !important;
        font-weight: 600;
    }
    
    .cart-item-qty {
        background: var(--bg-card);
        padding: 4px;
        border-radius: 8px;
    }
    
    .cart-item-qty button {
        width: 32px !important;
        height: 32px !important;
        font-size: 18px !important;
        font-weight: bold;
        border-radius: 8px !important;
        transition: all 0.15s;
    }
    
    .cart-item-qty button:active {
        background: var(--primary);
        color: white;
    }
    
    .cart-item-qty span {
        min-width: 36px;
        font-size: 15px !important;
    }
    
    /* ملخص السلة */
    .cart-summary {
        padding: 12px 16px !important;
        background: rgba(0,0,0,0.02);
    }
    
    .summary-row {
        margin-bottom: 8px !important;
    }
    
    .summary-row.total {
        font-size: 17px !important;
        color: var(--primary);
    }
    
    /* اختيار العميل */
    .customer-select {
        padding: 12px 16px !important;
    }
    
    /* أزرار السلة */
    .cart-actions {
        padding: 12px 16px 20px !important;
        gap: 10px !important;
    }
    
    .cart-actions .btn {
        padding: 14px !important;
        font-size: 15px !important;
        font-weight: 600;
        border-radius: 12px !important;
    }
    
    .cart-actions .btn-success {
        background: linear-gradient(135deg, #4CAF50, #43A047);
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }
    
    .cart-actions .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark, #1565C0));
        box-shadow: 0 4px 15px rgba(30, 136, 229, 0.3);
    }
    
    /* إضافة padding للمنتجات لتفادي تغطية السلة */
    .pos-container {
        padding-bottom: 90px !important;
    }
}

/* الشاشات الصغيرة جداً */
@media (max-width: 480px) {
    .pos-cart {
        max-height: 65px;
    }
    
    .cart-header h3 {
        font-size: 13px !important;
    }
    
    .cart-header h3 .material-icons-round {
        font-size: 18px;
    }
    
    .cart-mini-total {
        font-size: 12px;
        padding: 3px 8px;
    }
    
    .cart-count {
        min-width: 20px;
        height: 20px;
        font-size: 11px;
    }
    
    .btn-expand {
        width: 32px;
        height: 32px;
    }
    
    .cart-items {
        max-height: 25vh;
    }
}
</style>

<script>
let cart = [];
const currency = '<?= $settings['currency'] ?? 'ج.م' ?>';

// ═══════════════════════════════════════════════════════════════
// إعدادات الـ Pagination المتجاوبة
// ═══════════════════════════════════════════════════════════════
// عدد المنتجات حسب حجم الشاشة: موبايل = 8، سطح المكتب = 18
function getProductsPerPage() {
    return window.innerWidth <= 768 ? 8 : 18;
}

let PRODUCTS_PER_PAGE = getProductsPerPage();
let currentPage = 1;
let filteredProducts = [];

// تحديث عند تغيير حجم الشاشة
window.addEventListener('resize', function() {
    const newPerPage = getProductsPerPage();
    if (newPerPage !== PRODUCTS_PER_PAGE) {
        PRODUCTS_PER_PAGE = newPerPage;
        showPage(1); // إعادة العرض من الصفحة الأولى
    }
});

// تهيئة Pagination عند تحميل الصفحة
function initPagination() {
    const allProducts = document.querySelectorAll('.product-card');
    filteredProducts = Array.from(allProducts);
    showPage(1);
}

// عرض صفحة معينة
function showPage(page) {
    const start = (page - 1) * PRODUCTS_PER_PAGE;
    const end = start + PRODUCTS_PER_PAGE;
    
    filteredProducts.forEach((product, index) => {
        if (index >= start && index < end) {
            product.classList.remove('hidden');
        } else {
            product.classList.add('hidden');
        }
    });
    
    currentPage = page;
    updatePaginationControls();
}

// تغيير الصفحة
function changePage(direction) {
    const totalPages = Math.ceil(filteredProducts.length / PRODUCTS_PER_PAGE);
    const newPage = currentPage + direction;
    
    if (newPage >= 1 && newPage <= totalPages) {
        showPage(newPage);
    }
}

// تحديث عناصر التحكم (الأعلى والأسفل)
function updatePaginationControls() {
    const totalPages = Math.max(1, Math.ceil(filteredProducts.length / PRODUCTS_PER_PAGE));
    
    // تحديث أرقام الصفحات في كل الأماكن
    document.querySelectorAll('.currentPageNum').forEach(el => el.textContent = currentPage);
    document.querySelectorAll('.totalPagesNum').forEach(el => el.textContent = totalPages);
    
    // تفعيل/تعطيل أزرار السابق
    document.getElementById('prevPageTop').disabled = currentPage <= 1;
    document.getElementById('prevPageBottom').disabled = currentPage <= 1;
    
    // تفعيل/تعطيل أزرار التالي
    document.getElementById('nextPageTop').disabled = currentPage >= totalPages;
    document.getElementById('nextPageBottom').disabled = currentPage >= totalPages;
    
    // إخفاء التحكمات إذا كان هناك صفحة واحدة أو أقل
    const hideControls = filteredProducts.length <= PRODUCTS_PER_PAGE;
    document.getElementById('paginationControlsTop').style.display = hideControls ? 'none' : 'flex';
    document.getElementById('paginationControlsBottom').style.display = hideControls ? 'none' : 'flex';
}

// تصفية المنتجات مع Pagination
function filterProducts(category, searchTerm = '') {
    const allProducts = document.querySelectorAll('.product-card');
    filteredProducts = [];
    
    allProducts.forEach(product => {
        const productCategory = product.dataset.category;
        const productName = product.dataset.name.toLowerCase();
        const productBarcode = product.dataset.barcode?.toLowerCase() || '';
        
        const matchesCategory = category === 'all' || productCategory === category;
        const matchesSearch = searchTerm === '' || 
            productName.includes(searchTerm.toLowerCase()) || 
            productBarcode.includes(searchTerm.toLowerCase());
        
        if (matchesCategory && matchesSearch) {
            filteredProducts.push(product);
            product.style.display = '';
        } else {
            product.classList.add('hidden');
            product.style.display = 'none';
        }
    });
    
    // إعادة تعيين للصفحة الأولى عند التصفية
    showPage(1);
}

// تهيئة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    initPagination();
    
    // استعادة السلة من localStorage إذا كانت موجودة
    const savedCart = localStorage.getItem('posCartItems');
    if (savedCart) {
        try {
            const items = JSON.parse(savedCart);
            if (Array.isArray(items) && items.length > 0) {
                cart = items;
                renderCart();
            }
        } catch (e) {
            console.error('Error restoring cart:', e);
        }
        localStorage.removeItem('posCartItems');
    }
    
    // اختيار العميل الجديد إذا كنا عائدين من صفحة إضافة عميل
    const urlParams = new URLSearchParams(window.location.search);
    const newCustomerId = urlParams.get('new_customer_id');
    if (newCustomerId) {
        const customerSelect = document.getElementById('customerSelect');
        if (customerSelect) {
            // البحث عن العميل بالـ ID في القائمة
            for (let i = 0; i < customerSelect.options.length; i++) {
                if (customerSelect.options[i].value === newCustomerId) {
                    customerSelect.selectedIndex = i;
                    break;
                }
            }
        }
        // إزالة الـ parameter من URL بدون إعادة تحميل الصفحة
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
    }
    // دعم الطريقة القديمة (localStorage) للتوافق
    else if (localStorage.getItem('selectNewestCustomer') === 'pos') {
        localStorage.removeItem('selectNewestCustomer');
        const customerSelect = document.getElementById('customerSelect');
        if (customerSelect && customerSelect.options.length > 1) {
            // اختيار آخر عميل في القائمة (الأحدث)
            customerSelect.selectedIndex = customerSelect.options.length - 1;
        }
    }
});

// إضافة منتج للسلة
document.querySelectorAll('.product-card').forEach(card => {
    card.addEventListener('click', function() {
        const id = this.dataset.id;
        const name = this.dataset.name;
        const price = parseFloat(this.dataset.price);
        const stock = parseInt(this.dataset.quantity);
        
        if (stock <= 0) {
            alert('المنتج غير متوفر في المخزون');
            return;
        }
        
        const existing = cart.find(item => item.id === id);
        
        if (existing) {
            if (existing.quantity < stock) {
                existing.quantity++;
            } else {
                alert('لا يمكن إضافة أكثر من الكمية المتاحة');
                return;
            }
        } else {
            cart.push({ id, name, price, quantity: 1, stock });
        }
        
        renderCart();
    });
});

// عرض السلة
function renderCart() {
    const container = document.getElementById('cartItems');
    
    if (cart.length === 0) {
        container.innerHTML = '<p class="empty-cart">السلة فارغة</p>';
        updateTotals();
        updateProductCardSelection();
        return;
    }
    
    container.innerHTML = cart.map((item, index) => `
        <div class="cart-item">
            <span class="item-number">${index + 1}</span>
            <div class="cart-item-info">
                <h5>${item.name}</h5>
                <small>${item.price.toFixed(2)} ${currency}</small>
            </div>
            <div class="cart-item-qty">
                <button onclick="event.stopPropagation(); changeQty(${index}, -1)">-</button>
                <span>${item.quantity}</span>
                <button onclick="event.stopPropagation(); changeQty(${index}, 1)">+</button>
            </div>
            <button class="cart-item-remove" onclick="event.stopPropagation(); removeItem(${index})">
                <span class="material-icons-round">close</span>
            </button>
        </div>
    `).join('');
    
    updateTotals();
    updateProductCardSelection();
}

// تحديث حالة تحديد كروت المنتجات وإظهار الكمية
function updateProductCardSelection() {
    // إزالة التحديد من كل الكروت أولاً
    document.querySelectorAll('.product-card').forEach(card => {
        card.classList.remove('selected');
        const badge = card.querySelector('.product-qty-badge');
        if (badge) {
            badge.style.display = 'none';
            badge.textContent = '0';
        }
    });
    
    // إضافة التحديد للمنتجات الموجودة في السلة
    cart.forEach(item => {
        const card = document.querySelector(`.product-card[data-id="${item.id}"]`);
        if (card) {
            card.classList.add('selected');
            const badge = card.querySelector('.product-qty-badge');
            if (badge) {
                badge.style.display = 'flex';
                badge.textContent = item.quantity;
            }
        }
    });
}

// تغيير الكمية
function changeQty(index, change) {
    const item = cart[index];
    const newQty = item.quantity + change;
    
    if (newQty <= 0) {
        removeItem(index);
    } else if (newQty <= item.stock) {
        item.quantity = newQty;
        renderCart();
    } else {
        alert('لا يمكن إضافة أكثر من الكمية المتاحة');
    }
}

// حذف عنصر
function removeItem(index) {
    cart.splice(index, 1);
    renderCart();
}

// تفريغ السلة
function clearCart() {
    if (cart.length === 0) return;
    if (confirm('هل تريد تفريغ السلة؟')) {
        cart = [];
        renderCart();
    }
}

// تحديث الإجماليات
function updateTotals() {
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const discount = parseFloat(document.getElementById('discountInput').value) || 0;
    const total = subtotal - discount;
    
    document.getElementById('subtotal').textContent = subtotal.toFixed(2) + ' ' + currency;
    document.getElementById('grandTotal').textContent = total.toFixed(2) + ' ' + currency;
    
    // تحديث عداد السلة والإجمالي المصغر (للموبايل)
    // عدد المنتجات المختلفة (وليس مجموع الكميات)
    const uniqueProductsCount = cart.length;
    // مجموع الكميات (للعرض الاختياري)
    const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
    
    const cartCountEl = document.getElementById('cartCount');
    const cartMiniTotalEl = document.getElementById('cartMiniTotal');
    const totalItemsCountEl = document.getElementById('totalItemsCount');
    
    if (cartCountEl) {
        cartCountEl.textContent = uniqueProductsCount;
        cartCountEl.style.display = uniqueProductsCount > 0 ? 'inline-flex' : 'none';
    }
    
    // تحديث شارة إجمالي المنتجات في الملخص (عدد المنتجات المختلفة)
    if (totalItemsCountEl) {
        totalItemsCountEl.textContent = uniqueProductsCount;
    }
    
    if (cartMiniTotalEl) {
        cartMiniTotalEl.textContent = total.toFixed(2) + ' ' + currency;
    }
}

// ═══════════════════════════════════════════════════════════════
// Pull-up Cart Functions - وظائف السلة القابلة للسحب
// ═══════════════════════════════════════════════════════════════

let isCartExpanded = false;
let isDragging = false;
let startY = 0;
let currentY = 0;

// تبديل السلة (توسيع/تصغير)
function toggleCart() {
    const posCart = document.getElementById('posCart');
    if (!posCart) return;
    
    isCartExpanded = !isCartExpanded;
    posCart.classList.toggle('expanded', isCartExpanded);
    
    // اهتزاز خفيف للتغذية الراجعة (إذا كان مدعوماً)
    if (navigator.vibrate) {
        navigator.vibrate(10);
    }
}

// إغلاق السلة
function collapseCart() {
    const posCart = document.getElementById('posCart');
    if (!posCart) return;
    
    isCartExpanded = false;
    posCart.classList.remove('expanded');
}

// فتح السلة
function expandCart() {
    const posCart = document.getElementById('posCart');
    if (!posCart) return;
    
    isCartExpanded = true;
    posCart.classList.add('expanded');
}

// تهيئة السحب باللمس
function initDragGesture() {
    const cartHandle = document.getElementById('cartHandle');
    const cartHeader = document.getElementById('cartHeader');
    const posCart = document.getElementById('posCart');
    
    if (!cartHandle || !posCart) return;
    
    // أحداث اللمس للـ Handle
    cartHandle.addEventListener('touchstart', handleDragStart, { passive: true });
    cartHandle.addEventListener('touchmove', handleDragMove, { passive: false });
    cartHandle.addEventListener('touchend', handleDragEnd);
    
    // أحداث الماوس للـ Handle (للاختبار على الديسكتوب)
    cartHandle.addEventListener('mousedown', handleDragStart);
    document.addEventListener('mousemove', handleDragMove);
    document.addEventListener('mouseup', handleDragEnd);
    
    // النقر على الهيدر لفتح السلة
    cartHeader.addEventListener('click', function(e) {
        // تجاهل النقر على الأزرار
        if (e.target.closest('button')) return;
        toggleCart();
    });
}

function handleDragStart(e) {
    isDragging = true;
    startY = e.touches ? e.touches[0].clientY : e.clientY;
    currentY = startY;
    
    const posCart = document.getElementById('posCart');
    posCart.style.transition = 'none';
}

function handleDragMove(e) {
    if (!isDragging) return;
    
    currentY = e.touches ? e.touches[0].clientY : e.clientY;
    const deltaY = startY - currentY;
    
    // منع التمرير الافتراضي
    if (e.cancelable) {
        e.preventDefault();
    }
}

function handleDragEnd() {
    if (!isDragging) return;
    
    isDragging = false;
    const deltaY = startY - currentY;
    const posCart = document.getElementById('posCart');
    
    posCart.style.transition = '';
    
    // حد السحب للتبديل (50 بكسل)
    if (Math.abs(deltaY) > 50) {
        if (deltaY > 0) {
            // سحب لأعلى - فتح
            expandCart();
        } else {
            // سحب لأسفل - إغلاق
            collapseCart();
        }
    }
}

// تهيئة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    initDragGesture();
    
    // إغلاق السلة عند النقر خارجها (على الموبايل فقط)
    document.addEventListener('click', function(e) {
        if (window.innerWidth > 768) return;
        
        const posCart = document.getElementById('posCart');
        if (!posCart) return;
        
        if (isCartExpanded && !posCart.contains(e.target)) {
            collapseCart();
        }
    });
});

// إتمام البيع
async function completeSale() {
    if (cart.length === 0) {
        alert('السلة فارغة');
        return;
    }
    
    const items = cart.map(item => ({
        id: item.id,
        quantity: item.quantity,
        price: item.price
    }));
    
    const formData = new FormData();
    formData.append('items', JSON.stringify(items));
    formData.append('discount', document.getElementById('discountInput').value);
    formData.append('customer_id', document.getElementById('customerSelect').value);
    formData.append('payment_method', 'cash');
    
    try {
        const response = await fetch('<?= url('/pos/cash') ?>', {
            method: 'POST',
            body: formData
        });
        
        if (response.redirected) {
            window.location.href = response.url;
        }
    } catch (error) {
        alert('حدث خطأ في العملية');
    }
}

// الانتقال لصفحة التقسيط مع نقل السلة والعميل
function goToInstallment() {
    // حفظ السلة في localStorage لنقلها لصفحة التقسيط
    if (cart.length > 0) {
        localStorage.setItem('posCartItems', JSON.stringify(cart));
    }
    
    // حفظ العميل المختار
    const customerId = document.getElementById('customerSelect').value;
    if (customerId) {
        localStorage.setItem('posSelectedCustomer', customerId);
    }
    
    window.location.href = '<?= url('/pos/installment') ?>';
}

// حفظ السلة قبل الانتقال لإضافة عميل جديد
function saveCartBeforeAddCustomer() {
    // حفظ السلة
    if (cart.length > 0) {
        localStorage.setItem('posCartItems', JSON.stringify(cart));
    }
    // علامة لاختيار أحدث عميل عند العودة
    localStorage.setItem('selectNewestCustomer', 'pos');
}

// تصفية بالتصنيف (مع Pagination)
let currentCategory = 'all';
document.querySelectorAll('.cat-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        currentCategory = this.dataset.category;
        const searchTerm = document.getElementById('productSearch').value;
        filterProducts(currentCategory, searchTerm);
    });
});

// البحث (مع Pagination)
document.getElementById('productSearch').addEventListener('input', function() {
    const query = this.value;
    filterProducts(currentCategory, query);
});

// البحث الصوتي
function voiceSearchProduct() {
    if (!('webkitSpeechRecognition' in window)) {
        alert('المتصفح لا يدعم البحث الصوتي');
        return;
    }
    
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'ar-SA';
    recognition.onresult = function(event) {
        document.getElementById('productSearch').value = event.results[0][0].transcript;
        document.getElementById('productSearch').dispatchEvent(new Event('input'));
    };
    recognition.start();
}
</script>


============================================================
FILE: app/Views/pos/installment.php
============================================================
<div class="pos-container">
    <div class="pos-products">
        <div class="pos-header">
            <div class="search-wrapper">
                <span class="material-icons-round">search</span>
                <input type="text" id="productSearch" placeholder="بحث عن منتج..." autocomplete="off">
            </div>
            <div class="category-filter">
                <button class="cat-btn active" data-category="all">الكل</button>
                <?php foreach ($categories as $cat): ?>
                <button class="cat-btn" data-category="<?= $cat['id'] ?>"><?= $cat['name'] ?></button>
                <?php endforeach; ?>
            </div>
        </div>
        
        <!-- Pagination Controls - Top -->
        <div class="pagination-controls" id="paginationControlsTop">
            <button class="pagination-btn" id="prevPageTop" onclick="changePage(-1)">
                <span class="material-icons-round">chevron_right</span>
                السابق
            </button>
            <div class="pagination-info">
                <span class="currentPageNum">1</span> / <span class="totalPagesNum">1</span>
            </div>
            <button class="pagination-btn" id="nextPageTop" onclick="changePage(1)">
                التالي
                <span class="material-icons-round">chevron_left</span>
            </button>
        </div>
        
        <div class="products-grid" id="productsGrid">
            <?php foreach ($products as $product): ?>
            <div class="product-card" data-id="<?= $product['id'] ?>" 
                 data-name="<?= htmlspecialchars($product['name']) ?>"
                 data-price="<?= $product['installment_price'] ?: $product['cash_price'] ?>"
                 data-category="<?= $product['category_id'] ?>">
                <div class="product-qty-badge" style="display: none;">0</div>
                <div class="product-image">
                    <?php if ($product['image']): ?>
                        <img src="<?= upload('products/' . $product['image']) ?>" alt="" loading="lazy" decoding="async">
                    <?php else: ?>
                        <img src="<?= upload('products/default.png') ?>" alt="" loading="lazy" decoding="async">
                    <?php endif; ?>
                </div>
                <div class="product-info">
                    <h4><?= $product['name'] ?></h4>
                    <p class="product-price"><?= formatMoney($product['installment_price'] ?: $product['cash_price']) ?></p>
                </div>
            </div>
            <?php endforeach; ?>
        </div>
        
        <!-- Pagination Controls - Bottom -->
        <div class="pagination-controls" id="paginationControlsBottom">
            <button class="pagination-btn" id="prevPageBottom" onclick="changePage(-1)">
                <span class="material-icons-round">chevron_right</span>
                السابق
            </button>
            <div class="pagination-info">
                <span class="currentPageNum">1</span> / <span class="totalPagesNum">1</span>
            </div>
            <button class="pagination-btn" id="nextPageBottom" onclick="changePage(1)">
                التالي
                <span class="material-icons-round">chevron_left</span>
            </button>
        </div>
    </div>
    
    <div class="pos-cart installment-cart" id="posCart">
        <!-- Handle للسحب (يظهر فقط على الموبايل) -->
        <div class="cart-handle" id="cartHandle">
            <div class="handle-bar"></div>
        </div>
        
        <div class="cart-header" id="cartHeader">
            <div class="cart-title">
                <h3><span class="material-icons-round">shopping_cart</span> السلة</h3>
                <span class="cart-count" id="cartCount">0</span>
            </div>
            <div class="cart-header-actions">
                <span class="cart-mini-total" id="cartMiniTotal">0.00 <?= $settings['currency'] ?? 'ج.م' ?></span>
                <button class="btn-expand" id="btnExpandCart" onclick="toggleCart()">
                    <span class="material-icons-round">expand_less</span>
                </button>
                <button class="btn-clear" onclick="clearCart()" title="تفريغ السلة">
                    <span class="material-icons-round">delete</span>
                </button>
            </div>
        </div>
        
        <div class="cart-body" id="cartBody">
            <div class="customer-select">
                <label>العميل *</label>
                <select id="customerSelect" required>
                    <option value="">اختر العميل</option>
                    <?php foreach ($customers as $customer): ?>
                    <option value="<?= $customer['id'] ?>"><?= $customer['full_name'] ?> - <?= $customer['phone'] ?></option>
                    <?php endforeach; ?>
                </select>
                <a href="<?= url('/customers/create?return_to=installment') ?>" class="btn-add-customer" onclick="saveCartBeforeAddCustomer()">+ إضافة عميل جديد</a>
            </div>
            
            <div class="cart-items" id="cartItems">
                <p class="empty-cart">السلة فارغة</p>
            </div>
        
        <div class="installment-config">
            <div class="form-group">
                <label>خطة التقسيط</label>
                <select id="planSelect" onchange="calculateInstallment()">
                    <?php foreach ($plans as $plan): ?>
                    <option value="<?= $plan['id'] ?>" 
                            data-months="<?= $plan['months'] ?>" 
                            data-increase="<?= $plan['increase_percent'] ?>"
                            data-min-down="<?= $plan['min_down_payment_percent'] ?>">
                        <?= $plan['name'] ?> (<?= $plan['months'] ?> شهر - زيادة <?= $plan['increase_percent'] ?>%)
                    </option>
                    <?php endforeach; ?>
                </select>
            </div>
            
            <div class="form-group">
                <label>الدفعة المقدمة</label>
                <input type="number" id="downPayment" step="0.01" value="0" onchange="calculateInstallment()">
                <small id="minDownPayment"></small>
            </div>
        </div>
        
        <div class="cart-summary installment-summary">
            <div class="total-items-badge">
                <span class="material-icons-round">shopping_basket</span>
                <span>إجمالي المنتجات:</span>
                <strong id="totalItemsCount">0</strong>
            </div>
            <div class="summary-row"><span>السعر النقدي:</span><strong id="cashPrice">0.00</strong></div>
            <div class="summary-row"><span>سعر التقسيط:</span><strong id="installmentPrice">0.00</strong></div>
            <div class="summary-row"><span>الزيادة:</span><strong id="increaseAmount" class="text-warning">0.00</strong></div>
            <div class="summary-row"><span>الدفعة المقدمة:</span><strong id="downPaymentDisplay">0.00</strong></div>
            <div class="summary-row"><span>المتبقي:</span><strong id="remainingAmount">0.00</strong></div>
            <div class="summary-row total"><span>القسط الشهري:</span><strong id="monthlyInstallment">0.00</strong></div>
            <div class="summary-row"><span>عدد الأقساط:</span><strong id="monthsCount">0</strong> شهر</div>
        </div>
        
        <div class="cart-actions">
            <button class="btn btn-success btn-block" onclick="completeInstallmentSale()">
                <span class="material-icons-round">check_circle</span>
                إنشاء عقد التقسيط
            </button>
        </div>
        </div><!-- end cart-body -->
    </div>
</div>

<style>
.pos-container { display: grid; grid-template-columns: 1fr 420px; gap: 25px; height: calc(100vh - var(--header-height) - 60px); }
.pos-products { background: var(--bg-card); border-radius: var(--radius); overflow: hidden; display: flex; flex-direction: column; }
.pos-header { padding: 20px; border-bottom: 1px solid var(--border-color); }
.search-wrapper { display: flex; align-items: center; background: var(--bg-main); border-radius: 12px; padding: 0 15px; margin-bottom: 15px; }
.search-wrapper input { flex: 1; padding: 12px; border: none; background: transparent; font-family: inherit; font-size: 15px; color: var(--text-primary); }
.search-wrapper input:focus { outline: none; }
.category-filter { display: flex; gap: 8px; flex-wrap: wrap; }
.cat-btn { padding: 8px 16px; border: none; background: var(--bg-main); border-radius: 20px; font-family: inherit; font-size: 13px; cursor: pointer; }
.cat-btn:hover, .cat-btn.active { background: var(--primary); color: white; }
.products-grid { flex: 1; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; overflow-y: auto; align-content: start; }
.product-card { background: var(--bg-main); border-radius: var(--radius); padding: 15px; cursor: pointer; text-align: center; transition: all 0.2s; position: relative; border: 2px solid transparent; }
.product-card:hover { transform: translateY(-3px); box-shadow: var(--shadow); }
.product-card.selected { border-color: var(--primary); background: linear-gradient(135deg, rgba(30, 136, 229, 0.08), rgba(30, 136, 229, 0.03)); box-shadow: 0 0 15px rgba(30, 136, 229, 0.3); }
/* شارة الكمية على كارت المنتج */
.product-qty-badge { position: absolute; top: -10px; right: -10px; min-width: 28px; height: 28px; padding: 0 8px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary), var(--primary-dark, #1565C0)); color: white; border-radius: 14px; font-size: 14px; font-weight: 700; box-shadow: 0 3px 10px rgba(30, 136, 229, 0.4); z-index: 10; animation: badge-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes badge-pop { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
.product-image { width: 70px; height: 70px; margin: 0 auto 10px; background: var(--bg-card); border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.product-image img { max-width: 100%; max-height: 100%; object-fit: contain; }
.product-image .material-icons-round { font-size: 32px; color: var(--text-muted); }
.product-info h4 { font-size: 13px; margin-bottom: 5px; }
.product-price { color: var(--primary); font-weight: 700; font-size: 14px; }
.installment-cart { background: var(--bg-card); border-radius: var(--radius); display: flex; flex-direction: column; }
.cart-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
.cart-header h3 { display: flex; align-items: center; gap: 10px; font-size: 16px; margin: 0; }
.btn-clear { background: none; border: none; color: var(--danger); cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
.btn-clear:hover { background: rgba(229, 57, 53, 0.1); }
.customer-select { padding: 15px 20px; border-bottom: 1px solid var(--border-color); }
.customer-select label { display: block; margin-bottom: 8px; font-weight: 600; }
.customer-select select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit; }
.btn-add-customer { display: block; margin-top: 10px; font-size: 13px; color: var(--primary); }
.cart-items { flex: 1; padding: 15px; overflow-y: auto; min-height: 100px; }
.empty-cart { text-align: center; color: var(--text-muted); padding: 20px 0; }
.cart-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-main); border-radius: 8px; margin-bottom: 10px; }
.item-number { display: flex; align-items: center; justify-content: center; min-width: 26px; height: 26px; background: linear-gradient(135deg, var(--primary), var(--primary-dark, #1565C0)); color: white; border-radius: 50%; font-size: 12px; font-weight: 700; flex-shrink: 0; box-shadow: 0 2px 8px rgba(30, 136, 229, 0.3); }
.cart-item-info { flex: 1; }
.cart-item-info h5 { font-size: 13px; margin-bottom: 3px; }
.cart-item-info small { color: var(--text-muted); }
.cart-item-qty { display: flex; align-items: center; gap: 5px; }
.cart-item-qty button { width: 28px; height: 28px; border: none; background: var(--bg-card); border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; }
.cart-item-qty button:hover { background: var(--primary); color: white; }
.cart-item-qty span { width: 30px; text-align: center; font-weight: 600; }
.cart-item-remove { background: none; border: none; color: var(--danger); cursor: pointer; }
.total-items-badge { display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
.total-items-badge .material-icons-round { font-size: 22px; opacity: 0.9; }
.total-items-badge span { font-size: 13px; }
.total-items-badge strong { margin-right: auto; font-size: 18px; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 16px; min-width: 36px; text-align: center; }
.installment-config { padding: 15px 20px; border-top: 1px solid var(--border-color); background: var(--bg-main); }
.installment-config .form-group { margin-bottom: 15px; }
.installment-config .form-group:last-child { margin-bottom: 0; }
.installment-config label { display: block; margin-bottom: 5px; font-size: 13px; }
.installment-config select, .installment-config input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit; }
.installment-config small { display: block; margin-top: 5px; color: var(--text-muted); font-size: 11px; }
.installment-summary { padding: 15px 20px; border-top: 1px solid var(--border-color); }
.summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
.summary-row.total { font-size: 18px; padding-top: 10px; border-top: 2px solid var(--border-color); margin-top: 10px; color: var(--primary); }
.cart-actions { padding: 20px; }

/* Pagination Controls */
.pagination-controls { display: flex; align-items: center; justify-content: center; gap: 15px; padding: 15px; background: var(--bg-card); border-radius: var(--radius); margin-top: 15px; box-shadow: var(--shadow); }
.pagination-btn { display: flex; align-items: center; gap: 5px; padding: 10px 20px; border: none; background: var(--bg-main); border-radius: var(--radius-sm); font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; color: var(--text-primary); }
.pagination-btn:hover:not(:disabled) { background: var(--primary); color: white; }
.pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.pagination-info { display: flex; align-items: center; gap: 5px; font-size: 14px; font-weight: 600; color: var(--text-secondary); padding: 10px 20px; background: var(--bg-main); border-radius: var(--radius-sm); }
.pagination-info #currentPage { color: var(--primary); font-weight: 700; }
.product-card.hidden { display: none !important; }

/* ═══════════════════════════════════════════════════════════════
   Pull-up Cart Styles - للموبايل فقط
   ═══════════════════════════════════════════════════════════════ */

/* Handle للسحب - مخفي على الديسكتوب */
.cart-handle { display: none; }

/* عناصر الهيدر - تنسيق الديسكتوب */
.cart-title { display: flex; align-items: center; gap: 10px; }
.cart-title h3 { margin: 0; }
.cart-header-actions { display: flex; align-items: center; gap: 8px; }

/* عناصر مخفية على الديسكتوب */
.cart-count, .cart-mini-total, .btn-expand { display: none; }

/* Cart Body wrapper */
.cart-body { display: contents; }

@media (max-width: 768px) {
    /* السلة القابلة للسحب */
    .installment-cart {
        position: fixed !important;
        bottom: 0;
        left: 0;
        right: 0;
        border-radius: 24px 24px 0 0 !important;
        box-shadow: 0 -8px 40px rgba(0, 0, 0, 0.2);
        z-index: 100;
        background: var(--bg-card);
        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        max-height: 70px;
        overflow: hidden;
    }
    
    .installment-cart.expanded {
        max-height: 90vh;
        overflow: visible;
    }
    
    /* Handle للسحب */
    .cart-handle {
        display: flex;
        justify-content: center;
        padding: 12px 0 4px;
        cursor: grab;
        touch-action: none;
    }
    
    .handle-bar {
        width: 48px;
        height: 5px;
        background: linear-gradient(90deg, var(--primary-light), var(--primary));
        border-radius: 10px;
        transition: all 0.3s;
    }
    
    .installment-cart.expanded .handle-bar {
        background: var(--text-muted);
        width: 36px;
    }
    
    /* هيدر السلة المحسن */
    .installment-cart .cart-header {
        padding: 8px 16px 12px !important;
        border-bottom: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .cart-title, .cart-header-actions {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .installment-cart .cart-header h3 {
        font-size: 14px !important;
        margin: 0;
    }
    
    /* عداد المنتجات */
    .cart-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 24px;
        height: 24px;
        padding: 0 8px;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark, #1565C0));
        color: white;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 700;
        animation: pulse-badge 2s infinite;
    }
    
    @keyframes pulse-badge {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.08); }
    }
    
    /* الإجمالي المصغر */
    .cart-mini-total {
        display: inline-block;
        font-size: 13px;
        font-weight: 700;
        color: var(--success);
        background: rgba(76, 175, 80, 0.1);
        padding: 4px 10px;
        border-radius: 8px;
    }
    
    /* زر التوسيع */
    .btn-expand {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 34px;
        height: 34px;
        border: none;
        background: var(--bg-main);
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-expand .material-icons-round {
        transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        color: var(--primary);
        font-size: 20px;
    }
    
    .installment-cart.expanded .btn-expand .material-icons-round {
        transform: rotate(180deg);
    }
    
    /* Cart Body */
    .cart-body {
        display: block;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .installment-cart.expanded .cart-body {
        max-height: calc(90vh - 70px);
        overflow-y: auto;
    }
    
    /* عناصر السلة */
    .installment-cart .cart-items {
        padding: 10px 16px !important;
        max-height: 20vh;
        overflow-y: auto;
        border-top: 1px solid var(--border-color);
    }
    
    /* اختيار العميل */
    .customer-select {
        padding: 10px 16px !important;
    }
    
    /* إعدادات التقسيط */
    .installment-config {
        padding: 10px 16px !important;
    }
    
    /* الملخص */
    .installment-summary {
        padding: 10px 16px !important;
    }
    
    .installment-summary .summary-row {
        font-size: 12px !important;
        margin-bottom: 5px !important;
    }
    
    .installment-summary .summary-row.total {
        font-size: 15px !important;
    }
    
    /* أزرار السلة */
    .installment-cart .cart-actions {
        padding: 12px 16px 20px !important;
    }
    
    .installment-cart .cart-actions .btn {
        padding: 14px !important;
        font-size: 15px !important;
        font-weight: 600;
        border-radius: 12px !important;
        background: linear-gradient(135deg, #4CAF50, #43A047);
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }
    
    /* إضافة padding للمنتجات */
    .pos-container {
        padding-bottom: 90px !important;
    }
}

/* الشاشات الصغيرة جداً */
@media (max-width: 480px) {
    .installment-cart {
        max-height: 65px;
    }
    
    .installment-cart .cart-header h3 {
        font-size: 12px !important;
    }
    
    .cart-mini-total {
        font-size: 11px;
        padding: 3px 6px;
    }
    
    .cart-count {
        min-width: 20px;
        height: 20px;
        font-size: 11px;
    }
    
    .installment-cart .cart-items {
        max-height: 15vh;
    }
}
</style>

<script>
let cart = [];
const currency = '<?= $settings['currency'] ?? 'ج.م' ?>';

// ═══════════════════════════════════════════════════════════════
// إعدادات الـ Pagination المتجاوبة
// ═══════════════════════════════════════════════════════════════
// عدد المنتجات حسب حجم الشاشة: موبايل = 8، سطح المكتب = 18
function getProductsPerPage() {
    return window.innerWidth <= 768 ? 8 : 18;
}

let PRODUCTS_PER_PAGE = getProductsPerPage();
let currentPage = 1;
let filteredProducts = [];
let currentCategory = 'all';

// تحديث عند تغيير حجم الشاشة
window.addEventListener('resize', function() {
    const newPerPage = getProductsPerPage();
    if (newPerPage !== PRODUCTS_PER_PAGE) {
        PRODUCTS_PER_PAGE = newPerPage;
        showPage(1);
    }
});

function initPagination() {
    const allProducts = document.querySelectorAll('.product-card');
    filteredProducts = Array.from(allProducts);
    showPage(1);
}

function showPage(page) {
    const start = (page - 1) * PRODUCTS_PER_PAGE;
    const end = start + PRODUCTS_PER_PAGE;
    
    filteredProducts.forEach((product, index) => {
        if (index >= start && index < end) {
            product.classList.remove('hidden');
        } else {
            product.classList.add('hidden');
        }
    });
    
    currentPage = page;
    updatePaginationControls();
}

function changePage(direction) {
    const totalPages = Math.ceil(filteredProducts.length / PRODUCTS_PER_PAGE);
    const newPage = currentPage + direction;
    
    if (newPage >= 1 && newPage <= totalPages) {
        showPage(newPage);
    }
}

function updatePaginationControls() {
    const totalPages = Math.max(1, Math.ceil(filteredProducts.length / PRODUCTS_PER_PAGE));
    
    // تحديث أرقام الصفحات في كل الأماكن
    document.querySelectorAll('.currentPageNum').forEach(el => el.textContent = currentPage);
    document.querySelectorAll('.totalPagesNum').forEach(el => el.textContent = totalPages);
    
    // تفعيل/تعطيل أزرار السابق
    document.getElementById('prevPageTop').disabled = currentPage <= 1;
    document.getElementById('prevPageBottom').disabled = currentPage <= 1;
    
    // تفعيل/تعطيل أزرار التالي
    document.getElementById('nextPageTop').disabled = currentPage >= totalPages;
    document.getElementById('nextPageBottom').disabled = currentPage >= totalPages;
    
    // إخفاء التحكمات إذا كان هناك صفحة واحدة أو أقل
    const hideControls = filteredProducts.length <= PRODUCTS_PER_PAGE;
    document.getElementById('paginationControlsTop').style.display = hideControls ? 'none' : 'flex';
    document.getElementById('paginationControlsBottom').style.display = hideControls ? 'none' : 'flex';
}

function filterProducts(category, searchTerm = '') {
    const allProducts = document.querySelectorAll('.product-card');
    filteredProducts = [];
    
    allProducts.forEach(product => {
        const productCategory = product.dataset.category;
        const productName = product.dataset.name.toLowerCase();
        
        const matchesCategory = category === 'all' || productCategory === category;
        const matchesSearch = searchTerm === '' || productName.includes(searchTerm.toLowerCase());
        
        if (matchesCategory && matchesSearch) {
            filteredProducts.push(product);
            product.style.display = '';
        } else {
            product.classList.add('hidden');
            product.style.display = 'none';
        }
    });
    
    showPage(1);
}

// Category filter
document.querySelectorAll('.cat-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentCategory = this.dataset.category;
        const searchTerm = document.getElementById('productSearch')?.value || '';
        filterProducts(currentCategory, searchTerm);
    });
});

// Search filter
const searchInput = document.getElementById('productSearch');
if (searchInput) {
    searchInput.addEventListener('input', function() {
        filterProducts(currentCategory, this.value);
    });
}

document.addEventListener('DOMContentLoaded', initPagination);

document.querySelectorAll('.product-card').forEach(card => {
    card.addEventListener('click', function() {
        const id = this.dataset.id;
        const name = this.dataset.name;
        const price = parseFloat(this.dataset.price);
        
        const existing = cart.find(item => item.id === id);
        if (existing) { existing.quantity++; } 
        else { cart.push({ id, name, price, quantity: 1 }); }
        
        renderCart();
    });
});

function renderCart() {
    const container = document.getElementById('cartItems');
    if (cart.length === 0) {
        container.innerHTML = '<p class="empty-cart">السلة فارغة</p>';
        calculateInstallment();
        updateProductCardSelection();
        return;
    }
    
    container.innerHTML = cart.map((item, index) => `
        <div class="cart-item">
            <span class="item-number">${index + 1}</span>
            <div class="cart-item-info">
                <h5>${item.name}</h5>
                <small>${item.price.toFixed(2)} ${currency}</small>
            </div>
            <div class="cart-item-qty">
                <button onclick="event.stopPropagation(); changeQty(${index}, -1)">-</button>
                <span>${item.quantity}</span>
                <button onclick="event.stopPropagation(); changeQty(${index}, 1)">+</button>
            </div>
            <button class="cart-item-remove" onclick="event.stopPropagation(); removeItem(${index})">
                <span class="material-icons-round">close</span>
            </button>
        </div>
    `).join('');
    
    calculateInstallment();
    updateProductCardSelection();
}

// تحديث حالة تحديد كروت المنتجات وإظهار الكمية
function updateProductCardSelection() {
    // إزالة التحديد من كل الكروت أولاً
    document.querySelectorAll('.product-card').forEach(card => {
        card.classList.remove('selected');
        const badge = card.querySelector('.product-qty-badge');
        if (badge) {
            badge.style.display = 'none';
            badge.textContent = '0';
        }
    });
    
    // إضافة التحديد للمنتجات الموجودة في السلة
    cart.forEach(item => {
        const card = document.querySelector(`.product-card[data-id="${item.id}"]`);
        if (card) {
            card.classList.add('selected');
            const badge = card.querySelector('.product-qty-badge');
            if (badge) {
                badge.style.display = 'flex';
                badge.textContent = item.quantity;
            }
        }
    });
}

// تغيير الكمية
function changeQty(index, change) {
    const item = cart[index];
    const newQty = item.quantity + change;
    
    if (newQty <= 0) {
        removeItem(index);
    } else {
        item.quantity = newQty;
        renderCart();
    }
}

function removeItem(index) { cart.splice(index, 1); renderCart(); }

// تفريغ السلة
function clearCart() {
    if (cart.length === 0) return;
    // استخدام window.confirm للتوافق مع جميع المتصفحات
    var confirmed = window.confirm('هل تريد تفريغ السلة؟');
    if (confirmed) {
        cart = [];
        localStorage.removeItem('posCartItems');
        renderCart();
    }
}

// تحميل السلة والعميل من نقطة البيع (إذا كانت موجودة)
function loadCartFromStorage() {
    // تحميل السلة
    const savedCart = localStorage.getItem('posCartItems');
    if (savedCart) {
        try {
            const items = JSON.parse(savedCart);
            if (Array.isArray(items) && items.length > 0) {
                cart = items;
                localStorage.removeItem('posCartItems');
                renderCart();
            }
        } catch (e) {
            console.error('Error loading cart from storage:', e);
        }
    }
    
    // تحميل العميل المختار
    const savedCustomer = localStorage.getItem('posSelectedCustomer');
    if (savedCustomer) {
        const customerSelect = document.getElementById('customerSelect');
        if (customerSelect) {
            // البحث عن العميل في القائمة
            for (let i = 0; i < customerSelect.options.length; i++) {
                if (customerSelect.options[i].value === savedCustomer) {
                    customerSelect.selectedIndex = i;
                    break;
                }
            }
        }
        localStorage.removeItem('posSelectedCustomer');
    }
}

// تحميل السلة والعميل عند بدء الصفحة
loadCartFromStorage();

function calculateInstallment() {
    const cashTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const plan = document.getElementById('planSelect');
    const selected = plan.options[plan.selectedIndex];
    
    const months = parseInt(selected.dataset.months) || 0;
    const increase = parseFloat(selected.dataset.increase) || 0;
    const minDownPercent = parseFloat(selected.dataset.minDown) || 0;
    
    const installmentTotal = cashTotal * (1 + increase / 100);
    const minDown = installmentTotal * (minDownPercent / 100);
    
    let downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
    if (downPayment < minDown) downPayment = minDown;
    
    const remaining = installmentTotal - downPayment;
    const monthly = months > 0 ? remaining / months : 0;
    
    document.getElementById('minDownPayment').textContent = 'الحد الأدنى: ' + minDown.toFixed(2) + ' ' + currency;
    document.getElementById('cashPrice').textContent = cashTotal.toFixed(2) + ' ' + currency;
    document.getElementById('installmentPrice').textContent = installmentTotal.toFixed(2) + ' ' + currency;
    document.getElementById('increaseAmount').textContent = (installmentTotal - cashTotal).toFixed(2) + ' ' + currency;
    document.getElementById('downPaymentDisplay').textContent = downPayment.toFixed(2) + ' ' + currency;
    document.getElementById('remainingAmount').textContent = remaining.toFixed(2) + ' ' + currency;
    document.getElementById('monthlyInstallment').textContent = monthly.toFixed(2) + ' ' + currency;
    document.getElementById('monthsCount').textContent = months;
}

async function completeInstallmentSale() {
    if (cart.length === 0) { alert('السلة فارغة'); return; }
    if (!document.getElementById('customerSelect').value) { alert('يجب اختيار العميل'); return; }
    
    const formData = new FormData();
    formData.append('items', JSON.stringify(cart.map(i => ({ id: i.id, quantity: i.quantity, price: i.price }))));
    formData.append('customer_id', document.getElementById('customerSelect').value);
    formData.append('plan_id', document.getElementById('planSelect').value);
    formData.append('down_payment', document.getElementById('downPayment').value);
    
    const response = await fetch('<?= url('/pos/installment') ?>', { method: 'POST', body: formData });
    if (response.redirected) window.location.href = response.url;
}

document.querySelectorAll('.cat-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const category = this.dataset.category;
        document.querySelectorAll('.product-card').forEach(card => {
            card.style.display = (category === 'all' || card.dataset.category === category) ? '' : 'none';
        });
    });
});

document.getElementById('productSearch').addEventListener('input', function() {
    const query = this.value.toLowerCase();
    document.querySelectorAll('.product-card').forEach(card => {
        card.style.display = card.dataset.name.toLowerCase().includes(query) ? '' : 'none';
    });
});

// ═══════════════════════════════════════════════════════════════
// تحديث عداد السلة والإجمالي المصغر
// ═══════════════════════════════════════════════════════════════

function updateCartBadge() {
    // عدد المنتجات المختلفة (وليس مجموع الكميات)
    const uniqueProductsCount = cart.length;
    const cartCountEl = document.getElementById('cartCount');
    const cartMiniTotalEl = document.getElementById('cartMiniTotal');
    const totalItemsCountEl = document.getElementById('totalItemsCount');
    
    // حساب الإجمالي
    const cashTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const plan = document.getElementById('planSelect');
    const selected = plan.options[plan.selectedIndex];
    const increase = parseFloat(selected.dataset.increase) || 0;
    const installmentTotal = cashTotal * (1 + increase / 100);
    
    if (cartCountEl) {
        cartCountEl.textContent = uniqueProductsCount;
        cartCountEl.style.display = uniqueProductsCount > 0 ? 'inline-flex' : 'none';
    }
    
    if (cartMiniTotalEl) {
        cartMiniTotalEl.textContent = installmentTotal.toFixed(2) + ' ' + currency;
    }
    
    // تحديث شارة إجمالي المنتجات في الملخص (عدد المنتجات المختلفة)
    if (totalItemsCountEl) {
        totalItemsCountEl.textContent = uniqueProductsCount;
    }
}

// استدعاء تحديث العداد عند كل تغيير
const originalRenderCart = renderCart;
renderCart = function() {
    originalRenderCart();
    updateCartBadge();
};

// ═══════════════════════════════════════════════════════════════
// Pull-up Cart Functions - وظائف السلة القابلة للسحب
// ═══════════════════════════════════════════════════════════════

let isCartExpanded = false;
let isDragging = false;
let startY = 0;
let currentY = 0;

// تبديل السلة (توسيع/تصغير)
function toggleCart() {
    const posCart = document.getElementById('posCart');
    if (!posCart) return;
    
    isCartExpanded = !isCartExpanded;
    posCart.classList.toggle('expanded', isCartExpanded);
    
    if (navigator.vibrate) {
        navigator.vibrate(10);
    }
}

// إغلاق السلة
function collapseCart() {
    const posCart = document.getElementById('posCart');
    if (!posCart) return;
    
    isCartExpanded = false;
    posCart.classList.remove('expanded');
}

// فتح السلة
function expandCart() {
    const posCart = document.getElementById('posCart');
    if (!posCart) return;
    
    isCartExpanded = true;
    posCart.classList.add('expanded');
}

// تهيئة السحب باللمس
function initDragGesture() {
    const cartHandle = document.getElementById('cartHandle');
    const cartHeader = document.getElementById('cartHeader');
    const posCart = document.getElementById('posCart');
    
    if (!cartHandle || !posCart) return;
    
    // أحداث اللمس للـ Handle
    cartHandle.addEventListener('touchstart', handleDragStart, { passive: true });
    cartHandle.addEventListener('touchmove', handleDragMove, { passive: false });
    cartHandle.addEventListener('touchend', handleDragEnd);
    
    // أحداث الماوس للـ Handle
    cartHandle.addEventListener('mousedown', handleDragStart);
    document.addEventListener('mousemove', handleDragMove);
    document.addEventListener('mouseup', handleDragEnd);
    
    // النقر على الهيدر
    cartHeader.addEventListener('click', function(e) {
        if (e.target.closest('button') || e.target.closest('select')) return;
        toggleCart();
    });
}

function handleDragStart(e) {
    isDragging = true;
    startY = e.touches ? e.touches[0].clientY : e.clientY;
    currentY = startY;
    
    const posCart = document.getElementById('posCart');
    posCart.style.transition = 'none';
}

function handleDragMove(e) {
    if (!isDragging) return;
    
    currentY = e.touches ? e.touches[0].clientY : e.clientY;
    
    if (e.cancelable) {
        e.preventDefault();
    }
}

function handleDragEnd() {
    if (!isDragging) return;
    
    isDragging = false;
    const deltaY = startY - currentY;
    const posCart = document.getElementById('posCart');
    
    posCart.style.transition = '';
    
    if (Math.abs(deltaY) > 50) {
        if (deltaY > 0) {
            expandCart();
        } else {
            collapseCart();
        }
    }
}

// تهيئة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    initDragGesture();
    updateCartBadge();
    
    // استعادة السلة من localStorage إذا كانت موجودة
    const savedCart = localStorage.getItem('posCartItems');
    if (savedCart) {
        try {
            const items = JSON.parse(savedCart);
            if (Array.isArray(items) && items.length > 0) {
                cart = items;
                renderCart();
            }
        } catch (e) {
            console.error('Error restoring cart:', e);
        }
        localStorage.removeItem('posCartItems');
    }
    
    // اختيار العميل الجديد إذا كنا عائدين من صفحة إضافة عميل
    const urlParams = new URLSearchParams(window.location.search);
    const newCustomerId = urlParams.get('new_customer_id');
    if (newCustomerId) {
        const customerSelect = document.getElementById('customerSelect');
        if (customerSelect) {
            // البحث عن العميل بالـ ID في القائمة
            for (let i = 0; i < customerSelect.options.length; i++) {
                if (customerSelect.options[i].value === newCustomerId) {
                    customerSelect.selectedIndex = i;
                    break;
                }
            }
        }
        // إزالة الـ parameter من URL بدون إعادة تحميل الصفحة
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
    }
    // دعم الطريقة القديمة (localStorage) للتوافق
    else if (localStorage.getItem('selectNewestCustomer') === 'installment') {
        localStorage.removeItem('selectNewestCustomer');
        const customerSelect = document.getElementById('customerSelect');
        if (customerSelect && customerSelect.options.length > 1) {
            customerSelect.selectedIndex = customerSelect.options.length - 1;
        }
    }
    
    document.addEventListener('click', function(e) {
        if (window.innerWidth > 768) return;
        
        const posCart = document.getElementById('posCart');
        if (!posCart) return;
        
        if (isCartExpanded && !posCart.contains(e.target)) {
            collapseCart();
        }
    });
});

// حفظ السلة قبل الانتقال لإضافة عميل جديد
function saveCartBeforeAddCustomer() {
    if (cart.length > 0) {
        localStorage.setItem('posCartItems', JSON.stringify(cart));
    }
    localStorage.setItem('selectNewestCustomer', 'installment');
}

calculateInstallment();
</script>


============================================================
FILE: app/Views/products/create.php
============================================================
<div class="page-header">
    <h2><span class="material-icons-round">add_box</span> إضافة منتج جديد</h2>
    <a href="<?= url('/products') ?>" class="btn btn-secondary">
        <span class="material-icons-round">arrow_forward</span> رجوع
    </a>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST" action="<?= url('/products') ?>" enctype="multipart/form-data">
            <div class="form-grid">
                <div class="form-group">
                    <label>اسم المنتج *</label>
                    <input type="text" name="name" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>التصنيف</label>
                    <select name="category_id" class="form-control">
                        <option value="">اختر التصنيف</option>
                        <?php foreach ($categories as $cat): ?>
                        <option value="<?= $cat['id'] ?>"><?= $cat['name'] ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>الباركود</label>
                    <input type="text" name="barcode" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>رقم الصنف (SKU)</label>
                    <input type="text" name="sku" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>السعر النقدي *</label>
                    <input type="number" name="cash_price" class="form-control" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label>سعر التقسيط</label>
                    <input type="number" name="installment_price" class="form-control" step="0.01" placeholder="سيتم حسابه تلقائياً">
                </div>
                
                <div class="form-group">
                    <label>سعر التكلفة</label>
                    <input type="number" name="cost_price" class="form-control" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>الكمية</label>
                    <input type="number" name="quantity" class="form-control" value="0">
                </div>
                
                <div class="form-group">
                    <label>الحد الأدنى للتنبيه</label>
                    <input type="number" name="min_quantity" class="form-control" value="5">
                </div>
                
                <div class="form-group">
                    <label>الماركة</label>
                    <input type="text" name="brand" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>الموديل</label>
                    <input type="text" name="model" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>مدة الضمان (شهر)</label>
                    <input type="number" name="warranty_months" class="form-control" value="0">
                </div>
            </div>
            
            <div class="form-group">
                <label>الوصف</label>
                <textarea name="description" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label>صورة المنتج</label>
                <input type="file" name="image" class="form-control" accept="image/*">
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="is_active" value="1" checked>
                    منتج نشط
                </label>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <span class="material-icons-round">save</span> حفظ المنتج
                </button>
                <a href="<?= url('/products') ?>" class="btn btn-secondary">إلغاء</a>
            </div>
        </form>
    </div>
</div>

<style>
.form-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
}
.form-actions {
    display: flex;
    gap: 15px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
}
.checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}
.checkbox-label input {
    width: 18px;
    height: 18px;
}
@media (max-width: 768px) {
    .form-grid { grid-template-columns: 1fr; }
}
</style>


============================================================
FILE: app/Views/products/edit.php
============================================================
<?php $return = $_GET['return'] ?? ''; ?>
<div class="page-header">
    <h2><span class="material-icons-round">edit</span> تعديل: <?= $product['name'] ?></h2>
    <a href="<?= $return === 'inventory' ? url('/reports/inventory') : url('/products') ?>" class="btn btn-secondary">
        <span class="material-icons-round">arrow_forward</span> رجوع
    </a>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST" action="<?= url('/products/' . $product['id']) ?>" enctype="multipart/form-data">
            <?php if ($return): ?>
            <input type="hidden" name="return" value="<?= htmlspecialchars($return) ?>">
            <?php endif; ?>
            <div class="form-grid">
                <div class="form-group">
                    <label>اسم المنتج *</label>
                    <input type="text" name="name" class="form-control" value="<?= $product['name'] ?>" required>
                </div>
                
                <div class="form-group">
                    <label>التصنيف</label>
                    <select name="category_id" class="form-control">
                        <option value="">اختر التصنيف</option>
                        <?php foreach ($categories as $cat): ?>
                        <option value="<?= $cat['id'] ?>" <?= $cat['id'] == $product['category_id'] ? 'selected' : '' ?>><?= $cat['name'] ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>الباركود</label>
                    <input type="text" name="barcode" class="form-control" value="<?= $product['barcode'] ?>">
                </div>
                
                <div class="form-group">
                    <label>رقم الصنف (SKU)</label>
                    <input type="text" name="sku" class="form-control" value="<?= $product['sku'] ?>">
                </div>
                
                <div class="form-group">
                    <label>السعر النقدي *</label>
                    <input type="number" name="cash_price" class="form-control" step="0.01" value="<?= $product['cash_price'] ?>" required>
                </div>
                
                <div class="form-group">
                    <label>سعر التقسيط</label>
                    <input type="number" name="installment_price" class="form-control" step="0.01" value="<?= $product['installment_price'] ?>">
                </div>
                
                <div class="form-group">
                    <label>سعر التكلفة</label>
                    <input type="number" name="cost_price" class="form-control" step="0.01" value="<?= $product['cost_price'] ?>">
                </div>
                
                <div class="form-group">
                    <label>الكمية</label>
                    <input type="number" name="quantity" class="form-control" value="<?= $product['quantity'] ?>">
                </div>
                
                <div class="form-group">
                    <label>الحد الأدنى للتنبيه</label>
                    <input type="number" name="min_quantity" class="form-control" value="<?= $product['min_quantity'] ?>">
                </div>
                
                <div class="form-group">
                    <label>الماركة</label>
                    <input type="text" name="brand" class="form-control" value="<?= $product['brand'] ?>">
                </div>
                
                <div class="form-group">
                    <label>الموديل</label>
                    <input type="text" name="model" class="form-control" value="<?= $product['model'] ?>">
                </div>
                
                <div class="form-group">
                    <label>مدة الضمان (شهر)</label>
                    <input type="number" name="warranty_months" class="form-control" value="<?= $product['warranty_months'] ?>">
                </div>
            </div>
            
            <div class="form-group">
                <label>الوصف</label>
                <textarea name="description" class="form-control" rows="3"><?= $product['description'] ?></textarea>
            </div>
            
            <div class="form-group">
                <label>صورة المنتج</label>
                <?php if ($product['image']): ?>
                <div class="current-image">
                    <img src="<?= upload('products/' . $product['image']) ?>" alt="" style="max-height:100px;border-radius:8px">
                </div>
                <?php endif; ?>
                <input type="file" name="image" class="form-control" accept="image/*">
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="is_active" value="1" <?= $product['is_active'] ? 'checked' : '' ?>>
                    منتج نشط
                </label>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <span class="material-icons-round">save</span> حفظ التعديلات
                </button>
                <a href="<?= $return === 'inventory' ? url('/reports/inventory') : url('/products') ?>" class="btn btn-secondary">إلغاء</a>
            </div>
        </form>
    </div>
</div>

<style>
.form-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
}
.form-actions {
    display: flex;
    gap: 15px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
}
.current-image {
    margin-bottom: 10px;
}
@media (max-width: 768px) {
    .form-grid { grid-template-columns: 1fr; }
}
</style>


============================================================
FILE: app/Views/products/index.php
============================================================
<?php $exportUrl = url('/export/products'); ?>
<div class="page-header">
    <h2><span class="material-icons-round">inventory_2</span> إدارة المنتجات</h2>
    <div class="header-actions">
        <?php include dirname(__DIR__) . '/partials/export_buttons.php'; ?>
        <a href="<?= url('/products/create') ?>" class="btn btn-primary">
            <span class="material-icons-round">add</span> إضافة منتج
        </a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <form method="GET" class="filters">
            <select name="category" class="form-control" style="width:200px" onchange="this.form.submit()">
                <option value="">كل التصنيفات</option>
                <?php foreach ($categories as $cat): ?>
                <option value="<?= $cat['id'] ?>" <?= $categoryId == $cat['id'] ? 'selected' : '' ?>><?= $cat['name'] ?></option>
                <?php endforeach; ?>
            </select>
            <input type="text" name="q" class="form-control" style="width:250px" placeholder="بحث..." value="<?= htmlspecialchars($search) ?>">
            <button type="submit" class="btn btn-primary"><span class="material-icons-round">search</span></button>
            <?php if ($search || $categoryId): ?>
            <a href="<?= url('/products') ?>" class="btn btn-secondary"><span class="material-icons-round">clear</span></a>
            <?php endif; ?>
        </form>
    </div>
    <div class="card-body">
        <?php $selectionType = 'products'; $allowDelete = true; include dirname(__DIR__) . '/partials/table_selection.php'; ?>
        
        <div class="table-responsive">
            <table class="table" id="productsTable">
                <thead>
                    <tr>
                        <th class="select-checkbox"><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>
                        <th>#</th>
                        <th>الصورة</th>
                        <th>اسم المنتج</th>
                        <th>التصنيف</th>
                        <th>السعر نقدي</th>
                        <th>السعر تقسيط</th>
                        <th>الكمية</th>
                        <th>الحالة</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($products as $product): ?>
                    <tr>
                        <td class="select-checkbox"><input type="checkbox" class="row-checkbox" data-id="<?= $product['id'] ?>" onclick="toggleRowSelect(this)"></td>
                        <td><?= $product['id'] ?></td>
                        <td>
                            <div class="product-thumb">
                                <?php if ($product['image']): ?>
                                    <img src="<?= upload('products/' . $product['image']) ?>" alt="">
                                <?php else: ?>
                                    <span class="material-icons-round">inventory_2</span>
                                <?php endif; ?>
                            </div>
                        </td>
                        <td>
                            <strong><?= $product['name'] ?></strong>
                            <?php if ($product['barcode']): ?>
                            <br><small class="text-muted"><?= $product['barcode'] ?></small>
                            <?php endif; ?>
                        </td>
                        <td><?= $product['category_name'] ?? '-' ?></td>
                        <td><?= formatMoney($product['cash_price']) ?></td>
                        <td><?= formatMoney($product['installment_price']) ?></td>
                        <td>
                            <span class="<?= $product['quantity'] <= $product['min_quantity'] ? 'text-danger' : '' ?>">
                                <?= $product['quantity'] ?>
                            </span>
                        </td>
                        <td>
                            <span class="badge badge-<?= $product['is_active'] ? 'success' : 'secondary' ?>">
                                <?= $product['is_active'] ? 'نشط' : 'معطل' ?>
                            </span>
                        </td>
                        <td>
                            <div class="actions">
                                <a href="<?= url('/products/' . $product['id']) ?>" class="btn btn-sm btn-secondary" title="عرض">
                                    <span class="material-icons-round">visibility</span>
                                </a>
                                <a href="<?= url('/products/' . $product['id'] . '/edit') ?>" class="btn btn-sm btn-primary" title="تعديل">
                                    <span class="material-icons-round">edit</span>
                                </a>
                                <form method="POST" action="<?= url('/products/' . $product['id'] . '/delete') ?>" style="display:inline" onsubmit="return confirm('هل أنت متأكد من الحذف؟')">
                                    <button type="submit" class="btn btn-sm btn-danger" title="حذف">
                                        <span class="material-icons-round">delete</span>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
        
        <?php include dirname(__DIR__) . '/partials/pagination.php'; ?>
    </div>
</div>

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
}
.page-header h2 {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 22px;
}
.filters {
    display: flex;
    gap: 15px;
}
.product-thumb {
    width: 50px;
    height: 50px;
    background: var(--bg-main);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}
.product-thumb img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}
.product-thumb .material-icons-round {
    color: var(--text-muted);
}
.actions {
    display: flex;
    gap: 5px;
}
.actions .btn {
    padding: 5px 8px;
}
.actions .material-icons-round {
    font-size: 18px;
}
</style>

<script>
function filterProducts() {
    const category = document.getElementById('categoryFilter').value;
    const search = document.getElementById('searchInput').value.toLowerCase();
    
    document.querySelectorAll('#productsTable tbody tr').forEach(row => {
        const matchCategory = !category || row.dataset.category === category;
        const text = row.textContent.toLowerCase();
        const matchSearch = !search || text.includes(search);
        
        row.style.display = matchCategory && matchSearch ? '' : 'none';
    });
}
</script>


============================================================
FILE: app/Views/products/show.php
============================================================
<div class="page-header">
    <h2><span class="material-icons-round">inventory_2</span> <?= $product['name'] ?></h2>
    <div class="header-actions">
        <a href="<?= url('/products/' . $product['id'] . '/edit') ?>" class="btn btn-primary"><span class="material-icons-round">edit</span> تعديل</a>
        <a href="<?= url('/products') ?>" class="btn btn-secondary"><span class="material-icons-round">arrow_forward</span> رجوع</a>
    </div>
</div>

<div class="product-details">
    <div class="product-image-large">
        <?php if ($product['image']): ?>
            <img src="<?= upload('products/' . $product['image']) ?>" alt="<?= $product['name'] ?>">
        <?php else: ?>
            <span class="material-icons-round">inventory_2</span>
        <?php endif; ?>
    </div>
    
    <div class="product-info-card card">
        <div class="card-body">
            <h3><?= $product['name'] ?></h3>
            <p class="category-badge"><span class="badge badge-primary"><?= $product['category_name'] ?? 'بدون تصنيف' ?></span></p>
            
            <div class="price-box">
                <div class="price cash-price">
                    <span>السعر النقدي</span>
                    <strong><?= formatMoney($product['cash_price']) ?></strong>
                </div>
                <div class="price installment-price">
                    <span>سعر التقسيط</span>
                    <strong><?= formatMoney($product['installment_price']) ?></strong>
                </div>
            </div>
            
            <div class="info-list">
                <div class="info-item"><span>الباركود:</span><strong><?= $product['barcode'] ?: '-' ?></strong></div>
                <div class="info-item"><span>رقم الصنف:</span><strong><?= $product['sku'] ?: '-' ?></strong></div>
                <div class="info-item"><span>الماركة:</span><strong><?= $product['brand'] ?: '-' ?></strong></div>
                <div class="info-item"><span>الموديل:</span><strong><?= $product['model'] ?: '-' ?></strong></div>
                <div class="info-item"><span>الضمان:</span><strong><?= $product['warranty_months'] ? $product['warranty_months'] . ' شهر' : 'بدون ضمان' ?></strong></div>
                <div class="info-item"><span>سعر التكلفة:</span><strong><?= formatMoney($product['cost_price']) ?></strong></div>
            </div>
            
            <div class="stock-info">
                <div class="stock-current <?= $product['quantity'] <= $product['min_quantity'] ? 'low' : '' ?>">
                    <span>الكمية المتاحة</span>
                    <strong><?= $product['quantity'] ?></strong>
                </div>
                <div class="stock-min">
                    <span>حد التنبيه</span>
                    <strong><?= $product['min_quantity'] ?></strong>
                </div>
            </div>
            
            <?php if ($product['description']): ?>
            <div class="description">
                <h4>الوصف</h4>
                <p><?= nl2br($product['description']) ?></p>
            </div>
            <?php endif; ?>
        </div>
    </div>
</div>

<style>
.product-details { display: grid; grid-template-columns: 400px 1fr; gap: 30px; }
.product-image-large { background: var(--bg-card); border-radius: var(--radius); padding: 30px; text-align: center; height: fit-content; }
.product-image-large img { max-width: 100%; max-height: 350px; object-fit: contain; }
.product-image-large .material-icons-round { font-size: 120px; color: var(--text-muted); }
.product-info-card h3 { font-size: 24px; margin-bottom: 10px; }
.category-badge { margin-bottom: 20px; }
.price-box { display: flex; gap: 20px; margin-bottom: 25px; }
.price { flex: 1; padding: 20px; border-radius: 12px; text-align: center; }
.cash-price { background: #e8f5e9; }
.cash-price strong { color: #2e7d32; }
.installment-price { background: #e3f2fd; }
.installment-price strong { color: #1565c0; }
.price span { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 5px; }
.price strong { font-size: 24px; }
.info-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px; }
.info-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
.info-item span { color: var(--text-muted); }
.stock-info { display: flex; gap: 20px; margin-bottom: 25px; }
.stock-current, .stock-min { flex: 1; padding: 15px; background: var(--bg-main); border-radius: 10px; text-align: center; }
.stock-current span, .stock-min span { display: block; font-size: 12px; color: var(--text-muted); }
.stock-current strong, .stock-min strong { font-size: 28px; }
.stock-current.low { background: #ffebee; }
.stock-current.low strong { color: var(--danger); }
.description h4 { margin-bottom: 10px; color: var(--text-muted); }
@media (max-width: 900px) { .product-details { grid-template-columns: 1fr; } }
</style>


============================================================
FILE: app/Views/settings/api.php
============================================================
<div class="page-header">
    <h2><span class="material-icons-round">api</span> إدارة مفاتيح API</h2>
    <button class="btn btn-primary" onclick="showAddModal()">
        <span class="material-icons-round">add</span> إنشاء مفتاح جديد
    </button>
</div>

<!-- معلومات عن API -->
<div class="card" style="margin-bottom: 25px;">
    <div class="card-header"><h3><span class="material-icons-round">info</span> معلومات استخدام API</h3></div>
    <div class="card-body">
        <div class="api-info">
            <?php 
            $scheme = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') ? 'https' : 'http';
            $host = $_SERVER['HTTP_HOST'] ?? 'localhost:8080';
            ?>
            <p><strong>رابط API:</strong> <code><?= $scheme . '://' . $host ?>/api/v2/</code></p>
            <p><strong>طريقة المصادقة:</strong> أضف المفتاح في Header الطلب:</p>
            <pre style="background: var(--bg-main); padding: 15px; border-radius: 8px; direction: ltr; text-align: left;">X-API-KEY: your_api_key_here</pre>
            
            <div style="margin-top: 20px;">
                <h4 style="margin-bottom: 10px;">نقاط النهاية المتاحة:</h4>
                <div class="endpoints-grid">
                    <div class="endpoint-group">
                        <h5>المنتجات</h5>
                        <code>GET /api/v2/products</code>
                        <code>POST /api/v2/products</code>
                        <code>PUT /api/v2/products/{id}</code>
                        <code>DELETE /api/v2/products/{id}</code>
                    </div>
                    <div class="endpoint-group">
                        <h5>التصنيفات</h5>
                        <code>GET /api/v2/categories</code>
                        <code>POST /api/v2/categories</code>
                        <code>PUT /api/v2/categories/{id}</code>
                        <code>DELETE /api/v2/categories/{id}</code>
                    </div>
                    <div class="endpoint-group">
                        <h5>العملاء</h5>
                        <code>GET /api/v2/customers</code>
                        <code>POST /api/v2/customers</code>
                        <code>PUT /api/v2/customers/{id}</code>
                        <code>DELETE /api/v2/customers/{id}</code>
                    </div>
                    <div class="endpoint-group">
                        <h5>الفواتير والأقساط</h5>
                        <code>GET /api/v2/invoices</code>
                        <code>GET /api/v2/installments</code>
                        <code>GET /api/v2/installments/today</code>
                        <code>POST /api/v2/installments/{id}/pay</code>
                    </div>
                    <div class="endpoint-group">
                        <h5>لوحة التحكم</h5>
                        <code>GET /api/v2/dashboard/stats</code>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- قائمة المفاتيح -->
<div class="card">
    <div class="card-header"><h3><span class="material-icons-round">vpn_key</span> مفاتيح API الحالية</h3></div>
    <div class="card-body">
        <?php if (empty($apiKeys)): ?>
            <div class="empty-state">
                <span class="material-icons-round" style="font-size: 64px; color: var(--text-muted);">key_off</span>
                <p>لا توجد مفاتيح API حالياً</p>
                <button class="btn btn-primary" onclick="showAddModal()">إنشاء مفتاح جديد</button>
            </div>
        <?php else: ?>
            <div class="table-responsive">
                <table class="table" id="apiKeysTable">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>المفتاح</th>
                            <th>الحالة</th>
                            <th>تاريخ الانتهاء</th>
                            <th>آخر استخدام</th>
                            <th>تاريخ الإنشاء</th>
                            <th>أنشأه</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($apiKeys as $key): ?>
                        <tr id="key-row-<?= $key['id'] ?>" data-key='<?= htmlspecialchars(json_encode($key), ENT_QUOTES) ?>'>
                            <td>
                                <span class="key-name"><?= htmlspecialchars($key['name']) ?></span>
                            </td>
                            <td>
                                <div class="api-key-display">
                                    <code class="api-key-masked"><?= substr($key['api_key'], 0, 8) ?>...<?= substr($key['api_key'], -4) ?></code>
                                    <button class="btn btn-sm btn-outline" onclick="copyApiKey('<?= $key['api_key'] ?>')" title="نسخ">
                                        <span class="material-icons-round">content_copy</span>
                                    </button>
                                </div>
                            </td>
                            <td>
                                <span class="badge <?= $key['is_active'] ? 'badge-success' : 'badge-danger' ?>" id="status-<?= $key['id'] ?>">
                                    <?= $key['is_active'] ? 'مفعّل' : 'موقوف' ?>
                                </span>
                            </td>
                            <td>
                                <?php if ($key['expires_at']): ?>
                                    <?php 
                                    $expiresDate = strtotime($key['expires_at']);
                                    $isExpired = $expiresDate < time();
                                    ?>
                                    <span class="<?= $isExpired ? 'text-danger' : '' ?>">
                                        <?= date('Y-m-d', $expiresDate) ?>
                                        <?= $isExpired ? '<small>(منتهي)</small>' : '' ?>
                                    </span>
                                <?php else: ?>
                                    <span class="text-muted">غير محدد</span>
                                <?php endif; ?>
                            </td>
                            <td><?= $key['last_used_at'] ? date('Y-m-d H:i', strtotime($key['last_used_at'])) : 'لم يُستخدم' ?></td>
                            <td><?= date('Y-m-d', strtotime($key['created_at'])) ?></td>
                            <td><?= htmlspecialchars($key['created_by_name'] ?? '-') ?></td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-secondary" onclick="editKey(<?= $key['id'] ?>)" title="تعديل">
                                        <span class="material-icons-round">edit</span>
                                    </button>
                                    <button class="btn btn-sm <?= $key['is_active'] ? 'btn-warning' : 'btn-success' ?>" 
                                            onclick="toggleKey(<?= $key['id'] ?>)"
                                            id="toggle-btn-<?= $key['id'] ?>"
                                            title="<?= $key['is_active'] ? 'إيقاف' : 'تفعيل' ?>">
                                        <span class="material-icons-round"><?= $key['is_active'] ? 'pause' : 'play_arrow' ?></span>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="showDeleteModal(<?= $key['id'] ?>, '<?= htmlspecialchars($key['name'], ENT_QUOTES) ?>')" title="حذف">
                                        <span class="material-icons-round">delete</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        <?php endif; ?>
    </div>
</div>

<!-- Modal إضافة/تعديل مفتاح -->
<div id="keyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle"><span class="material-icons-round">add</span> إنشاء مفتاح API جديد</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="keyForm">
                <input type="hidden" id="keyId" name="id">
                <div class="form-group">
                    <label>اسم المفتاح *</label>
                    <input type="text" id="keyName" name="name" class="form-control" placeholder="مثال: تطبيق الموبايل" required>
                </div>
                <div class="form-group" id="apiKeyDisplayGroup" style="display: none;">
                    <label>مفتاح API</label>
                    <div class="api-key-edit-display">
                        <input type="password" id="editApiKey" class="form-control" readonly style="direction: ltr; font-family: monospace;">
                        <button type="button" class="btn btn-outline" onclick="toggleApiKeyVisibility()" title="إظهار/إخفاء">
                            <span class="material-icons-round" id="toggleKeyIcon">visibility</span>
                        </button>
                        <button type="button" class="btn btn-primary" onclick="copyEditApiKey()" title="نسخ">
                            <span class="material-icons-round">content_copy</span>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label>تاريخ انتهاء الصلاحية (اختياري)</label>
                    <input type="date" id="keyExpires" name="expires_at" class="form-control">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeModal()">إلغاء</button>
            <button class="btn btn-primary" id="submitBtn" onclick="submitForm()">
                <span class="material-icons-round">save</span> حفظ
            </button>
        </div>
    </div>
</div>

<!-- Modal عرض المفتاح الجديد -->
<div id="newKeyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><span class="material-icons-round">check_circle</span> تم إنشاء المفتاح بنجاح</h3>
        </div>
        <div class="modal-body">
            <div class="alert alert-warning">
                <span class="material-icons-round">warning</span>
                <strong>تنبيه:</strong> هذه هي المرة الوحيدة التي سترى فيها المفتاح كاملاً. احفظه في مكان آمن!
            </div>
            <div class="form-group">
                <label>مفتاح API</label>
                <div class="input-with-copy">
                    <input type="text" id="newApiKey" class="form-control" readonly style="direction: ltr;">
                    <button class="btn btn-primary" onclick="copyNewKey()">
                        <span class="material-icons-round">content_copy</span> نسخ
                    </button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeNewKeyModal()">تم</button>
        </div>
    </div>
</div>

<!-- Modal تأكيد الحذف -->
<div id="deleteModal" class="modal">
    <div class="modal-content" style="max-width:400px">
        <div class="modal-header">
            <h3><span class="material-icons-round">warning</span> تأكيد الحذف</h3>
            <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p id="deleteMessage">هل أنت متأكد من حذف هذا المفتاح؟</p>
            <div class="alert alert-danger" style="margin-top:15px">
                <span class="material-icons-round">info</span>
                <span>التطبيقات التي تستخدم هذا المفتاح ستتوقف عن العمل</span>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeDeleteModal()">إلغاء</button>
            <button class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDeleteApiKey()">
                <span class="material-icons-round">delete</span> حذف
            </button>
        </div>
    </div>
</div>

<style>
.api-info code {
    background: var(--bg-main);
    padding: 4px 8px;
    border-radius: 4px;
    font-family: monospace;
}

.endpoints-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.endpoint-group {
    background: var(--bg-main);
    padding: 12px;
    border-radius: 8px;
}

.endpoint-group h5 {
    margin-bottom: 8px;
    color: var(--primary);
    font-size: 14px;
}

.endpoint-group code {
    display: block;
    margin: 4px 0;
    font-size: 11px;
    direction: ltr;
    text-align: left;
}

.api-key-display {
    display: flex;
    align-items: center;
    gap: 8px;
}

.api-key-masked {
    font-family: monospace;
    font-size: 12px;
}

.api-key-edit-display {
    display: flex;
    gap: 8px;
    align-items: center;
}

.api-key-edit-display input {
    flex: 1;
}

.input-with-copy {
    display: flex;
    gap: 10px;
}

.input-with-copy input {
    flex: 1;
    font-family: monospace;
}

.empty-state {
    text-align: center;
    padding: 40px;
}

.btn-group {
    display: flex;
    gap: 5px;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modal.show {
    display: flex;
    opacity: 1;
}

.modal-content {
    background: var(--bg-card);
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: var(--shadow-lg);
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
}

.modal-header h3 {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 0;
}

.close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-muted);
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 20px;
    border-top: 1px solid var(--border-color);
}

.alert {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 15px;
    border-radius: 8px;
}

.alert-warning {
    background: rgba(255, 152, 0, 0.1);
    color: #f57c00;
}

.alert-danger {
    background: rgba(244, 67, 54, 0.1);
    color: #d32f2f;
}
</style>

<script>
let currentKeyId = null;
let isEditMode = false;

function showAddModal() {
    document.getElementById('modalTitle').innerHTML = '<span class="material-icons-round">add</span> إنشاء مفتاح API جديد';
    document.getElementById('keyId').value = '';
    document.getElementById('keyName').value = '';
    document.getElementById('keyExpires').value = '';
    document.getElementById('submitBtn').innerHTML = '<span class="material-icons-round">vpn_key</span> إنشاء المفتاح';
    // إخفاء حقل المفتاح عند الإضافة
    document.getElementById('apiKeyDisplayGroup').style.display = 'none';
    currentKeyId = null;
    isEditMode = false;
    document.getElementById('keyModal').classList.add('show');
}

function editKey(id) {
    const row = document.getElementById('key-row-' + id);
    const keyData = JSON.parse(row.dataset.key);
    
    document.getElementById('modalTitle').innerHTML = '<span class="material-icons-round">edit</span> تعديل مفتاح API';
    document.getElementById('keyId').value = keyData.id;
    document.getElementById('keyName').value = keyData.name;
    document.getElementById('keyExpires').value = keyData.expires_at || '';
    document.getElementById('submitBtn').innerHTML = '<span class="material-icons-round">save</span> حفظ التعديلات';
    
    // إظهار حقل المفتاح عند التعديل
    document.getElementById('apiKeyDisplayGroup').style.display = 'block';
    document.getElementById('editApiKey').value = keyData.api_key;
    document.getElementById('editApiKey').type = 'password'; // مخفي افتراضياً
    document.getElementById('toggleKeyIcon').textContent = 'visibility';
    
    currentKeyId = id;
    isEditMode = true;
    document.getElementById('keyModal').classList.add('show');
}

function toggleApiKeyVisibility() {
    const input = document.getElementById('editApiKey');
    const icon = document.getElementById('toggleKeyIcon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.textContent = 'visibility_off';
    } else {
        input.type = 'password';
        icon.textContent = 'visibility';
    }
}

function copyEditApiKey() {
    const key = document.getElementById('editApiKey').value;
    navigator.clipboard.writeText(key).then(() => {
        showToast('تم نسخ المفتاح');
    });
}

function closeModal() {
    document.getElementById('keyModal').classList.remove('show');
    // إعادة إخفاء المفتاح عند إغلاق النافذة
    document.getElementById('editApiKey').type = 'password';
    document.getElementById('toggleKeyIcon').textContent = 'visibility';
}

function closeNewKeyModal() {
    document.getElementById('newKeyModal').classList.remove('show');
    location.reload(); // تحديث الصفحة لإظهار المفتاح الجديد
}

function submitForm() {
    const form = document.getElementById('keyForm');
    const formData = new FormData(form);
    const btn = document.getElementById('submitBtn');
    
    const name = document.getElementById('keyName').value.trim();
    if (!name) {
        alert('اسم المفتاح مطلوب');
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="material-icons-round">hourglass_empty</span> جاري الحفظ...';
    
    const url = isEditMode 
        ? '<?= url('/settings/api/') ?>' + currentKeyId + '/update'
        : '<?= url('/settings/api/generate') ?>';
    
    console.log('Submit URL:', url);
    console.log('Edit mode:', isEditMode);
    console.log('Current Key ID:', currentKeyId);
    
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error('HTTP ' + response.status + ': ' + text);
            });
        }
        return response.json();
    })
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = isEditMode 
            ? '<span class="material-icons-round">save</span> حفظ التعديلات'
            : '<span class="material-icons-round">vpn_key</span> إنشاء المفتاح';
        
        if (data.success) {
            closeModal();
            
            if (isEditMode) {
                // تحديث بعد التعديل
                showToast('تم تحديث المفتاح بنجاح');
                setTimeout(() => location.reload(), 500);
            } else {
                // عرض المفتاح الجديد
                document.getElementById('newApiKey').value = data.api_key;
                document.getElementById('newKeyModal').classList.add('show');
            }
        } else {
            alert(data.message || 'حدث خطأ');
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = isEditMode 
            ? '<span class="material-icons-round">save</span> حفظ التعديلات'
            : '<span class="material-icons-round">vpn_key</span> إنشاء المفتاح';
        console.error('Error:', error);
        alert('حدث خطأ: ' + error.message);
    });
}

function showDeleteModal(id, name) {
    currentKeyId = id;
    document.getElementById('deleteMessage').textContent = 'هل أنت متأكد من حذف مفتاح "' + name + '"؟';
    document.getElementById('deleteModal').classList.add('show');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('show');
}

function confirmDeleteApiKey() {
    if (!currentKeyId) {
        console.error('No key ID set');
        return;
    }
    
    const btn = document.getElementById('confirmDeleteBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="material-icons-round">hourglass_empty</span> جاري الحذف...';
    
    const deleteUrl = '<?= url('/settings/api/') ?>' + currentKeyId + '/delete';
    console.log('Delete URL:', deleteUrl);
    
    fetch(deleteUrl, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/x-www-form-urlencoded'
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            return response.text().then(text => {
                console.error('Error response:', text);
                throw new Error('HTTP ' + response.status);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            closeDeleteModal();
            showToast('تم حذف المفتاح بنجاح');
            setTimeout(() => location.reload(), 500);
        } else {
            btn.disabled = false;
            btn.innerHTML = '<span class="material-icons-round">delete</span> حذف';
            alert(data.message || 'حدث خطأ');
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = '<span class="material-icons-round">delete</span> حذف';
        console.error('Fetch Error:', error);
        alert('حدث خطأ: ' + error.message);
    });
}

function toggleKey(id) {
    const btn = document.getElementById('toggle-btn-' + id);
    if (!btn) {
        console.error('Toggle button not found for id:', id);
        return;
    }
    btn.disabled = true;
    
    const toggleUrl = '<?= url('/settings/api/') ?>' + id + '/toggle';
    console.log('Toggle URL:', toggleUrl);
    
    fetch(toggleUrl, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/x-www-form-urlencoded'
        }
    })
    .then(response => {
        console.log('Toggle response status:', response.status);
        if (!response.ok) {
            return response.text().then(text => {
                console.error('Toggle error response:', text);
                throw new Error('HTTP ' + response.status);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Toggle response data:', data);
        btn.disabled = false;
        
        if (data.success) {
            const statusBadge = document.getElementById('status-' + id);
            
            if (data.is_active) {
                statusBadge.className = 'badge badge-success';
                statusBadge.textContent = 'مفعّل';
                btn.className = 'btn btn-sm btn-warning';
                btn.title = 'إيقاف';
                btn.innerHTML = '<span class="material-icons-round">pause</span>';
            } else {
                statusBadge.className = 'badge badge-danger';
                statusBadge.textContent = 'موقوف';
                btn.className = 'btn btn-sm btn-success';
                btn.title = 'تفعيل';
                btn.innerHTML = '<span class="material-icons-round">play_arrow</span>';
            }
            
            showToast(data.message);
        } else {
            alert(data.message || 'حدث خطأ');
        }
    })
    .catch(error => {
        btn.disabled = false;
        console.error('Toggle Fetch Error:', error);
        alert('حدث خطأ: ' + error.message);
    });
}

function updateTableRow(key) {
    const row = document.getElementById('key-row-' + key.id);
    if (row) {
        row.querySelector('.key-name').textContent = key.name;
        // تحديث data attribute
        const oldData = JSON.parse(row.dataset.key);
        oldData.name = key.name;
        if (key.expires_at) oldData.expires_at = key.expires_at;
        row.dataset.key = JSON.stringify(oldData);
    }
}

function copyApiKey(key) {
    navigator.clipboard.writeText(key).then(() => {
        showToast('تم نسخ المفتاح');
    });
}

function copyNewKey() {
    const key = document.getElementById('newApiKey').value;
    navigator.clipboard.writeText(key).then(() => {
        showToast('تم نسخ المفتاح');
    });
}

function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    toast.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 24px;border-radius:8px;z-index:9999;';
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>


============================================================
FILE: app/Views/settings/backup.php
============================================================
<div class="page-header">
    <h2><span class="material-icons-round">backup</span> النسخ الاحتياطي</h2>
    <a href="<?= url('/settings') ?>" class="btn btn-secondary"><span class="material-icons-round">arrow_forward</span> رجوع</a>
</div>

<div class="backup-actions">
    <form method="POST" action="<?= url('/settings/backup/create') ?>" style="display:inline">
        <button type="submit" class="btn btn-primary btn-lg">
            <span class="material-icons-round">cloud_upload</span>
            إنشاء نسخة احتياطية
        </button>
    </form>
</div>

<div class="card" style="margin-top:25px">
    <div class="card-header">
        <h3><span class="material-icons-round">history</span> النسخ الاحتياطية المحفوظة</h3>
    </div>
    <div class="card-body">
        <?php if (empty($backups)): ?>
        <p class="empty-message">لا توجد نسخ احتياطية محفوظة</p>
        <?php else: ?>
        <div class="table-responsive">
            <table class="table">
                <thead><tr><th>الملف</th><th>الحجم</th><th>التاريخ</th><th></th></tr></thead>
                <tbody>
                    <?php foreach ($backups as $backup): ?>
                    <tr>
                        <td><strong><?= $backup['filename'] ?></strong></td>
                        <td><?= number_format($backup['size'] / 1024, 2) ?> KB</td>
                        <td><?= date('Y-m-d H:i', $backup['date']) ?></td>
                        <td>
                            <a href="<?= url('/settings/backup/download/' . $backup['filename']) ?>" class="btn btn-sm btn-primary"><span class="material-icons-round">download</span></a>
                            <form method="POST" action="<?= url('/settings/backup/delete/' . $backup['filename']) ?>" style="display:inline" onsubmit="return confirm('هل أنت متأكد؟')">
                                <button type="submit" class="btn btn-sm btn-danger"><span class="material-icons-round">delete</span></button>
                            </form>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
        <?php endif; ?>
    </div>
</div>

<div class="card" style="margin-top:25px">
    <div class="card-header">
        <h3><span class="material-icons-round">restore</span> استعادة نسخة احتياطية</h3>
    </div>
    <div class="card-body">
        <div class="alert alert-warning">
            <span class="material-icons-round">warning</span>
            تحذير: استعادة نسخة احتياطية ستستبدل جميع البيانات الحالية!
        </div>
        <form method="POST" action="<?= url('/settings/backup/restore') ?>" enctype="multipart/form-data">
            <div class="form-group">
                <label>اختر ملف النسخة الاحتياطية</label>
                <input type="file" name="backup" class="form-control" accept=".sqlite" required>
            </div>
            <button type="submit" class="btn btn-danger" onclick="return confirm('هل أنت متأكد من استعادة هذه النسخة؟ سيتم استبدال جميع البيانات الحالية.')">
                <span class="material-icons-round">restore</span> استعادة
            </button>
        </form>
    </div>
</div>

<style>
.backup-actions { text-align: center; padding: 30px; background: var(--bg-card); border-radius: var(--radius); }
.btn-lg { padding: 15px 30px; font-size: 16px; }
</style>


============================================================
FILE: app/Views/settings/index.php
============================================================
<div class="page-header">
    <h2><span class="material-icons-round">settings</span> إعدادات النظام</h2>
</div>

<div class="settings-grid">
    <div class="card">
        <div class="card-header"><h3><span class="material-icons-round">store</span> بيانات المتجر</h3></div>
        <div class="card-body">
            <form method="POST" action="<?= url('/settings') ?>" enctype="multipart/form-data">
                <div class="form-group">
                    <label>اسم المتجر</label>
                    <input type="text" name="store_name" class="form-control" value="<?= $settings['store_name'] ?? '' ?>">
                </div>
                <div class="form-group">
                    <label>رقم الهاتف</label>
                    <input type="tel" name="store_phone" class="form-control" value="<?= $settings['store_phone'] ?? '' ?>">
                </div>
                <div class="form-group">
                    <label>هاتف إضافي</label>
                    <input type="tel" name="store_phone2" class="form-control" value="<?= $settings['store_phone2'] ?? '' ?>">
                </div>
                <div class="form-group">
                    <label>العنوان</label>
                    <textarea name="store_address" class="form-control" rows="2"><?= $settings['store_address'] ?? '' ?></textarea>
                </div>
                <div class="form-group">
                    <label>شعار المتجر</label>
                    <?php if (!empty($settings['store_logo'])): ?>
                    <div style="margin-bottom:10px"><img src="<?= asset('images/' . $settings['store_logo']) ?>" alt="" style="max-height:60px"></div>
                    <?php endif; ?>
                    <input type="file" name="store_logo" class="form-control" accept="image/*">
                </div>
                <button type="submit" class="btn btn-primary"><span class="material-icons-round">save</span> حفظ</button>
            </form>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header"><h3><span class="material-icons-round">receipt</span> إعدادات الفواتير</h3></div>
        <div class="card-body">
            <form method="POST" action="<?= url('/settings') ?>">
                <div class="form-group">
                    <label>العملة</label>
                    <input type="text" name="currency" class="form-control" value="<?= $settings['currency'] ?? 'ج.م' ?>">
                </div>
                <div class="form-group">
                    <label>نسبة الضريبة %</label>
                    <input type="number" name="tax_rate" class="form-control" step="0.01" value="<?= $settings['tax_rate'] ?? 0 ?>">
                </div>
                <div class="form-group">
                    <label>بادئة الفاتورة</label>
                    <input type="text" name="invoice_prefix" class="form-control" value="<?= $settings['invoice_prefix'] ?? 'INV' ?>">
                </div>
                <div class="form-group">
                    <label>بادئة الإيصال</label>
                    <input type="text" name="receipt_prefix" class="form-control" value="<?= $settings['receipt_prefix'] ?? 'RCP' ?>">
                </div>
                <div class="form-group">
                    <label>تذييل الفاتورة</label>
                    <textarea name="invoice_footer" class="form-control" rows="2"><?= $settings['invoice_footer'] ?? 'شكراً لتعاملكم معنا' ?></textarea>
                </div>
                <button type="submit" class="btn btn-primary"><span class="material-icons-round">save</span> حفظ</button>
            </form>
        </div>
    </div>
    
    <!-- المظهر الأساسي (للنظام - يحفظه المشرف) -->
    <div class="card">
        <div class="card-header"><h3><span class="material-icons-round">palette</span> المظهر الأساسي للنظام</h3></div>
        <div class="card-body">
            <p style="color: var(--text-muted); margin-bottom: 15px; font-size: 14px;">
                <span class="material-icons-round" style="vertical-align: middle; font-size: 18px;">info</span>
                هذه الإعدادات تُطبق كإفتراضي على جميع الموظفين. يمكن لكل موظف تخصيص مظهره الخاص من قسم "تخصيص المظهر" أدناه.
            </p>
            <form method="POST" action="<?= url('/settings') ?>">
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="dark_mode" value="1" <?= ($settings['dark_mode'] ?? 0) ? 'checked' : '' ?>>
                        الوضع الليلي
                    </label>
                </div>
                <div class="form-group">
                    <label>اللون الرئيسي</label>
                    <input type="color" name="primary_color" class="form-control" value="<?= $settings['primary_color'] ?? '#1e88e5' ?>" style="height:45px">
                </div>
                <div class="form-group">
                    <label>لون القائمة الجانبية</label>
                    <input type="color" name="sidebar_color" class="form-control" value="<?= $settings['sidebar_color'] ?? '#1a237e' ?>" style="height:45px">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary"><span class="material-icons-round">save</span> حفظ الإفتراضي</button>
                    <button type="button" class="btn btn-outline" onclick="resetSystemAppearance()"><span class="material-icons-round">restart_alt</span> إعادة للأصل</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- تخصيص المظهر (لكل موظف) -->
    <div class="card">
        <div class="card-header"><h3><span class="material-icons-round">brush</span> تخصيص المظهر (لك فقط)</h3></div>
        <div class="card-body" id="themeEditor">
            <p style="color: var(--text-muted); margin-bottom: 15px; font-size: 14px;">
                <span class="material-icons-round" style="vertical-align: middle; font-size: 18px;">person</span>
                خصص مظهر النظام حسب رغبتك. هذه التغييرات تُطبق عليك فقط ولا تؤثر على الموظفين الآخرين.
            </p>
            
            <!-- اختيار الوضع -->
            <div class="theme-mode-selector" style="display: flex; gap: 15px; margin-bottom: 25px;">
                <label class="mode-option" style="flex: 1; cursor: pointer;">
                    <input type="radio" name="themeMode" value="light" <?= !($themeConfig['dark_mode'] ?? false) ? 'checked' : '' ?> onchange="switchThemeMode('light')">
                    <div class="mode-card" style="border: 2px solid var(--border-color); border-radius: 12px; padding: 20px; text-align: center; transition: all 0.3s; background: #f5f7fa;">
                        <span class="material-icons-round" style="font-size: 48px; color: #ff9800;">light_mode</span>
                        <h4 style="margin: 10px 0 5px; color: #212121;">الوضع النهاري</h4>
                        <small style="color: #666;">ألوان فاتحة ومريحة للعين</small>
                    </div>
                </label>
                <label class="mode-option" style="flex: 1; cursor: pointer;">
                    <input type="radio" name="themeMode" value="dark" <?= ($themeConfig['dark_mode'] ?? false) ? 'checked' : '' ?> onchange="switchThemeMode('dark')">
                    <div class="mode-card" style="border: 2px solid var(--border-color); border-radius: 12px; padding: 20px; text-align: center; transition: all 0.3s; background: #1e1e1e;">
                        <span class="material-icons-round" style="font-size: 48px; color: #64b5f6;">dark_mode</span>
                        <h4 style="margin: 10px 0 5px; color: #ffffff;">الوضع الليلي</h4>
                        <small style="color: #b0b0b0;">ألوان داكنة لراحة العين ليلاً</small>
                    </div>
                </label>
            </div>
            
            <input type="hidden" id="themeDarkMode" value="<?= ($themeConfig['dark_mode'] ?? false) ? '1' : '0' ?>">
            
            <!-- ألوان الوضع النهاري -->
            <div id="lightModeColors" class="theme-section" style="<?= ($themeConfig['dark_mode'] ?? false) ? 'display:none;' : '' ?>">
                <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                    <span class="material-icons-round" style="color: #ff9800;">light_mode</span>
                    ألوان الوضع النهاري
                </h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>اللون الرئيسي</label>
                        <input type="color" id="themePrimaryColor" class="form-control" 
                               value="<?= $themeConfig['primary_color'] ?? ($settings['primary_color'] ?? '#1e88e5') ?>" 
                               style="height:45px">
                    </div>
                    <div class="form-group">
                        <label>لون القائمة الجانبية</label>
                        <input type="color" id="themeSidebarColor" class="form-control" 
                               value="<?= $themeConfig['sidebar_color'] ?? ($settings['sidebar_color'] ?? '#1a237e') ?>" 
                               style="height:45px">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>لون نص القائمة</label>
                        <input type="color" id="themeSidebarTextColor" class="form-control" 
                               value="<?= $themeConfig['sidebar_text_color'] ?? '#ffffff' ?>" 
                               style="height:45px">
                    </div>
                    <div class="form-group">
                        <label>لون الخلفية</label>
                        <input type="color" id="themeBgColor" class="form-control" 
                               value="<?= $themeConfig['bg_color'] ?? '#f5f7fa' ?>" 
                               style="height:45px">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>لون البطاقات</label>
                        <input type="color" id="themeCardColor" class="form-control" 
                               value="<?= $themeConfig['card_color'] ?? '#ffffff' ?>" 
                               style="height:45px">
                    </div>
                    <div class="form-group">
                        <label>لون النص</label>
                        <input type="color" id="themeTextColor" class="form-control" 
                               value="<?= $themeConfig['text_color'] ?? '#212121' ?>" 
                               style="height:45px">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>لون رأس الأقسام</label>
                        <input type="color" id="themeSectionHeaderColor" class="form-control" 
                               value="<?= $themeConfig['section_header_color'] ?? '#1565c0' ?>" 
                               style="height:45px">
                    </div>
                    <div class="form-group">
                        <label>لون الأزرار الثانوية</label>
                        <input type="color" id="themeSecondaryColor" class="form-control" 
                               value="<?= $themeConfig['secondary_color'] ?? '#546e7a' ?>" 
                               style="height:45px">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>لون الحدود</label>
                        <input type="color" id="themeBorderColor" class="form-control" 
                               value="<?= $themeConfig['border_color'] ?? '#e0e0e0' ?>" 
                               style="height:45px">
                    </div>
                    <div class="form-group">
                        <label>لون النص الثانوي</label>
                        <input type="color" id="themeTextSecondaryColor" class="form-control" 
                               value="<?= $themeConfig['text_secondary_color'] ?? '#666666' ?>" 
                               style="height:45px">
                    </div>
                </div>
            </div>
            
            <!-- ألوان الوضع الليلي -->
            <div id="darkModeColors" class="theme-section" style="<?= !($themeConfig['dark_mode'] ?? false) ? 'display:none;' : '' ?>">
                <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                    <span class="material-icons-round" style="color: #64b5f6;">dark_mode</span>
                    ألوان الوضع الليلي
                </h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>اللون الرئيسي</label>
                        <input type="color" id="themeDarkPrimaryColor" class="form-control" 
                               value="<?= $themeConfig['dark_primary_color'] ?? '#64b5f6' ?>" 
                               style="height:45px">
                    </div>
                    <div class="form-group">
                        <label>لون القائمة الجانبية</label>
                        <input type="color" id="themeDarkSidebarColor" class="form-control" 
                               value="<?= $themeConfig['dark_sidebar_color'] ?? '#121212' ?>" 
                               style="height:45px">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>لون نص القائمة</label>
                        <input type="color" id="themeDarkSidebarTextColor" class="form-control" 
                               value="<?= $themeConfig['dark_sidebar_text_color'] ?? '#ffffff' ?>" 
                               style="height:45px">
                    </div>
                    <div class="form-group">
                        <label>لون الخلفية</label>
                        <input type="color" id="themeDarkBgColor" class="form-control" 
                               value="<?= $themeConfig['dark_bg_color'] ?? '#121212' ?>" 
                               style="height:45px">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>لون البطاقات</label>
                        <input type="color" id="themeDarkCardColor" class="form-control" 
                               value="<?= $themeConfig['dark_card_color'] ?? '#1e1e1e' ?>" 
                               style="height:45px">
                    </div>
                    <div class="form-group">
                        <label>لون النص</label>
                        <input type="color" id="themeDarkTextColor" class="form-control" 
                               value="<?= $themeConfig['dark_text_color'] ?? '#ffffff' ?>" 
                               style="height:45px">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>لون رأس الأقسام</label>
                        <input type="color" id="themeDarkSectionHeaderColor" class="form-control" 
                               value="<?= $themeConfig['dark_section_header_color'] ?? '#64b5f6' ?>" 
                               style="height:45px">
                    </div>
                    <div class="form-group">
                        <label>لون الأزرار الثانوية</label>
                        <input type="color" id="themeDarkSecondaryColor" class="form-control" 
                               value="<?= $themeConfig['dark_secondary_color'] ?? '#78909c' ?>" 
                               style="height:45px">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>لون الحدود</label>
                        <input type="color" id="themeDarkBorderColor" class="form-control" 
                               value="<?= $themeConfig['dark_border_color'] ?? '#333333' ?>" 
                               style="height:45px">
                    </div>
                    <div class="form-group">
                        <label>لون النص الثانوي</label>
                        <input type="color" id="themeDarkTextSecondaryColor" class="form-control" 
                               value="<?= $themeConfig['dark_text_secondary_color'] ?? '#b0b0b0' ?>" 
                               style="height:45px">
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-primary" onclick="saveThemeConfig()">
                    <span class="material-icons-round">save</span> حفظ المظهر
                </button>
                <button type="button" class="btn btn-outline" onclick="resetThemeConfig()">
                    <span class="material-icons-round">restart_alt</span> إعادة للإفتراضي
                </button>
                <button type="button" class="btn btn-outline" onclick="previewTheme()">
                    <span class="material-icons-round">visibility</span> معاينة
                </button>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header"><h3><span class="material-icons-round">credit_score</span> خطط التقسيط</h3></div>
        <div class="card-body">
            <a href="<?= url('/settings/installment') ?>" class="btn btn-outline btn-block">إدارة خطط التقسيط</a>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header"><h3><span class="material-icons-round">backup</span> النسخ الاحتياطي</h3></div>
        <div class="card-body">
            <a href="<?= url('/settings/backup') ?>" class="btn btn-outline btn-block">إدارة النسخ الاحتياطي</a>
        </div>
    </div>
    
    
    <div class="card">
        <div class="card-header"><h3><span class="material-icons-round">api</span> واجهة برمجة التطبيقات</h3></div>
        <div class="card-body">
            <p style="color: var(--text-muted); margin-bottom: 15px; font-size: 14px;">
                إدارة مفاتيح API للتكامل مع تطبيقات الموبايل والأنظمة الخارجية
            </p>
            <a href="<?= url('/settings/api') ?>" class="btn btn-outline btn-block">
                <span class="material-icons-round">vpn_key</span> إدارة API Keys
            </a>
        </div>
    </div>
    <div class="card" style="grid-column: span 2">
        <div class="card-header"><h3><span class="material-icons-round">menu</span> ترتيب القائمة الجانبية</h3></div>
        <div class="card-body">
            <p style="color:var(--text-muted);margin-bottom:20px;font-size:14px">
                <span class="material-icons-round" style="font-size:16px;vertical-align:middle">info</span>
                اسحب وأفلت لترتيب الأقسام والعناصر كما تريد. استخدم مفاتيح التبديل للإظهار/الإخفاء
            </p>
            
            <div id="menuEditor" class="menu-editor">
                <!-- الإدارة -->
                <div class="menu-section" data-section="admin" draggable="true">
                    <div class="menu-section-header">
                        <span class="material-icons-round drag-handle">drag_indicator</span>
                        <span class="section-name">الإدارة</span>
                        <label class="toggle-switch">
                            <input type="checkbox" checked data-type="section" data-id="admin">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="material-icons-round expand-btn" onclick="toggleExpand(this)">expand_more</span>
                    </div>
                    <div class="menu-section-items">
                        <div class="menu-item" data-item="dashboard" draggable="true">
                            <span class="material-icons-round drag-handle">drag_indicator</span>
                            <span class="material-icons-round item-icon">dashboard</span>
                            <span>لوحة التحكم</span>
                            <label class="toggle-switch small">
                                <input type="checkbox" checked data-type="item" data-id="dashboard">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="menu-item" data-item="pos" draggable="true">
                            <span class="material-icons-round drag-handle">drag_indicator</span>
                            <span class="material-icons-round item-icon">point_of_sale</span>
                            <span>نقطة البيع</span>
                            <label class="toggle-switch small">
                                <input type="checkbox" checked data-type="item" data-id="pos">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="menu-item" data-item="pos-installment" draggable="true">
                            <span class="material-icons-round drag-handle">drag_indicator</span>
                            <span class="material-icons-round item-icon">credit_score</span>
                            <span>بيع بالتقسيط</span>
                            <label class="toggle-switch small">
                                <input type="checkbox" checked data-type="item" data-id="pos-installment">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- المخزون -->
                <div class="menu-section" data-section="inventory" draggable="true">
                    <div class="menu-section-header">
                        <span class="material-icons-round drag-handle">drag_indicator</span>
                        <span class="section-name">المخزون</span>
                        <label class="toggle-switch">
                            <input type="checkbox" checked data-type="section" data-id="inventory">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="material-icons-round expand-btn" onclick="toggleExpand(this)">expand_more</span>
                    </div>
                    <div class="menu-section-items">
                        <div class="menu-item" data-item="products" draggable="true">
                            <span class="material-icons-round drag-handle">drag_indicator</span>
                            <span class="material-icons-round item-icon">inventory_2</span>
                            <span>المنتجات</span>
                            <label class="toggle-switch small">
                                <input type="checkbox" checked data-type="item" data-id="products">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="menu-item" data-item="categories" draggable="true">
                            <span class="material-icons-round drag-handle">drag_indicator</span>
                            <span class="material-icons-round item-icon">category</span>
                            <span>التصنيفات</span>
                            <label class="toggle-switch small">
                                <input type="checkbox" checked data-type="item" data-id="categories">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="menu-item" data-item="customers" draggable="true">
                            <span class="material-icons-round drag-handle">drag_indicator</span>
                            <span class="material-icons-round item-icon">people</span>
                            <span>العملاء</span>
                            <label class="toggle-switch small">
                                <input type="checkbox" checked data-type="item" data-id="customers">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- المالية -->
                <div class="menu-section" data-section="finance" draggable="true">
                    <div class="menu-section-header">
                        <span class="material-icons-round drag-handle">drag_indicator</span>
                        <span class="section-name">المالية</span>
                        <label class="toggle-switch">
                            <input type="checkbox" checked data-type="section" data-id="finance">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="material-icons-round expand-btn" onclick="toggleExpand(this)">expand_more</span>
                    </div>
                    <div class="menu-section-items">
                        <div class="menu-item" data-item="invoices" draggable="true">
                            <span class="material-icons-round drag-handle">drag_indicator</span>
                            <span class="material-icons-round item-icon">receipt_long</span>
                            <span>الفواتير</span>
                            <label class="toggle-switch small">
                                <input type="checkbox" checked data-type="item" data-id="invoices">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="menu-item" data-item="installments" draggable="true">
                            <span class="material-icons-round drag-handle">drag_indicator</span>
                            <span class="material-icons-round item-icon">payments</span>
                            <span>الأقساط</span>
                            <label class="toggle-switch small">
                                <input type="checkbox" checked data-type="item" data-id="installments">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="menu-item" data-item="installments-today" draggable="true">
                            <span class="material-icons-round drag-handle">drag_indicator</span>
                            <span class="material-icons-round item-icon">today</span>
                            <span>أقساط اليوم</span>
                            <label class="toggle-switch small">
                                <input type="checkbox" checked data-type="item" data-id="installments-today">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="menu-item" data-item="installments-overdue" draggable="true">
                            <span class="material-icons-round drag-handle">drag_indicator</span>
                            <span class="material-icons-round item-icon">warning</span>
                            <span>متأخرات</span>
                            <label class="toggle-switch small">
                                <input type="checkbox" checked data-type="item" data-id="installments-overdue">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="menu-item" data-item="payments" draggable="true">
                            <span class="material-icons-round drag-handle">drag_indicator</span>
                            <span class="material-icons-round item-icon">account_balance_wallet</span>
                            <span>المدفوعات</span>
                            <label class="toggle-switch small">
                                <input type="checkbox" checked data-type="item" data-id="payments">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- النظام -->
                <div class="menu-section" data-section="system" draggable="true">
                    <div class="menu-section-header">
                        <span class="material-icons-round drag-handle">drag_indicator</span>
                        <span class="section-name">النظام</span>
                        <label class="toggle-switch">
                            <input type="checkbox" checked data-type="section" data-id="system">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="material-icons-round expand-btn" onclick="toggleExpand(this)">expand_more</span>
                    </div>
                    <div class="menu-section-items">
                        <div class="menu-item" data-item="reports" draggable="true">
                            <span class="material-icons-round drag-handle">drag_indicator</span>
                            <span class="material-icons-round item-icon">analytics</span>
                            <span>التقارير</span>
                            <label class="toggle-switch small">
                                <input type="checkbox" checked data-type="item" data-id="reports">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="menu-item" data-item="users" draggable="true">
                            <span class="material-icons-round drag-handle">drag_indicator</span>
                            <span class="material-icons-round item-icon">manage_accounts</span>
                            <span>المستخدمين</span>
                            <label class="toggle-switch small">
                                <input type="checkbox" checked data-type="item" data-id="users">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="menu-item" data-item="settings" draggable="true">
                            <span class="material-icons-round drag-handle">drag_indicator</span>
                            <span class="material-icons-round item-icon">settings</span>
                            <span>الإعدادات</span>
                            <label class="toggle-switch small">
                                <input type="checkbox" checked data-type="item" data-id="settings">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top:20px;display:flex;gap:10px">
                <button onclick="saveFullMenuConfig()" class="btn btn-primary">
                    <span class="material-icons-round">save</span> حفظ التغييرات
                </button>
                <button onclick="resetFullMenuConfig()" class="btn btn-secondary">
                    <span class="material-icons-round">restart_alt</span> إعادة تعيين
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.settings-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; }
.checkbox-label { display: flex; align-items: center; gap: 10px; cursor: pointer; }
.checkbox-label input { width: 20px; height: 20px; }
@media (max-width: 1024px) { 
    .settings-grid { grid-template-columns: 1fr; }
    .settings-grid .card[style*="grid-column: span 2"] { grid-column: span 1 !important; }
}

/* Menu Order Styles */
.menu-order-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.menu-order-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    background: var(--bg-main);
    border-radius: var(--radius-sm);
    cursor: grab;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.menu-order-item:hover {
    background: var(--bg-card);
    border-color: var(--primary);
}

.menu-order-item.dragging {
    opacity: 0.5;
    border-color: var(--primary);
    cursor: grabbing;
}

.menu-order-item .drag-handle {
    color: var(--text-muted);
}

.menu-order-item span:nth-child(2) {
    flex: 1;
    font-weight: 600;
}

/* Toggle Switch */
.toggle-switch {
    position: relative;
    width: 44px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: var(--secondary);
    border-radius: 24px;
    transition: 0.3s;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    right: 3px;
    bottom: 3px;
    background: white;
    border-radius: 50%;
    transition: 0.3s;
}

.toggle-switch input:checked + .toggle-slider {
    background: var(--success);
}

.toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(-20px);
}

/* Menu Editor Styles */
.menu-editor {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.menu-section {
    background: var(--bg-main);
    border-radius: var(--radius);
    overflow: hidden;
    border: 2px solid transparent;
    transition: all 0.2s;
}

.menu-section.dragging {
    opacity: 0.5;
    border-color: var(--primary);
}

.menu-section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 15px;
    background: var(--bg-main);
    cursor: grab;
}

.menu-section-header:hover {
    background: rgba(30, 136, 229, 0.05);
}

.menu-section-header .section-name {
    flex: 1;
    font-weight: 700;
    font-size: 15px;
}

.menu-section-header .expand-btn {
    cursor: pointer;
    transition: transform 0.3s;
    color: var(--text-muted);
}

.menu-section.expanded .expand-btn {
    transform: rotate(180deg);
}

.menu-section-items {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    background: var(--bg-card);
}

.menu-section.expanded .menu-section-items {
    max-height: 500px;
}

.menu-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 15px 12px 40px;
    border-top: 1px solid var(--border-color);
    cursor: grab;
    transition: all 0.2s;
}

.menu-item:hover {
    background: rgba(30, 136, 229, 0.05);
}

.menu-item.dragging {
    opacity: 0.5;
    background: rgba(30, 136, 229, 0.1);
}

.menu-item .item-icon {
    color: var(--primary);
    font-size: 20px;
}

.menu-item span:nth-child(3) {
    flex: 1;
    font-weight: 500;
}

.menu-item .drag-handle {
    color: var(--text-muted);
    font-size: 18px;
}

.toggle-switch.small {
    width: 36px;
    height: 20px;
}

.toggle-switch.small .toggle-slider:before {
    height: 14px;
    width: 14px;
}

.toggle-switch.small input:checked + .toggle-slider:before {
    transform: translateX(-16px);
}
</style>

<script>
let draggedElement = null;
let dragType = null;
const menuEditor = document.getElementById('menuEditor');

// Toggle section expand/collapse
function toggleExpand(btn) {
    const section = btn.closest('.menu-section');
    section.classList.toggle('expanded');
}

// Setup drag for sections
document.querySelectorAll('.menu-section').forEach(section => {
    section.addEventListener('dragstart', function(e) {
        if (e.target.classList.contains('menu-item')) return;
        draggedElement = this;
        dragType = 'section';
        this.classList.add('dragging');
        e.stopPropagation();
    });
    
    section.addEventListener('dragend', function() {
        this.classList.remove('dragging');
        draggedElement = null;
        dragType = null;
    });
    
    section.addEventListener('dragover', function(e) {
        e.preventDefault();
        if (dragType === 'section' && draggedElement && draggedElement !== this) {
            const sections = [...menuEditor.querySelectorAll('.menu-section')];
            const draggedIdx = sections.indexOf(draggedElement);
            const targetIdx = sections.indexOf(this);
            
            if (draggedIdx < targetIdx) {
                this.after(draggedElement);
            } else {
                this.before(draggedElement);
            }
        }
    });
});

// Setup drag for items
document.querySelectorAll('.menu-item').forEach(item => {
    item.addEventListener('dragstart', function(e) {
        draggedElement = this;
        dragType = 'item';
        this.classList.add('dragging');
        e.stopPropagation();
    });
    
    item.addEventListener('dragend', function() {
        this.classList.remove('dragging');
        draggedElement = null;
        dragType = null;
    });
    
    item.addEventListener('dragover', function(e) {
        e.preventDefault();
        if (dragType === 'item' && draggedElement && draggedElement !== this) {
            const container = this.closest('.menu-section-items');
            const items = [...container.querySelectorAll('.menu-item')];
            const draggedIdx = items.indexOf(draggedElement);
            const targetIdx = items.indexOf(this);
            
            if (draggedIdx < targetIdx) {
                this.after(draggedElement);
            } else {
                this.before(draggedElement);
            }
        }
    });
});

// Load saved config on page load and apply to editor
document.addEventListener('DOMContentLoaded', function() {
    // Load menu config from PHP (database) - this is per-user from the server
    const config = <?= json_encode($menuConfig ?? null, JSON_UNESCAPED_UNICODE) ?> || {};
    
    console.log('Settings editor loading config from server:', config);
    
    // Apply section order
    if (config.sectionOrder && config.sectionOrder.length > 0) {
        config.sectionOrder.forEach(sectionId => {
            const section = menuEditor.querySelector(`[data-section="${sectionId}"]`);
            if (section) menuEditor.appendChild(section);
        });
    }
    
    // Apply item order per section (move items from any section to target section)
    if (config.itemOrder) {
        Object.keys(config.itemOrder).forEach(sectionId => {
            const section = menuEditor.querySelector(`[data-section="${sectionId}"]`);
            const itemsContainer = section?.querySelector('.menu-section-items');
            if (itemsContainer && config.itemOrder[sectionId]) {
                config.itemOrder[sectionId].forEach(itemId => {
                    // Search in entire editor, not just current section
                    const item = menuEditor.querySelector(`[data-item="${itemId}"]`);
                    if (item) itemsContainer.appendChild(item);
                });
            }
        });
    }
    
    // Apply visibility (uncheck hidden items)
    if (config.hidden) {
        config.hidden.sections?.forEach(id => {
            const checkbox = document.querySelector(`#menuEditor input[data-type="section"][data-id="${id}"]`);
            if (checkbox) checkbox.checked = false;
        });
        config.hidden.items?.forEach(id => {
            const checkbox = document.querySelector(`#menuEditor input[data-type="item"][data-id="${id}"]`);
            if (checkbox) checkbox.checked = false;
        });
    }
});

function saveFullMenuConfig() {
    const config = {
        sectionOrder: [],
        itemOrder: {},
        hidden: { sections: [], items: [] }
    };
    
    // Collect section order
    document.querySelectorAll('#menuEditor .menu-section').forEach(section => {
        const sectionId = section.dataset.section;
        if (sectionId) {
            config.sectionOrder.push(sectionId);
            
            // Collect item order for this section
            config.itemOrder[sectionId] = [];
            section.querySelectorAll('.menu-item').forEach(item => {
                if (item.dataset.item) {
                    config.itemOrder[sectionId].push(item.dataset.item);
                }
            });
        }
    });
    
    // Collect hidden sections and items
    document.querySelectorAll('#menuEditor input[data-type="section"]').forEach(checkbox => {
        if (!checkbox.checked && checkbox.dataset.id) {
            config.hidden.sections.push(checkbox.dataset.id);
        }
    });
    document.querySelectorAll('#menuEditor input[data-type="item"]').forEach(checkbox => {
        if (!checkbox.checked && checkbox.dataset.id) {
            config.hidden.items.push(checkbox.dataset.id);
        }
    });
    
    console.log('Saving menu config to server:', config);
    
    // Save to server
    fetch('<?= url('/settings/menu-config') ?>', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('تم حفظ إعدادات القائمة بنجاح!');
            location.reload();
        } else {
            alert('خطأ: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ في حفظ الإعدادات');
    });
}

function resetFullMenuConfig() {
    // Reset by saving empty config
    fetch('<?= url('/settings/menu-config') ?>', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        // Also clear localStorage
        localStorage.removeItem('menuConfig');
        localStorage.removeItem('menuOrder');
        localStorage.removeItem('hiddenSections');
        localStorage.removeItem('openSections');
        alert('تم إعادة تعيين القائمة للإعدادات الافتراضية');
        location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ في إعادة التعيين');
    });
}

// ══════════════════════════════════════════════════════════════════
// إعدادات المظهر
// ══════════════════════════════════════════════════════════════════

function switchThemeMode(mode) {
    const darkModeInput = document.getElementById('themeDarkMode');
    const lightModeColors = document.getElementById('lightModeColors');
    const darkModeColors = document.getElementById('darkModeColors');
    
    if (mode === 'dark') {
        darkModeInput.value = '1';
        lightModeColors.style.display = 'none';
        darkModeColors.style.display = 'block';
    } else {
        darkModeInput.value = '0';
        lightModeColors.style.display = 'block';
        darkModeColors.style.display = 'none';
    }
}

function getThemeValues() {
    const isDarkMode = document.getElementById('themeDarkMode').value === '1';
    
    return {
        dark_mode: isDarkMode,
        // ألوان الوضع النهاري
        primary_color: document.getElementById('themePrimaryColor').value,
        sidebar_color: document.getElementById('themeSidebarColor').value,
        sidebar_text_color: document.getElementById('themeSidebarTextColor').value,
        bg_color: document.getElementById('themeBgColor').value,
        card_color: document.getElementById('themeCardColor').value,
        text_color: document.getElementById('themeTextColor').value,
        section_header_color: document.getElementById('themeSectionHeaderColor').value,
        secondary_color: document.getElementById('themeSecondaryColor').value,
        border_color: document.getElementById('themeBorderColor').value,
        text_secondary_color: document.getElementById('themeTextSecondaryColor').value,
        // ألوان الوضع الليلي
        dark_primary_color: document.getElementById('themeDarkPrimaryColor').value,
        dark_sidebar_color: document.getElementById('themeDarkSidebarColor').value,
        dark_sidebar_text_color: document.getElementById('themeDarkSidebarTextColor').value,
        dark_bg_color: document.getElementById('themeDarkBgColor').value,
        dark_card_color: document.getElementById('themeDarkCardColor').value,
        dark_text_color: document.getElementById('themeDarkTextColor').value,
        dark_section_header_color: document.getElementById('themeDarkSectionHeaderColor').value,
        dark_secondary_color: document.getElementById('themeDarkSecondaryColor').value,
        dark_border_color: document.getElementById('themeDarkBorderColor').value,
        dark_text_secondary_color: document.getElementById('themeDarkTextSecondaryColor').value
    };
}

function applyTheme(theme) {
    const root = document.documentElement;
    
    if (theme.primary_color) {
        root.style.setProperty('--primary', theme.primary_color);
    }
    if (theme.sidebar_color) {
        root.style.setProperty('--bg-sidebar', theme.sidebar_color);
    }
    if (theme.sidebar_text_color) {
        root.style.setProperty('--text-light', theme.sidebar_text_color);
    }
    if (theme.bg_color) {
        root.style.setProperty('--bg-main', theme.bg_color);
    }
    if (theme.card_color) {
        root.style.setProperty('--bg-card', theme.card_color);
    }
    if (theme.text_color) {
        root.style.setProperty('--text-primary', theme.text_color);
    }
    
    if (theme.dark_mode) {
        document.body.classList.add('dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
    }
}

function previewTheme() {
    const theme = getThemeValues();
    applyTheme(theme);
    alert('تم تطبيق المعاينة! اضغط "حفظ" لحفظ التغييرات أو أعد تحميل الصفحة للتراجع.');
}

function saveThemeConfig() {
    const theme = getThemeValues();
    
    console.log('Saving theme config:', theme);
    
    fetch('<?= url('/settings/theme-config') ?>', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(theme)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('تم حفظ إعدادات المظهر بنجاح!');
            location.reload();
        } else {
            alert('خطأ: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ في حفظ المظهر');
    });
}

function resetThemeConfig() {
    if (!confirm('هل تريد إعادة المظهر للإعدادات الافتراضية؟')) {
        return;
    }
    
    fetch('<?= url('/settings/theme-config') ?>', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        alert('تم إعادة المظهر للإعدادات الافتراضية');
        location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ في إعادة التعيين');
    });
}

function resetSystemAppearance() {
    if (!confirm('هل تريد إعادة المظهر الأساسي للنظام للإعدادات الافتراضية؟\n\nسيتم تعيين:\n- الوضع الليلي: مغلق\n- اللون الرئيسي: #1e88e5\n- لون القائمة: #1a237e')) {
        return;
    }
    
    // Create a form to submit the reset values
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '<?= url('/settings') ?>';
    
    // Default values
    const defaults = {
        'dark_mode': '0',
        'primary_color': '#1e88e5',
        'sidebar_color': '#1a237e'
    };
    
    for (const [key, value] of Object.entries(defaults)) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
    }
    
    document.body.appendChild(form);
    form.submit();
}
</script>



============================================================
FILE: app/Views/settings/installment.php
============================================================
<div class="page-header">
    <h2><span class="material-icons-round">credit_score</span> خطط التقسيط</h2>
    <div>
        <button class="btn btn-primary" onclick="showAddModal()"><span class="material-icons-round">add</span> إضافة خطة</button>
        <a href="<?= url('/settings') ?>" class="btn btn-secondary"><span class="material-icons-round">arrow_forward</span> رجوع</a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>اسم الخطة</th>
                        <th>عدد الأشهر</th>
                        <th>نسبة الزيادة</th>
                        <th>الحد الأدنى للمقدم</th>
                        <th>الحالة</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($plans as $plan): ?>
                    <tr>
                        <td><strong><?= $plan['name'] ?></strong></td>
                        <td><?= $plan['months'] ?> شهر</td>
                        <td><?= $plan['increase_percent'] ?>%</td>
                        <td><?= $plan['min_down_payment_percent'] ?>%</td>
                        <td><span class="badge badge-<?= $plan['is_active'] ? 'success' : 'secondary' ?>"><?= $plan['is_active'] ? 'نشط' : 'معطل' ?></span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick='editPlan(<?= json_encode($plan) ?>)'><span class="material-icons-round">edit</span></button>
                            <button class="btn btn-sm btn-danger" onclick='deletePlan(<?= $plan["id"] ?>, "<?= htmlspecialchars($plan["name"], ENT_QUOTES) ?>")'><span class="material-icons-round">delete</span></button>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal" id="planModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">إضافة خطة تقسيط</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="planForm" method="POST">
                <input type="hidden" id="planId" name="id">
                <div class="form-group">
                    <label>اسم الخطة *</label>
                    <input type="text" id="planName" name="name" class="form-control" required placeholder="مثال: 12 شهر">
                </div>
                <div class="form-group">
                    <label>عدد الأشهر *</label>
                    <input type="number" id="planMonths" name="months" class="form-control" min="1" max="60" required>
                </div>
                <div class="form-group">
                    <label>نسبة الزيادة % *</label>
                    <input type="number" id="planIncrease" name="increase_percent" class="form-control" step="0.01" min="0" required>
                    <small>مثال: 15 يعني 15% زيادة على السعر النقدي</small>
                </div>
                <div class="form-group">
                    <label>الحد الأدنى للدفعة المقدمة %</label>
                    <input type="number" id="planMinDown" name="min_down_payment_percent" class="form-control" step="0.01" min="0" value="0">
                    <small>مثال: 20 يعني 20% كحد أدنى للمقدم</small>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="planActive" name="is_active" value="1" checked>
                        خطة نشطة
                    </label>
                </div>
                <button type="submit" class="btn btn-primary btn-block">حفظ</button>
            </form>
        </div>
    </div>
</div>

<style>.checkbox-label { display: flex; align-items: center; gap: 10px; cursor: pointer; } .checkbox-label input { width: 18px; height: 18px; }</style>

<script>
function showAddModal() {
    document.getElementById('modalTitle').textContent = 'إضافة خطة تقسيط';
    document.getElementById('planForm').action = '<?= url('/settings/installment') ?>';
    document.getElementById('planId').value = '';
    document.getElementById('planName').value = '';
    document.getElementById('planMonths').value = '';
    document.getElementById('planIncrease').value = '';
    document.getElementById('planMinDown').value = '0';
    document.getElementById('planActive').checked = true;
    document.getElementById('planModal').classList.add('show');
}

function editPlan(plan) {
    document.getElementById('modalTitle').textContent = 'تعديل خطة تقسيط';
    document.getElementById('planForm').action = '<?= url('/settings/installment/') ?>' + plan.id;
    document.getElementById('planId').value = plan.id;
    document.getElementById('planName').value = plan.name;
    document.getElementById('planMonths').value = plan.months;
    document.getElementById('planIncrease').value = plan.increase_percent;
    document.getElementById('planMinDown').value = plan.min_down_payment_percent;
    document.getElementById('planActive').checked = plan.is_active == 1;
    document.getElementById('planModal').classList.add('show');
}

function closeModal() { document.getElementById('planModal').classList.remove('show'); }

function deletePlan(id, name) {
    if (confirm('هل أنت متأكد من حذف خطة التقسيط "' + name + '"؟')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '<?= url('/settings/installment/') ?>' + id + '/delete';
        document.body.appendChild(form);
        form.submit();
    }
}
</script>


============================================================
FILE: app/Views/users/create.php
============================================================
<div class="page-header">
    <h2><span class="material-icons-round">person_add</span> إضافة مستخدم</h2>
    <a href="<?= url('/users') ?>" class="btn btn-secondary"><span class="material-icons-round">arrow_forward</span> رجوع</a>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST" action="<?= url('/users') ?>">
            <div class="form-grid">
                <div class="form-group">
                    <label>الاسم الكامل *</label>
                    <input type="text" name="full_name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>اسم المستخدم *</label>
                    <input type="text" name="username" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>كلمة المرور *</label>
                    <input type="password" name="password" class="form-control" required minlength="6">
                </div>
                <div class="form-group">
                    <label>رقم الهاتف</label>
                    <input type="tel" name="phone" class="form-control">
                </div>
                <div class="form-group">
                    <label>الدور</label>
                    <select name="role" class="form-control">
                        <option value="sales">موظف مبيعات</option>
                        <option value="accountant">محاسب</option>
                        <option value="admin">مدير</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="is_active" value="1" checked>
                        حساب نشط
                    </label>
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary"><span class="material-icons-round">save</span> حفظ</button>
                <a href="<?= url('/users') ?>" class="btn btn-secondary">إلغاء</a>
            </div>
        </form>
    </div>
</div>

<style>
.form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
.form-actions { margin-top: 25px; display: flex; gap: 15px; }
.checkbox-label { display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 30px; }
.checkbox-label input { width: 18px; height: 18px; }
</style>


============================================================
FILE: app/Views/users/edit.php
============================================================
<div class="page-header">
    <h2><span class="material-icons-round">edit</span> تعديل مستخدم: <?= $user['full_name'] ?></h2>
    <a href="<?= url('/users') ?>" class="btn btn-secondary"><span class="material-icons-round">arrow_forward</span> رجوع</a>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST" action="<?= url('/users/' . $user['id']) ?>">
            <div class="form-grid">
                <div class="form-group">
                    <label>الاسم الكامل *</label>
                    <input type="text" name="full_name" class="form-control" value="<?= $user['full_name'] ?>" required>
                </div>
                <div class="form-group">
                    <label>اسم المستخدم *</label>
                    <input type="text" name="username" class="form-control" value="<?= $user['username'] ?>" required>
                </div>
                <div class="form-group">
                    <label>كلمة مرور جديدة</label>
                    <input type="password" name="password" class="form-control" minlength="6" placeholder="اتركه فارغاً للإبقاء على الحالية">
                </div>
                <div class="form-group">
                    <label>رقم الهاتف</label>
                    <input type="tel" name="phone" class="form-control" value="<?= $user['phone'] ?>">
                </div>
                <div class="form-group">
                    <label>الدور</label>
                    <select name="role" class="form-control">
                        <option value="sales" <?= $user['role'] === 'sales' ? 'selected' : '' ?>>موظف مبيعات</option>
                        <option value="accountant" <?= $user['role'] === 'accountant' ? 'selected' : '' ?>>محاسب</option>
                        <option value="admin" <?= $user['role'] === 'admin' ? 'selected' : '' ?>>مدير</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="is_active" value="1" <?= $user['is_active'] ? 'checked' : '' ?>>
                        حساب نشط
                    </label>
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary"><span class="material-icons-round">save</span> حفظ التعديلات</button>
                <a href="<?= url('/users') ?>" class="btn btn-secondary">إلغاء</a>
            </div>
        </form>
    </div>
</div>

<style>
.form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
.form-actions { margin-top: 25px; display: flex; gap: 15px; }
.checkbox-label { display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 30px; }
.checkbox-label input { width: 18px; height: 18px; }
</style>


============================================================
FILE: app/Views/users/index.php
============================================================
<?php $exportUrl = url('/export/users'); ?>
<div class="page-header">
    <h2><span class="material-icons-round">people</span> إدارة المستخدمين</h2>
    <div class="header-actions">
        <?php include dirname(__DIR__) . '/partials/export_buttons.php'; ?>
        <a href="<?= url('/users/create') ?>" class="btn btn-primary"><span class="material-icons-round">add</span> إضافة مستخدم</a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <?php $selectionType = 'users'; $allowDelete = true; include dirname(__DIR__) . '/partials/table_selection.php'; ?>
        
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th class="select-checkbox"><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>
                        <th>الاسم</th>
                        <th>اسم المستخدم</th>
                        <th>الهاتف</th>
                        <th>الدور</th>
                        <th>الحالة</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($users as $user): ?>
                    <tr>
                        <td class="select-checkbox"><input type="checkbox" class="row-checkbox" data-id="<?= $user['id'] ?>" onclick="toggleRowSelect(this)"></td>
                        <td><strong><?= $user['full_name'] ?></strong></td>
                        <td><?= $user['username'] ?></td>
                        <td><?= $user['phone'] ?? '-' ?></td>
                        <td><span class="badge badge-<?= $user['role'] === 'admin' ? 'primary' : 'secondary' ?>"><?= userRole($user['role']) ?></span></td>
                        <td><span class="badge badge-<?= $user['is_active'] ? 'success' : 'danger' ?>"><?= $user['is_active'] ? 'نشط' : 'معطل' ?></span></td>
                        <td>
                            <a href="<?= url('/users/' . $user['id'] . '/edit') ?>" class="btn btn-sm btn-secondary"><span class="material-icons-round">edit</span></a>
                            <?php if ($user['id'] != $_SESSION['user_id']): ?>
                            <form method="POST" action="<?= url('/users/' . $user['id'] . '/delete') ?>" style="display:inline" onsubmit="return confirm('هل أنت متأكد؟')">
                                <button type="submit" class="btn btn-sm btn-danger"><span class="material-icons-round">delete</span></button>
                            </form>
                            <?php endif; ?>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
        
        <?php include dirname(__DIR__) . '/partials/pagination.php'; ?>
    </div>
</div>



============================================================
FILE: config/app.php
============================================================
<?php
/**
 * ╔══════════════════════════════════════════════════════════════════╗
 * ║                    نظام تقسيط - إعدادات التطبيق                   ║
 * ╚══════════════════════════════════════════════════════════════════╝
 */

return [
    // اسم التطبيق
    'name' => 'نظام تقسيط',
    
    // الإصدار
    'version' => '1.0.0',
    
    // وضع التطوير
    'debug' => true,
    
    // المنطقة الزمنية
    'timezone' => 'Africa/Cairo',
    
    // اللغة الافتراضية
    'locale' => 'ar',
    
    // مسار الجذر
    'base_path' => dirname(__DIR__),
    
    // مسار العام
    'public_path' => dirname(__DIR__) . '/public',
    
    // مسار التخزين
    'storage_path' => dirname(__DIR__) . '/storage',
    
    // مسار الرفع
    'upload_path' => dirname(__DIR__) . '/public/uploads',
    
    // الرابط الأساسي
    'base_url' => 'http://localhost/nizam-taqsit/public',
    
    // مفتاح التشفير
    'app_key' => 'nizam-taqsit-secret-key-2024',
    
    // إعدادات الجلسة
    'session' => [
        'name' => 'nizam_session',
        'lifetime' => 120, // بالدقائق
        'secure' => false,
        'httponly' => true,
    ],
];


============================================================
FILE: config/database.php
============================================================
<?php
/**
 * ╔══════════════════════════════════════════════════════════════════╗
 * ║                    نظام تقسيط - إعدادات قاعدة البيانات            ║
 * ╚══════════════════════════════════════════════════════════════════╝
 */

return [
    // نوع قاعدة البيانات
    'driver' => 'sqlite',
    
    // مسار ملف SQLite
    'database' => dirname(__DIR__) . '/database/database.sqlite',
    
    // إعدادات إضافية
    'options' => [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        PDO::ATTR_EMULATE_PREPARES => false,
    ],
];


============================================================
FILE: config/routes.php
============================================================
<?php
/**
 * ╔══════════════════════════════════════════════════════════════════╗
 * ║                    نظام تقسيط - المسارات                          ║
 * ╚══════════════════════════════════════════════════════════════════╝
 */

use Core\Router;

$router = new Router();

// ══════════════════════════════════════════════════════════════════
// المصادقة
// ══════════════════════════════════════════════════════════════════
$router->get('/login', 'AuthController@showLogin');
$router->post('/login', 'AuthController@login');
$router->get('/logout', 'AuthController@logout');

// ══════════════════════════════════════════════════════════════════
// لوحة التحكم
// ══════════════════════════════════════════════════════════════════
$router->get('/', 'DashboardController@index');
$router->get('/dashboard', 'DashboardController@index');
$router->get('/dashboard/stats', 'DashboardController@stats');

// ══════════════════════════════════════════════════════════════════
// المنتجات
// ══════════════════════════════════════════════════════════════════
$router->get('/products', 'ProductController@index');
$router->get('/products/create', 'ProductController@create');
$router->post('/products', 'ProductController@store');
$router->post('/products/bulk-delete', 'ProductController@bulkDelete');
$router->get('/products/search', 'ProductController@search');
$router->get('/products/barcode/{code}', 'ProductController@findByBarcode');
$router->get('/products/{id}', 'ProductController@show');
$router->get('/products/{id}/edit', 'ProductController@edit');
$router->post('/products/{id}', 'ProductController@update');
$router->post('/products/{id}/delete', 'ProductController@destroy');

// ══════════════════════════════════════════════════════════════════
// التصنيفات
// ══════════════════════════════════════════════════════════════════
$router->get('/categories', 'CategoryController@index');
$router->post('/categories', 'CategoryController@store');
// المسارات المحددة أولاً قبل {id}
$router->post('/categories/{id}/move-all', 'CategoryController@moveAllProducts');
$router->post('/categories/{id}/move-product', 'CategoryController@moveProduct');
$router->post('/categories/{id}/delete-product', 'CategoryController@deleteProduct');
$router->post('/categories/{id}/delete', 'CategoryController@destroy');
$router->post('/categories/{id}', 'CategoryController@update');
$router->get('/categories/{id}', 'CategoryController@show');

// ══════════════════════════════════════════════════════════════════
// العملاء
// ══════════════════════════════════════════════════════════════════
$router->get('/customers', 'CustomerController@index');
$router->get('/customers/create', 'CustomerController@create');
$router->post('/customers', 'CustomerController@store');
$router->post('/customers/store_ajax', 'CustomerController@storeAjax');
$router->post('/customers/bulk-delete', 'CustomerController@bulkDelete');
$router->get('/customers/{id}', 'CustomerController@show');
$router->get('/customers/{id}/edit', 'CustomerController@edit');
$router->post('/customers/{id}', 'CustomerController@update');
$router->post('/customers/{id}/delete', 'CustomerController@destroy');
$router->get('/customers/search', 'CustomerController@search');

// ══════════════════════════════════════════════════════════════════
// نقطة البيع
// ══════════════════════════════════════════════════════════════════
$router->get('/pos', 'InvoiceController@pos');
$router->post('/pos/cash', 'InvoiceController@storeCash');
$router->get('/pos/installment', 'InvoiceController@posInstallment');
$router->post('/pos/installment', 'InvoiceController@storeInstallment');
$router->get('/pos/calculate', 'InvoiceController@calculateInstallment');

// ══════════════════════════════════════════════════════════════════
// الفواتير
// ══════════════════════════════════════════════════════════════════
$router->get('/invoices', 'InvoiceController@index');
$router->post('/invoices/bulk-delete', 'InvoiceController@bulkDelete');
$router->get('/invoices/{id}', 'InvoiceController@show');
$router->get('/invoices/{id}/edit', 'InvoiceController@edit');
$router->post('/invoices/{id}', 'InvoiceController@update');
$router->get('/invoices/{id}/print', 'InvoiceController@print');
$router->get('/invoices/{id}/contract', 'InvoiceController@contract');
$router->post('/invoices/{id}/cancel', 'InvoiceController@cancel');
$router->post('/invoices/{id}/delete', 'InvoiceController@destroy');

// ══════════════════════════════════════════════════════════════════
// الأقساط
// ══════════════════════════════════════════════════════════════════
$router->get('/installments', 'InstallmentController@index');
$router->get('/installments/today', 'InstallmentController@today');
$router->get('/installments/overdue', 'InstallmentController@overdue');
$router->get('/installments/upcoming', 'InstallmentController@upcoming');
$router->get('/installments/{id}', 'InstallmentController@show');
$router->post('/installments/{id}/pay', 'InstallmentController@pay');

// ══════════════════════════════════════════════════════════════════
// المدفوعات
// ══════════════════════════════════════════════════════════════════
$router->get('/payments', 'PaymentController@index');
$router->get('/payments/{id}/receipt', 'PaymentController@receipt');

// ══════════════════════════════════════════════════════════════════
// التقارير
// ══════════════════════════════════════════════════════════════════
$router->get('/reports', 'ReportController@index');
$router->get('/reports/sales', 'ReportController@sales');
$router->get('/reports/collections', 'ReportController@collections');
$router->get('/reports/overdue', 'ReportController@overdue');
$router->get('/reports/customers', 'ReportController@customers');
$router->get('/reports/inventory', 'ReportController@inventory');
// التقارير المتقدمة
$router->get('/reports/profits', 'AdvancedReportController@profits');
$router->get('/reports/employees', 'AdvancedReportController@employees');
$router->get('/reports/cashflow', 'AdvancedReportController@cashflow');
$router->get('/reports/chart/sales', 'AdvancedReportController@salesChart');

// ══════════════════════════════════════════════════════════════════
// المستخدمين
// ══════════════════════════════════════════════════════════════════
$router->get('/users', 'UserController@index');
$router->get('/users/create', 'UserController@create');
$router->post('/users', 'UserController@store');
$router->get('/users/{id}/edit', 'UserController@edit');
$router->post('/users/{id}', 'UserController@update');
$router->post('/users/{id}/delete', 'UserController@destroy');

// ══════════════════════════════════════════════════════════════════
// الإعدادات
// ══════════════════════════════════════════════════════════════════
$router->get('/settings', 'SettingController@index');
$router->post('/settings', 'SettingController@update');
$router->get('/settings/installment', 'SettingController@installmentPlans');
$router->post('/settings/installment', 'SettingController@updateInstallmentPlan');
$router->post('/settings/installment/{id}', 'SettingController@updateInstallmentPlan');
$router->post('/settings/installment/{id}/delete', 'SettingController@deleteInstallmentPlan');
// إعدادات القائمة
$router->post('/settings/menu-config', 'SettingController@saveMenuConfig');
$router->get('/settings/menu-config', 'SettingController@fetchMenuConfig');
// إعدادات المظهر
$router->post('/settings/theme-config', 'SettingController@saveThemeConfig');
// النسخ الاحتياطي
$router->get('/settings/backup', 'BackupController@index');
$router->post('/settings/backup/create', 'BackupController@create');
$router->get('/settings/backup/download/{filename}', 'BackupController@download');
$router->post('/settings/backup/delete/{filename}', 'BackupController@delete');
$router->post('/settings/backup/restore', 'BackupController@restore');

// ══════════════════════════════════════════════════════════════════
// التنبيهات
// ══════════════════════════════════════════════════════════════════
$router->get('/notifications', 'NotificationController@index');
$router->post('/notifications/{id}/read', 'NotificationController@markAsRead');
$router->post('/notifications/read-all', 'NotificationController@markAllAsRead');

// ══════════════════════════════════════════════════════════════════
// API
// ══════════════════════════════════════════════════════════════════
$router->get('/api/products', 'ApiController@products');
$router->get('/api/products/{id}', 'ApiController@product');
$router->get('/api/customers', 'ApiController@customers');
$router->get('/api/customers/{id}', 'ApiController@customer');
$router->get('/api/invoices', 'ApiController@invoices');
$router->get('/api/installments', 'ApiController@installments');
$router->get('/api/installments/due', 'ApiController@dueInstallments');
$router->post('/api/auth/login', 'ApiController@login');
$router->post('/api/payments', 'ApiController@storePayment');

// ══════════════════════════════════════════════════════════════════
// API v2 (محمي بـ API Key)
// ══════════════════════════════════════════════════════════════════
// المنتجات
$router->get('/api/v2/products', 'Api\ApiV2Controller@products');
$router->get('/api/v2/products/{id}', 'Api\ApiV2Controller@product');
$router->post('/api/v2/products', 'Api\ApiV2Controller@createProduct');
$router->put('/api/v2/products/{id}', 'Api\ApiV2Controller@updateProduct');
$router->post('/api/v2/products/{id}/update', 'Api\ApiV2Controller@updateProduct');
$router->delete('/api/v2/products/{id}', 'Api\ApiV2Controller@deleteProduct');
$router->post('/api/v2/products/{id}/delete', 'Api\ApiV2Controller@deleteProduct');

// التصنيفات
$router->get('/api/v2/categories', 'Api\ApiV2Controller@categories');
$router->get('/api/v2/categories/{id}', 'Api\ApiV2Controller@category');
$router->post('/api/v2/categories', 'Api\ApiV2Controller@createCategory');
$router->put('/api/v2/categories/{id}', 'Api\ApiV2Controller@updateCategory');
$router->post('/api/v2/categories/{id}/update', 'Api\ApiV2Controller@updateCategory');
$router->delete('/api/v2/categories/{id}', 'Api\ApiV2Controller@deleteCategory');
$router->post('/api/v2/categories/{id}/delete', 'Api\ApiV2Controller@deleteCategory');

// العملاء
$router->get('/api/v2/customers', 'Api\ApiV2Controller@customers');
$router->get('/api/v2/customers/{id}', 'Api\ApiV2Controller@customer');
$router->post('/api/v2/customers', 'Api\ApiV2Controller@createCustomer');
$router->put('/api/v2/customers/{id}', 'Api\ApiV2Controller@updateCustomer');
$router->post('/api/v2/customers/{id}/update', 'Api\ApiV2Controller@updateCustomer');
$router->delete('/api/v2/customers/{id}', 'Api\ApiV2Controller@deleteCustomer');
$router->post('/api/v2/customers/{id}/delete', 'Api\ApiV2Controller@deleteCustomer');

// المستخدمين
$router->get('/api/v2/users', 'Api\ApiV2Controller@users');
$router->get('/api/v2/users/{id}', 'Api\ApiV2Controller@user');
$router->post('/api/v2/users', 'Api\ApiV2Controller@createUser');
$router->put('/api/v2/users/{id}', 'Api\ApiV2Controller@updateUser');
$router->post('/api/v2/users/{id}/update', 'Api\ApiV2Controller@updateUser');
$router->delete('/api/v2/users/{id}', 'Api\ApiV2Controller@deleteUser');
$router->post('/api/v2/users/{id}/delete', 'Api\ApiV2Controller@deleteUser');

// الفواتير
$router->get('/api/v2/invoices', 'Api\ApiV2Controller@invoices');
$router->get('/api/v2/invoices/{id}', 'Api\ApiV2Controller@invoice');

// الأقساط
$router->get('/api/v2/installments', 'Api\ApiV2Controller@installments');
$router->get('/api/v2/installments/today', 'Api\ApiV2Controller@installmentsToday');
$router->get('/api/v2/installments/overdue', 'Api\ApiV2Controller@installmentsOverdue');
$router->post('/api/v2/installments/{id}/pay', 'Api\ApiV2Controller@payInstallment');

// المدفوعات
$router->get('/api/v2/payments', 'Api\ApiV2Controller@payments');
$router->get('/api/v2/payments/{id}', 'Api\ApiV2Controller@payment');

// لوحة التحكم
$router->get('/api/v2/dashboard/stats', 'Api\ApiV2Controller@dashboardStats');

// ══════════════════════════════════════════════════════════════════
// إدارة API Keys
// ══════════════════════════════════════════════════════════════════
$router->get('/settings/api', 'ApiKeyController@index');
$router->post('/settings/api/generate', 'ApiKeyController@generate');
$router->post('/settings/api/{id}/update', 'ApiKeyController@update');
$router->post('/settings/api/{id}/toggle', 'ApiKeyController@toggle');
$router->post('/settings/api/{id}/delete', 'ApiKeyController@delete');


// ══════════════════════════════════════════════════════════════════
// التصدير PDF/Excel
// ══════════════════════════════════════════════════════════════════
$router->get('/export/products/{format}', 'ExportController@products');
$router->get('/export/customers/{format}', 'ExportController@customers');
$router->get('/export/invoices/{format}', 'ExportController@invoices');
$router->get('/export/installments/overdue/{format}', 'ExportController@overdueInstallments');
$router->get('/export/installments/today/{format}', 'ExportController@todayInstallments');
$router->get('/export/installments/{format}', 'ExportController@installments');
$router->get('/export/payments/{format}', 'ExportController@payments');
$router->get('/export/reports/sales/{format}', 'ExportController@salesReport');
$router->get('/export/reports/collections/{format}', 'ExportController@collectionsReport');
$router->get('/export/reports/overdue/{format}', 'ExportController@overdueReport');
$router->get('/export/reports/customers/{format}', 'ExportController@customersReport');
$router->get('/export/reports/inventory/{format}', 'ExportController@inventoryReport');
$router->get('/export/reports/profits/{format}', 'ExportController@profitsReport');
$router->get('/export/reports/employees/{format}', 'ExportController@employeesReport');
$router->get('/export/reports/cashflow/{format}', 'ExportController@cashflowReport');
$router->get('/export/users/{format}', 'ExportController@users');
$router->get('/export/categories/{format}', 'ExportController@categories');

return $router;


============================================================
FILE: core/ApiMiddleware.php
============================================================
<?php
namespace Core;

/**
 * ╔══════════════════════════════════════════════════════════════════╗
 * ║                    نظام تقسيط - API Middleware                    ║
 * ║                  التحقق من صحة API Key                           ║
 * ╚══════════════════════════════════════════════════════════════════╝
 */
class ApiMiddleware
{
    private Database $db;
    
    public function __construct()
    {
        $this->db = Database::getInstance();
    }
    
    /**
     * التحقق من API Key
     * @return array|false بيانات المفتاح أو false إذا فشل التحقق
     */
    public function authenticate(): array|false
    {
        // الحصول على API Key من الـ Header
        $apiKey = $this->getApiKeyFromRequest();
        
        if (!$apiKey) {
            return false;
        }
        
        // البحث عن المفتاح في قاعدة البيانات
        $keyData = $this->db->fetch(
            "SELECT * FROM api_keys WHERE api_key = ? AND is_active = 1",
            [$apiKey]
        );
        
        if (!$keyData) {
            return false;
        }
        
        // التحقق من انتهاء الصلاحية
        if ($keyData['expires_at'] && strtotime($keyData['expires_at']) < time()) {
            return false;
        }
        
        // تحديث آخر استخدام
        $this->db->update('api_keys', [
            'last_used_at' => date('Y-m-d H:i:s')
        ], 'id = ?', [$keyData['id']]);
        
        return $keyData;
    }
    
    /**
     * استخراج API Key من الطلب
     */
    private function getApiKeyFromRequest(): ?string
    {
        // من Header - البحث بشكل غير حساس لحالة الأحرف
        $headers = $this->getRequestHeaders();
        
        // تحويل كل مفاتيح الـ Headers إلى حالة صغيرة للمقارنة
        $headersLower = array_change_key_case($headers, CASE_LOWER);
        
        if (isset($headersLower['x-api-key'])) {
            return $headersLower['x-api-key'];
        }
        
        // محاولة أخرى من $_SERVER مباشرة
        if (isset($_SERVER['HTTP_X_API_KEY'])) {
            return $_SERVER['HTTP_X_API_KEY'];
        }
        
        // من Query Parameter (للاختبار فقط)
        if (isset($_GET['api_key'])) {
            return $_GET['api_key'];
        }
        
        return null;
    }
    
    /**
     * الحصول على headers الطلب
     */
    private function getRequestHeaders(): array
    {
        $headers = [];
        
        if (function_exists('getallheaders')) {
            $headers = getallheaders();
        } else {
            foreach ($_SERVER as $key => $value) {
                if (substr($key, 0, 5) === 'HTTP_') {
                    $header = str_replace(' ', '-', ucwords(str_replace('_', ' ', strtolower(substr($key, 5)))));
                    $headers[$header] = $value;
                }
            }
        }
        
        return $headers;
    }
    
    /**
     * إرجاع خطأ عدم المصادقة
     */
    public function unauthorized(string $message = 'مفتاح API غير صالح أو مفقود'): void
    {
        http_response_code(401);
        header('Content-Type: application/json; charset=utf-8');
        echo json_encode([
            'success' => false,
            'error' => $message,
            'error_code' => 'UNAUTHORIZED'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    /**
     * التحقق من صلاحية معينة
     */
    public function hasPermission(array $keyData, string $permission): bool
    {
        if (empty($keyData['permissions'])) {
            return true; // إذا لم يتم تحديد صلاحيات، السماح بالكل
        }
        
        $permissions = json_decode($keyData['permissions'], true);
        
        if (!is_array($permissions)) {
            return true;
        }
        
        return in_array($permission, $permissions) || in_array('*', $permissions);
    }
    
    /**
     * إنشاء مفتاح API جديد
     */
    public static function generateApiKey(): string
    {
        return bin2hex(random_bytes(32)); // 64 character hex string
    }
}


============================================================
FILE: core/Application.php
============================================================
<?php
namespace Core;

/**
 * ╔══════════════════════════════════════════════════════════════════╗
 * ║                    نظام تقسيط - كلاس التطبيق                      ║
 * ╚══════════════════════════════════════════════════════════════════╝
 */
class Application
{
    private static ?Application $instance = null;
    private array $config;
    private Router $router;
    private Database $db;
    
    /**
     * إنشاء التطبيق
     */
    public function __construct()
    {
        self::$instance = $this;
        $this->loadConfig();
        $this->initTimezone();
        $this->initSession();
        $this->initDatabase();
    }
    
    /**
     * الحصول على نسخة التطبيق
     */
    public static function getInstance(): ?Application
    {
        return self::$instance;
    }
    
    /**
     * تحميل الإعدادات
     */
    private function loadConfig(): void
    {
        $this->config = require dirname(__DIR__) . '/config/app.php';
    }
    
    /**
     * تهيئة المنطقة الزمنية
     */
    private function initTimezone(): void
    {
        date_default_timezone_set($this->config['timezone'] ?? 'Africa/Cairo');
    }
    
    /**
     * تهيئة الجلسة
     */
    private function initSession(): void
    {
        if (session_status() === PHP_SESSION_NONE) {
            $sessionConfig = $this->config['session'] ?? [];
            
            session_name($sessionConfig['name'] ?? 'nizam_session');
            session_set_cookie_params([
                'lifetime' => ($sessionConfig['lifetime'] ?? 120) * 60,
                'secure' => $sessionConfig['secure'] ?? false,
                'httponly' => $sessionConfig['httponly'] ?? true,
                'samesite' => 'Lax'
            ]);
            
            session_start();
        }
    }
    
    /**
     * تهيئة قاعدة البيانات
     */
    private function initDatabase(): void
    {
        $this->db = Database::getInstance();
    }
    
    /**
     * الحصول على الإعدادات
     */
    public function getConfig(string $key = null)
    {
        if ($key === null) {
            return $this->config;
        }
        return $this->config[$key] ?? null;
    }
    
    /**
     * الحصول على قاعدة البيانات
     */
    public function getDb(): Database
    {
        return $this->db;
    }
    
    /**
     * تشغيل التطبيق
     */
    public function run(): void
    {
        try {
            // تحميل المسارات
            $this->router = require dirname(__DIR__) . '/config/routes.php';
            
            // معالجة الطلب
            $this->router->dispatch();
            
        } catch (\Exception $e) {
            $this->handleException($e);
        }
    }
    
    /**
     * معالجة الاستثناءات
     */
    private function handleException(\Exception $e): void
    {
        if ($this->config['debug'] ?? false) {
            echo '<div dir="rtl" style="font-family: Arial; padding: 20px; background: #fee; border: 1px solid #f00; margin: 20px;">';
            echo '<h2 style="color: #c00;">خطأ في النظام</h2>';
            echo '<p><strong>الرسالة:</strong> ' . htmlspecialchars($e->getMessage()) . '</p>';
            echo '<p><strong>الملف:</strong> ' . $e->getFile() . '</p>';
            echo '<p><strong>السطر:</strong> ' . $e->getLine() . '</p>';
            echo '<pre>' . htmlspecialchars($e->getTraceAsString()) . '</pre>';
            echo '</div>';
        } else {
            // صفحة خطأ عامة
            http_response_code(500);
            include dirname(__DIR__) . '/app/Views/errors/500.php';
        }
        
        // تسجيل الخطأ
        $this->logError($e);
    }
    
    /**
     * تسجيل الخطأ
     */
    private function logError(\Exception $e): void
    {
        $logPath = dirname(__DIR__) . '/storage/logs/error.log';
        $message = sprintf(
            "[%s] %s in %s:%d\n%s\n\n",
            date('Y-m-d H:i:s'),
            $e->getMessage(),
            $e->getFile(),
            $e->getLine(),
            $e->getTraceAsString()
        );
        
        file_put_contents($logPath, $message, FILE_APPEND);
    }
}


============================================================
FILE: core/BaseApiController.php
============================================================
<?php
namespace Core;

/**
 * ╔══════════════════════════════════════════════════════════════════╗
 * ║                    نظام تقسيط - Base API Controller               ║
 * ║            Controller أساسي لجميع نقاط نهاية API                  ║
 * ╚══════════════════════════════════════════════════════════════════╝
 */
abstract class BaseApiController
{
    protected Database $db;
    protected ?array $apiKey = null;
    
    public function __construct()
    {
        $this->db = Database::getInstance();
        $this->setupHeaders();
        $this->authenticate();
    }
    
    /**
     * إعداد Headers للـ API
     */
    protected function setupHeaders(): void
    {
        header('Content-Type: application/json; charset=utf-8');
        header('Access-Control-Allow-Origin: *');
        header('Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS');
        header('Access-Control-Allow-Headers: Content-Type, X-API-KEY, Authorization');
        
        // Handle preflight requests
        if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
            http_response_code(200);
            exit;
        }
    }
    
    /**
     * التحقق من API Key
     */
    protected function authenticate(): void
    {
        $middleware = new ApiMiddleware();
        $keyData = $middleware->authenticate();
        
        if (!$keyData) {
            $middleware->unauthorized();
        }
        
        $this->apiKey = $keyData;
    }
    
    /**
     * إرجاع استجابة ناجحة
     */
    protected function success(mixed $data = null, ?string $message = null, int $status = 200): void
    {
        http_response_code($status);
        $response = ['success' => true];
        
        if ($message) {
            $response['message'] = $message;
        }
        
        if ($data !== null) {
            $response['data'] = $data;
        }
        
        echo json_encode($response, JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    /**
     * إرجاع استجابة مع Pagination
     */
    protected function paginated(array $data, int $total, int $page, int $perPage): void
    {
        http_response_code(200);
        echo json_encode([
            'success' => true,
            'data' => $data,
            'pagination' => [
                'total' => $total,
                'page' => $page,
                'per_page' => $perPage,
                'total_pages' => ceil($total / $perPage)
            ]
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    /**
     * إرجاع خطأ
     */
    protected function error(string $message, int $status = 400, ?string $errorCode = null): void
    {
        http_response_code($status);
        $response = [
            'success' => false,
            'error' => $message
        ];
        
        if ($errorCode) {
            $response['error_code'] = $errorCode;
        }
        
        echo json_encode($response, JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    /**
     * خطأ 404
     */
    protected function notFound(string $message = 'المورد غير موجود'): void
    {
        $this->error($message, 404, 'NOT_FOUND');
    }
    
    /**
     * خطأ التحقق
     */
    protected function validationError(array $errors): void
    {
        http_response_code(422);
        echo json_encode([
            'success' => false,
            'error' => 'خطأ في البيانات المدخلة',
            'error_code' => 'VALIDATION_ERROR',
            'errors' => $errors
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    /**
     * الحصول على بيانات JSON من الطلب
     */
    protected function getJsonInput(): array
    {
        $input = file_get_contents('php://input');
        $data = json_decode($input, true);
        return is_array($data) ? $data : [];
    }
    
    /**
     * الحصول على قيمة من الإدخال
     */
    protected function input(string $key, mixed $default = null): mixed
    {
        $jsonData = $this->getJsonInput();
        return $jsonData[$key] ?? $_POST[$key] ?? $_GET[$key] ?? $default;
    }
    
    /**
     * الحصول على معلمات Pagination
     */
    protected function getPagination(int $defaultPerPage = 20): array
    {
        $page = max(1, (int) ($_GET['page'] ?? 1));
        $perPage = min(100, max(1, (int) ($_GET['per_page'] ?? $defaultPerPage)));
        $offset = ($page - 1) * $perPage;
        
        return [
            'page' => $page,
            'per_page' => $perPage,
            'offset' => $offset
        ];
    }
    
    /**
     * تسجيل نشاط API
     */
    protected function logApiActivity(string $action, ?string $entityType = null, ?int $entityId = null): void
    {
        $this->db->insert('activity_log', [
            'user_id' => $this->apiKey['created_by'] ?? 0,
            'action' => 'api_' . $action,
            'entity_type' => $entityType,
            'entity_id' => $entityId,
            'description' => 'API: ' . $action,
            'ip_address' => $_SERVER['REMOTE_ADDR'] ?? null,
        ]);
    }
}


============================================================
FILE: core/Controller.php
============================================================
<?php
namespace Core;

/**
 * ╔══════════════════════════════════════════════════════════════════╗
 * ║                    نظام تقسيط - المتحكم الأساسي                   ║
 * ╚══════════════════════════════════════════════════════════════════╝
 */
abstract class Controller
{
    protected Database $db;
    protected array $data = [];
    
    public function __construct()
    {
        $this->db = Database::getInstance();
        $this->data['user'] = $this->getCurrentUser();
        $this->data['settings'] = $this->getSettings();
        $this->data['menuConfig'] = $this->getMenuConfig();
        $this->data['themeConfig'] = $this->getThemeConfig();
    }
    
    /**
     * عرض صفحة
     */
    protected function view(string $view, array $data = []): void
    {
        // منع التخزين المؤقت للمتصفح
        header('Cache-Control: no-store, no-cache, must-revalidate, max-age=0');
        header('Cache-Control: post-check=0, pre-check=0', false);
        header('Pragma: no-cache');
        header('Expires: Thu, 01 Jan 1970 00:00:00 GMT');
        
        $data = array_merge($this->data, $data);
        extract($data);
        
        $viewPath = dirname(__DIR__) . "/app/Views/{$view}.php";
        
        if (!file_exists($viewPath)) {
            throw new \Exception("عرض غير موجود: {$view}");
        }
        
        // بدء التخزين المؤقت
        ob_start();
        include $viewPath;
        $content = ob_get_clean();
        
        // عرض القالب الرئيسي
        $layoutPath = dirname(__DIR__) . '/app/Views/layouts/master.php';
        if (file_exists($layoutPath)) {
            include $layoutPath;
        } else {
            echo $content;
        }
    }
    
    /**
     * عرض صفحة بدون قالب
     */
    protected function viewOnly(string $view, array $data = []): void
    {
        $data = array_merge($this->data, $data);
        extract($data);
        
        $viewPath = dirname(__DIR__) . "/app/Views/{$view}.php";
        
        if (!file_exists($viewPath)) {
            throw new \Exception("عرض غير موجود: {$view}");
        }
        
        include $viewPath;
    }
    
    /**
     * إرسال JSON
     */
    protected function json(mixed $data, int $status = 200): void
    {
        http_response_code($status);
        header('Content-Type: application/json; charset=utf-8');
        echo json_encode($data, JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    /**
     * إعادة توجيه
     */
    protected function redirect(string $url, array $flash = []): void
    {
        if (!empty($flash)) {
            foreach ($flash as $key => $value) {
                $_SESSION['flash'][$key] = $value;
            }
        }
        
        header("Location: {$url}");
        exit;
    }
    
    /**
     * رسالة نجاح
     */
    protected function success(string $message): void
    {
        $_SESSION['flash']['success'] = $message;
    }
    
    /**
     * رسالة خطأ
     */
    protected function error(string $message): void
    {
        $_SESSION['flash']['error'] = $message;
    }
    
    /**
     * الحصول على رسالة Flash
     */
    protected function getFlash(string $key): ?string
    {
        $message = $_SESSION['flash'][$key] ?? null;
        unset($_SESSION['flash'][$key]);
        return $message;
    }
    
    /**
     * التحقق من تسجيل الدخول
     */
    protected function requireAuth(): void
    {
        if (!isset($_SESSION['user_id'])) {
            $this->redirect(url('/login'));
        }
    }
    
    /**
     * التحقق من الصلاحية
     */
    protected function requireRole(string|array $roles): void
    {
        $this->requireAuth();
        
        $userRole = $_SESSION['user_role'] ?? '';
        $roles = is_array($roles) ? $roles : [$roles];
        
        if (!in_array($userRole, $roles)) {
            // إذا كان AJAX request، أرسل JSON
            if ($this->isAjax()) {
                $this->json(['success' => false, 'message' => 'ليس لديك صلاحية لهذا الإجراء'], 403);
            }
            $this->error('ليس لديك صلاحية للوصول لهذه الصفحة');
            $this->redirect('/dashboard');
        }
    }
    
    /**
     * التحقق من أن الطلب AJAX
     */
    protected function isAjax(): bool
    {
        return isset($_SERVER['HTTP_X_REQUESTED_WITH']) && 
               strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) === 'xmlhttprequest';
    }
    
    /**
     * الحصول على المستخدم الحالي
     */
    protected function getCurrentUser(): ?array
    {
        if (!isset($_SESSION['user_id'])) {
            return null;
        }
        
        return $this->db->fetch(
            "SELECT id, username, full_name, role FROM users WHERE id = ?",
            [$_SESSION['user_id']]
        );
    }
    
    /**
     * الحصول على الإعدادات
     */
    protected function getSettings(): array
    {
        $rows = $this->db->fetchAll("SELECT setting_key, setting_value FROM settings");
        $settings = [];
        foreach ($rows as $row) {
            $settings[$row['setting_key']] = $row['setting_value'];
        }
        return $settings;
    }
    
    /**
     * الحصول على إعدادات القائمة للمستخدم الحالي
     */
    protected function getMenuConfig(): ?array
    {
        if (!isset($_SESSION['user_id'])) {
            return null;
        }
        
        $user = $this->db->fetch(
            "SELECT menu_config FROM users WHERE id = ?",
            [$_SESSION['user_id']]
        );
        
        if ($user && !empty($user['menu_config'])) {
            return json_decode($user['menu_config'], true);
        }
        
        return null;
    }
    
    /**
     * الحصول على إعدادات المظهر للمستخدم الحالي
     */
    protected function getThemeConfig(): ?array
    {
        if (!isset($_SESSION['user_id'])) {
            return null;
        }
        
        $user = $this->db->fetch(
            "SELECT theme_config FROM users WHERE id = ?",
            [$_SESSION['user_id']]
        );
        
        if ($user && !empty($user['theme_config'])) {
            return json_decode($user['theme_config'], true);
        }
        
        return null;
    }
    
    /**
     * الحصول على قيمة من الطلب
     */
    protected function input(string $key, mixed $default = null): mixed
    {
        return $_POST[$key] ?? $_GET[$key] ?? $default;
    }
    
    /**
     * الحصول على كل بيانات الطلب
     */
    protected function all(): array
    {
        return array_merge($_GET, $_POST);
    }
    
    /**
     * التحقق من البيانات
     */
    protected function validate(array $rules): array
    {
        $errors = [];
        $data = [];
        
        foreach ($rules as $field => $rule) {
            $value = $this->input($field);
            $rulesList = explode('|', $rule);
            
            foreach ($rulesList as $r) {
                if ($r === 'required' && empty($value)) {
                    $errors[$field] = "الحقل {$field} مطلوب";
                    break;
                }
                
                if (!empty($value)) {
                    if ($r === 'numeric' && !is_numeric($value)) {
                        $errors[$field] = "الحقل {$field} يجب أن يكون رقماً";
                    }
                    
                    if ($r === 'email' && !filter_var($value, FILTER_VALIDATE_EMAIL)) {
                        $errors[$field] = "البريد الإلكتروني غير صالح";
                    }
                    
                    if (preg_match('/^min:(\d+)$/', $r, $matches) && strlen($value) < $matches[1]) {
                        $errors[$field] = "الحقل {$field} يجب أن يكون {$matches[1]} أحرف على الأقل";
                    }
                    
                    if (preg_match('/^max:(\d+)$/', $r, $matches) && strlen($value) > $matches[1]) {
                        $errors[$field] = "الحقل {$field} يجب ألا يتجاوز {$matches[1]} حرفاً";
                    }
                }
            }
            
            $data[$field] = $value;
        }
        
        if (!empty($errors)) {
            $_SESSION['errors'] = $errors;
            $_SESSION['old'] = $data;
        }
        
        return ['errors' => $errors, 'data' => $data];
    }
    
    /**
     * تسجيل نشاط
     */
    protected function logActivity(string $action, string $entityType = null, int $entityId = null, string $description = null): void
    {
        if (!isset($_SESSION['user_id'])) {
            return;
        }
        
        $this->db->insert('activity_log', [
            'user_id' => $_SESSION['user_id'],
            'action' => $action,
            'entity_type' => $entityType,
            'entity_id' => $entityId,
            'description' => $description,
            'ip_address' => $_SERVER['REMOTE_ADDR'] ?? null,
        ]);
    }
}


============================================================
FILE: core/Database.php
============================================================
<?php
namespace Core;

/**
 * ╔══════════════════════════════════════════════════════════════════╗
 * ║                    نظام تقسيط - كلاس قاعدة البيانات               ║
 * ╚══════════════════════════════════════════════════════════════════╝
 */
class Database
{
    private static ?Database $instance = null;
    private \PDO $pdo;
    
    /**
     * إنشاء الاتصال
     */
    private function __construct()
    {
        $config = require dirname(__DIR__) . '/config/database.php';
        
        $dbPath = $config['database'];
        $isNew = !file_exists($dbPath);
        
        // إنشاء مجلد قاعدة البيانات إن لم يكن موجوداً
        $dbDir = dirname($dbPath);
        if (!is_dir($dbDir)) {
            mkdir($dbDir, 0755, true);
        }
        
        // الاتصال بقاعدة البيانات
        $this->pdo = new \PDO(
            "sqlite:{$dbPath}",
            null,
            null,
            $config['options']
        );
        
        // تفعيل المفاتيح الأجنبية
        $this->pdo->exec('PRAGMA foreign_keys = ON');
        
        // إنشاء الجداول إن كانت قاعدة البيانات جديدة
        if ($isNew) {
            $this->initSchema();
        }
    }
    
    /**
     * الحصول على النسخة الوحيدة
     */
    public static function getInstance(): Database
    {
        if (self::$instance === null) {
            self::$instance = new self();
        }
        return self::$instance;
    }
    
    /**
     * تهيئة الجداول
     */
    private function initSchema(): void
    {
        $schemaPath = dirname(__DIR__) . '/database/schema.sql';
        $seedsPath = dirname(__DIR__) . '/database/seeds.sql';
        
        if (file_exists($schemaPath)) {
            $sql = file_get_contents($schemaPath);
            $this->pdo->exec($sql);
        }
        
        if (file_exists($seedsPath)) {
            $sql = file_get_contents($seedsPath);
            $this->pdo->exec($sql);
        }
    }
    
    /**
     * تنفيذ استعلام
     */
    public function query(string $sql, array $params = []): \PDOStatement
    {
        $stmt = $this->pdo->prepare($sql);
        $stmt->execute($params);
        return $stmt;
    }
    
    /**
     * جلب صف واحد
     */
    public function fetch(string $sql, array $params = []): ?array
    {
        $stmt = $this->query($sql, $params);
        $result = $stmt->fetch();
        return $result ?: null;
    }
    
    /**
     * جلب كل الصفوف
     */
    public function fetchAll(string $sql, array $params = []): array
    {
        $stmt = $this->query($sql, $params);
        return $stmt->fetchAll();
    }
    
    /**
     * جلب عمود واحد
     */
    public function fetchColumn(string $sql, array $params = []): mixed
    {
        $stmt = $this->query($sql, $params);
        return $stmt->fetchColumn();
    }
    
    /**
     * إدراج صف
     */
    public function insert(string $table, array $data): int
    {
        $columns = implode(', ', array_keys($data));
        $placeholders = ':' . implode(', :', array_keys($data));
        
        $sql = "INSERT INTO {$table} ({$columns}) VALUES ({$placeholders})";
        $this->query($sql, $data);
        
        return (int) $this->pdo->lastInsertId();
    }
    
    /**
     * تحديث صفوف
     */
    public function update(string $table, array $data, string $where, array $whereParams = []): int
    {
        $set = [];
        $values = [];
        foreach ($data as $column => $value) {
            $set[] = "{$column} = ?";
            $values[] = $value;
        }
        $setString = implode(', ', $set);
        
        $sql = "UPDATE {$table} SET {$setString} WHERE {$where}";
        $stmt = $this->query($sql, array_merge($values, $whereParams));
        
        return $stmt->rowCount();
    }
    
    /**
     * حذف صفوف
     */
    public function delete(string $table, string $where, array $params = []): int
    {
        $sql = "DELETE FROM {$table} WHERE {$where}";
        $stmt = $this->query($sql, $params);
        
        return $stmt->rowCount();
    }
    
    /**
     * بدء معاملة
     */
    public function beginTransaction(): bool
    {
        return $this->pdo->beginTransaction();
    }
    
    /**
     * تأكيد المعاملة
     */
    public function commit(): bool
    {
        return $this->pdo->commit();
    }
    
    /**
     * التراجع عن المعاملة
     */
    public function rollback(): bool
    {
        return $this->pdo->rollBack();
    }
    
    /**
     * الحصول على PDO
     */
    public function getPdo(): \PDO
    {
        return $this->pdo;
    }
    
    /**
     * آخر ID مُدرج
     */
    public function lastInsertId(): string
    {
        return $this->pdo->lastInsertId();
    }
}


============================================================
FILE: core/Pagination.php
============================================================
<?php
/**
 * كلاس الـ Pagination للتعدد الصفحات
 */

namespace Core;

class Pagination
{
    private int $totalItems;
    private int $perPage;
    private int $currentPage;
    private int $totalPages;
    
    public function __construct(int $totalItems, int $perPage = 10, int $currentPage = 1)
    {
        $this->totalItems = $totalItems;
        $this->perPage = max(1, $perPage);
        $this->currentPage = max(1, $currentPage);
        $this->totalPages = max(1, (int) ceil($totalItems / $this->perPage));
        
        // تصحيح الصفحة الحالية
        if ($this->currentPage > $this->totalPages) {
            $this->currentPage = $this->totalPages;
        }
    }
    
    public function getOffset(): int
    {
        return ($this->currentPage - 1) * $this->perPage;
    }
    
    public function getLimit(): int
    {
        return $this->perPage;
    }
    
    public function getCurrentPage(): int
    {
        return $this->currentPage;
    }
    
    public function getTotalPages(): int
    {
        return $this->totalPages;
    }
    
    public function getTotalItems(): int
    {
        return $this->totalItems;
    }
    
    public function getPerPage(): int
    {
        return $this->perPage;
    }
    
    public function hasNext(): bool
    {
        return $this->currentPage < $this->totalPages;
    }
    
    public function hasPrev(): bool
    {
        return $this->currentPage > 1;
    }
    
    public function getStartItem(): int
    {
        if ($this->totalItems === 0) return 0;
        return $this->getOffset() + 1;
    }
    
    public function getEndItem(): int
    {
        $end = $this->getOffset() + $this->perPage;
        return min($end, $this->totalItems);
    }
    
    /**
     * الحصول على أرقام الصفحات للعرض
     */
    public function getPageNumbers(int $range = 2): array
    {
        $pages = [];
        
        $start = max(1, $this->currentPage - $range);
        $end = min($this->totalPages, $this->currentPage + $range);
        
        // إضافة الصفحة الأولى
        if ($start > 1) {
            $pages[] = 1;
            if ($start > 2) {
                $pages[] = '...';
            }
        }
        
        // إضافة الصفحات في النطاق
        for ($i = $start; $i <= $end; $i++) {
            $pages[] = $i;
        }
        
        // إضافة الصفحة الأخيرة
        if ($end < $this->totalPages) {
            if ($end < $this->totalPages - 1) {
                $pages[] = '...';
            }
            $pages[] = $this->totalPages;
        }
        
        return $pages;
    }
    
    /**
     * إنشاء رابط مع الصفحة المحددة
     */
    public static function buildUrl(int $page, int $perPage, array $extraParams = []): string
    {
        $params = array_merge($_GET, ['page' => $page, 'per_page' => $perPage], $extraParams);
        return '?' . http_build_query($params);
    }
}


============================================================
FILE: core/Permission.php
============================================================
<?php
/**
 * Middleware للتحقق من الصلاحيات
 */

namespace Core;

class Permission
{
    private static array $permissions = [
        'admin' => ['*'],
        'accountant' => [
            'dashboard', 'pos', 'invoices', 'payments', 'installments',
            'customers.view', 'products.view', 'reports'
        ],
        'sales' => [
            'dashboard', 'pos', 'invoices.create', 'customers.create',
            'products.view', 'installments.view'
        ]
    ];

    /**
     * التحقق من صلاحية
     */
    public static function check(string $permission): bool
    {
        $role = $_SESSION['user_role'] ?? 'guest';
        
        if (!isset(self::$permissions[$role])) {
            return false;
        }

        $userPermissions = self::$permissions[$role];
        
        // المدير لديه كل الصلاحيات
        if (in_array('*', $userPermissions)) {
            return true;
        }

        // التحقق من الصلاحية المحددة
        if (in_array($permission, $userPermissions)) {
            return true;
        }

        // التحقق من الصلاحية الأساسية (مثل products من products.view)
        $basePerm = explode('.', $permission)[0];
        if (in_array($basePerm, $userPermissions)) {
            return true;
        }

        return false;
    }

    /**
     * التحقق والتوجيه إذا لم تتوفر الصلاحية
     */
    public static function require(string $permission): void
    {
        if (!self::check($permission)) {
            $_SESSION['flash']['error'] = 'ليس لديك صلاحية لهذا الإجراء';
            header('Location: ' . url('/'));
            exit;
        }
    }

    /**
     * الحصول على قائمة الصلاحيات للدور
     */
    public static function getForRole(string $role): array
    {
        return self::$permissions[$role] ?? [];
    }

    /**
     * تحديث صلاحيات دور
     */
    public static function setForRole(string $role, array $permissions): void
    {
        self::$permissions[$role] = $permissions;
    }

    /**
     * قائمة كل الصلاحيات المتاحة
     */
    public static function allAvailable(): array
    {
        return [
            'dashboard' => 'لوحة التحكم',
            'pos' => 'نقطة البيع',
            'products' => 'إدارة المنتجات',
            'products.view' => 'عرض المنتجات',
            'products.create' => 'إضافة منتجات',
            'products.edit' => 'تعديل منتجات',
            'products.delete' => 'حذف منتجات',
            'customers' => 'إدارة العملاء',
            'customers.view' => 'عرض العملاء',
            'customers.create' => 'إضافة عملاء',
            'invoices' => 'الفواتير',
            'invoices.create' => 'إنشاء فواتير',
            'installments' => 'الأقساط',
            'installments.view' => 'عرض الأقساط',
            'installments.pay' => 'تسجيل الدفعات',
            'payments' => 'المدفوعات',
            'reports' => 'التقارير',
            'users' => 'إدارة المستخدمين',
            'settings' => 'الإعدادات'
        ];
    }
}


============================================================
FILE: core/Router.php
============================================================
<?php
namespace Core;

/**
 * ╔══════════════════════════════════════════════════════════════════╗
 * ║                    نظام تقسيط - كلاس الموجّه                      ║
 * ╚══════════════════════════════════════════════════════════════════╝
 */
class Router
{
    private array $routes = [];
    private array $params = [];
    
    /**
     * إضافة مسار GET
     */
    public function get(string $path, string $handler): self
    {
        return $this->addRoute('GET', $path, $handler);
    }
    
    /**
     * إضافة مسار POST
     */
    public function post(string $path, string $handler): self
    {
        return $this->addRoute('POST', $path, $handler);
    }
    
    /**
     * إضافة مسار PUT
     */
    public function put(string $path, string $handler): self
    {
        return $this->addRoute('PUT', $path, $handler);
    }
    
    /**
     * إضافة مسار DELETE
     */
    public function delete(string $path, string $handler): self
    {
        return $this->addRoute('DELETE', $path, $handler);
    }
    
    /**
     * إضافة مسار
     */
    private function addRoute(string $method, string $path, string $handler): self
    {
        // تحويل المتغيرات في المسار إلى regex - فقط أرقام أو حروف وأرقام بدون /
        $pattern = preg_replace('/\{([a-zA-Z_]+)\}/', '(?P<$1>[^/]+)', $path);
        $pattern = '#^' . $pattern . '$#';
        
        // حساب عدد الأجزاء في المسار للترتيب
        $segmentCount = substr_count($path, '/');
        
        $this->routes[] = [
            'method' => $method,
            'path' => $path,
            'pattern' => $pattern,
            'handler' => $handler,
            'segments' => $segmentCount
        ];
        
        // ترتيب المسارات: الأطول أولاً
        usort($this->routes, function($a, $b) {
            return $b['segments'] - $a['segments'];
        });
        
        return $this;
    }
    
    /**
     * معالجة الطلب
     */
    public function dispatch(): void
    {
        $method = $_SERVER['REQUEST_METHOD'];
        $uri = $this->getUri();
        
        foreach ($this->routes as $route) {
            if ($route['method'] === $method && preg_match($route['pattern'], $uri, $matches)) {
                // استخراج المتغيرات
                $this->params = array_filter($matches, 'is_string', ARRAY_FILTER_USE_KEY);
                
                // تنفيذ المتحكم
                $this->executeHandler($route['handler']);
                return;
            }
        }
        
        // 404 - صفحة غير موجودة
        $this->notFound();
    }
    
    /**
     * الحصول على URI
     */
    private function getUri(): string
    {
        $uri = $_SERVER['REQUEST_URI'] ?? '/';
        
        // إزالة query string
        if (($pos = strpos($uri, '?')) !== false) {
            $uri = substr($uri, 0, $pos);
        }
        
        // إزالة المسار الأساسي
        $basePath = '/nizam-taqsit/public';
        if (strpos($uri, $basePath) === 0) {
            $uri = substr($uri, strlen($basePath));
        }
        
        // التأكد من أن المسار يبدأ بـ /
        if (empty($uri) || $uri[0] !== '/') {
            $uri = '/' . $uri;
        }
        
        return $uri;
    }
    
    /**
     * تنفيذ المتحكم
     */
    private function executeHandler(string $handler): void
    {
        list($controllerName, $method) = explode('@', $handler);
        
        $controllerClass = "App\\Controllers\\{$controllerName}";
        
        if (!class_exists($controllerClass)) {
            throw new \Exception("المتحكم غير موجود: {$controllerClass}");
        }
        
        $controller = new $controllerClass();
        
        if (!method_exists($controller, $method)) {
            throw new \Exception("الدالة غير موجودة: {$method}");
        }
        
        // تمرير المتغيرات للدالة - فقط القيم
        call_user_func_array([$controller, $method], array_values($this->params));
    }
    
    /**
     * صفحة 404
     */
    private function notFound(): void
    {
        http_response_code(404);
        include dirname(__DIR__) . '/app/Views/errors/404.php';
    }
    
    /**
     * الحصول على المتغيرات
     */
    public function getParams(): array
    {
        return $this->params;
    }
}


============================================================
FILE: database/add_color_column.php
============================================================
<?php
/**
 * سكربت لإضافة عمود color إلى جدول categories
 * شغله من: php database/add_color_column.php
 */

// مسار قاعدة البيانات
$dbPath = __DIR__ . '/database.sqlite';

if (!file_exists($dbPath)) {
    die("❌ قاعدة البيانات غير موجودة في: $dbPath\n");
}

try {
    $pdo = new PDO("sqlite:$dbPath");
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    // التحقق من وجود العمود
    $stmt = $pdo->query("PRAGMA table_info(categories)");
    $columns = $stmt->fetchAll(PDO::FETCH_ASSOC);
    $hasColor = false;
    
    foreach ($columns as $column) {
        if ($column['name'] === 'color') {
            $hasColor = true;
            break;
        }
    }
    
    if (!$hasColor) {
        // إضافة العمود
        $pdo->exec("ALTER TABLE categories ADD COLUMN color VARCHAR(20) DEFAULT '#1e88e5'");
        echo "✅ تم إضافة عمود color بنجاح!\n";
    } else {
        echo "ℹ️ عمود color موجود مسبقاً.\n";
    }
    
} catch (PDOException $e) {
    echo "❌ خطأ: " . $e->getMessage() . "\n";
}


============================================================
FILE: database/init.php
============================================================
<?php
/**
 * سكريبت تهيئة قاعدة البيانات
 * يتم تشغيله مرة واحدة لإنشاء الجداول وإضافة البيانات الأولية
 */

// التأكد من أن السكريبت يعمل من سطر الأوامر أو بتفويض
if (php_sapi_name() !== 'cli' && !isset($_GET['setup_key'])) {
    die('يجب تشغيل هذا السكريبت من سطر الأوامر');
}

echo "<pre style='font-family:monospace;direction:rtl;text-align:right'>\n";
echo "╔══════════════════════════════════════════════════════════════════╗\n";
echo "║           نظام تقسيط - تهيئة قاعدة البيانات                      ║\n";
echo "╚══════════════════════════════════════════════════════════════════╝\n\n";

$dbPath = __DIR__ . '/database.sqlite';
$schemaPath = __DIR__ . '/schema.sql';
$seedsPath = __DIR__ . '/seeds.sql';

// التحقق من وجود ملفات SQL
if (!file_exists($schemaPath)) {
    die("خطأ: ملف schema.sql غير موجود\n");
}

// إنشاء قاعدة البيانات
echo "» إنشاء قاعدة البيانات...\n";

try {
    $pdo = new PDO('sqlite:' . $dbPath);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    // تفعيل المفاتيح الخارجية
    $pdo->exec('PRAGMA foreign_keys = ON');
    
    echo "✓ تم إنشاء قاعدة البيانات\n\n";
    
    // تنفيذ سكريبت الجداول
    echo "» إنشاء الجداول...\n";
    $schema = file_get_contents($schemaPath);
    $pdo->exec($schema);
    echo "✓ تم إنشاء الجداول\n\n";
    
    // تنفيذ البيانات الأولية
    if (file_exists($seedsPath)) {
        echo "» إدخال البيانات الأولية...\n";
        $seeds = file_get_contents($seedsPath);
        $pdo->exec($seeds);
        echo "✓ تم إدخال البيانات الأولية\n\n";
    }
    
    // التحقق من الجداول
    echo "» التحقق من الجداول:\n";
    $tables = $pdo->query("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name")->fetchAll(PDO::FETCH_COLUMN);
    foreach ($tables as $table) {
        if ($table !== 'sqlite_sequence') {
            $count = $pdo->query("SELECT COUNT(*) FROM {$table}")->fetchColumn();
            echo "  - {$table}: {$count} سجل\n";
        }
    }
    
    echo "\n╔══════════════════════════════════════════════════════════════════╗\n";
    echo "║                    ✓ تمت التهيئة بنجاح                          ║\n";
    echo "╚══════════════════════════════════════════════════════════════════╝\n\n";
    
    echo "بيانات تسجيل الدخول:\n";
    echo "  اسم المستخدم: admin\n";
    echo "  كلمة المرور: admin123\n\n";
    
    echo "رابط النظام: http://localhost/nizam-taqsit/public/\n";
    
} catch (PDOException $e) {
    die("\nخطأ: " . $e->getMessage() . "\n");
}

echo "</pre>";


============================================================
FILE: database/migrate_api_keys.php
============================================================
<?php
/**
 * ╔══════════════════════════════════════════════════════════════════╗
 * ║                    نظام تقسيط - إنشاء جدول API Keys               ║
 * ╚══════════════════════════════════════════════════════════════════╝
 */

// تحميل الإعدادات
define('BASE_PATH', dirname(__DIR__));

// الاتصال بقاعدة البيانات
$dbPath = BASE_PATH . '/database/database.sqlite';

try {
    $pdo = new PDO('sqlite:' . $dbPath);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    // إنشاء جدول API Keys
    $sql = "
    CREATE TABLE IF NOT EXISTS api_keys (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name VARCHAR(100) NOT NULL,
        api_key VARCHAR(64) UNIQUE NOT NULL,
        permissions TEXT DEFAULT NULL,
        is_active INTEGER DEFAULT 1,
        last_used_at DATETIME DEFAULT NULL,
        expires_at DATETIME DEFAULT NULL,
        created_by INTEGER DEFAULT NULL,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL
    );
    ";
    
    $pdo->exec($sql);
    
    // إنشاء فهرس للبحث السريع
    $pdo->exec("CREATE INDEX IF NOT EXISTS idx_api_keys_key ON api_keys(api_key);");
    $pdo->exec("CREATE INDEX IF NOT EXISTS idx_api_keys_active ON api_keys(is_active);");
    
    echo "✅ تم إنشاء جدول api_keys بنجاح!\n";
    echo "✅ تم إنشاء الفهارس بنجاح!\n";
    
} catch (PDOException $e) {
    echo "❌ خطأ: " . $e->getMessage() . "\n";
    exit(1);
}


============================================================
FILE: database/migrate_menu_config.php
============================================================
<?php
/**
 * Migration: Add menu_config and theme_config columns to users table
 */

// تعريف المسار الأساسي
define('BASE_PATH', dirname(__DIR__));

// تحميل الـ Autoloader
spl_autoload_register(function ($class) {
    $baseDir = BASE_PATH . '/';
    $class = str_replace('\\', '/', $class);
    
    if (strpos($class, 'Core/') === 0) {
        $file = $baseDir . 'core/' . substr($class, 5) . '.php';
    } else {
        $file = $baseDir . $class . '.php';
    }
    
    if (file_exists($file)) {
        require $file;
    }
});

try {
    $db = Core\Database::getInstance();
    
    // Check if columns already exist
    $columns = $db->fetchAll("PRAGMA table_info(users)");
    $hasMenuConfig = false;
    $hasThemeConfig = false;
    
    foreach ($columns as $col) {
        if ($col['name'] === 'menu_config') $hasMenuConfig = true;
        if ($col['name'] === 'theme_config') $hasThemeConfig = true;
    }
    
    if (!$hasMenuConfig) {
        $db->query("ALTER TABLE users ADD COLUMN menu_config TEXT DEFAULT NULL");
        echo "تم إضافة عمود menu_config بنجاح\n";
    } else {
        echo "العمود menu_config موجود بالفعل\n";
    }
    
    if (!$hasThemeConfig) {
        $db->query("ALTER TABLE users ADD COLUMN theme_config TEXT DEFAULT NULL");
        echo "تم إضافة عمود theme_config بنجاح\n";
    } else {
        echo "العمود theme_config موجود بالفعل\n";
    }
    
} catch (Exception $e) {
    echo "خطأ: " . $e->getMessage() . "\n";
}


============================================================
FILE: database/schema.sql
============================================================
-- ╔══════════════════════════════════════════════════════════════════╗
-- ║                    نظام تقسيط - قاعدة البيانات                    ║
-- ║                   Installment System Database                      ║
-- ╚══════════════════════════════════════════════════════════════════╝
-- تفعيل المفاتيح الأجنبية
PRAGMA foreign_keys = ON;
-- ══════════════════════════════════════════════════════════════════
-- جدول الإعدادات
-- ══════════════════════════════════════════════════════════════════
CREATE TABLE IF NOT EXISTS settings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    setting_key VARCHAR(100) UNIQUE NOT NULL,
    setting_value TEXT,
    setting_group VARCHAR(50) DEFAULT 'general',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
-- ══════════════════════════════════════════════════════════════════
-- جدول المستخدمين
-- ══════════════════════════════════════════════════════════════════
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    email VARCHAR(100),
    role VARCHAR(20) DEFAULT 'sales' CHECK(role IN ('admin', 'sales', 'accountant')),
    is_active INTEGER DEFAULT 1,
    last_login DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
CREATE INDEX IF NOT EXISTS idx_users_role ON users(role);
-- ══════════════════════════════════════════════════════════════════
-- جدول التصنيفات
-- ══════════════════════════════════════════════════════════════════
CREATE TABLE IF NOT EXISTS categories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    parent_id INTEGER DEFAULT NULL,
    icon VARCHAR(50),
    sort_order INTEGER DEFAULT 0,
    is_active INTEGER DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (parent_id) REFERENCES categories(id) ON DELETE
    SET NULL
);
CREATE INDEX IF NOT EXISTS idx_categories_parent ON categories(parent_id);
-- ══════════════════════════════════════════════════════════════════
-- جدول المنتجات
-- ══════════════════════════════════════════════════════════════════
CREATE TABLE IF NOT EXISTS products (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    category_id INTEGER,
    barcode VARCHAR(50) UNIQUE,
    sku VARCHAR(50) UNIQUE,
    cash_price DECIMAL(10, 2) NOT NULL,
    installment_price DECIMAL(10, 2),
    cost_price DECIMAL(10, 2),
    quantity INTEGER DEFAULT 0,
    min_quantity INTEGER DEFAULT 5,
    image VARCHAR(255),
    brand VARCHAR(100),
    model VARCHAR(100),
    warranty_months INTEGER DEFAULT 0,
    is_active INTEGER DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE
    SET NULL
);
CREATE INDEX IF NOT EXISTS idx_products_category ON products(category_id);
CREATE INDEX IF NOT EXISTS idx_products_barcode ON products(barcode);
CREATE INDEX IF NOT EXISTS idx_products_name ON products(name);
-- ══════════════════════════════════════════════════════════════════
-- جدول العملاء
-- ══════════════════════════════════════════════════════════════════
CREATE TABLE IF NOT EXISTS customers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    full_name VARCHAR(150) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    phone2 VARCHAR(20),
    national_id VARCHAR(20),
    national_id_image VARCHAR(255),
    address TEXT,
    city VARCHAR(100),
    work_address TEXT,
    work_phone VARCHAR(20),
    guarantor_name VARCHAR(150),
    guarantor_phone VARCHAR(20),
    guarantor_national_id VARCHAR(20),
    credit_limit DECIMAL(10, 2) DEFAULT 0,
    notes TEXT,
    is_active INTEGER DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IF NOT EXISTS idx_customers_phone ON customers(phone);
CREATE INDEX IF NOT EXISTS idx_customers_national_id ON customers(national_id);
CREATE INDEX IF NOT EXISTS idx_customers_name ON customers(full_name);
-- ══════════════════════════════════════════════════════════════════
-- جدول خطط التقسيط
-- ══════════════════════════════════════════════════════════════════
CREATE TABLE IF NOT EXISTS installment_plans (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,
    months INTEGER NOT NULL,
    increase_percent DECIMAL(5, 2) NOT NULL,
    min_down_payment_percent DECIMAL(5, 2) DEFAULT 20,
    is_active INTEGER DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
-- ══════════════════════════════════════════════════════════════════
-- جدول الفواتير
-- ══════════════════════════════════════════════════════════════════
CREATE TABLE IF NOT EXISTS invoices (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    invoice_number VARCHAR(30) UNIQUE NOT NULL,
    invoice_type VARCHAR(20) NOT NULL CHECK(invoice_type IN ('cash', 'installment')),
    customer_id INTEGER,
    user_id INTEGER NOT NULL,
    subtotal DECIMAL(10, 2) NOT NULL,
    discount_amount DECIMAL(10, 2) DEFAULT 0,
    discount_percent DECIMAL(5, 2) DEFAULT 0,
    tax_amount DECIMAL(10, 2) DEFAULT 0,
    total_amount DECIMAL(10, 2) NOT NULL,
    paid_amount DECIMAL(10, 2) DEFAULT 0,
    remaining_amount DECIMAL(10, 2) DEFAULT 0,
    installment_plan_id INTEGER,
    down_payment DECIMAL(10, 2) DEFAULT 0,
    monthly_installment DECIMAL(10, 2) DEFAULT 0,
    installments_count INTEGER DEFAULT 0,
    first_installment_date DATE,
    notes TEXT,
    status VARCHAR(20) DEFAULT 'active' CHECK(
        status IN ('pending', 'active', 'completed', 'cancelled')
    ),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE RESTRICT,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (installment_plan_id) REFERENCES installment_plans(id)
);
CREATE INDEX IF NOT EXISTS idx_invoices_number ON invoices(invoice_number);
CREATE INDEX IF NOT EXISTS idx_invoices_customer ON invoices(customer_id);
CREATE INDEX IF NOT EXISTS idx_invoices_type ON invoices(invoice_type);
CREATE INDEX IF NOT EXISTS idx_invoices_status ON invoices(status);
CREATE INDEX IF NOT EXISTS idx_invoices_date ON invoices(created_at);
-- ══════════════════════════════════════════════════════════════════
-- جدول بنود الفاتورة
-- ══════════════════════════════════════════════════════════════════
CREATE TABLE IF NOT EXISTS invoice_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    invoice_id INTEGER NOT NULL,
    product_id INTEGER NOT NULL,
    product_name VARCHAR(200) NOT NULL,
    quantity INTEGER NOT NULL DEFAULT 1,
    unit_price DECIMAL(10, 2) NOT NULL,
    discount_amount DECIMAL(10, 2) DEFAULT 0,
    total_price DECIMAL(10, 2) NOT NULL,
    serial_number VARCHAR(100),
    warranty_end_date DATE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (invoice_id) REFERENCES invoices(id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE RESTRICT
);
CREATE INDEX IF NOT EXISTS idx_invoice_items_invoice ON invoice_items(invoice_id);
CREATE INDEX IF NOT EXISTS idx_invoice_items_product ON invoice_items(product_id);
-- ══════════════════════════════════════════════════════════════════
-- جدول الأقساط
-- ══════════════════════════════════════════════════════════════════
CREATE TABLE IF NOT EXISTS installments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    invoice_id INTEGER NOT NULL,
    installment_number INTEGER NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    due_date DATE NOT NULL,
    paid_amount DECIMAL(10, 2) DEFAULT 0,
    remaining_amount DECIMAL(10, 2) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending' CHECK(
        status IN ('pending', 'partial', 'paid', 'overdue')
    ),
    paid_date DATE,
    notes TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (invoice_id) REFERENCES invoices(id) ON DELETE RESTRICT
);
CREATE INDEX IF NOT EXISTS idx_installments_invoice ON installments(invoice_id);
CREATE INDEX IF NOT EXISTS idx_installments_due_date ON installments(due_date);
CREATE INDEX IF NOT EXISTS idx_installments_status ON installments(status);
-- ══════════════════════════════════════════════════════════════════
-- جدول المدفوعات
-- ══════════════════════════════════════════════════════════════════
CREATE TABLE IF NOT EXISTS payments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    invoice_id INTEGER NOT NULL,
    installment_id INTEGER,
    amount DECIMAL(10, 2) NOT NULL,
    payment_method VARCHAR(20) DEFAULT 'cash' CHECK(
        payment_method IN ('cash', 'card', 'transfer', 'other')
    ),
    payment_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    receipt_number VARCHAR(30),
    user_id INTEGER NOT NULL,
    notes TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (invoice_id) REFERENCES invoices(id) ON DELETE RESTRICT,
    FOREIGN KEY (installment_id) REFERENCES installments(id) ON DELETE
    SET NULL,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE RESTRICT
);
CREATE INDEX IF NOT EXISTS idx_payments_invoice ON payments(invoice_id);
CREATE INDEX IF NOT EXISTS idx_payments_date ON payments(payment_date);
CREATE INDEX IF NOT EXISTS idx_payments_user ON payments(user_id);
-- ══════════════════════════════════════════════════════════════════
-- جدول سجل النشاط
-- ══════════════════════════════════════════════════════════════════
CREATE TABLE IF NOT EXISTS activity_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    action VARCHAR(50) NOT NULL,
    entity_type VARCHAR(50),
    entity_id INTEGER,
    description TEXT,
    old_values TEXT,
    new_values TEXT,
    ip_address VARCHAR(45),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
CREATE INDEX IF NOT EXISTS idx_activity_user ON activity_log(user_id);
CREATE INDEX IF NOT EXISTS idx_activity_action ON activity_log(action);
CREATE INDEX IF NOT EXISTS idx_activity_date ON activity_log(created_at);
-- ══════════════════════════════════════════════════════════════════
-- جدول التنبيهات
-- ══════════════════════════════════════════════════════════════════
CREATE TABLE IF NOT EXISTS notifications (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    title VARCHAR(200) NOT NULL,
    message TEXT NOT NULL,
    type VARCHAR(20) DEFAULT 'info' CHECK(type IN ('info', 'warning', 'danger', 'success')),
    related_entity VARCHAR(50),
    related_id INTEGER,
    is_read INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
CREATE INDEX IF NOT EXISTS idx_notifications_user ON notifications(user_id);
CREATE INDEX IF NOT EXISTS idx_notifications_read ON notifications(is_read);
-- ══════════════════════════════════════════════════════════════════
-- جدول النسخ الاحتياطي
-- ══════════════════════════════════════════════════════════════════
CREATE TABLE IF NOT EXISTS backups (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    filename VARCHAR(255) NOT NULL,
    file_size INTEGER,
    backup_type VARCHAR(20) DEFAULT 'manual' CHECK(backup_type IN ('manual', 'auto')),
    user_id INTEGER,
    notes TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE
    SET NULL
);

============================================================
FILE: docker/default.conf
============================================================
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    
    server_name _;
    root /var/www/html/public;
    index index.php index.html;

    charset utf-8;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Main location
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # PHP handling
    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
    }

    # Static files caching
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # Deny access to sensitive files
    location ~ /\.(?!well-known) {
        deny all;
    }

    location ~ /database/ {
        deny all;
    }

    # Uploads directory - handle both /uploads and /public/uploads
    location /uploads/ {
        alias /var/www/html/public/uploads/;
    }
    
    # Handle URLs with /public prefix (redirect to correct path)
    location /public/uploads/ {
        alias /var/www/html/public/uploads/;
    }

    # Error pages
    error_page 404 /index.php;
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /var/lib/nginx/html;
    }
}


============================================================
FILE: docker/nginx.conf
============================================================
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /run/nginx/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 50M;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml application/javascript application/json;

    include /etc/nginx/http.d/*.conf;
}


============================================================
FILE: docker/supervisord.conf
============================================================
[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/run/supervisord.pid
user=root

[program:php-fpm]
command=/usr/local/sbin/php-fpm -F
autostart=true
autorestart=true
priority=5
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

[program:nginx]
command=/usr/sbin/nginx -g 'daemon off;'
autostart=true
autorestart=true
priority=10
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0


============================================================
FILE: add_products_with_images.php
============================================================
<?php
/**
 * إضافة منتجات مع صور من Unsplash (مجاني بدون API)
 */

$dbPath = __DIR__ . '/database/database.sqlite';
$pdo = new PDO('sqlite:' . $dbPath);
$pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

$imagesDir = __DIR__ . '/public/assets/images/products';
if (!is_dir($imagesDir)) {
    mkdir($imagesDir, 0755, true);
}

echo "بدء إضافة المنتجات مع الصور...\n\n";

// منتجات لكل تصنيف مع روابط صور Unsplash
$productsData = [
    1 => [ // تلفزيونات
        ['تلفزيون سامسونج 55 بوصة سمارت 4K', 15000, 17250, 'https://images.unsplash.com/photo-1593359677879-a4bb92f829d1?w=400'],
        ['تلفزيون LG 50 بوصة Ultra HD', 12000, 13800, 'https://images.unsplash.com/photo-1567690187548-f07b1d7bf5a9?w=400'],
        ['تلفزيون سوني 65 بوصة OLED', 25000, 28750, 'https://images.unsplash.com/photo-1593784991095-a205069470b6?w=400'],
        ['تلفزيون توشيبا 43 بوصة سمارت', 8000, 9200, 'https://images.unsplash.com/photo-1461151304267-38535e780c79?w=400'],
        ['تلفزيون TCL 55 بوصة اندرويد', 9500, 10925, 'https://images.unsplash.com/photo-1558888401-3cc1de77652d?w=400'],
        ['تلفزيون هايسنس 58 بوصة', 11000, 12650, 'https://images.unsplash.com/photo-1571415060716-baff5f717c37?w=400'],
        ['تلفزيون فيليبس 50 بوصة امبيلايت', 10500, 12075, 'https://images.unsplash.com/photo-1509281373149-e957c6296406?w=400'],
        ['تلفزيون شارب 45 بوصة LED', 7500, 8625, 'https://images.unsplash.com/photo-1522869635100-9f4c5e86aa37?w=400'],
    ],
    2 => [ // ثلاجات
        ['ثلاجة توشيبا 18 قدم نوفروست سيلفر', 18000, 20700, 'https://images.unsplash.com/photo-1571175443880-49e1d25b2bc5?w=400'],
        ['ثلاجة شارب 16 قدم نوفروست', 15000, 17250, 'https://images.unsplash.com/photo-1584568694244-14fbdf83bd30?w=400'],
        ['ثلاجة LG 20 قدم انفرتر', 22000, 25300, 'https://images.unsplash.com/photo-1536353284924-9220c464e262?w=400'],
        ['ثلاجة سامسونج 24 قدم فرنش دور', 28000, 32200, 'https://images.unsplash.com/photo-1585771724684-38269d6639fd?w=400'],
        ['ثلاجة كريازي 14 قدم ديفروست', 12000, 13800, 'https://images.unsplash.com/photo-1619624683930-5c12c2500c6c?w=400'],
        ['ثلاجة الاسكا 16 قدم نوفروست', 14000, 16100, 'https://images.unsplash.com/photo-1606787366850-de6330128bfc?w=400'],
        ['ثلاجة فريش 18 قدم ديجيتال', 16000, 18400, 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400'],
        ['ثلاجة وايت ويل 20 قدم', 19000, 21850, 'https://images.unsplash.com/photo-1562913844-31e29e3e6e58?w=400'],
    ],
    3 => [ // غسالات
        ['غسالة سامسونج 8 كيلو فول أوتوماتيك', 12000, 13800, 'https://images.unsplash.com/photo-1626806787461-102c1bfaaea1?w=400'],
        ['غسالة LG 10 كيلو انفرتر ستيم', 15000, 17250, 'https://images.unsplash.com/photo-1610557892470-55d9e80c0bce?w=400'],
        ['غسالة توشيبا 7 كيلو تحميل أمامي', 9000, 10350, 'https://images.unsplash.com/photo-1604335399105-a0c585fd81a1?w=400'],
        ['غسالة زانوسي 8 كيلو ستيم', 11000, 12650, 'https://images.unsplash.com/photo-1582735689369-4fe89db7114c?w=400'],
        ['غسالة وايت بوينت 9 كيلو', 10500, 12075, 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400'],
        ['غسالة شارب 7 كيلو فول ديجيتال', 8500, 9775, 'https://images.unsplash.com/photo-1567690187548-f07b1d7bf5a9?w=400'],
        ['غسالة بوش 9 كيلو انفرتر', 18000, 20700, 'https://images.unsplash.com/photo-1585771724684-38269d6639fd?w=400'],
        ['غسالة إيديال 7 كيلو اوتوماتيك', 7000, 8050, 'https://images.unsplash.com/photo-1571175443880-49e1d25b2bc5?w=400'],
    ],
    4 => [ // تكييفات
        ['تكييف شارب 1.5 حصان بارد ساخن انفرتر', 12000, 13800, 'https://images.unsplash.com/photo-1631545806609-4b1c1c9b0e4a?w=400'],
        ['تكييف كاريير 2.25 حصان اوبتيماكس', 18000, 20700, 'https://images.unsplash.com/photo-1580595999172-787970a962d9?w=400'],
        ['تكييف يونيون اير 3 حصان انفرتر', 22000, 25300, 'https://images.unsplash.com/photo-1622974909575-9f8878c51c7a?w=400'],
        ['تكييف LG 1.5 حصان دوال انفرتر', 15000, 17250, 'https://images.unsplash.com/photo-1585767934604-5b7e8f9e7f56?w=400'],
        ['تكييف سامسونج 2.25 حصان ديجيتال', 16000, 18400, 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400'],
        ['تكييف جري 1.5 حصان بلازما', 11000, 12650, 'https://images.unsplash.com/photo-1562913844-31e29e3e6e58?w=400'],
        ['تكييف ميديا 2.25 حصان انفرتر', 14000, 16100, 'https://images.unsplash.com/photo-1558888401-3cc1de77652d?w=400'],
        ['تكييف تورنيدو 1.5 حصان بارد', 10000, 11500, 'https://images.unsplash.com/photo-1571415060716-baff5f717c37?w=400'],
    ],
    5 => [ // بوتاجازات
        ['بوتاجاز يونيفرسال 5 شعلة ستانلس', 8000, 9200, 'https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=400'],
        ['بوتاجاز فريش 4 شعلة عيون نحاس', 6000, 6900, 'https://images.unsplash.com/photo-1584568694244-14fbdf83bd30?w=400'],
        ['بوتاجاز اي كوك 5 شعلة بلت ان', 9000, 10350, 'https://images.unsplash.com/photo-1590794056226-79ef3a8147e1?w=400'],
        ['بوتاجاز لاجيرمانيا 5 شعلة ايطالي', 12000, 13800, 'https://images.unsplash.com/photo-1565538810643-b5bdb714032a?w=400'],
        ['بوتاجاز جليم غاز 4 شعلة', 7500, 8625, 'https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=400'],
        ['بوتاجاز تكنوجاز 5 شعلة الماني', 8500, 9775, 'https://images.unsplash.com/photo-1556909172-54557c7e4fb7?w=400'],
        ['بوتاجاز وايت ويل 5 شعلة شواية', 7000, 8050, 'https://images.unsplash.com/photo-1571175443880-49e1d25b2bc5?w=400'],
        ['بوتاجاز كريازي 4 شعلة اقتصادي', 5500, 6325, 'https://images.unsplash.com/photo-1584568694244-14fbdf83bd30?w=400'],
    ],
    6 => [ // سخانات
        ['سخان غاز اوليمبيك 10 لتر ديجيتال', 3500, 4025, 'https://images.unsplash.com/photo-1585771724684-38269d6639fd?w=400'],
        ['سخان كهرباء تورنيدو 50 لتر', 4000, 4600, 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400'],
        ['سخان غاز فريش 6 لتر امان', 2500, 2875, 'https://images.unsplash.com/photo-1562913844-31e29e3e6e58?w=400'],
        ['سخان كهرباء اريستون 80 لتر ايطالي', 6000, 6900, 'https://images.unsplash.com/photo-1567690187548-f07b1d7bf5a9?w=400'],
        ['سخان غاز وايت بوينت 10 لتر', 3000, 3450, 'https://images.unsplash.com/photo-1571175443880-49e1d25b2bc5?w=400'],
        ['سخان كهرباء يونيون 50 لتر', 3500, 4025, 'https://images.unsplash.com/photo-1584568694244-14fbdf83bd30?w=400'],
        ['سخان غاز كريازي 6 لتر اقتصادي', 2200, 2530, 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400'],
        ['سخان فوري اريستون كهرباء', 5000, 5750, 'https://images.unsplash.com/photo-1562913844-31e29e3e6e58?w=400'],
    ],
    7 => [ // ميكروويف
        ['ميكروويف سامسونج 40 لتر كونفكشن', 4500, 5175, 'https://images.unsplash.com/photo-1574269909862-7e1d70bb8078?w=400'],
        ['ميكروويف LG 25 لتر سمارت انفرتر', 3500, 4025, 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400'],
        ['ميكروويف شارب 30 لتر جريل', 4000, 4600, 'https://images.unsplash.com/photo-1585659722983-3a675dabf23d?w=400'],
        ['ميكروويف باناسونيك 27 لتر انفرتر', 4200, 4830, 'https://images.unsplash.com/photo-1574269909862-7e1d70bb8078?w=400'],
        ['ميكروويف بلاك اند ديكر 20 لتر', 2500, 2875, 'https://images.unsplash.com/photo-1562913844-31e29e3e6e58?w=400'],
        ['ميكروويف تورنيدو 25 لتر ديجيتال', 3000, 3450, 'https://images.unsplash.com/photo-1571175443880-49e1d25b2bc5?w=400'],
        ['ميكروويف كينوود 30 لتر جريل', 3800, 4370, 'https://images.unsplash.com/photo-1585659722983-3a675dabf23d?w=400'],
        ['ميكروويف فريش 23 لتر عادي', 2800, 3220, 'https://images.unsplash.com/photo-1584568694244-14fbdf83bd30?w=400'],
    ],
    8 => [ // أجهزة منزلية
        ['خلاط براون 1000 وات متعدد السرعات', 2500, 2875, 'https://images.unsplash.com/photo-1585515320310-259814833e62?w=400'],
        ['خلاط مولينكس 800 وات فرنسي', 2000, 2300, 'https://images.unsplash.com/photo-1570222094114-d054a817e56b?w=400'],
        ['مكنسة كهربائية باناسونيك 2000 وات', 4000, 4600, 'https://images.unsplash.com/photo-1558317374-067fb5f30001?w=400'],
        ['مكنسة كهربائية فيليبس 1800 وات', 3500, 4025, 'https://images.unsplash.com/photo-1527515637462-cff94eecc1ac?w=400'],
        ['مكواة بخار تيفال 2400 وات', 1500, 1725, 'https://images.unsplash.com/photo-1595225476474-87563907a212?w=400'],
        ['مكواة بخار فيليبس باور لايف', 1800, 2070, 'https://images.unsplash.com/photo-1562913844-31e29e3e6e58?w=400'],
        ['ماكينة قهوة ديلونجي اسبريسو', 5000, 5750, 'https://images.unsplash.com/photo-1517701550927-30cf4ba1dba5?w=400'],
        ['فرن كهرباء تورنيدو 48 لتر تربو', 3000, 3450, 'https://images.unsplash.com/photo-1571175443880-49e1d25b2bc5?w=400'],
        ['ديب فريزر كريازي 5 درج نوفروست', 8000, 9200, 'https://images.unsplash.com/photo-1584568694244-14fbdf83bd30?w=400'],
        ['شفاط مطبخ فريش 60 سم ستانلس', 2500, 2875, 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400'],
    ],
    9 => [ // موبايلات
        ['آيفون 15 Pro Max 256GB تيتانيوم', 55000, 63250, 'https://images.unsplash.com/photo-1695048133142-1a20484d2569?w=400'],
        ['آيفون 15 128GB أزرق', 42000, 48300, 'https://images.unsplash.com/photo-1592750475338-74b7b21085ab?w=400'],
        ['سامسونج Galaxy S24 Ultra 512GB', 50000, 57500, 'https://images.unsplash.com/photo-1610945265064-0e34e5519bbf?w=400'],
        ['سامسونج Galaxy A54 128GB', 15000, 17250, 'https://images.unsplash.com/photo-1598327105666-5b89351aff97?w=400'],
        ['شاومي 14 Pro 256GB', 25000, 28750, 'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?w=400'],
        ['شاومي Redmi Note 13 128GB', 8000, 9200, 'https://images.unsplash.com/photo-1598327105666-5b89351aff97?w=400'],
        ['أوبو Reno 11 256GB', 18000, 20700, 'https://images.unsplash.com/photo-1574944985070-8f3ebc6b79d2?w=400'],
        ['ريلمي GT 5 256GB', 16000, 18400, 'https://images.unsplash.com/photo-1565849904461-04a58ad377e0?w=400'],
        ['هواوي Nova 12 256GB', 14000, 16100, 'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?w=400'],
        ['فيفو V30 256GB', 17000, 19550, 'https://images.unsplash.com/photo-1592750475338-74b7b21085ab?w=400'],
    ],
    10 => [ // لابتوبات
        ['لابتوب HP Pavilion 15 Core i7 16GB', 28000, 32200, 'https://images.unsplash.com/photo-1496181133206-80ce9b88a853?w=400'],
        ['لابتوب Dell Inspiron 14 Core i5', 25000, 28750, 'https://images.unsplash.com/photo-1588872657578-7efd1f1555ed?w=400'],
        ['لابتوب Lenovo IdeaPad 3 Ryzen 5', 18000, 20700, 'https://images.unsplash.com/photo-1525547719571-a2d4ac8945e2?w=400'],
        ['لابتوب ASUS VivoBook 15 Core i5', 20000, 23000, 'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?w=400'],
        ['لابتوب Acer Aspire 5 Core i5', 16000, 18400, 'https://images.unsplash.com/photo-1496181133206-80ce9b88a853?w=400'],
        ['لابتوب MacBook Air M2 256GB', 55000, 63250, 'https://images.unsplash.com/photo-1611186871348-b1ce696e52c9?w=400'],
        ['لابتوب MacBook Pro 14 M3 Pro', 75000, 86250, 'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?w=400'],
        ['لابتوب HP Victus Gaming RTX 3050', 35000, 40250, 'https://images.unsplash.com/photo-1593642702821-c8da6771f0c6?w=400'],
        ['لابتوب Dell G15 Gaming RTX 4060', 38000, 43700, 'https://images.unsplash.com/photo-1588872657578-7efd1f1555ed?w=400'],
        ['لابتوب MSI GF63 Gaming RTX 3050', 32000, 36800, 'https://images.unsplash.com/photo-1525547719571-a2d4ac8945e2?w=400'],
    ],
];

function downloadImage($url, $filepath) {
    $context = stream_context_create([
        'http' => ['timeout' => 15, 'user_agent' => 'Mozilla/5.0'],
        'ssl' => ['verify_peer' => false, 'verify_peer_name' => false]
    ]);
    
    $imageContent = @file_get_contents($url, false, $context);
    
    if ($imageContent && strlen($imageContent) > 1000) {
        file_put_contents($filepath, $imageContent);
        return true;
    }
    return false;
}

// حذف المنتجات القديمة
$pdo->exec("DELETE FROM invoice_items");
$pdo->exec("DELETE FROM products");
echo "تم حذف المنتجات القديمة\n\n";

$totalProducts = 0;
$totalImages = 0;

foreach ($productsData as $categoryId => $products) {
    // الحصول على اسم التصنيف
    $stmt = $pdo->prepare("SELECT name FROM categories WHERE id = ?");
    $stmt->execute([$categoryId]);
    $cat = $stmt->fetch(PDO::FETCH_ASSOC);
    $categoryName = $cat ? $cat['name'] : "التصنيف $categoryId";
    
    echo "📁 $categoryName (" . count($products) . " منتج)\n";
    
    foreach ($products as $product) {
        $name = $product[0];
        $cashPrice = $product[1];
        $installmentPrice = $product[2];
        $imageUrl = $product[3];
        $costPrice = $cashPrice * 0.7;
        $quantity = rand(10, 50);
        $barcode = '30' . str_pad(rand(1, 999999), 6, '0', STR_PAD_LEFT);
        
        // تحميل الصورة
        $imageFilename = 'product_' . md5($name) . '.jpg';
        $imagePath = $imagesDir . '/' . $imageFilename;
        
        echo "   ⏳ $name... ";
        
        if (downloadImage($imageUrl, $imagePath)) {
            echo "✅\n";
            $totalImages++;
            $dbImagePath = $imageFilename;
        } else {
            echo "❌\n";
            $dbImagePath = null;
        }
        
        // إضافة المنتج
        $stmt = $pdo->prepare("INSERT INTO products (name, category_id, cash_price, installment_price, cost_price, quantity, min_quantity, barcode, image, is_active) VALUES (?, ?, ?, ?, ?, ?, 5, ?, ?, 1)");
        $stmt->execute([$name, $categoryId, $cashPrice, $installmentPrice, $costPrice, $quantity, $barcode, $dbImagePath]);
        $totalProducts++;
        
        usleep(100000); // 0.1 ثانية
    }
    
    echo "\n";
}

echo "\n✅ اكتمل!\n";
echo "📦 إجمالي المنتجات: $totalProducts\n";
echo "🖼️ الصور المحملة: $totalImages\n";


============================================================
FILE: check_api_keys.php
============================================================
<?php
$db = new SQLite3('database/database.sqlite');

// Get all tables
$result = $db->query("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name");
echo "=== Tables in Database ===\n";
while ($row = $result->fetchArray(SQLITE3_ASSOC)) {
    echo "- " . $row['name'] . "\n";
}

echo "\n=== API Keys ===\n";
$result = $db->query('SELECT id, name, api_key, is_active, expires_at FROM api_keys');
if ($result) {
    while ($row = $result->fetchArray(SQLITE3_ASSOC)) {
        echo "ID: " . $row['id'] . "\n";
        echo "Name: " . $row['name'] . "\n";
        echo "API Key: " . $row['api_key'] . "\n";
        echo "Active: " . ($row['is_active'] ? 'Yes' : 'No') . "\n";
        echo "Expires: " . ($row['expires_at'] ?? 'Never') . "\n";
        echo "---\n";
    }
} else {
    echo "Table api_keys does not exist\n";
}


============================================================
FILE: docker-compose-copy.yml
============================================================
# نظام تقسيط - NizamTaqsit
# Docker Compose Configuration

#version: '3.8'

services:
  # Main Application
  nizamtaqsit:
    build:
      context: .
      dockerfile: Dockerfile
    image: nizamtaqsit:latest
    container_name: nizamtaqsit-app
    restart: unless-stopped
    ports:
      - "8080:80"  # Access at http://localhost:8080
    volumes:
      # Local file persistence (على جهازك)
      #- ./database:/var/www/html/database
      #- ./public/uploads:/var/www/html/public/uploads
      #- ./config:/var/www/html/config
      
      # Server mount (مجلد على السيرفر - عدل المسار حسب السيرفر)
      # Uncomment and modify the path below for your server mount
       - /mnt/server/nizamtaqsit/database:/var/www/html/database
       - /mnt/server/nizamtaqsit/uploads:/var/www/html/public/uploads
      
      # Named volumes for logs
      - app_logs:/var/log/nginx
    environment:
      - TZ=Africa/Cairo
      - PHP_OPCACHE_ENABLE=1
    networks:
      - nizamtaqsit-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

# Optional: Database backup service
  backup:
    image: alpine:latest
    container_name: nizamtaqsit-backup
    restart: "no"
    volumes:
      - ./database:/source:ro
      - ./backups:/backup
    command: >
      sh -c "
        mkdir -p /backup
        cp /source/*.sqlite /backup/database_$(date +%Y%m%d_%H%M%S).sqlite
        echo 'Backup completed'
      "
    profiles:
      - backup

networks:
  nizamtaqsit-network:
    driver: bridge

volumes:
  app_logs:
    driver: local


============================================================
FILE: fix_password.php
============================================================
<?php
// Fix admin password
$dbPath = __DIR__ . '/database/database.sqlite';
$pdo = new PDO('sqlite:' . $dbPath);
$hash = password_hash('admin123', PASSWORD_DEFAULT);
$pdo->exec("UPDATE users SET password_hash='" . $hash . "' WHERE username='admin'");
echo "Password updated to: admin123\n";


============================================================
FILE: generate_bulk_products.php
============================================================
<?php
/**
 * إضافة منتجات بكميات كبيرة لاختبار أداء النظام
 * يضيف 250 منتج لكل تصنيف مع صور وأسعار ووصف
 */

$dbPath = __DIR__ . '/database/database.sqlite';
$pdo = new PDO('sqlite:' . $dbPath);
$pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

$uploadsDir = __DIR__ . '/public/uploads/products';
if (!is_dir($uploadsDir)) {
    mkdir($uploadsDir, 0755, true);
}

echo "==============================================\n";
echo "   إضافة منتجات بكميات كبيرة لاختبار الأداء\n";
echo "==============================================\n\n";

// جلب جميع التصنيفات
$categories = $pdo->query("SELECT id, name FROM categories ORDER BY id")->fetchAll(PDO::FETCH_ASSOC);

echo "📁 التصنيفات الموجودة: " . count($categories) . "\n\n";

// قوائم الكلمات لتوليد أسماء المنتجات
$brands = [
    'أجهزة منزلية' => ['سامسونج', 'LG', 'توشيبا', 'شارب', 'باناسونيك', 'فيليبس', 'بوش', 'سيمنز', 'هيتاشي', 'ميلي'],
    'بوتاجازات' => ['يونيفرسال', 'فريش', 'اي كوك', 'لاجيرمانيا', 'جليم غاز', 'تكنوجاز', 'وايت ويل', 'كريازي'],
    'تكييفات' => ['شارب', 'كاريير', 'يونيون اير', 'LG', 'سامسونج', 'جري', 'ميديا', 'تورنيدو', 'هايسنس'],
    'تلفزيونات' => ['سامسونج', 'LG', 'سوني', 'توشيبا', 'TCL', 'هايسنس', 'فيليبس', 'شارب', 'باناسونيك'],
    'ثلاجات' => ['توشيبا', 'شارب', 'LG', 'سامسونج', 'كريازي', 'الاسكا', 'فريش', 'وايت ويل', 'بيكو'],
    'سخانات' => ['اوليمبيك', 'تورنيدو', 'فريش', 'اريستون', 'وايت بوينت', 'يونيون', 'كريازي', 'بوش'],
    'غسالات' => ['سامسونج', 'LG', 'توشيبا', 'زانوسي', 'وايت بوينت', 'شارب', 'بوش', 'ايديال', 'بيكو'],
    'لابتوبات' => ['HP', 'Dell', 'Lenovo', 'ASUS', 'Acer', 'Apple', 'MSI', 'Toshiba', 'Samsung', 'Microsoft'],
    'موبايلات' => ['Apple', 'Samsung', 'Xiaomi', 'Oppo', 'Realme', 'Huawei', 'Vivo', 'Honor', 'Google', 'OnePlus'],
    'ميكروويف' => ['سامسونج', 'LG', 'شارب', 'باناسونيك', 'بلاك اند ديكر', 'تورنيدو', 'كينوود', 'فريش'],
    'أجهزة كهربائية' => ['فيليبس', 'براون', 'مولينكس', 'كينوود', 'بلاك اند ديكر', 'تيفال', 'راسل هوبز'],
    'هواتف محمولة' => ['Apple', 'Samsung', 'Xiaomi', 'Oppo', 'Realme', 'Huawei', 'Vivo', 'Honor', 'Nokia'],
    'ملحقات' => ['سامسونج', 'Apple', 'Anker', 'Belkin', 'JBL', 'Sony', 'Logitech', 'Baseus', 'Ugreen'],
    'أجهزة مطبخ' => ['كينوود', 'مولينكس', 'براون', 'بلاك اند ديكر', 'فيليبس', 'نيوتري', 'نينجا', 'همليتون'],
    'شاشات وتلفزيونات' => ['سامسونج', 'LG', 'سوني', 'توشيبا', 'TCL', 'هايسنس', 'فيليبس', 'BenQ', 'ViewSonic'],
    'ثلاجات ومجمدات' => ['توشيبا', 'شارب', 'LG', 'سامسونج', 'كريازي', 'الاسكا', 'فريش', 'وايت ويل'],
    'مكيفات' => ['شارب', 'كاريير', 'يونيون اير', 'LG', 'سامسونج', 'جري', 'ميديا', 'دايكن', 'ميتسوبيشي'],
];

$defaultBrands = ['سامسونج', 'LG', 'توشيبا', 'شارب', 'فيليبس', 'سوني', 'براون', 'بوش'];

$productTypes = [
    'أجهزة منزلية' => ['خلاط', 'مكنسة كهرباء', 'مكواة بخار', 'ماكينة قهوة', 'عصارة', 'مفرمة', 'كبة', 'غلاية', 'توستر'],
    'بوتاجازات' => ['بوتاجاز 4 شعلة', 'بوتاجاز 5 شعلة', 'بوتاجاز بلت ان', 'فرن غاز', 'مسطح غاز'],
    'تكييفات' => ['تكييف 1.5 حصان', 'تكييف 2.25 حصان', 'تكييف 3 حصان', 'تكييف انفرتر', 'تكييف سبليت', 'تكييف شباك'],
    'تلفزيونات' => ['تلفزيون 32 بوصة', 'تلفزيون 43 بوصة', 'تلفزيون 50 بوصة', 'تلفزيون 55 بوصة', 'تلفزيون 65 بوصة', 'تلفزيون 75 بوصة'],
    'ثلاجات' => ['ثلاجة 12 قدم', 'ثلاجة 14 قدم', 'ثلاجة 16 قدم', 'ثلاجة 18 قدم', 'ثلاجة 20 قدم', 'ثلاجة 24 قدم'],
    'سخانات' => ['سخان غاز 6 لتر', 'سخان غاز 10 لتر', 'سخان كهرباء 40 لتر', 'سخان كهرباء 50 لتر', 'سخان كهرباء 80 لتر', 'سخان فوري'],
    'غسالات' => ['غسالة 7 كيلو', 'غسالة 8 كيلو', 'غسالة 9 كيلو', 'غسالة 10 كيلو', 'غسالة 12 كيلو', 'غسالة تحميل علوي'],
    'لابتوبات' => ['لابتوب 14 بوصة', 'لابتوب 15.6 بوصة', 'لابتوب 17 بوصة', 'لابتوب جيمنج', 'لابتوب الترابوك', 'لابتوب 2 في 1'],
    'موبايلات' => ['موبايل 64GB', 'موبايل 128GB', 'موبايل 256GB', 'موبايل 512GB', 'موبايل 5G', 'موبايل فولدابل'],
    'ميكروويف' => ['ميكروويف 20 لتر', 'ميكروويف 25 لتر', 'ميكروويف 30 لتر', 'ميكروويف 40 لتر', 'ميكروويف جريل', 'ميكروويف كونفكشن'],
    'أجهزة كهربائية' => ['سشوار', 'فير شعر', 'ماكينة حلاقة', 'مكواة شعر', 'ماسح كهربائي', 'مدلك كهربائي'],
    'هواتف محمولة' => ['هاتف 64GB', 'هاتف 128GB', 'هاتف 256GB', 'هاتف 512GB', 'هاتف 5G', 'هاتف Pro Max'],
    'ملحقات' => ['سماعة بلوتوث', 'شاحن سريع', 'كابل شحن', 'جراب موبايل', 'واقي شاشة', 'باور بانك', 'ساعة ذكية'],
    'أجهزة مطبخ' => ['خلاط يدوي', 'فود بروسيسور', 'عجانة', 'قلاية هوائية', 'محضر طعام', 'ماكينة وافل', 'صانعة خبز'],
    'شاشات وتلفزيونات' => ['شاشة 32 بوصة', 'شاشة 43 بوصة', 'شاشة 50 بوصة', 'شاشة 55 بوصة OLED', 'شاشة 65 بوصة', 'شاشة كمبيوتر'],
    'ثلاجات ومجمدات' => ['ثلاجة نوفروست', 'ديب فريزر', 'ثلاجة ميني بار', 'فريزر أفقي', 'ثلاجة فرنش دور'],
    'مكيفات' => ['مكيف سبليت', 'مكيف شباك', 'مكيف متنقل', 'مكيف كاسيت', 'مكيف مخفي'],
];

$defaultTypes = ['جهاز', 'منتج', 'موديل', 'نوع', 'اصدار'];

$features = [
    'سمارت', 'ديجيتال', 'انفرتر', 'اوتوماتيك', 'بروفيشنال', 'ايكو', 'تربو', 'سوبر', 'الترا', 
    'بريميوم', 'ستانلس ستيل', 'LED', 'LCD', 'OLED', 'نوفروست', 'بلازما', 'WiFi', 'بلوتوث',
    'عالي الكفاءة', 'موفر للطاقة', 'صامت', 'سريع', 'متعدد الوظائف', 'تحكم عن بعد', 'شاشة تاتش'
];

$colors = ['أبيض', 'أسود', 'فضي', 'ذهبي', 'رمادي', 'أزرق', 'أحمر', 'بني'];

// صور عشوائية من Lorem Picsum
function getRandomImageUrl($categoryName) {
    $seed = rand(1, 1000);
    // نستخدم أرقام عشوائية لضمان صور مختلفة
    return "https://picsum.photos/seed/{$seed}/400/400";
}

// تنزيل صورة
function downloadImage($url, $filepath) {
    $context = stream_context_create([
        'http' => ['timeout' => 10, 'user_agent' => 'Mozilla/5.0'],
        'ssl' => ['verify_peer' => false, 'verify_peer_name' => false]
    ]);
    
    $imageContent = @file_get_contents($url, false, $context);
    
    if ($imageContent && strlen($imageContent) > 1000) {
        file_put_contents($filepath, $imageContent);
        return true;
    }
    return false;
}

// توليد اسم منتج عشوائي
function generateProductName($categoryName, $brands, $productTypes, $features, $colors) {
    global $defaultBrands, $defaultTypes;
    
    $brandList = isset($brands[$categoryName]) ? $brands[$categoryName] : $defaultBrands;
    $typeList = isset($productTypes[$categoryName]) ? $productTypes[$categoryName] : $defaultTypes;
    
    $brand = $brandList[array_rand($brandList)];
    $type = $typeList[array_rand($typeList)];
    $feature = $features[array_rand($features)];
    $color = rand(0, 1) ? ' ' . $colors[array_rand($colors)] : '';
    
    $modelNumber = rand(100, 9999);
    
    return "{$type} {$brand} {$feature}{$color} موديل {$modelNumber}";
}

// توليد وصف المنتج
function generateDescription($name, $categoryName) {
    $descriptions = [
        "منتج {$name} بجودة عالية وتصميم عصري. يتميز بالمتانة والكفاءة العالية. مناسب للاستخدام اليومي.",
        "{$name} - الاختيار الأمثل للمنازل العصرية. تقنية متطورة وأداء متميز. ضمان شامل.",
        "احصل على {$name} بأفضل سعر. منتج أصلي مع ضمان الوكيل. توصيل سريع لجميع المناطق.",
        "{$name} من أفضل المنتجات في فئة {$categoryName}. جودة ممتازة وسعر منافس.",
        "منتج {$name} الجديد كلياً. تصميم أنيق وأداء قوي. مثالي للعائلات.",
    ];
    
    return $descriptions[array_rand($descriptions)];
}

// توليد سعر عشوائي بناءً على التصنيف
function generatePrice($categoryName) {
    $priceRanges = [
        'أجهزة منزلية' => [500, 8000],
        'بوتاجازات' => [3000, 15000],
        'تكييفات' => [8000, 30000],
        'تلفزيونات' => [4000, 40000],
        'ثلاجات' => [8000, 35000],
        'سخانات' => [1500, 8000],
        'غسالات' => [6000, 25000],
        'لابتوبات' => [10000, 80000],
        'موبايلات' => [3000, 70000],
        'ميكروويف' => [1500, 8000],
        'أجهزة كهربائية' => [200, 5000],
        'هواتف محمولة' => [2000, 60000],
        'ملحقات' => [50, 3000],
        'أجهزة مطبخ' => [500, 10000],
        'شاشات وتلفزيونات' => [3000, 50000],
        'ثلاجات ومجمدات' => [5000, 30000],
        'مكيفات' => [7000, 35000],
    ];
    
    $range = isset($priceRanges[$categoryName]) ? $priceRanges[$categoryName] : [1000, 20000];
    
    // تقريب السعر لأقرب 50
    $price = rand($range[0], $range[1]);
    return round($price / 50) * 50;
}

$productsPerCategory = 250;
$totalProducts = 0;
$totalImages = 0;
$batchSize = 50; // إضافة 50 منتج في كل دفعة ثم نعرض التقدم

// بدء المعاملة للأداء
echo "🚀 بدء إضافة المنتجات...\n\n";

foreach ($categories as $category) {
    $categoryId = $category['id'];
    $categoryName = $category['name'];
    
    echo "📁 {$categoryName} (ID: {$categoryId})\n";
    echo "   إضافة {$productsPerCategory} منتج...\n";
    
    $categoryProducts = 0;
    $categoryImages = 0;
    
    $pdo->beginTransaction();
    
    for ($i = 1; $i <= $productsPerCategory; $i++) {
        // توليد بيانات المنتج
        $name = generateProductName($categoryName, $brands, $productTypes, $features, $colors);
        $description = generateDescription($name, $categoryName);
        $cashPrice = generatePrice($categoryName);
        $installmentPrice = round($cashPrice * 1.15 / 50) * 50; // زيادة 15% للتقسيط
        $costPrice = round($cashPrice * 0.7 / 50) * 50;
        $quantity = rand(5, 100);
        $minQuantity = rand(3, 10);
        $barcode = '50' . str_pad(rand(1, 9999999999), 10, '0', STR_PAD_LEFT);
        $sku = 'SKU-' . strtoupper(substr(md5(uniqid()), 0, 8));
        $warranty = rand(0, 1) ? rand(6, 36) : 0;
        
        // تنزيل صورة (نقلل عدد الصور لتسريع العملية)
        $imageFilename = null;
        if ($i <= 10 || rand(1, 5) === 1) { // فقط أول 10 منتجات + 20% من الباقي
            $imageUrl = getRandomImageUrl($categoryName);
            $imageFilename = 'product_' . md5($name . $i) . '.jpg';
            $imagePath = $uploadsDir . '/' . $imageFilename;
            
            if (downloadImage($imageUrl, $imagePath)) {
                $categoryImages++;
            } else {
                $imageFilename = null;
            }
        }
        
        // إضافة المنتج
        $stmt = $pdo->prepare("
            INSERT INTO products 
            (name, description, category_id, barcode, sku, cash_price, installment_price, cost_price, 
             quantity, min_quantity, image, warranty_months, is_active, created_at, updated_at) 
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 1, datetime('now'), datetime('now'))
        ");
        
        $stmt->execute([
            $name, $description, $categoryId, $barcode, $sku, 
            $cashPrice, $installmentPrice, $costPrice,
            $quantity, $minQuantity, $imageFilename, $warranty
        ]);
        
        $categoryProducts++;
        
        // عرض التقدم كل 50 منتج
        if ($i % $batchSize === 0) {
            echo "   ✓ {$i}/{$productsPerCategory}\n";
        }
    }
    
    $pdo->commit();
    
    $totalProducts += $categoryProducts;
    $totalImages += $categoryImages;
    
    echo "   ✅ تم إضافة {$categoryProducts} منتج ({$categoryImages} صورة)\n\n";
}

echo "==============================================\n";
echo "   ✅ اكتملت العملية بنجاح!\n";
echo "==============================================\n";
echo "📦 إجمالي المنتجات المضافة: {$totalProducts}\n";
echo "🖼️  إجمالي الصور المحملة: {$totalImages}\n";
echo "📁 عدد التصنيفات: " . count($categories) . "\n";
echo "📊 متوسط المنتجات لكل تصنيف: " . round($totalProducts / count($categories)) . "\n";


============================================================
FILE: generate_sample_data.php
============================================================
<?php
/**
 * سكريبت إضافة بيانات تجريبية كثيرة
 */

$dbPath = __DIR__ . '/database/database.sqlite';
$pdo = new PDO('sqlite:' . $dbPath);
$pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

echo "بدء إضافة البيانات التجريبية...\n";

// أسماء عربية للتوليد العشوائي
$firstNames = ['محمد', 'أحمد', 'علي', 'حسن', 'إبراهيم', 'عمر', 'خالد', 'يوسف', 'عبدالله', 'مصطفى', 'كريم', 'طارق', 'سامي', 'فهد', 'ناصر', 'عادل', 'سعيد', 'رامي', 'هاني', 'وليد'];
$lastNames = ['محمود', 'عبدالرحمن', 'السيد', 'حسين', 'العلي', 'الأحمد', 'المصري', 'الشريف', 'البدر', 'النجار', 'الحداد', 'الخطيب', 'السالم', 'الفهد', 'العمري'];
$cities = ['القاهرة', 'الجيزة', 'الإسكندرية', 'أسوان', 'الأقصر', 'المنصورة', 'طنطا', 'الزقازيق', 'دمياط', 'بورسعيد'];

$productNames = [
    'تلفزيون سامسونج 55 بوصة', 'تلفزيون LG 50 بوصة', 'تلفزيون سوني 65 بوصة',
    'ثلاجة توشيبا 18 قدم', 'ثلاجة شارب 16 قدم', 'ثلاجة ال جي 20 قدم',
    'غسالة سامسونج 8 كيلو', 'غسالة ال جي 10 كيلو', 'غسالة توشيبا 7 كيلو',
    'تكييف شارب 1.5 حصان', 'تكييف كاريير 2.25 حصان', 'تكييف يونيون اير 3 حصان',
    'بوتاجاز يونيفرسال 5 شعلة', 'بوتاجاز فريش 4 شعلة', 'بوتاجاز اي كوك 5 شعلة',
    'سخان غاز اوليمبيك', 'سخان كهرباء تورنيدو', 'سخان غاز فريش',
    'ميكروويف سامسونج', 'ميكروويف ال جي', 'ميكروويف شارب',
    'خلاط براون', 'خلاط مولينكس', 'خلاط تورنيدو',
    'شاشة كمبيوتر HP 24', 'شاشة كمبيوتر Dell 27', 'لابتوب Lenovo',
    'لابتوب HP Pavilion', 'لابتوب Dell Inspiron', 'لابتوب ASUS',
    'آيفون 15 Pro', 'سامسونج S24', 'شاومي 14', 'أوبو رينو',
    'ديب فريزر كريازي', 'ديب فريزر الاسكا', 'مكنسة كهربائية باناسونيك'
];

// ========== إضافة تصنيفات ==========
echo "إضافة التصنيفات...\n";
$categories = ['تلفزيونات', 'ثلاجات', 'غسالات', 'تكييفات', 'بوتاجازات', 'سخانات', 'ميكروويف', 'أجهزة منزلية', 'موبايلات', 'لابتوبات'];

foreach ($categories as $cat) {
    $pdo->exec("INSERT OR IGNORE INTO categories (name) VALUES ('$cat')");
}
echo "تم إضافة " . count($categories) . " تصنيف\n";

// ========== إضافة منتجات ==========
echo "إضافة المنتجات...\n";
$productCount = 0;
foreach ($productNames as $name) {
    $categoryId = rand(1, 10);
    $cashPrice = rand(3000, 50000);
    $installmentPrice = $cashPrice * 1.15;
    $costPrice = $cashPrice * 0.75;
    $quantity = rand(5, 100);
    $barcode = '10' . str_pad(rand(1, 999999), 6, '0', STR_PAD_LEFT);
    
    try {
        $stmt = $pdo->prepare("INSERT INTO products (name, category_id, cash_price, installment_price, cost_price, quantity, min_quantity, barcode, is_active) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 1)");
        $stmt->execute([$name, $categoryId, $cashPrice, $installmentPrice, $costPrice, $quantity, 5, $barcode]);
        $productCount++;
    } catch (Exception $e) {
        // تجاهل المنتجات المكررة
    }
}
echo "تم إضافة $productCount منتج\n";

// ========== إضافة عملاء ==========
echo "إضافة العملاء...\n";
$customerCount = 0;
for ($i = 1; $i <= 200; $i++) {
    $name = $firstNames[array_rand($firstNames)] . ' ' . $lastNames[array_rand($lastNames)];
    $phone = '01' . rand(0, 2) . str_pad(rand(1, 99999999), 8, '0', STR_PAD_LEFT);
    $nationalId = rand(20000000000000, 39999999999999);
    $city = $cities[array_rand($cities)];
    $address = 'شارع ' . rand(1, 100) . '، ' . $city;
    
    try {
        $stmt = $pdo->prepare("INSERT INTO customers (full_name, phone, national_id, city, address, is_active) VALUES (?, ?, ?, ?, ?, 1)");
        $stmt->execute([$name, $phone, $nationalId, $city, $address]);
        $customerCount++;
    } catch (Exception $e) {
        // تجاهل
    }
}
echo "تم إضافة $customerCount عميل\n";

// ========== إضافة فواتير وأقساط ==========
echo "إضافة الفواتير والأقساط...\n";
$invoiceCount = 0;
$installmentCount = 0;
$paymentCount = 0;

// فواتير نقدية (100 فاتورة)
for ($i = 1; $i <= 100; $i++) {
    $invoiceNumber = 'INV-' . date('Ymd') . '-' . str_pad($i, 4, '0', STR_PAD_LEFT);
    $customerId = rand(1, 200);
    $productId = rand(1, 35);
    $daysAgo = rand(0, 90);
    $createdAt = date('Y-m-d H:i:s', strtotime("-$daysAgo days"));
    
    $product = $pdo->query("SELECT * FROM products WHERE id = $productId")->fetch(PDO::FETCH_ASSOC);
    if (!$product) continue;
    
    $quantity = rand(1, 3);
    $totalAmount = $product['cash_price'] * $quantity;
    
    try {
        $stmt = $pdo->prepare("INSERT INTO invoices (invoice_number, invoice_type, customer_id, user_id, subtotal, total_amount, paid_amount, remaining_amount, status, created_at) VALUES (?, 'cash', ?, 1, ?, ?, ?, 0, 'completed', ?)");
        $stmt->execute([$invoiceNumber, $customerId, $totalAmount, $totalAmount, $totalAmount, $createdAt]);
        $invoiceId = $pdo->lastInsertId();
        
        // إضافة بند الفاتورة
        $stmt = $pdo->prepare("INSERT INTO invoice_items (invoice_id, product_id, product_name, quantity, unit_price, total_price) VALUES (?, ?, ?, ?, ?, ?)");
        $stmt->execute([$invoiceId, $productId, $product['name'], $quantity, $product['cash_price'], $totalAmount]);
        
        // إضافة دفعة
        $receiptNumber = 'RCP-' . date('Ymd', strtotime($createdAt)) . '-' . str_pad($paymentCount + 1, 4, '0', STR_PAD_LEFT);
        $stmt = $pdo->prepare("INSERT INTO payments (invoice_id, amount, payment_method, receipt_number, user_id, payment_date) VALUES (?, ?, 'cash', ?, 1, ?)");
        $stmt->execute([$invoiceId, $totalAmount, $receiptNumber, $createdAt]);
        $paymentCount++;
        
        $invoiceCount++;
    } catch (Exception $e) {
        // تجاهل
    }
}

// فواتير تقسيط (150 فاتورة)
for ($i = 1; $i <= 150; $i++) {
    $invoiceNumber = 'INV-' . date('Ymd') . '-' . str_pad(100 + $i, 4, '0', STR_PAD_LEFT);
    $customerId = rand(1, 200);
    $productId = rand(1, 35);
    $daysAgo = rand(0, 180);
    $createdAt = date('Y-m-d H:i:s', strtotime("-$daysAgo days"));
    
    $product = $pdo->query("SELECT * FROM products WHERE id = $productId")->fetch(PDO::FETCH_ASSOC);
    if (!$product) continue;
    
    $quantity = rand(1, 2);
    $totalAmount = $product['installment_price'] * $quantity;
    $downPayment = $totalAmount * 0.2;
    $remainingAmount = $totalAmount - $downPayment;
    $months = [6, 12, 18, 24][rand(0, 3)];
    $monthlyInstallment = $remainingAmount / $months;
    
    try {
        $stmt = $pdo->prepare("INSERT INTO invoices (invoice_number, invoice_type, customer_id, user_id, subtotal, total_amount, paid_amount, remaining_amount, down_payment, monthly_installment, installments_count, first_installment_date, status, created_at) VALUES (?, 'installment', ?, 1, ?, ?, ?, ?, ?, ?, ?, ?, 'active', ?)");
        $firstInstDate = date('Y-m-d', strtotime($createdAt . ' +1 month'));
        $stmt->execute([$invoiceNumber, $customerId, $totalAmount, $totalAmount, $downPayment, $remainingAmount, $downPayment, $monthlyInstallment, $months, $firstInstDate, $createdAt]);
        $invoiceId = $pdo->lastInsertId();
        
        // إضافة بند الفاتورة
        $stmt = $pdo->prepare("INSERT INTO invoice_items (invoice_id, product_id, product_name, quantity, unit_price, total_price) VALUES (?, ?, ?, ?, ?, ?)");
        $stmt->execute([$invoiceId, $productId, $product['name'], $quantity, $product['installment_price'], $totalAmount]);
        
        // إضافة الأقساط
        for ($m = 1; $m <= $months; $m++) {
            $dueDate = date('Y-m-d', strtotime($firstInstDate . ' +' . ($m - 1) . ' months'));
            $status = 'pending';
            $paidAmount = 0;
            
            // بعض الأقساط مدفوعة
            if (strtotime($dueDate) < time() && rand(0, 100) < 70) {
                $status = 'paid';
                $paidAmount = $monthlyInstallment;
            } else if (strtotime($dueDate) < time() && rand(0, 100) < 50) {
                $status = 'partial';
                $paidAmount = $monthlyInstallment * 0.5;
            }
            
            $stmt = $pdo->prepare("INSERT INTO installments (invoice_id, installment_number, amount, due_date, paid_amount, remaining_amount, status) VALUES (?, ?, ?, ?, ?, ?, ?)");
            $stmt->execute([$invoiceId, $m, $monthlyInstallment, $dueDate, $paidAmount, $monthlyInstallment - $paidAmount, $status]);
            $installmentCount++;
            
            // إضافة دفعة إذا مدفوع
            if ($paidAmount > 0) {
                $receiptNumber = 'RCP-' . date('Ymd', strtotime($dueDate)) . '-' . str_pad($paymentCount + 1, 4, '0', STR_PAD_LEFT);
                $stmt = $pdo->prepare("INSERT INTO payments (invoice_id, installment_id, amount, payment_method, receipt_number, user_id, payment_date) VALUES (?, ?, ?, 'cash', ?, 1, ?)");
                $instId = $pdo->lastInsertId();
                $stmt->execute([$invoiceId, $instId, $paidAmount, $receiptNumber, $dueDate]);
                $paymentCount++;
            }
        }
        
        $invoiceCount++;
    } catch (Exception $e) {
        // تجاهل
    }
}

echo "تم إضافة $invoiceCount فاتورة\n";
echo "تم إضافة $installmentCount قسط\n";
echo "تم إضافة $paymentCount دفعة\n";

echo "\n✅ اكتمل إضافة البيانات التجريبية بنجاح!\n";
echo "الملخص:\n";
echo "- " . count($categories) . " تصنيف\n";
echo "- $productCount منتج\n";
echo "- $customerCount عميل\n";
echo "- $invoiceCount فاتورة\n";
echo "- $installmentCount قسط\n";
echo "- $paymentCount دفعة\n";


============================================================
FILE: README.md
============================================================
<div dir="rtl">

# نظام تقسيط - NizamTaqsit

<div align="center">

![Dashboard](docs/screenshots/dashboard.png)

**نظام متكامل لإدارة التقسيط والمبيعات**

[![PHP](https://img.shields.io/badge/PHP-8.2-777BB4?style=flat-square&logo=php)](https://php.net)
[![SQLite](https://img.shields.io/badge/SQLite-3-003B57?style=flat-square&logo=sqlite)](https://sqlite.org)
[![Docker](https://img.shields.io/badge/Docker-Ready-2496ED?style=flat-square&logo=docker)](https://docker.com)
[![License](https://img.shields.io/badge/License-MIT-green?style=flat-square)](LICENSE)

</div>

---

## 📋 المحتويات

- [نظرة عامة](#-نظرة-عامة)
- [المميزات](#-المميزات)
- [لقطات الشاشة](#-لقطات-الشاشة)
- [API](#-api)
- [المتطلبات](#-المتطلبات)
- [التثبيت](#-التثبيت)
- [الاستخدام](#-الاستخدام)
- [Docker](#-docker)

---

## 🎯 نظرة عامة

نظام تقسيط هو تطبيق ويب متكامل لإدارة عمليات البيع بالتقسيط. يتيح للمحلات التجارية إدارة العملاء، المنتجات، خطط التقسيط، والمدفوعات بكفاءة عالية.

---

## ✨ المميزات

| الميزة | الوصف |
|--------|-------|
| 🏠 **لوحة تحكم** | عرض شامل للإحصائيات والتنبيهات |
| 🛒 **نقطة البيع** | واجهة سهلة للمبيعات السريعة |
| 👥 **إدارة العملاء** | تسجيل ومتابعة بيانات العملاء |
| 📦 **إدارة المنتجات** | إضافة وتعديل المنتجات والفئات |
| 💳 **خطط التقسيط** | إنشاء ومتابعة خطط السداد |
| 💰 **إدارة المدفوعات** | تسجيل الأقساط والمتأخرات |
| 📊 **التقارير** | تقارير تفصيلية للمبيعات والتحصيل |
| ⚙️ **الإعدادات** | تخصيص النظام والمظهر |
| 🎨 **ثيمات مخصصة** | تخصيص المظهر لكل موظف |
| 🔐 **الصلاحيات** | نظام أدوار وصلاحيات متكامل |
| 🔑 **API متكامل** | واجهة برمجية RESTful للتكامل مع التطبيقات الخارجية |

---

## 📸 لقطات الشاشة

### 🏠 لوحة التحكم (Dashboard)
تعرض ملخص شامل للنظام يتضمن:
- إجمالي المبيعات والتحصيلات
- عدد العملاء والأقساط المتأخرة
- رسوم بيانية للأداء
- آخر العمليات والتنبيهات

![لوحة التحكم](docs/screenshots/dashboard.png)

---

### 🛒 نقطة البيع (POS)
واجهة البيع السريع:
- عرض المنتجات حسب الفئات
- البحث السريع في المنتجات
- سلة المشتريات
- خيارات الدفع (نقدي/تقسيط)

![نقطة البيع](docs/screenshots/pos.png)

---

### 👥 إدارة العملاء
إدارة شاملة للعملاء:
- إضافة عملاء جدد
- عرض بيانات العميل
- سجل المشتريات والأقساط
- البحث والفلترة

![العملاء](docs/screenshots/customers.png)

---

### 📦 إدارة المنتجات
إدارة المخزون:
- إضافة وتعديل المنتجات
- الفئات والتصنيفات
- الأسعار والخصومات
- صور المنتجات

![المنتجات](docs/screenshots/products.png)

---

### 📊 التقارير
تقارير تفصيلية:
- تقارير المبيعات
- تقارير التحصيل
- تقارير الأقساط المتأخرة
- تقارير أداء الموظفين

![التقارير](docs/screenshots/reports.png)

---

### ⚙️ الإعدادات
تخصيص النظام:
- إعدادات الشركة
- المظهر والألوان
- إعدادات الطباعة
- النسخ الاحتياطي

![الإعدادات](docs/screenshots/settings.png)

---

## � API

نظام تقسيط يوفر واجهة برمجية RESTful متكاملة للتكامل مع التطبيقات الخارجية مثل تطبيقات الموبايل.

### 🔐 المصادقة (Authentication)

جميع طلبات API تتطلب مفتاح API صالح. أضف المفتاح في Header الطلب:

```http
X-API-KEY: your_api_key_here
```

#### إنشاء مفتاح API:
1. اذهب إلى **الإعدادات** > **إدارة API Keys**
2. اضغط على **إنشاء مفتاح جديد**
3. أدخل اسم المفتاح وتاريخ الانتهاء (اختياري)
4. احفظ المفتاح في مكان آمن

### 📡 رابط API الأساسي

```
https://your-domain.com/api/v2/
```

### 📦 نقاط النهاية (Endpoints)

#### المنتجات (Products)
| Method | Endpoint | الوصف |
|--------|----------|-------|
| `GET` | `/api/v2/products` | جلب جميع المنتجات |
| `GET` | `/api/v2/products/{id}` | جلب منتج بالـ ID |
| `POST` | `/api/v2/products` | إضافة منتج جديد |
| `PUT` | `/api/v2/products/{id}` | تحديث منتج |
| `DELETE` | `/api/v2/products/{id}` | حذف منتج |

#### التصنيفات (Categories)
| Method | Endpoint | الوصف |
|--------|----------|-------|
| `GET` | `/api/v2/categories` | جلب جميع التصنيفات |
| `GET` | `/api/v2/categories/{id}` | جلب تصنيف بالـ ID |
| `POST` | `/api/v2/categories` | إضافة تصنيف جديد |
| `PUT` | `/api/v2/categories/{id}` | تحديث تصنيف |
| `DELETE` | `/api/v2/categories/{id}` | حذف تصنيف |

#### العملاء (Customers)
| Method | Endpoint | الوصف |
|--------|----------|-------|
| `GET` | `/api/v2/customers` | جلب جميع العملاء |
| `GET` | `/api/v2/customers/{id}` | جلب عميل بالـ ID |
| `POST` | `/api/v2/customers` | إضافة عميل جديد |
| `PUT` | `/api/v2/customers/{id}` | تحديث عميل |
| `DELETE` | `/api/v2/customers/{id}` | حذف عميل |

#### الفواتير (Invoices)
| Method | Endpoint | الوصف |
|--------|----------|-------|
| `GET` | `/api/v2/invoices` | جلب جميع الفواتير |
| `GET` | `/api/v2/invoices/{id}` | جلب فاتورة بالـ ID |

#### الأقساط (Installments)
| Method | Endpoint | الوصف |
|--------|----------|-------|
| `GET` | `/api/v2/installments` | جلب جميع الأقساط |
| `GET` | `/api/v2/installments/today` | أقساط اليوم |
| `GET` | `/api/v2/installments/overdue` | الأقساط المتأخرة |
| `POST` | `/api/v2/installments/{id}/pay` | تسجيل دفعة |

#### لوحة التحكم (Dashboard)
| Method | Endpoint | الوصف |
|--------|----------|-------|
| `GET` | `/api/v2/dashboard/stats` | إحصائيات لوحة التحكم |

### 📝 أمثلة

#### جلب المنتجات (cURL)
```bash
curl -X GET "https://your-domain.com/api/v2/products" \
     -H "X-API-KEY: your_api_key_here"
```

#### إضافة منتج جديد
```bash
curl -X POST "https://your-domain.com/api/v2/products" \
     -H "X-API-KEY: your_api_key_here" \
     -H "Content-Type: application/json" \
     -d '{
       "name": "منتج جديد",
       "price": 1500,
       "cost_price": 1200,
       "category_id": 1,
       "stock_quantity": 10
     }'
```

#### الاستجابة (Response)
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "منتج جديد",
    "price": 1500,
    "stock_quantity": 10
  },
  "message": "تم إضافة المنتج بنجاح"
}
```

### ⚠️ أكواد الحالة (Status Codes)

| الكود | المعنى |
|-------|--------|
| `200` | نجاح |
| `201` | تم الإنشاء بنجاح |
| `400` | طلب غير صالح |
| `401` | غير مصرح (مفتاح API غير صالح) |
| `404` | غير موجود |
| `500` | خطأ في السيرفر |

---

## �💻 المتطلبات

### للتشغيل المباشر:
- PHP 8.0 أو أعلى
- SQLite 3
- امتدادات PHP: pdo_sqlite, gd, mbstring

### للتشغيل بـ Docker:
- Docker
- Docker Compose

---

## 🚀 التثبيت

### الطريقة الأولى: التشغيل المباشر

```bash
# 1. استنساخ المشروع
git clone https://github.com/hany-php/NizamTaqsit.git
cd NizamTaqsit

# 2. تشغيل السيرفر
php -S localhost:8000 -t public

# 3. افتح المتصفح
# http://localhost:8000
```

### الطريقة الثانية: Docker (موصى بها)

```bash
# 1. استنساخ المشروع
git clone https://github.com/hany-php/NizamTaqsit.git
cd NizamTaqsit

# 2. بناء وتشغيل الحاوية
docker-compose build
docker-compose up -d

# 3. افتح المتصفح
# http://localhost:4000
```

---

## 📖 الاستخدام

### تسجيل الدخول
- **اسم المستخدم**: admin
- **كلمة المرور**: admin123

### إضافة عميل جديد
1. اذهب إلى **العملاء** من القائمة الجانبية
2. اضغط على **إضافة عميل**
3. أدخل البيانات المطلوبة
4. اضغط **حفظ**

### إنشاء عملية بيع
1. اذهب إلى **نقطة البيع**
2. اختر المنتجات من القائمة
3. اختر العميل
4. اختر طريقة الدفع (نقدي/تقسيط)
5. أكمل العملية

### متابعة الأقساط
1. اذهب إلى **التقارير** > **المتأخرات**
2. راجع الأقساط المستحقة
3. سجّل الدفعات المستلمة

---

## 🐳 Docker

### هيكل الملفات
```
NizamTaqsit/
├── Dockerfile              # صورة Docker
├── docker-compose.yml      # إعدادات Docker Compose
├── docker/
│   ├── nginx.conf          # إعدادات Nginx
│   ├── default.conf        # إعدادات السيرفر
│   └── supervisord.conf    # إدارة العمليات
```

### المجلدات المُركّبة (Volumes)
| المجلد على السيرفر | داخل الحاوية | الوصف |
|-------------------|-------------|-------|
| `/mnt/nizamtaqsit/app` | `/var/www/html/app` | ملفات التطبيق |
| `/mnt/nizamtaqsit/database` | `/var/www/html/database` | قاعدة البيانات |
| `/mnt/nizamtaqsit/public` | `/var/www/html/public` | الملفات العامة |

### أوامر مفيدة
```bash
# إيقاف الحاوية
docker-compose down

# عرض السجلات
docker-compose logs -f

# إعادة البناء
docker-compose build --no-cache

# الدخول للحاوية
docker exec -it nizamtaqsit-app sh

# عمل نسخة احتياطية
docker-compose --profile backup run backup
```

---

## 👨‍💻 المطور

**Hany PHP**
- GitHub: [@hany-php](https://github.com/hany-php)

---

## 📄 الترخيص

هذا المشروع مرخص تحت رخصة MIT - راجع ملف [LICENSE](LICENSE) للتفاصيل.

---

<div align="center">

**صُنع بـ ❤️ في مصر**

</div>

</div>